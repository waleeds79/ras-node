/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
jQuery.propHooks.disabled={set:function(e,t){e.disabled!==t&&((e.disabled=t)?$(e).trigger("disabled"):$(e).trigger("enabled"))}};var RED=function(){function s(e,a){a=a||function(){};var i,t=/<!-- --- \[red-module:(\S+)\] --- -->/.exec(e.trim());i=t?t[1]:"unknown";try{var s=!1,r=$("<div>"+e+"</div>"),o=r.find("script"),l=o.length;o.each(function(e,t){var o=$(t).attr("src");if(o&&!/^\s*(https?:|\/|\.)/.test(o)){$(t).remove();var n=document.createElement("script");n.onload=function(){0===--l&&($("body").append(r),a())},$("body").append(n),n.src=RED.settings.apiRootUrl+o,s=!0}else(/\/ace.js$/.test(o)||/\/ext-language_tools.js$/.test(o))&&(console.warn("Blocked attempt to load",o,"by",i),$(t).remove()),l--}),s||($("body").append(r),a())}catch(e){RED.notify(RED._("notification.errors.failedToAppendNode",{module:i,error:e.toString()}),{type:"error",timeout:1e4}),console.log("["+i+"] "+e.toString()),a()}}function r(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"icons",success:function(e){RED.nodes.setIconSets(e),t&&t()}})}function t(){$.ajax({headers:{Accept:"text/html"},cache:!1,url:"nodes",success:function(e){var t=e.trim().split(/(?=<!-- --- \[red-module:\S+\] --- -->)/),o=function(){0===t.length?($("body").i18n(),$("#palette > .palette-spinner").hide(),$(".palette-scroll").removeClass("hide"),$("#palette-search").removeClass("hide"),l(function(){RED.settings.theme("projects.enabled",!1)?RED.projects.refresh(function(e){RED.sidebar.info.refresh(),e||(RED.menu.setDisabled("menu-item-projects-open",!0),RED.menu.setDisabled("menu-item-projects-settings",!0),!1===e||RED.projects.showStartup()),n()}):(RED.sidebar.info.refresh(),n())})):s(t.shift(),o)};o()}})}function l(o){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(e){if(e){var t=window.location.hash;RED.nodes.version(e.rev),RED.nodes.import(e.flows),RED.nodes.dirty(!1),RED.view.redraw(!0),/^#flow\/.+$/.test(t)&&RED.workspaces.show(t.substring(6))}o()}})}function n(){var i={};RED.comms.subscribe("notification/#",function(e,o){var t=e.split("/")[1];if("runtime-deploy"!==t&&"node"!==t){if("project-update"===t)return RED.nodes.clear(),RED.history.clear(),RED.view.redraw(!0),void RED.projects.refresh(function(){l(function(){var e=RED.projects.getActiveProject(),t={"change-branch":RED._("notification.project.change-branch",{project:e.git.branches.local}),"merge-abort":RED._("notification.project.merge-abort"),loaded:RED._("notification.project.loaded",{project:o.project}),updated:RED._("notification.project.updated",{project:o.project}),pull:RED._("notification.project.pull",{project:o.project}),revert:RED._("notification.project.revert",{project:o.project}),"merge-complete":RED._("notification.project.merge-complete")}[o.action];RED.notify("<p>"+t+"</p>"),RED.sidebar.info.refresh()})});if(o.text){o.default=o.text;var n=RED._(o.text,o),a={type:o.type,fixed:void 0===o.timeout,timeout:o.timeout,id:t};"runtime-state"===t&&("safe-mode"===o.error?a.buttons=[{text:RED._("common.label.close"),click:function(){i[t].hideNotification()}}]:"missing-types"===o.error?(n+="<ul><li>"+o.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.projects.getActiveProject()?a.buttons=[{text:RED._("notification.label.manage-project-dep"),click:function(){i[t].hideNotification(),RED.projects.settings.show("deps")}}]:a.buttons=[{text:RED._("common.label.close"),click:function(){i[t].hideNotification()}}]):"credentials_load_failed"===o.error?RED.settings.theme("projects.enabled",!1)?RED.user.hasPermission("projects.write")&&(a.buttons=[{text:RED._("notification.project.setupCredentials"),click:function(){i[t].hideNotification(),RED.projects.showCredentialsPrompt()}}]):a.buttons=[{text:RED._("common.label.close"),click:function(){i[t].hideNotification()}}]:"missing_flow_file"===o.error?RED.user.hasPermission("projects.write")&&(a.buttons=[{text:RED._("notification.project.setupProjectFiles"),click:function(){i[t].hideNotification(),RED.projects.showFilesPrompt()}}]):"missing_package_file"===o.error?RED.user.hasPermission("projects.write")&&(a.buttons=[{text:RED._("notification.project.setupProjectFiles"),click:function(){i[t].hideNotification(),RED.projects.showFilesPrompt()}}]):"project_empty"===o.error?RED.user.hasPermission("projects.write")&&(a.buttons=[{text:RED._("notification.project.no"),click:function(){i[t].hideNotification()}},{text:RED._("notification.project.createDefault"),click:function(){i[t].hideNotification(),RED.projects.createDefaultFileSet()}}]):"git_merge_conflict"===o.error&&(RED.nodes.clear(),RED.sidebar.versionControl.refresh(!0),RED.user.hasPermission("projects.write")&&(a.buttons=[{text:RED._("notification.project.mergeConflict"),click:function(){i[t].hideNotification(),RED.sidebar.versionControl.showLocalChanges()}}]))),i.hasOwnProperty(t)?i[t].update(n,a):i[t]=RED.notify(n,a)}else i.hasOwnProperty(t)&&(i[t].close(),delete i[t])}}),RED.comms.subscribe("status/#",function(e,t){var o=e.split("/"),n=RED.nodes.node(o[1]);n&&(t.hasOwnProperty("text")&&"."!==t.text[0]&&(t.text=n._(t.text.toString(),{defaultValue:t.text.toString()})),n.status=t,n.dirty=!0,RED.view.redraw())}),RED.comms.subscribe("notification/node/#",function(e,t){var o,n,a;if("notification/node/added"==e){var i=[];t.forEach(function(e){var t=e.id;RED.nodes.addNodeSet(e),i=i.concat(e.types),RED.i18n.loadNodeCatalog(t,function(){$.get("nodes/"+t,function(e){s(e)})})}),i.length&&(a="<ul><li>"+i.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:i.length})+a,"success")),r()}else if("notification/node/removed"==e){for(o=0;o<t.length;o++)n=t[o],RED.nodes.removeNodeSet(n.id).added&&(a="<ul><li>"+n.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeRemoved",{count:n.types.length})+a,"success"));r()}else"notification/node/enabled"==e?t.types&&(RED.nodes.getNodeSet(t.id).added?(RED.nodes.enableNodeSet(t.id),a="<ul><li>"+t.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeEnabled",{count:t.types.length})+a,"success")):$.get("nodes/"+t.id,function(e){s(e),a="<ul><li>"+t.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:t.types.length})+a,"success")})):"notification/node/disabled"==e?t.types&&(RED.nodes.disableNodeSet(t.id),a="<ul><li>"+t.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeDisabled",{count:t.types.length})+a,"success")):"notification/node/upgraded"==e&&(RED.notify(RED._("palette.event.nodeUpgraded",{module:t.module,version:t.version}),"success"),RED.nodes.registry.setModulePendingUpdated(t.module,t.version));RED.library.loadFlowLibrary()}),RED.comms.subscribe("event-log/#",function(e,t){var o=e.substring(9);RED.eventLog.log(o,t)})}function o(){$.get("red/about",function(e){RED.sidebar.info.set('<div style="text-align:center;"><img width="50px" src="red/images/node-red-icon.svg" /></div>'+marked(e)),RED.sidebar.info.show()})}function a(){var e=[];RED.settings.theme("projects.enabled",!1)&&e.push({id:"menu-item-projects-menu",label:RED._("menu.label.projects"),options:[{id:"menu-item-projects-new",label:RED._("menu.label.projects-new"),disabled:!1,onselect:"core:new-project"},{id:"menu-item-projects-open",label:RED._("menu.label.projects-open"),disabled:!1,onselect:"core:open-project"},{id:"menu-item-projects-settings",label:RED._("menu.label.projects-settings"),disabled:!1,onselect:"core:show-project-settings"}]}),e.push({id:"menu-item-view-menu",label:RED._("menu.label.view.view"),options:[{id:"menu-item-palette",label:RED._("menu.label.palette.show"),toggle:!0,onselect:"core:toggle-palette",selected:!0},{id:"menu-item-sidebar",label:RED._("menu.label.sidebar.show"),toggle:!0,onselect:"core:toggle-sidebar",selected:!0},{id:"menu-item-event-log",label:RED._("eventLog.title"),onselect:"core:show-event-log"},null]}),e.push(null),e.push({id:"menu-item-import",label:RED._("menu.label.import"),options:[{id:"menu-item-import-clipboard",label:RED._("menu.label.clipboard"),onselect:"core:show-import-dialog"},{id:"menu-item-import-library",label:RED._("menu.label.library"),options:[]}]}),e.push({id:"menu-item-export",label:RED._("menu.label.export"),options:[{id:"menu-item-export-clipboard",label:RED._("menu.label.clipboard"),onselect:"core:show-export-dialog"},{id:"menu-item-export-library",label:RED._("menu.label.library"),disabled:!0,onselect:"core:library-export"}]}),e.push(null),e.push({id:"menu-item-search",label:RED._("menu.label.search"),onselect:"core:search"}),e.push(null),e.push({id:"menu-item-config-nodes",label:RED._("menu.label.displayConfig"),onselect:"core:show-config-tab"}),e.push({id:"menu-item-workspace",label:RED._("menu.label.flows"),options:[{id:"menu-item-workspace-add",label:RED._("menu.label.add"),onselect:"core:add-flow"},{id:"menu-item-workspace-edit",label:RED._("menu.label.rename"),onselect:"core:edit-flow"},{id:"menu-item-workspace-delete",label:RED._("menu.label.delete"),onselect:"core:remove-flow"}]}),e.push({id:"menu-item-subflow",label:RED._("menu.label.subflows"),options:[{id:"menu-item-subflow-create",label:RED._("menu.label.createSubflow"),onselect:"core:create-subflow"},{id:"menu-item-subflow-convert",label:RED._("menu.label.selectionToSubflow"),disabled:!0,onselect:"core:convert-to-subflow"}]}),e.push(null),!1!==RED.settings.theme("palette.editable")&&(e.push({id:"menu-item-edit-palette",label:RED._("menu.label.editPalette"),onselect:"core:manage-palette"}),e.push(null)),e.push({id:"menu-item-user-settings",label:RED._("menu.label.settings"),onselect:"core:show-user-settings"}),e.push(null),e.push({id:"menu-item-keyboard-shortcuts",label:RED._("menu.label.keyboardShortcuts"),onselect:"core:show-help"}),e.push({id:"menu-item-help",label:RED.settings.theme("menu.menu-item-help.label",RED._("menu.label.help")),href:RED.settings.theme("menu.menu-item-help.url","http://nodered.org/docs")}),e.push({id:"menu-item-node-red-version",label:"v"+RED.settings.version,onselect:"core:show-about"}),RED.view.init(),RED.userSettings.init(),RED.user.init(),RED.library.init(),RED.keyboard.init(),RED.palette.init(),RED.eventLog.init(),!1!==RED.settings.theme("palette.editable")?RED.palette.editor.init():console.log("Palette editor disabled"),RED.sidebar.init(),RED.settings.theme("projects.enabled",!1)?RED.projects.init():console.log("Projects disabled"),RED.subflow.init(),RED.workspaces.init(),RED.clipboard.init(),RED.search.init(),RED.editor.init(),RED.diff.init(),RED.menu.init({id:"btn-sidemenu",options:e}),RED.deploy.init(RED.settings.theme("deployButton",null)),RED.notifications.init(),RED.actions.add("core:show-about",o),RED.nodes.init(),RED.comms.connect(),$("#main-container").show(),$(".header-toolbar").show(),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"nodes",success:function(e){RED.nodes.setNodeList(e),RED.i18n.loadNodeCatalogs(function(){r(t)})}})}var i=!1;return{init:function(e){if(i)throw new Error("RED already initialised");i=!0,ace.require("ace/ext/language_tools"),(e=e||{}).apiRootUrl=e.apiRootUrl||"",e.apiRootUrl&&!/\/$/.test(e.apiRootUrl)&&(e.apiRootUrl=e.apiRootUrl+"/"),RED.i18n.init(e,function(){RED.settings.init(e,a)})}}}();RED.events=function(){var a={};return{on:function(e,t){a[e]=a[e]||[],a[e].push(t)},off:function(e,t){var o=a[e];if(o)for(var n=0;n<o.length;n++)if(o[n]===t)return void o.splice(n,1)},emit:function(t,e){if(a[t])for(var o=0;o<a[t].length;o++)try{a[t][o](e)}catch(e){console.log("RED.events.emit error: ["+t+"] "+e.toString()),console.log(e)}}}}(),RED.i18n=function(){var i;return{init:function(e,t){i=e.apiRootUrl||"",i18n.init({resGetPath:i+"locales/__ns__?lng=__lng__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red","jsonata","infotips"],defaultNs:"editor"},fallbackLng:["en-US"],useCookie:!1,returnObjectTrees:!0},function(){t()}),RED._=function(){var e=i18n.t.apply(null,arguments);return"string"==typeof e?e:arguments[0]}},loadNodeCatalog:function(o,n){var e=i18n.functions.toLanguages(i18n.detectLanguage()),a=e.length;e.forEach(function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:i+"nodes/"+o+"/messages?lng="+t,success:function(e){i18n.addResourceBundle(t,o,e),0===--a&&n()}})})},loadNodeCatalogs:function(e){var t=i18n.functions.toLanguages(i18n.detectLanguage()),n=t.length;t.forEach(function(o){$.ajax({headers:{Accept:"application/json"},cache:!1,url:i+"nodes/messages?lng="+o,success:function(t){Object.keys(t).forEach(function(e){i18n.addResourceBundle(o,e,t[e])}),0===--n&&e()}})})}}}(),RED.settings=function(){var e,o={},n={},a=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},i=function(n){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(e){!function(e){for(var t in o)o.hasOwnProperty(t)&&RED.settings.hasOwnProperty(t)&&delete RED.settings[t];for(t in e)e.hasOwnProperty(t)&&(RED.settings[t]=e[t]);o=e}(e),RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-RED: "+e.version),t(n)},error:function(e,t,o){401===e.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){i(n)})):console.log("Unexpected error loading settings:",e.status,t)}})};function t(t){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings/user",success:function(e){n=e,t()},error:function(e,t,o){console.log("Unexpected error loading user settings:",e.status,t)}})}function s(){RED.user.hasPermission("settings.write")&&(e&&clearTimeout(e),e=setTimeout(function(){e=null,$.ajax({method:"POST",contentType:"application/json",url:"settings/user",data:JSON.stringify(n),success:function(e){},error:function(e,t,o){console.log("Unexpected error saving user settings:",e.status,t)}})},300))}return{init:function(n,e){var t=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(t){var o=t[1];RED.settings.set("auth-tokens",{access_token:o}),window.location.search=""}RED.settings.apiRootUrl=n.apiRootUrl,$.ajaxSetup({beforeSend:function(e,t){if(!/^\s*(https?:|\/|\.)/.test(t.url)){n.apiRootUrl&&(t.url=n.apiRootUrl+t.url);var o=RED.settings.get("auth-tokens");o&&e.setRequestHeader("Authorization","Bearer "+o.access_token),e.setRequestHeader("Node-RED-API-Version","v2")}}}),i(e)},load:i,loadUserSettings:t,set:function(e,t){a()&&("auth-tokens"===e?localStorage.setItem(e,JSON.stringify(t)):(n[e]=t,s()))},get:function(e){if(a())return"auth-tokens"===e?JSON.parse(localStorage.getItem(e)):n[e]},remove:function(e){a()&&("auth-tokens"===e?localStorage.removeItem(e):(delete n[e],s()))},theme:function(e,t){if(!RED.settings.editorTheme)return t;var o=e.split("."),n=RED.settings.editorTheme;try{for(var a=0;a<o.length;a++)n=n[o[a]];return void 0===n?t:n}catch(e){return t}}}}(),RED.user=function(){function p(){$("#btn-usermenu-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("btn-usermenu",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),p(),RED.events.emit("login",RED.settings.user.username)})})}}):(RED.menu.addItem("btn-usermenu",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("btn-usermenu",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}var a=/^((.+)\.)?read$/,i=/^((.+)\.)?write$/;return{init:function(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu"))){var e=$('<li><a id="btn-usermenu" class="button hide" data-toggle="dropdown" href="#"></a></li>').prependTo(".header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(e.find("a")):$('<i class="fa fa-user"></i>').appendTo(e.find("a")),RED.menu.init({id:"btn-usermenu",options:[]}),p()}},login:function(l,d){"function"==typeof l&&(d=l,l={});var c=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');c.dialog({autoOpen:!1,dialogClass:"ui-dialog-no-close",modal:!0,closeOnEscape:!!l.cancelable,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(a){var e=0;if("credentials"==a.type){for(;e<a.prompts.length;e++){var t=a.prompts[e],o=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+t.id+'">'+RED._(t.label)+":</label><br/>").appendTo(o);var n=$('<input style="width: 100%" id="node-dialog-login-'+t.id+'" type="'+t.type+'" tabIndex="'+(e+1)+'"/>').appendTo(o);e<a.prompts.length-1&&n.keypress(function(){var t=o;return function(e){13==e.keyCode&&(t.next("div").find("input").focus(),e.preventDefault())}}()),o.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(l.cancelable?'<a href="#" id="node-dialog-login-cancel" style="margin-right: 20px;" tabIndex="'+(e+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" style="width: auto;" tabIndex="'+(e+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").submit(function(e){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var t={client_id:"node-red-editor",grant_type:"password",scope:""},o=0;o<a.prompts.length;o++){var n=a.prompts[o];t[n.id]=$("#node-dialog-login-"+n.id).val()}$.ajax({url:"auth/token",type:"POST",data:t}).done(function(e,t,o){RED.settings.set("auth-tokens",e),$("#node-dialog-login").dialog("destroy").remove(),l.updateMenu&&p(),d()}).fail(function(e,t,o){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),e.preventDefault()})}else if("strategy"==a.type)for(e=0;e<a.prompts.length;e++){t=a.prompts[e],o=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields");var i=$('<a href="#"></a>',{style:"padding: 10px"}).appendTo(o).click(function(){document.location=t.url});if(t.image)$("<img>",{src:t.image}).appendTo(i);else if(t.label){var s=$("<span></span>").text(t.label);t.icon&&($("<i></i>",{class:"fa fa-2x "+t.icon,style:"vertical-align: middle"}).appendTo(i),s.css({verticalAlign:"middle",marginLeft:"8px"})),s.appendTo(i)}i.button()}l.cancelable&&$("#node-dialog-login-cancel").button().click(function(e){$("#node-dialog-login").dialog("destroy").remove()});var r=a.image||"red/images/node-red-256.png";$("#node-dialog-login-image").load(function(){c.dialog("open")}).attr("src",r)}})},logout:function(){var e=RED.settings.get("auth-tokens"),t=e?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:t}}).done(function(e,t,o){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)}).fail(function(e,t,o){401===e.status?document.location.reload(!0):console.log(t)})},hasPermission:function(e){return""===e||!RED.settings.user||function e(t,o){if(""===o)return!0;var n;if(Array.isArray(o)){for(n=0;n<o.length;n++)if(!e(t,o[n]))return!1;return!0}if(Array.isArray(t)){if(0===t.length)return!1;for(n=0;n<t.length;n++)if(e(t[n],o))return!0;return!1}return"*"===t||t===o||("read"===t||"*.read"===t?a.test(o):("write"===t||"*.write"===t)&&i.test(o))}(RED.settings.user.permissions||"",e)}}}(),RED.comms=function(){var i,s=null,d=null,c=null,p=10,u={},f=!1,h=0,g=!1;return{connect:function r(){var e;if(g=!0,RED.settings.apiRootUrl){var t=/^(https?):\/\/(.*)$/.exec(RED.settings.apiRootUrl);t&&(console.log(t),e="ws"+("https"===t[1]?"s":"")+"://"+t[2]+"comms")}else{var o=location.hostname,n=location.port;0!==n.length&&(o=o+":"+n),o=(o+=document.location.pathname)+("/"==o.slice(-1)?"":"/")+"comms",e="ws"+("https:"==document.location.protocol?"s":"")+"://"+o}var a=RED.settings.get("auth-tokens");function l(){for(var e in u)u.hasOwnProperty(e)&&i.send(JSON.stringify({subscribe:e}))}f=null!=a,(i=new WebSocket(e)).onopen=function(){h=0,s&&(d=setTimeout(function(){s.close(),s=null},1e3)),f?i.send(JSON.stringify({auth:a.access_token})):l()},i.onmessage=function(e){var t=JSON.parse(e.data);if(t.auth)f&&"ok"===t.auth?(f=!1,l()):"fail"===t.auth&&(g=!1,RED.user.login({updateMenu:!0},function(){r()}));else for(var o=0;o<t.length;o++){var n=t[o];if(n.topic)for(var a in u)if(u.hasOwnProperty(a)&&new RegExp("^"+a.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(n.topic)){var i=u[a];if(i)for(var s=0;s<i.length;s++)i[s](n.topic,n.data)}}},i.onclose=function(){g&&(d&&(clearTimeout(d),d=null),++h<10?(setTimeout(r,1e3),5<h&&null==s&&(s=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):h<20?setTimeout(r,2e3):(p=60,c=setInterval(function(){if(0==--p)s.update(RED._("notification.errors.lostConnection")),clearInterval(c),r();else{var e=RED._("notification.errors.lostConnectionReconnect",{time:p})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>";s.update(e,{silent:!0}),$(s).find("a").click(function(e){e.preventDefault(),s.update(RED._("notification.errors.lostConnection"),{silent:!0}),clearInterval(c),r()})}},1e3)))}},subscribe:function(e,t){null==u[e]&&(u[e]=[]),u[e].push(t),i&&1==i.readyState&&i.send(JSON.stringify({subscribe:e}))},unsubscribe:function(e,t){if(u[e]){for(var o=0;o<u[e].length;o++)if(u[e][o]===t){u[e].splice(o,1);break}0===u[e].length&&delete u[e]}}}}(),RED.text={},RED.text.bidi=function(){var t="";function o(e){return"auto"==t?function(e){for(var t,o,n=e.length,a=0;a<n;a++){if(1488<=(o=e.charCodeAt(a))&&o<=1535||1536<=o&&o<=1631||1642<=o&&o<=1775||1786<=o&&o<=2047||64285<=o&&o<=65023||65136<=o&&o<=65276)return!0;if(64<(t=e.charCodeAt(a))&&t<91||96<t&&t<123)return!1}return!1}(e)?"rtl":"ltr":t}function n(){$(this).attr("dir",o($(this).val()))}return{setTextDirection:function(e){t=e,RED.nodes.eachNode(function(e){e.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),$("#workspace").find("span.bidiAware").each(function(){$(this).attr("dir",o($(this).html()))}),$("#sidebar").find("span.bidiAware").each(function(){$(this).attr("dir",o($(this).text()))})},enforceTextDirectionWithUCC:function(e){if(e){var t=o(e);if("ltr"==t)return"‪"+e+"‬";if("rtl"==t)return"‫"+e+"‬"}return e},resolveBaseTextDir:o,prepareInput:function(e){e.on("keyup",n).on("paste",n).on("cut",n),n.call(e)}}}(),RED.text.format=function(){var f=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},l=function(){function p(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var o=parseInt(e.length,10);return isNaN(o)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function u(e,t){var o={};for(var n in t)t.hasOwnProperty(n)&&(o[n]=t[n]);var a=e.content,i=o.usePos&&o.startPos<a.length;i&&(o.start="",o.loops=!1),o.bStart=i?o.startPos:0<o.start.length?a.indexOf(o.start):0;var s=o.useLength&&0<o.length&&o.bStart+o.length<a.length;return s&&(o.end=""),o.bEnd=s?o.bStart+o.length:0<o.end.length?a.indexOf(o.end,o.bStart+o.start.length)+1:a.length,o.after||(o.start=""),o.before||(o.end=""),o}return{handleSubcontents:function(e,t,o,n,a){if(!o.content||"string"!=typeof o.content||0===o.content.length)return e;var i=!0;void 0!==o.loops&&(i=!!o.loops);for(var s=0;!(s>=e.length);s++)if(!(e[s].isParsed||e.keep||e[s].isSeparator)){var r=e[s].content,l=r.indexOf(o.content);if(!(l<0)){var d,c=0;if(o.continued)for(;c++,0===(d=r.indexOf(o.content,l+c*o.content.length)););else c=1;if(d=l+c*o.content.length,e.splice(s,1),0<l&&(e.splice(s,0,new f({content:r.substring(0,l),localGui:t.dir,keep:!0})),s++),e.splice(s,0,new f({content:r.substring(l,d),textDirection:o.subDir,localGui:t.dir})),d<r.length&&e.splice(s+1,0,new f({content:r.substring(d,r.length),localGui:t.dir,keep:!0})),!i)break}}},handleBounds:function(e,t,o,n,a){for(var i=0;i<o.length;i++)if(p(o[i]))for(var s=0;!(s>=e.length);s++)if(!(e[s].isParsed||e[s].inBounds||e.keep||e[s].isSeparator)){var r=u(e[s],o[i]),l=r.bStart,d=r.bEnd;if(!(l<0||d<0)){var c=e[s].content;if(e.splice(s,1),0<l&&(e.splice(s,0,new f({content:c.substring(0,l),localGui:t.dir,keep:!0})),s++),r.start&&(e.splice(s,0,new f({content:r.start,localGui:t.dir,isSeparator:!0})),s++),e.splice(s,0,new f({content:c.substring(l+r.start.length,d-r.end.length),textDirection:r.subDir,localGui:t.dir,inBounds:!0})),r.end&&(s++,e.splice(s,0,new f({content:r.end,localGui:t.dir,isSeparator:!0}))),d+r.end.length<c.length&&e.splice(s+1,0,new f({content:c.substring(d+r.end.length,c.length),localGui:t.dir,keep:!0})),!r.loops)break}}for(i=0;i<e.length;i++)e[i].inBounds=!1;return e},handleCases:function(e,t,o,n,a){if(0===o.length)return e;var i={};for(var s in t)t.hasOwnProperty(s)&&(i[s]=t[s]);for(var r=0;r<o.length;r++)o[r].handler&&"function"==typeof o[r].handler.handle||(o[r].handler=t.commonHandler),o[r].args?(i.cases=o[r].args.cases,i.points=o[r].args.points,i.bounds=o[r].args.bounds,i.subs=o[r].args.subs):(i.cases=[],i.points=[],i.bounds=[],i.subs={}),o[r].handler.handle(n,e,i,a);return e},handlePoints:function(e,t,o,n,a){for(var i=0;i<o.length;i++)for(var s=0;!(s>=e.length);s++)if(!(e[s].isParsed||e[s].keep||e[s].isSeparator)){var r=e[s].content,l=r.indexOf(o[i]);0<=l&&(e.splice(s,1),0<l&&(e.splice(s,0,new f({content:r.substring(0,l),textDirection:t.subDir,localGui:t.dir,inPoints:!0})),s++),e.splice(s,0,new f({content:o[i],localGui:t.dir,isSeparator:!0})),l+o[i].length+1<=r.length&&e.splice(s+1,0,new f({content:r.substring(l+o[i].length),textDirection:t.subDir,localGui:t.dir,inPoints:!0})))}for(i=0;i<e.length;i++)e[i].keep?e[i].keep=!1:e[i].inPoints&&(e[i].isParsed=!0,e[i].inPoints=!1);return e}}}(),r={handle:function(e,t,o,n){var a=[];Array.isArray(o.cases)&&(a=o.cases);var i=[];void 0!==o.points&&(Array.isArray(o.points)?i=o.points:"string"==typeof o.points&&(i=o.points.split("")));var s={};"object"==typeof o.subs&&(s=o.subs);var r=[];return Array.isArray(o.bounds)&&(r=o.bounds),l.handleBounds(t,o,r,e,n),l.handleSubcontents(t,o,s,e,n),l.handleCases(t,o,a,e,n),l.handlePoints(t,o,i,e,n),t}},p={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){if(e||(e="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),e=e.toLowerCase(),!(o=(t=e)?t.split("-")[0]:"")||o.length<2||!["iw","he","ar","fa","ur"].some(function(e){return e===o}))return{lang:"not-bidi"};var t,o,n=e.split("-");return{lang:n[0],country:n[1]?n[1]:""}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,o,n){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;o=/^(rtl|ltr)$/i.test(o)?o:"ltr";var a=n?e.split("").reverse().join(""):e,i=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(a);return i?i[0]<="z"?"ltr":"rtl":o},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var o="",n=0;n<e.length;n++){var a=""+e.charAt(n);switch(a){case"‎":o+="<LRM>";break;case"‏":o+="<RLM>";break;case"‪":o+="<LRE>";break;case"‫":o+="<RLE>";break;case"‭":o+="<LRO>";break;case"‮":o+="<RLO>";break;case"‬":o+="<PDF>";break;default:o+=a}}var i=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return i+o+(""===i?"":"‬")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},d=function(){var e={};function s(e,t){var o=Array.isArray(e)?e[0]:e;return o.guiDir||(o.guiDir="ltr"),o.dir||(o.dir=o.guiDir),t&&(void 0===o.points&&(o.points=[]),o.cases||(o.cases=[]),o.bounds||(o.bounds=[]),o.commonHandler=r),o}function a(e,t,o){if(!e||!t)return new f({content:""});var n=s(t,!0),a=[new f({content:e,actual:e,localGui:n.dir})],i=r.handle;return n.handler&&"function"==typeof n.handler&&(i=n.handler.handle),i(e,a,n,o),a}function i(e,t,o){var n=s(t,!1);return o?function(e,t,o){for(var n="",a="",i=0;i<e.length;i++)if(e[i].isVisible){var s=e[i].textDirection,r=e[i].localGui;if(""!==r&&""===a?n+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>":""===a||""!==r&&r===a&&!stop||(n+="</bdi>"+(i==e.length-1&&""!==r?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==r&&(n+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>")),"auto"===s&&(s=p.getDirection(e[i].content,s,t.guiDir)),/^(rtl|ltr)$/i.test(s)?(n+="<bdi dir='"+("rtl"===s?"rtl":"ltr")+"'>"+e[i].content+"</bdi>",s):(n+=e[i].content,p.getDirection(e[i].content,s,t.guiDir,!0)),i<e.length-1){var l=r&&e[i+1].localGui?r:t.dir;n+="<span style='unicode-bidi: embed; direction: "+("rtl"===l?"rtl":"ltr")+";'></span>"}else""!==a&&(n+="</bdi>");a=r,stop=!1}else stop=!0;var d="auto"===t.dir?p.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;d!==t.guiDir&&(n="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>"+n+"</bdi>");return n}(e,n):function(e,t,o){for(var n="",a="",i=!1,s=0;s<e.length;s++)if(e[s].isVisible){var r=e[s].textDirection,l=e[s].localGui;if(""!==l&&""===a?n+="rtl"===l?p.RLE:p.LRE:""===a||""!==l&&l===a&&!i||(n+=p.PDF+(s==e.length-1&&""!==l?"":"rtl"===t.dir?p.RLM:p.LRM),""!==l&&(n+="rtl"===l?p.RLE:p.LRE)),"auto"===r&&(r=p.getDirection(e[s].content,r,t.guiDir)),/^(rtl|ltr)$/i.test(r)?(n+=("rtl"===r?p.RLE:p.LRE)+e[s].content+p.PDF,r):(n+=e[s].content,p.getDirection(e[s].content,r,t.guiDir,!0)),s<e.length-1){var d=l&&e[s+1].localGui?l:t.dir;n+="rtl"===d?p.RLM:p.LRM}else""!==a&&(n+=p.PDF);a=l,i=!1}else i=!0;var c="auto"===t.dir?p.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;c!==t.guiDir&&(n=("rtl"===c?p.RLE:p.LRE)+n+p.PDF);return n}(e,n)}return e.parseAndDisplayStructure=function(e,t,o,n){return e&&t?i(a(e,t,n),t,o):e},e.parseStructure=a,e.displayStructure=i,e.restore=function(e,t){return e},e}(),t={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:t.dir?t.dir:o?"rtl":"ltr",subs:{content:">",continued:!0,subDir:o?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:o?"ltr":"rtl"}}}]};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},o={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:","};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},n={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:function(e,t){if("ar"!==p.getLocaleDetails(t).lang)return"ltr";var o=e.indexOf("@");return 0<o&&o<e.length-1&&p.hasArabicChar(e.substring(o+1))?"rtl":"ltr"}(e,a),points:"<>.:,;@",cases:[{handler:r,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},a={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:"/\\:."};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},i={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},s={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:r,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:r,args:{subs:{content:" ",continued:!0}}},{handler:r,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},c={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:"_"};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},u={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},h={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:t.dir?t.dir:o?"rtl":"ltr",points:" ,.!?;:"};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},g={format:function(e,t,o,n,a,i){var s={guiDir:o?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:r,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},v={format:function(e,t,o,n,a,i){var s={},r="",l=Array.isArray(t)?t[0]:t;for(r in l)l.hasOwnProperty(r)&&(s[r]=l[r]);return s.guiDir=o?"rtl":"ltr",s.dir=s.dir?s.dir:s.guiDir,i?d.parseStructure(e,s,!!n,a):d.parseAndDisplayStructure(e,s,!!n,a)}},b=(function(){var e={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},t=!1;function o(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function n(e){0===e.msgDir.length&&(e.msgDir=o(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:o(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}}(),null);function m(e){switch(e){case"breadcrumb":return t;case"comma":return o;case"email":return n;case"filepath":return a;case"formula":return i;case"sql":return s;case"underscore":return c;case"url":return u;case"word":return h;case"xpath":return g;default:return v}}function y(t,e,o,n,a){if(!t||1!=t.nodeType)return!1;b||(b=document.createEvent("Event")).initEvent("TF",!0,!0),t.setAttribute("data-tf-type",e);var i="undefined"===o?"{}":JSON.stringify(Array.isArray(o)?o[0]:o);t.setAttribute("data-tf-args",i);var s="ltr";if("undefined"===n&&(t.dir?s=t.dir:t.style&&t.style.direction&&(s=t.style.direction),n="rtl"===s.toLowerCase()),t.setAttribute("data-tf-dir",n),t.setAttribute("data-tf-locale",p.getLocaleDetails(a).lang),function(e){var t=window.navigator.userAgent;if(0<=t.indexOf("MSIE")||0<=t.indexOf("Trident")||0<=t.indexOf("Edge"))return!1;var o=document.createElement(e.tagName);o.contentEditable=!0;var n="oninput"in o;return n||(o.setAttribute("oninput","return;"),n="function"==typeof o.oninput),o=null,n}(t)){t.oninput;t.oninput=function(e){w(e.target)}}else t.onkeyup=function(e){w(e.target),t.dispatchEvent(b)},t.onmouseup=function(e){w(e.target),t.dispatchEvent(b)};return w(t),!0}function w(e){var t=e.textContent||"",o=document.getSelection();if(0===t.length||!o||o.rangeCount<=0)e.dispatchEvent(b);else{var n,a,i=o.getRangeAt(0),s=i.cloneRange();n=i.startContainer,a=i.startOffset;var r=0;3===n.nodeType&&(r+=a),s.setStart(e,0),s.setEndBefore(n);var l=document.createElement("div");l.appendChild(s.cloneContents()),r+=l.textContent.length,e.innerHTML=m(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale"));var d=e,c=e,p=0,u=!1;for(o.removeAllRanges(),i.setStart(e,0),i.setEnd(e,0);c;){if(3===c.nodeType){if(p+c.nodeValue.length>=r){i.setStart(c,r-p);break}p+=c.nodeValue.length,c=c.nextSibling}else{if(c.hasChildNodes()){c=(d=c).firstChild;continue}c=c.nextSibling}for(;!c;){if(d===e){u=!0;break}c=d.nextSibling,d=d.parentNode}if(u)break}o.addRange(i),e.dispatchEvent(b)}}return{getHtml:function(e,t,o,n,a){return m(t).format(e,o,n,!0,a)},attach:function(e,t,o,n,a){return y(e,t,o,n,a)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9,PANNING:10},RED.nodes=function(){var W,K,p=[],H={},u=[],Y={},s=[],r={},t=null,o=!1;var X=function(){var a={},i=[],s={},r={},o={},t={};o.tab={defaults:{label:{value:""},disabled:{value:!1},info:{value:""}}};var n={setModulePendingUpdated:function(e,t){a[e].pending_version=t,RED.events.emit("registry:module-updated",{module:e,version:t})},getModule:function(e){return a[e]},getNodeSetForType:function(e){return n.getNodeSet(r[e])},getModuleList:function(){return a},getNodeList:function(){return i},getNodeTypes:function(){return Object.keys(o)},setNodeList:function(e){i=[];for(var t=0;t<e.length;t++){var o=e[t];n.addNodeSet(o)}},addNodeSet:function(e){e.added=!1,s[e.id]=e;for(var t=0;t<e.types.length;t++)r[e.types[t]]=e.id;i.push(e),a[e.module]=a[e.module]||{name:e.module,version:e.version,local:e.local,sets:{}},e.pending_version&&(a[e.module].pending_version=e.pending_version),a[e.module].sets[e.name]=e,RED.events.emit("registry:node-set-added",e)},removeNodeSet:function(e){for(var t=s[e],o=0;o<t.types.length;o++)delete r[t.types[o]];delete s[e];for(var n=0;n<i.length;n++)if(i[n].id===e){i.splice(n,1);break}return delete a[t.module].sets[t.name],0===Object.keys(a[t.module].sets).length&&delete a[t.module],RED.events.emit("registry:node-set-removed",t),t},getNodeSet:function(e){return s[e]},enableNodeSet:function(e){var t=s[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=s[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){var n;"subflow:"!=((o[e]=t).type=e).substring(0,8)&&(t.set=s[r[e]],s[r[e]].added=!0,s[r[e]].enabled=!0,n="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0];-1===e[0].indexOf(":")&&(e[0]=n+":"+e[0]);var o=RED._.apply(null,e);return o===e[0]&&(o=t),o});RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete o[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return o[e]},setIconSets:function(e){(t=e)["font-awesome"]=RED.nodes.fontAwesome.getIconList()},getIconSets:function(){return t}};return n}();function Q(){return(1+4294967295*Math.random()).toString(16)}function Z(e){if(0!==e.type.indexOf("subflow")?e._=e._def._:e._=RED._,"config"==e._def.category)H[e.id]=e;else{if(e.ports=[],e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.outputs)for(var t=0;t<e.outputs;t++)e.ports.push(t);if(e.dirty=!0,a(e),"subflows"==e._def.category&&void 0===e.i){var o=0;RED.nodes.eachNode(function(e){o=Math.max(o,e.i||0)}),e.i=o+1}p.push(e)}RED.events.emit("nodes:add",e)}function ee(e){u.push(e)}function f(e){if(e in H)return H[e];for(var t in p)if(p[t].id==e)return p[t];return null}function h(e){var t,o=[],a=[];if(e in H)t=H[e],delete H[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(t=f(e)){p.splice(p.indexOf(t),1),(o=u.filter(function(e){return e.source===t||e.target===t})).forEach(function(e){u.splice(u.indexOf(e),1)});var i=!1;for(var s in t._def.defaults)if(t._def.defaults.hasOwnProperty(s)){var r=t._def.defaults[s];if(r.type){var l=X.getNodeType(r.type);if(l&&"config"==l.category){var d=H[t[s]];if(d)if(i=!0,d._def.exclusive)h(t[s]),a.push(d);else{var c=d.users;c.splice(c.indexOf(t),1)}}}}i&&RED.workspaces.refresh();try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&(console.log("Deprecated API warning: node type ",t.type," has an onremove function - should be oneditremove - please report"),t._def.onremove.call(n)),{links:o,nodes:a}}function l(e){var t=u.indexOf(e);-1!=t&&u.splice(t,1)}function te(e,t){(Y[e.id]=e)._def=RED.nodes.getType("tab"),void 0===t?s.push(e.id):s.splice(t,0,e.id)}function oe(t,e){if(e){var o=Object.keys(r).map(function(e){return r[e].name});o.sort();var n=1,a=t.name;o.forEach(function(e){a==e&&(n++,a=t.name+" ("+n+")")}),t.name=a}r[t.id]=t,RED.nodes.registerType("subflow:"+t.id,{defaults:{name:{value:""},env:{value:[]}},icon:function(){return t.icon||"subflow.png"},category:t.category||"subflows",inputs:t.in.length,outputs:t.out.length,color:"#da9",label:function(){return this.name||RED.nodes.subflow(t.id).name},labelStyle:function(){return this.name?"node_label_italic":""},paletteLabel:function(){return RED.nodes.subflow(t.id).name},inputLabels:function(e){return t.inputLabels?t.inputLabels[e]:null},outputLabels:function(e){return t.outputLabels?t.outputLabels[e]:null},oneditresize:function(e){for(var t=$("#dialog-form>div:not(.node-input-env-container-row)"),o=e.height,n=0;n<t.size();n++)o-=$(t[n]).outerHeight(!0);var a=$("#dialog-form>div.node-input-env-container-row");o-=parseInt(a.css("marginTop"))+parseInt(a.css("marginBottom")),$("#node-input-env-container").editableList("height",o-80)},set:{module:"node-red"}}),t._def=RED.nodes.getType("subflow:"+t.id)}function ne(e){return r[e]}function ae(e,t){for(var o=0;o<p.length;o++){var n=p[o];if(n.z===e){var a=/^subflow:(.+)$/.exec(n.type);if(a){if(a[1]===t)return!0;if(ae(a[1],t))return!0}}}return!1}function g(e){var t={};for(var o in t.id=e.id,t.type=e.type,e._def.defaults)e._def.defaults.hasOwnProperty(o)&&(t[o]=e[o]);return t}function d(t,e){if("tab"===t.type)return g(t);e=e||!1;var o={};if(o.id=t.id,o.type=t.type,o.z=t.z,"unknown"==o.type)for(var n in t._orig)t._orig.hasOwnProperty(n)&&(o[n]=t._orig[n]);else{for(var a in t._def.defaults)t._def.defaults.hasOwnProperty(a)&&(o[a]=t[a]);if(e&&t.credentials){var i={};for(var s in o.credentials={},t._def.credentials)t._def.credentials.hasOwnProperty(s)&&("password"==t._def.credentials[s].type?(!t.credentials._||t.credentials["has_"+s]!=t.credentials._["has_"+s]||t.credentials["has_"+s]&&t.credentials[s])&&(i[s]=t.credentials[s]):null==t.credentials[s]||t.credentials._&&t.credentials[s]==t.credentials._[s]||(i[s]=t.credentials[s]));0<Object.keys(i).length&&(o.credentials=i)}}if("config"!=t._def.category){o.x=t.x,o.y=t.y,o.wires=[];for(var r=0;r<t.outputs;r++)o.wires.push([]);for(var l=u.filter(function(e){return e.source===t}),d=0;d<l.length;d++){var c=l[d];"subflow"!=c.target.type&&c.sourcePort<o.wires.length&&o.wires[c.sourcePort].push(c.target.id)}if(0<t.inputs&&t.inputLabels&&!/^\s*$/.test(t.inputLabels.join(""))&&(o.inputLabels=t.inputLabels.slice()),0<t.outputs&&t.outputLabels&&!/^\s*$/.test(t.outputLabels.join(""))&&(o.outputLabels=t.outputLabels.slice()),(!t._def.defaults||!t._def.defaults.hasOwnProperty("icon"))&&t.icon){var p=RED.utils.getDefaultNodeIcon(t._def,t);t.icon!==p.module+"/"+p.file&&(o.icon=t.icon)}if((!t._def.defaults||!t._def.defaults.hasOwnProperty("l"))&&t.hasOwnProperty("l"))/^link (in|out)$/.test(o.type)==t.l&&(o.l=t.l)}return t.info&&(o.info=t.info),o}function v(a){var s={};return s.id=a.id,s.type=a.type,s.name=a.name,s.info=a.info,s.category=a.category,s.in=[],s.out=[],s.env=a.env,a.in.forEach(function(t){for(var e={x:t.x,y:t.y,wires:[]},o=u.filter(function(e){return e.source===t}),n=0;n<o.length;n++){var a=o[n];"subflow"!=a.target.type&&e.wires.push({id:a.target.id})}s.in.push(e)}),a.out.forEach(function(t,e){var o={x:t.x,y:t.y,wires:[]},n=u.filter(function(e){return e.target===t});for(i=0;i<n.length;i++)"subflow"!=n[i].source.type?o.wires.push({id:n[i].source.id,port:n[i].sourcePort}):o.wires.push({id:a.id,port:0});s.out.push(o)}),0<s.in.length&&a.inputLabels&&!/^\s*$/.test(a.inputLabels.join(""))&&(s.inputLabels=a.inputLabels.slice()),0<s.out.length&&a.outputLabels&&!/^\s*$/.test(a.outputLabels.join(""))&&(s.outputLabels=a.outputLabels.slice()),a.icon&&"node-red/subflow.png"!==a.icon&&(s.icon=a.icon),a.status&&(s.status={x:a.status.x,y:a.status.y,wires:[]},u.forEach(function(e){e.target===a.status&&("subflow"!=e.source.type?s.status.wires.push({id:e.source.id,port:e.sourcePort}):s.status.wires.push({id:a.id,port:0}))})),s}function b(e,t,o){var n=[];o=o||{},t=t||{};for(var a=0;a<e.length;a++){var i=e[a];if("subflow:"==i.type.substring(0,8)){var s=i.type.substring(8);if(!t[s]){t[s]=!0;var r=[ne(s)];RED.nodes.eachNode(function(e){e.z==s&&r.push(e)}),n=b(r,t,o).concat(n)}}if("subflow"!=i.type){var l=RED.nodes.convertNode(i);for(var d in i._def.defaults)if(i._def.defaults[d].type&&i[d]in H){var c=H[i[d]],p=X.getNodeType(i._def.defaults[d].type).exportable;null==p||p?i[d]in o||(o[i[d]]=!0,e.push(c)):l[d]=""}n.push(l)}else{var u=v(i);n.push(u)}}return n}function ie(s,r){var l;r=r||[];var d=null;return RED.nodes.eachSubflow(function(e){if(e.name==s.name&&e.info==s.info&&e.in.length==s.in.length&&e.out.length==s.out.length){var t=RED.nodes.filterNodes({z:e.id});if(t.length==r.length){var o=[s].concat(r),n=[e].concat(t),a=JSON.stringify(o),i=JSON.stringify(b(n));for(l=0;l<t.length;l++)a=a.replace(new RegExp('"'+r[l].id+'"',"g"),'"'+t[l].id+'"');if((a=a.replace(new RegExp('"'+s.id+'"',"g"),'"'+e.id+'"'))===i)return d=e,!1}}}),d}function se(e,t,o){if(o&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var n=e._def;for(var a in n.defaults)if(n.defaults.hasOwnProperty(a)){var i=e[a],s=t[a];if(typeof i!=typeof s)return!1;if(null===i||"string"==typeof i||"number"==typeof i){if(i!==s)return!1}else if(JSON.stringify(i)!==JSON.stringify(s))return!1}return!0}function c(e,t,o){var n,a,i,s={};if("string"==typeof e){if(""===e)return;try{i=JSON.parse(e)}catch(g){var r=new Error(RED._("clipboard.invalidFlow",{message:g.message}));throw r.code="NODE_RED",r}}else i=e;$.isArray(i)||(i=[i]);var l={};i=i.filter(function(e){return!l[e.id]&&(l[e.id]=!0)});var d=!1;K||(d=!0,K=JSON.parse(JSON.stringify(i)));var c=[];for(n=0;n<i.length;n++)"workspace"==(a=i[n]).type||"tab"==a.type||"subflow"==a.type||X.getNodeType(a.type)||"subflow:"==a.type.substring(0,8)||-1!=c.indexOf(a.type)||c.push(a.type),a.z&&(s[a.z]=s[a.z]||[],s[a.z].push(a));if(!d&&0<c.length){var p="<ul><li>"+c.join("</li><li>")+"</li></ul>";RED.notify("<p>"+RED._("clipboard.importUnrecognised",{count:c.length})+"</p>"+p,"error",!1,1e4)}var u=RED.workspaces.active(),f=ne(u);for(n=0;n<i.length;n++){var h=/^subflow:(.+)$/.exec(i[n].type);if(h){var g,v=h[1],b=ne(i[n].z||u);if(b)if(v===b.id&&(g=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),ae(v,b.id)&&(g=new Error(RED._("notification.errors.cannotAddCircularReference"))),g)throw g.code="NODE_RED",g}}var m,y,w,D,E=[],R={},x=[],k={},T={},_={},j=[],C=[],S=null;for(n=0;n<i.length;n++)if("workspace"===(a=i[n]).type||"tab"===a.type)"workspace"===a.type&&(a.type="tab"),null==W&&(W=a),t&&(m=Q(),R[a.id]=m,a.id=m),te(a),RED.workspaces.add(a),E.push(a);else if("subflow"===a.type){var O=ie(a,s[a.id]);O?T[a.id]=O:(k[a.id]=a,t&&(m=Q(),a.id=m),a.in.forEach(function(e,t){e.type="subflow",e.direction="in",e.z=a.id,e.i=t,e.id=Q()}),a.out.forEach(function(e,t){e.type="subflow",e.direction="out",e.z=a.id,e.i=t,e.id=Q()}),a.status&&(a.status.type="subflow",a.status.direction="status",a.status.z=a.id,a.status.id=Q()),x.push(a),oe(a,t))}for(null==W&&(te(W={type:"tab",id:Q(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1})}),RED.workspaces.add(W),E.push(W),u=RED.workspaces.active()),n=0;n<i.length;n++)if(a=i[n],(y=X.getNodeType(a.type))&&"config"==y.category){var L=null;if(t){if(a.z){if(T[a.z])continue;k[a.z]?a.z=k[a.z].id:(a.z=R[a.z],Y[a.z]||(o?(null===S&&(S=RED.workspaces.add(null,!0),E.push(S)),a.z=S.id):a.z=u))}if((L=RED.nodes.node(a.id))&&a.z&&L.z!==a.z)for(var P in L=null,H)if(H.hasOwnProperty(P)&&H[P].z===a.z&&se(H[P],a,!1)){L=H[P],_[a.id]=H[P];break}}if(!L||L._def.exclusive){for(D in w={id:a.id,z:a.z,type:a.type,info:a.info,users:[],_config:{}},y.defaults)y.defaults.hasOwnProperty(D)&&(w[D]=a[D],w._config[D]=JSON.stringify(a[D]));if(y.hasOwnProperty("credentials")&&a.hasOwnProperty("credentials"))for(D in w.credentials={},y.credentials)y.credentials.hasOwnProperty(D)&&a.credentials.hasOwnProperty(D)&&(w.credentials[D]=a.credentials[D]);w.label=y.label,w._def=y,t&&(w.id=Q()),_[a.id]=w,j.push(w),RED.nodes.add(w)}}for(n=0;n<i.length;n++)if("workspace"!==(a=i[n]).type&&"tab"!==a.type&&"subflow"!==a.type&&(!(y=X.getNodeType(a.type))||"config"!=y.category)){var I={x:parseFloat(a.x||0),y:parseFloat(a.y||0),z:a.z,type:0,wires:a.wires||[],inputLabels:a.inputLabels,outputLabels:a.outputLabels,icon:a.icon,info:a.info,changed:!1,_config:{}};if(a.hasOwnProperty("l")&&(I.l=a.l),t){if(T[a.z])continue;k[I.z]?I.z=k[I.z].id:(I.z=R[I.z],Y[I.z]||(o?(null===S&&(S=RED.workspaces.add(null,!0),E.push(S)),I.z=S.id):I.z=u)),I.id=Q()}else I.id=a.id,null!=I.z&&(Y[I.z]||k[I.z])||(o?(null===S&&(S=RED.workspaces.add(null,!0),E.push(S)),I.z=S.id):I.z=u);if(I.type=a.type,I._def=y,"subflow"===a.type.substring(0,7)){var N=a.type.split(":")[1],z=T[N]||k[N]||ne(N);t&&(N=z.id,I.type="subflow:"+N,I._def=X.getNodeType(I.type),delete I.i),I.name=a.name,I.outputs=z.out.length,I.inputs=z.in.length,I.env=a.env}else{if(!I._def){I.x&&I.y?I._def={color:"#fee",defaults:{},label:"unknown: "+a.type,labelStyle:"node_label_italic",outputs:a.outputs||a.wires.length,set:X.getNodeSet("node-red/unknown")}:(I._def={category:"config",set:X.getNodeSet("node-red/unknown")},I.users=[],delete I.x,delete I.y,delete I.wires,delete I.inputLabels,delete I.outputLabels);var A={};for(var M in a)a.hasOwnProperty(M)&&"x"!=M&&"y"!=M&&"z"!=M&&"id"!=M&&"wires"!=M&&(A[M]=a[M]);I._orig=A,I.name=a.type,I.type="unknown"}if("config"!=I._def.category){for(D in a.hasOwnProperty("inputs")?(I.inputs=a.inputs,I._config.inputs=JSON.stringify(a.inputs)):I.inputs=I._def.inputs,a.hasOwnProperty("outputs")?(I.outputs=a.outputs,I._config.outputs=JSON.stringify(a.outputs)):I.outputs=I._def.outputs,I.hasOwnProperty("wires")&&I.wires.length>I.outputs&&(I._def.defaults.hasOwnProperty("outputs")&&isNaN(parseInt(a.outputs))?I.outputs=I.wires.length:(console.log("Warning: node.wires longer than node.outputs - trimming wires:",I.id," wires:",I.wires.length," outputs:",I.outputs),I.wires=I.wires.slice(0,I.outputs))),I._def.defaults)I._def.defaults.hasOwnProperty(D)&&"inputs"!==D&&"outputs"!==D&&(I[D]=a[D],I._config[D]=JSON.stringify(a[D]));if(I._config.x=I.x,I._config.y=I.y,I._def.hasOwnProperty("credentials")&&a.hasOwnProperty("credentials"))for(D in I.credentials={},I._def.credentials)I._def.credentials.hasOwnProperty(D)&&a.credentials.hasOwnProperty(D)&&(I.credentials[D]=a.credentials[D])}}Z(I),RED.editor.validateNode(I),"unknown"!==(_[a.id]=I).type&&"config"===I._def.category||j.push(I)}var B={catch:"scope",status:"scope","link in":"links","link out":"links"};for(n=0;n<j.length;n++){if((a=j[n]).wires){for(var q=0;q<a.wires.length;q++)for(var U=a.wires[q]instanceof Array?a.wires[q]:[a.wires[q]],J=0;J<U.length;J++)if(_.hasOwnProperty(U[J]))if(a.z===_[U[J]].z){var F={source:a,sourcePort:q,target:_[U[J]]};ee(F),C.push(F)}else console.log("Warning: dropping link that crosses tabs:",a.id,"->",_[U[J]].id);delete a.wires}for(var V in a._def.defaults)if(a._def.defaults.hasOwnProperty(V))if(a._def.defaults[V].type&&_[a[V]])a[V]=_[a[V]].id,(w=RED.nodes.node(a[V]))&&-1===w.users.indexOf(a)&&w.users.push(a);else if(B.hasOwnProperty(a.type)&&B[a.type]===V&&void 0!==a[V]&&null!==a[V])for(var G=0;G<a[V].length;G++)_[a[V][G]]&&(a[V][G]=_[a[V][G]].id);f&&/^link /.test(a.type)&&a.links&&(a.links=a.links.filter(function(e){var t=RED.nodes.node(e);return t&&t.z===u})),RED.editor.validateNode(a)}for(n=0;n<x.length;n++)(a=x[n]).in.forEach(function(o){o.wires.forEach(function(e){var t={source:o,sourcePort:0,target:_[e.id]};ee(t),C.push(t)}),delete o.wires}),a.out.forEach(function(o){o.wires.forEach(function(e){var t;ee(t=k[e.id]&&k[e.id].id==a.id?{source:a.in[e.port],sourcePort:e.port,target:o}:{source:_[e.id]||k[e.id],sourcePort:e.port,target:o}),C.push(t)}),delete o.wires}),a.status&&(a.status.wires.forEach(function(e){var t;ee(t=k[e.id]&&k[e.id].id==a.id?{source:a.in[e.port],sourcePort:e.port,target:a.status}:{source:_[e.id]||k[e.id],sourcePort:e.port,target:a.status}),C.push(t)}),delete a.status.wires);return RED.workspaces.refresh(),[j,C,E,x,S]}function a(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var o=e._def.defaults[t];if(o.type){var n=X.getNodeType(o.type);if(n&&"config"==n.category){var a=H[e[t]];a&&-1===a.users.indexOf(e)&&a.users.push(e)}}}}return{init:function(){RED.events.on("registry:node-type-added",function(t){X.getNodeType(t);var o={};RED.nodes.eachNode(function(e){"unknown"===e.type&&e.name===t&&(o[e.id]=e)}),RED.nodes.eachConfig(function(e){"unknown"===e.type&&e.name===t&&(o[e.id]=e)});var e=Object.keys(o);if(0<e.length){var n=[];e.forEach(function(e){var t=o[e];H.hasOwnProperty(t.id)?delete H[t.id]:p.splice(p.indexOf(t),1),n.push(d(t))});var a=[];RED.nodes.eachLink(function(e){o.hasOwnProperty(e.source.id)&&o.hasOwnProperty(e.target.id)&&a.push(e)}),a.forEach(l),RED.view.redraw(!0);var i=c(n,!1),s={};i[0].forEach(function(e){s[e.id]=e}),RED.nodes.eachLink(function(e){s.hasOwnProperty(e.source.id)&&(e.source=s[e.source.id]),s.hasOwnProperty(e.target.id)&&(e.target=s[e.target.id])}),RED.view.redraw(!0)}})},registry:X,setNodeList:X.setNodeList,getNodeSet:X.getNodeSet,addNodeSet:X.addNodeSet,removeNodeSet:X.removeNodeSet,enableNodeSet:X.enableNodeSet,disableNodeSet:X.disableNodeSet,setIconSets:X.setIconSets,getIconSets:X.getIconSets,registerType:X.registerNodeType,getType:X.getNodeType,convertNode:d,add:Z,remove:h,clear:function(){p=[],u=[],H={},s=[],Object.keys(r).forEach(function(e){RED.subflow.removeSubflow(e)}),Object.keys(Y).forEach(function(e){RED.workspaces.remove(Y[e])}),K=W=null,RED.nodes.dirty(!1),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.sidebar.info.refresh()},addLink:ee,removeLink:l,addWorkspace:te,removeWorkspace:function(e){delete Y[e],s.splice(s.indexOf(e),1);var t,o,n=[],a=[];for(t=0;t<p.length;t++)(o=p[t]).z==e&&n.push(o);for(t in H)H.hasOwnProperty(t)&&(o=H[t]).z==e&&n.push(o);for(t=0;t<n.length;t++){var i=h(n[t].id);a=a.concat(i.links)}return{nodes:n,links:a}},getWorkspaceOrder:function(){return s},setWorkspaceOrder:function(e){s=e},workspace:function(e){return Y[e]},addSubflow:oe,removeSubflow:function(e){delete r[e.id],X.removeNodeType("subflow:"+e.id)},subflow:ne,subflowContains:ae,eachNode:function(e){for(var t=0;t<p.length&&!1!==e(p[t]);t++);},eachLink:function(e){for(var t=0;t<u.length&&!1!==e(u[t]);t++);},eachConfig:function(e){for(var t in H)if(H.hasOwnProperty(t)&&!1===e(H[t]))break},eachSubflow:function(e){for(var t in r)if(r.hasOwnProperty(t)&&!1===e(r[t]))break},eachWorkspace:function(e){for(var t=0;t<s.length&&!1!==e(Y[s[t]]);t++);},node:f,version:function(e){if(void 0===e)return t;t=e},originalFlow:function(e){if(void 0===e)return K;K=e},filterNodes:function(e){for(var t=[],o=0;o<p.length;o++){var n=p[o];e.hasOwnProperty("z")&&n.z!==e.z||e.hasOwnProperty("type")&&n.type!==e.type||t.push(n)}return t},filterLinks:function(e){for(var t=[],o=0;o<u.length;o++){var n=u[o];if(e.source){if(e.source.hasOwnProperty("id")&&n.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&n.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&n.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&n.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&n.sourcePort!==e.sourcePort||t.push(n)}return t},import:c,getAllFlowNodes:function(e){var t={};t[e.id]=!0;for(var o=[e],n=[e];0!==n.length;)for(var a=n.shift(),i=u.filter(function(e){return e.source===a||e.target===a}),s=0;s<i.length;s++){var r=i[s].source===a?i[s].target:i[s].source,l=r.id;l||(l=r.direction+":"+r.i),t[l]||(t[l]=!0,o.push(r),n.push(r))}return o},createExportableNodeSet:b,createCompleteNodeSet:function(e){void 0===e&&(e=!0);var t,o=[];for(t=0;t<s.length;t++)"tab"==Y[s[t]].type&&o.push(g(Y[s[t]]));for(t in r)r.hasOwnProperty(t)&&o.push(v(r[t]));for(t in H)H.hasOwnProperty(t)&&o.push(d(H[t],e));for(t=0;t<p.length;t++){var n=p[t];o.push(d(n,e))}return o},updateConfigNodeUsers:a,id:Q,dirty:function(e){if(null==e)return o;o=e,RED.events.emit("nodes:change",{dirty:o})}}}(),RED.nodes.fontAwesome=function(){var o={"fa-address-book-o":"","fa-address-book":"","fa-address-card-o":"","fa-address-card":"","fa-adjust":"","fa-align-center":"","fa-align-justify":"","fa-align-left":"","fa-align-right":"","fa-ambulance":"","fa-american-sign-language-interpreting":"","fa-anchor":"","fa-angle-double-down":"","fa-angle-double-left":"","fa-angle-double-right":"","fa-angle-double-up":"","fa-angle-down":"","fa-angle-left":"","fa-angle-right":"","fa-angle-up":"","fa-archive":"","fa-area-chart":"","fa-arrow-circle-down":"","fa-arrow-circle-left":"","fa-arrow-circle-o-down":"","fa-arrow-circle-o-left":"","fa-arrow-circle-o-right":"","fa-arrow-circle-o-up":"","fa-arrow-circle-right":"","fa-arrow-circle-up":"","fa-arrow-down":"","fa-arrow-left":"","fa-arrow-right":"","fa-arrow-up":"","fa-arrows-alt":"","fa-arrows-h":"","fa-arrows-v":"","fa-arrows":"","fa-asl-interpreting":"","fa-assistive-listening-systems":"","fa-asterisk":"","fa-at":"","fa-audio-description":"","fa-automobile":"","fa-backward":"","fa-balance-scale":"","fa-ban":"","fa-bank":"","fa-bar-chart-o":"","fa-bar-chart":"","fa-barcode":"","fa-bars":"","fa-bath":"","fa-bathtub":"","fa-battery-0":"","fa-battery-1":"","fa-battery-2":"","fa-battery-3":"","fa-battery-4":"","fa-battery-empty":"","fa-battery-full":"","fa-battery-half":"","fa-battery-quarter":"","fa-battery-three-quarters":"","fa-battery":"","fa-bed":"","fa-beer":"","fa-bell-o":"","fa-bell-slash-o":"","fa-bell-slash":"","fa-bell":"","fa-bicycle":"","fa-binoculars":"","fa-birthday-cake":"","fa-blind":"","fa-bold":"","fa-bolt":"","fa-bomb":"","fa-book":"","fa-bookmark-o":"","fa-bookmark":"","fa-braille":"","fa-briefcase":"","fa-bug":"","fa-building-o":"","fa-building":"","fa-bullhorn":"","fa-bullseye":"","fa-bus":"","fa-cab":"","fa-calculator":"","fa-calendar-check-o":"","fa-calendar-minus-o":"","fa-calendar-o":"","fa-calendar-plus-o":"","fa-calendar-times-o":"","fa-calendar":"","fa-camera-retro":"","fa-camera":"","fa-car":"","fa-caret-down":"","fa-caret-left":"","fa-caret-right":"","fa-caret-square-o-down":"","fa-caret-square-o-left":"","fa-caret-square-o-right":"","fa-caret-square-o-up":"","fa-caret-up":"","fa-cart-arrow-down":"","fa-cart-plus":"","fa-cc":"","fa-certificate":"","fa-chain-broken":"","fa-chain":"","fa-check-circle-o":"","fa-check-circle":"","fa-check-square-o":"","fa-check-square":"","fa-check":"","fa-chevron-circle-down":"","fa-chevron-circle-left":"","fa-chevron-circle-right":"","fa-chevron-circle-up":"","fa-chevron-down":"","fa-chevron-left":"","fa-chevron-right":"","fa-chevron-up":"","fa-child":"","fa-circle-o-notch":"","fa-circle-o":"","fa-circle-thin":"","fa-circle":"","fa-clipboard":"","fa-clock-o":"","fa-clone":"","fa-close":"","fa-cloud-download":"","fa-cloud-upload":"","fa-cloud":"","fa-cny":"","fa-code-fork":"","fa-code":"","fa-coffee":"","fa-cog":"","fa-cogs":"","fa-columns":"","fa-comment-o":"","fa-comment":"","fa-commenting-o":"","fa-commenting":"","fa-comments-o":"","fa-comments":"","fa-compass":"","fa-compress":"","fa-copy":"","fa-copyright":"","fa-creative-commons":"","fa-credit-card-alt":"","fa-credit-card":"","fa-crop":"","fa-crosshairs":"","fa-cube":"","fa-cubes":"","fa-cut":"","fa-cutlery":"","fa-dashboard":"","fa-database":"","fa-deaf":"","fa-deafness":"","fa-dedent":"","fa-desktop":"","fa-diamond":"","fa-dollar":"","fa-dot-circle-o":"","fa-download":"","fa-drivers-license-o":"","fa-drivers-license":"","fa-edit":"","fa-eject":"","fa-ellipsis-h":"","fa-ellipsis-v":"","fa-envelope-o":"","fa-envelope-open-o":"","fa-envelope-open":"","fa-envelope-square":"","fa-envelope":"","fa-eraser":"","fa-eur":"","fa-euro":"","fa-exchange":"","fa-exclamation-circle":"","fa-exclamation-triangle":"","fa-exclamation":"","fa-expand":"","fa-external-link-square":"","fa-external-link":"","fa-eye-slash":"","fa-eye":"","fa-eyedropper":"","fa-fast-backward":"","fa-fast-forward":"","fa-fax":"","fa-feed":"","fa-female":"","fa-fighter-jet":"","fa-file-archive-o":"","fa-file-audio-o":"","fa-file-code-o":"","fa-file-excel-o":"","fa-file-image-o":"","fa-file-movie-o":"","fa-file-o":"","fa-file-pdf-o":"","fa-file-photo-o":"","fa-file-picture-o":"","fa-file-powerpoint-o":"","fa-file-sound-o":"","fa-file-text-o":"","fa-file-text":"","fa-file-video-o":"","fa-file-word-o":"","fa-file-zip-o":"","fa-file":"","fa-files-o":"","fa-film":"","fa-filter":"","fa-fire-extinguisher":"","fa-fire":"","fa-flag-checkered":"","fa-flag-o":"","fa-flag":"","fa-flash":"","fa-flask":"","fa-floppy-o":"","fa-folder-o":"","fa-folder-open-o":"","fa-folder-open":"","fa-folder":"","fa-font":"","fa-forward":"","fa-frown-o":"","fa-futbol-o":"","fa-gamepad":"","fa-gavel":"","fa-gbp":"","fa-gear":"","fa-gears":"","fa-genderless":"","fa-gift":"","fa-glass":"","fa-globe":"","fa-graduation-cap":"","fa-group":"","fa-h-square":"","fa-hand-grab-o":"","fa-hand-lizard-o":"","fa-hand-o-down":"","fa-hand-o-left":"","fa-hand-o-right":"","fa-hand-o-up":"","fa-hand-paper-o":"","fa-hand-peace-o":"","fa-hand-pointer-o":"","fa-hand-rock-o":"","fa-hand-scissors-o":"","fa-hand-spock-o":"","fa-hand-stop-o":"","fa-handshake-o":"","fa-hard-of-hearing":"","fa-hashtag":"","fa-hdd-o":"","fa-header":"","fa-headphones":"","fa-heart-o":"","fa-heart":"","fa-heartbeat":"","fa-history":"","fa-home":"","fa-hospital-o":"","fa-hotel":"","fa-hourglass-1":"","fa-hourglass-2":"","fa-hourglass-3":"","fa-hourglass-end":"","fa-hourglass-half":"","fa-hourglass-o":"","fa-hourglass-start":"","fa-hourglass":"","fa-i-cursor":"","fa-id-badge":"","fa-id-card-o":"","fa-id-card":"","fa-ils":"","fa-image":"","fa-inbox":"","fa-indent":"","fa-industry":"","fa-info-circle":"","fa-info":"","fa-inr":"","fa-institution":"","fa-intersex":"","fa-italic":"","fa-jpy":"","fa-key":"","fa-keyboard-o":"","fa-krw":"","fa-language":"","fa-laptop":"","fa-leaf":"","fa-legal":"","fa-lemon-o":"","fa-level-down":"","fa-level-up":"","fa-life-bouy":"","fa-life-buoy":"","fa-life-ring":"","fa-life-saver":"","fa-lightbulb-o":"","fa-line-chart":"","fa-link":"","fa-list-alt":"","fa-list-ol":"","fa-list-ul":"","fa-list":"","fa-location-arrow":"","fa-lock":"","fa-long-arrow-down":"","fa-long-arrow-left":"","fa-long-arrow-right":"","fa-long-arrow-up":"","fa-low-vision":"","fa-magic":"","fa-magnet":"","fa-mail-forward":"","fa-mail-reply-all":"","fa-mail-reply":"","fa-male":"","fa-map-marker":"","fa-map-o":"","fa-map-pin":"","fa-map-signs":"","fa-map":"","fa-mars-double":"","fa-mars-stroke-h":"","fa-mars-stroke-v":"","fa-mars-stroke":"","fa-mars":"","fa-medkit":"","fa-meh-o":"","fa-mercury":"","fa-microchip":"","fa-microphone-slash":"","fa-microphone":"","fa-minus-circle":"","fa-minus-square-o":"","fa-minus-square":"","fa-minus":"","fa-mobile-phone":"","fa-mobile":"","fa-money":"","fa-moon-o":"","fa-mortar-board":"","fa-motorcycle":"","fa-mouse-pointer":"","fa-music":"","fa-navicon":"","fa-neuter":"","fa-newspaper-o":"","fa-object-group":"","fa-object-ungroup":"","fa-outdent":"","fa-paint-brush":"","fa-paper-plane-o":"","fa-paper-plane":"","fa-paperclip":"","fa-paragraph":"","fa-paste":"","fa-pause-circle-o":"","fa-pause-circle":"","fa-pause":"","fa-paw":"","fa-pencil-square-o":"","fa-pencil-square":"","fa-pencil":"","fa-percent":"","fa-phone-square":"","fa-phone":"","fa-photo":"","fa-picture-o":"","fa-pie-chart":"","fa-plane":"","fa-play-circle-o":"","fa-play-circle":"","fa-play":"","fa-plug":"","fa-plus-circle":"","fa-plus-square-o":"","fa-plus-square":"","fa-plus":"","fa-podcast":"","fa-power-off":"","fa-print":"","fa-puzzle-piece":"","fa-qrcode":"","fa-question-circle-o":"","fa-question-circle":"","fa-question":"","fa-quote-left":"","fa-quote-right":"","fa-random":"","fa-recycle":"","fa-refresh":"","fa-registered":"","fa-remove":"","fa-reorder":"","fa-repeat":"","fa-reply-all":"","fa-reply":"","fa-retweet":"","fa-rmb":"","fa-road":"","fa-rocket":"","fa-rotate-left":"","fa-rotate-right":"","fa-rouble":"","fa-rss-square":"","fa-rss":"","fa-rub":"","fa-ruble":"","fa-rupee":"","fa-s15":"","fa-save":"","fa-scissors":"","fa-search-minus":"","fa-search-plus":"","fa-search":"","fa-send-o":"","fa-send":"","fa-server":"","fa-share-square-o":"","fa-share-square":"","fa-share":"","fa-shekel":"","fa-sheqel":"","fa-shield":"","fa-ship":"","fa-shopping-bag":"","fa-shopping-basket":"","fa-shopping-cart":"","fa-shower":"","fa-sign-in":"","fa-sign-language":"","fa-sign-out":"","fa-signal":"","fa-signing":"","fa-sitemap":"","fa-sliders":"","fa-smile-o":"","fa-snowflake-o":"","fa-soccer-ball-o":"","fa-sort-alpha-asc":"","fa-sort-alpha-desc":"","fa-sort-amount-asc":"","fa-sort-amount-desc":"","fa-sort-asc":"","fa-sort-desc":"","fa-sort-down":"","fa-sort-numeric-asc":"","fa-sort-numeric-desc":"","fa-sort-up":"","fa-sort":"","fa-space-shuttle":"","fa-spinner":"","fa-spoon":"","fa-square-o":"","fa-square":"","fa-star-half-empty":"","fa-star-half-full":"","fa-star-half-o":"","fa-star-half":"","fa-star-o":"","fa-star":"","fa-step-backward":"","fa-step-forward":"","fa-stethoscope":"","fa-sticky-note-o":"","fa-sticky-note":"","fa-stop-circle-o":"","fa-stop-circle":"","fa-stop":"","fa-street-view":"","fa-strikethrough":"","fa-subscript":"","fa-subway":"","fa-suitcase":"","fa-sun-o":"","fa-superscript":"","fa-support":"","fa-table":"","fa-tablet":"","fa-tachometer":"","fa-tag":"","fa-tags":"","fa-tasks":"","fa-taxi":"","fa-television":"","fa-terminal":"","fa-text-height":"","fa-text-width":"","fa-th-large":"","fa-th-list":"","fa-th":"","fa-thermometer-0":"","fa-thermometer-1":"","fa-thermometer-2":"","fa-thermometer-3":"","fa-thermometer-4":"","fa-thermometer-empty":"","fa-thermometer-full":"","fa-thermometer-half":"","fa-thermometer-quarter":"","fa-thermometer-three-quarters":"","fa-thermometer":"","fa-thumb-tack":"","fa-thumbs-down":"","fa-thumbs-o-down":"","fa-thumbs-o-up":"","fa-thumbs-up":"","fa-ticket":"","fa-times-circle-o":"","fa-times-circle":"","fa-times-rectangle-o":"","fa-times-rectangle":"","fa-times":"","fa-tint":"","fa-toggle-down":"","fa-toggle-left":"","fa-toggle-off":"","fa-toggle-on":"","fa-toggle-right":"","fa-toggle-up":"","fa-trademark":"","fa-train":"","fa-transgender-alt":"","fa-transgender":"","fa-trash-o":"","fa-trash":"","fa-tree":"","fa-trophy":"","fa-truck":"","fa-try":"","fa-tty":"","fa-turkish-lira":"","fa-tv":"","fa-umbrella":"","fa-underline":"","fa-undo":"","fa-universal-access":"","fa-university":"","fa-unlink":"","fa-unlock-alt":"","fa-unlock":"","fa-unsorted":"","fa-upload":"","fa-usd":"","fa-user-circle-o":"","fa-user-circle":"","fa-user-md":"","fa-user-o":"","fa-user-plus":"","fa-user-secret":"","fa-user-times":"","fa-user":"","fa-users":"","fa-vcard-o":"","fa-vcard":"","fa-venus-double":"","fa-venus-mars":"","fa-venus":"","fa-video-camera":"","fa-volume-control-phone":"","fa-volume-down":"","fa-volume-off":"","fa-volume-up":"","fa-warning":"","fa-wheelchair-alt":"","fa-wheelchair":"","fa-wifi":"","fa-window-close-o":"","fa-window-close":"","fa-window-maximize":"","fa-window-minimize":"","fa-window-restore":"","fa-won":"","fa-wrench":"","fa-yen":""},t={"fa-500px":"","fa-adn":"","fa-amazon":"","fa-android":"","fa-angellist":"","fa-apple":"","fa-bandcamp":"","fa-behance-square":"","fa-behance":"","fa-bitbucket-square":"","fa-bitbucket":"","fa-bitcoin":"","fa-black-tie":"","fa-bluetooth-b":"","fa-bluetooth":"","fa-btc":"","fa-buysellads":"","fa-cc-amex":"","fa-cc-diners-club":"","fa-cc-discover":"","fa-cc-jcb":"","fa-cc-mastercard":"","fa-cc-paypal":"","fa-cc-stripe":"","fa-cc-visa":"","fa-chrome":"","fa-codepen":"","fa-codiepie":"","fa-connectdevelop":"","fa-contao":"","fa-css3":"","fa-dashcube":"","fa-delicious":"","fa-deviantart":"","fa-digg":"","fa-dribbble":"","fa-dropbox":"","fa-drupal":"","fa-edge":"","fa-eercast":"","fa-empire":"","fa-envira":"","fa-etsy":"","fa-expeditedssl":"","fa-fa":"","fa-facebook-f":"","fa-facebook-official":"","fa-facebook-square":"","fa-facebook":"","fa-firefox":"","fa-first-order":"","fa-flickr":"","fa-font-awesome":"","fa-fonticons":"","fa-fort-awesome":"","fa-forumbee":"","fa-foursquare":"","fa-free-code-camp":"","fa-ge":"","fa-get-pocket":"","fa-gg-circle":"","fa-gg":"","fa-git-square":"","fa-git":"","fa-github-alt":"","fa-github-square":"","fa-github":"","fa-gitlab":"","fa-gittip":"","fa-glide-g":"","fa-glide":"","fa-google-plus-circle":"","fa-google-plus-official":"","fa-google-plus-square":"","fa-google-plus":"","fa-google-wallet":"","fa-google":"","fa-gratipay":"","fa-grav":"","fa-hacker-news":"","fa-houzz":"","fa-html5":"","fa-imdb":"","fa-instagram":"","fa-internet-explorer":"","fa-ioxhost":"","fa-joomla":"","fa-jsfiddle":"","fa-lastfm-square":"","fa-lastfm":"","fa-leanpub":"","fa-linkedin-square":"","fa-linkedin":"","fa-linode":"","fa-linux":"","fa-maxcdn":"","fa-meanpath":"","fa-medium":"","fa-meetup":"","fa-mixcloud":"","fa-modx":"","fa-odnoklassniki-square":"","fa-odnoklassniki":"","fa-opencart":"","fa-openid":"","fa-opera":"","fa-optin-monster":"","fa-pagelines":"","fa-paypal":"","fa-pied-piper-alt":"","fa-pied-piper-pp":"","fa-pied-piper":"","fa-pinterest-p":"","fa-pinterest-square":"","fa-pinterest":"","fa-product-hunt":"","fa-qq":"","fa-quora":"","fa-ra":"","fa-ravelry":"","fa-rebel":"","fa-reddit-alien":"","fa-reddit-square":"","fa-reddit":"","fa-renren":"","fa-resistance":"","fa-safari":"","fa-scribd":"","fa-sellsy":"","fa-share-alt-square":"","fa-share-alt":"","fa-shirtsinbulk":"","fa-simplybuilt":"","fa-skyatlas":"","fa-skype":"","fa-slack":"","fa-slideshare":"","fa-snapchat-ghost":"","fa-snapchat-square":"","fa-snapchat":"","fa-soundcloud":"","fa-spotify":"","fa-stack-exchange":"","fa-stack-overflow":"","fa-steam-square":"","fa-steam":"","fa-stumbleupon-circle":"","fa-stumbleupon":"","fa-superpowers":"","fa-telegram":"","fa-tencent-weibo":"","fa-themeisle":"","fa-trello":"","fa-tripadvisor":"","fa-tumblr-square":"","fa-tumblr":"","fa-twitch":"","fa-twitter-square":"","fa-twitter":"","fa-usb":"","fa-viacoin":"","fa-viadeo-square":"","fa-viadeo":"","fa-vimeo-square":"","fa-vimeo":"","fa-vine":"","fa-vk":"","fa-wechat":"","fa-weibo":"","fa-weixin":"","fa-whatsapp":"","fa-wikipedia-w":"","fa-windows":"","fa-wordpress":"","fa-wpbeginner":"","fa-wpexplorer":"","fa-wpforms":"","fa-xing-square":"","fa-xing":"","fa-y-combinator-square":"","fa-y-combinator":"","fa-yahoo":"","fa-yc-square":"","fa-yc":"","fa-yelp":"","fa-yoast":"","fa-youtube-play":"","fa-youtube-square":"","fa-youtube":""},n=[],a={};return Object.keys(o).forEach(function(e){var t=o[e];!0!==a[t]&&(n.push(e),a[t]=!0)}),a=void 0,{getIconUnicode:function(e){return o[e]||t[e]},getIconList:function(){return n}}}(),RED.history=function(){var t=[];return{markAllDirty:function(){for(var e=0;e<t.length;e++)t[e].dirty=!0},list:function(){return t},depth:function(){return t.length},push:function(e){t.push(e)},pop:function(){!function e(t){var o,n,a,i={};if(t){if("multi"==t.t)for(o=t.events.length-1;0<=o;o--)e(t.events[o]);else if("replace"==t.t)RED.nodes.clear(),RED.nodes.import(t.config)[0].forEach(function(e){t.changed[e.id]&&(e.changed=!0)}),RED.nodes.version(t.rev);else if("add"==t.t){if(t.nodes)for(o=0;o<t.nodes.length;o++)(n=RED.nodes.node(t.nodes[o])).z&&(i[n.z]=!0),RED.nodes.remove(t.nodes[o]);if(t.links)for(o=0;o<t.links.length;o++)RED.nodes.removeLink(t.links[o]);if(t.workspaces)for(o=0;o<t.workspaces.length;o++)RED.nodes.removeWorkspace(t.workspaces[o].id),RED.workspaces.remove(t.workspaces[o]);if(t.subflows)for(o=0;o<t.subflows.length;o++)RED.nodes.removeSubflow(t.subflows[o]),RED.workspaces.remove(t.subflows[o]);if(t.subflow&&(t.subflow.instances&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),t.subflow.hasOwnProperty("changed")&&(a=RED.nodes.subflow(t.subflow.id))&&(a.changed=t.subflow.changed)),t.removedLinks)for(o=0;o<t.removedLinks.length;o++)RED.nodes.addLink(t.removedLinks[o])}else if("delete"==t.t){if(t.workspaces)for(o=0;o<t.workspaces.length;o++)RED.nodes.addWorkspace(t.workspaces[o],t.workspaces[o]._index),RED.workspaces.add(t.workspaces[o],void 0,t.workspaces[o]._index),delete t.workspaces[o]._index;if(t.subflows)for(o=0;o<t.subflows.length;o++)RED.nodes.addSubflow(t.subflows[o]);if(t.subflowInputs&&0<t.subflowInputs.length&&((a=RED.nodes.subflow(t.subflowInputs[0].z)).in.push(t.subflowInputs[0]),a.in[0].dirty=!0),t.subflowOutputs&&0<t.subflowOutputs.length)for(a=RED.nodes.subflow(t.subflowOutputs[0].z),t.subflowOutputs.sort(function(e,t){return e.i-t.i}),o=0;o<t.subflowOutputs.length;o++){var s=t.subflowOutputs[o];a.out.splice(s.i,0,s);for(var r=s.i+1;r<a.out.length;r++)a.out[r].i++,a.out[r].dirty=!0;RED.nodes.eachLink(function(e){e.source.type=="subflow:"+a.id&&e.sourcePort>=s.i&&e.sourcePort++})}if(t.subflow&&(t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),t.subflow.hasOwnProperty("status")&&((a=RED.nodes.subflow(t.subflow.id)).status=t.subflow.status)),a&&RED.nodes.filterNodes({type:"subflow:"+a.id}).forEach(function(e){for(e.inputs=a.in.length,e.outputs=a.out.length;e.outputs>e.ports.length;)e.ports.push(e.ports.length);e.resize=!0,e.dirty=!0}),t.nodes)for(o=0;o<t.nodes.length;o++)RED.nodes.add(t.nodes[o]),i[t.nodes[o].z]=!0;if(t.links)for(o=0;o<t.links.length;o++)RED.nodes.addLink(t.links[o]);if(t.changes)for(o in t.changes)if(t.changes.hasOwnProperty(o)&&(n=RED.nodes.node(o))){for(var l in t.changes[o])t.changes[o].hasOwnProperty(l)&&(n[l]=t.changes[o][l]);n.dirty=!0}}else if("move"==t.t){for(o=0;o<t.nodes.length;o++){var d=t.nodes[o];d.n.x=d.ox,d.n.y=d.oy,d.n.dirty=!0,d.n.moved=d.moved}if(t.links)for(o=0;o<t.links.length;o++)RED.nodes.removeLink(t.links[o]);if(t.removedLinks)for(o=0;o<t.removedLinks.length;o++)RED.nodes.addLink(t.removedLinks[o])}else if("edit"==t.t){for(o in t.changes)if(t.changes.hasOwnProperty(o)){if(t.node._def.defaults&&t.node._def.defaults[o]&&t.node._def.defaults[o].type){var c=RED.nodes.node(t.node[o]);c&&c.users.splice(c.users.indexOf(t.node),1);var p=RED.nodes.node(t.changes[o]);p&&p.users.push(t.node)}t.node[o]=t.changes[o]}if(t.subflow)t.subflow.hasOwnProperty("inputCount")&&(t.node.in.length>t.subflow.inputCount?t.node.in.splice(t.subflow.inputCount):0<t.subflow.inputs.length&&(t.node.in=t.node.in.concat(t.subflow.inputs))),t.subflow.hasOwnProperty("outputCount")&&(t.node.out.length>t.subflow.outputCount?t.node.out.splice(t.subflow.outputCount):0<t.subflow.outputs.length&&(t.node.out=t.node.out.concat(t.subflow.outputs))),t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),t.subflow.hasOwnProperty("status")&&t.subflow.status&&delete t.node.status,RED.editor.validateNode(t.node),RED.nodes.filterNodes({type:"subflow:"+t.node.id}).forEach(function(e){e.inputs=t.node.in.length,e.outputs=t.node.out.length,RED.editor.updateNodeProperties(e),RED.editor.validateNode(e)});else{var u;if(t.outputMap)for(var f in u={},t.outputMap)t.outputMap.hasOwnProperty(f)&&"-1"!==t.outputMap[f]&&(u[t.outputMap[f]]=f);RED.editor.updateNodeProperties(t.node,u),RED.editor.validateNode(t.node)}if(t.links)for(o=0;o<t.links.length;o++)RED.nodes.addLink(t.links[o]);t.node.dirty=!0,t.node.changed=t.changed}else if("createSubflow"==t.t){if(t.nodes)for(RED.nodes.filterNodes({z:t.subflow.subflow.id}).forEach(function(e){e.x+=t.subflow.offsetX,e.y+=t.subflow.offsetY,e.z=t.activeWorkspace,e.dirty=!0}),o=0;o<t.nodes.length;o++)RED.nodes.remove(t.nodes[o]);if(t.links)for(o=0;o<t.links.length;o++)RED.nodes.removeLink(t.links[o]);if(RED.nodes.removeSubflow(t.subflow.subflow),RED.workspaces.remove(t.subflow.subflow),t.removedLinks)for(o=0;o<t.removedLinks.length;o++)RED.nodes.addLink(t.removedLinks[o])}else"reorder"==t.t&&t.order&&RED.workspaces.order(t.order);Object.keys(i).forEach(function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)}),RED.nodes.dirty(t.dirty),RED.view.select(null),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.subflow.refresh()}}(t.pop())},peek:function(){return t[t.length-1]},clear:function(){t=[]}}}(),RED.validators={number:function(t){return function(e){return t&&(""===e||void 0===e)||""!==e&&!isNaN(e)}},regex:function(t){return function(e){return t.test(e)}},typedInput:function(o,n){return function(e){var t=$("#node-"+(n?"config-":"")+"input-"+o).val()||this[o];if("json"===t)try{return JSON.parse(e),!0}catch(e){return!1}else{if("msg"===t||"flow"===t||"global"===t)return RED.utils.validatePropertyExpression(e);if("num"===t)return/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(e)}return!0}}},RED.utils=function(){function I(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function N(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function z(e){var t;if(Array.isArray(e))t=$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("array["+e.length+"]");else if(null===e)t=$('<span class="debug-message-object-value debug-message-type-null">null</span>');else if("object"==typeof e)t=e.hasOwnProperty("type")&&"Buffer"===e.type&&e.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("buffer["+e.length+"]"):e.hasOwnProperty("type")&&"array"===e.type&&e.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("array["+e.length+"]"):e.hasOwnProperty("type")&&"function"===e.type?$('<span class="debug-message-object-value debug-message-type-meta"></span>').text("function"):e.hasOwnProperty("type")&&"number"===e.type?$('<span class="debug-message-object-value debug-message-type-number"></span>').text(e.data):$('<span class="debug-message-object-value debug-message-type-meta">object</span>');else if("string"==typeof e){var o;o=30<e.length?N(e.substring(0,30))+"&hellip;":N(e),t=$('<span class="debug-message-object-value debug-message-type-string"></span>').html('"'+I(o)+'"')}else t="number"==typeof e?$('<span class="debug-message-object-value debug-message-type-number"></span>').text(""+e):$('<span class="debug-message-object-value debug-message-type-other"></span>').text(""+e);return t}function A(o,n,a,e){o.addClass("debug-message-expandable"),o.prop("toggle",function(){return function(e){var t=o.parent();if(t.hasClass("collapsed")){if(e)return n&&!t.hasClass("built")&&(n(),t.addClass("built")),t.removeClass("collapsed"),!0}else if(!e)return t.addClass("collapsed"),!0;return!1}}),o.click(function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&a&&a(!t),e.preventDefault()}),e&&o.click()}var M={},d={};function B(e,t,o,n){if(t&&0<t.length){if(""===e&&void 0===o)return!0;for(var a=0;a<t.length;a++){var i=t[a];if(0===i.indexOf(e)&&("."===i[e.length]||"["===i[e.length])){if(void 0===o||"["!==i[e.length])return!0;var s=i.substring(e.length),r=/\[(\d+)\]/.exec(s);if(r){var l=parseInt(r[1]);return o<=l&&l<=n}}}}return!1}function q(e,t,o,n,a,i){var s=d[o]&&d[o][n]&&d[o][n].number||i||"dec";if(a?(s="dec"===s?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===s||"dateS"==s?13===t.toString().length&&t<=2147483647e3?"dateML":10===t.toString().length&&t<=2147483647?"dateL":"hex":"dateML"===s||"dateL"==s?"hex":"dec",d[o]=d[o]||{},d[o][n]=d[o][n]||{},d[o][n].number=s):void 0!==i&&(d[o]=d[o]||{},d[o][n]=d[o][n]||{},d[o][n].number=s),"dec"===s)e.text(""+t);else if("dateMS"===s)e.text(new Date(t).toISOString());else if("dateS"===s)e.text(new Date(1e3*t).toISOString());else if("dateML"===s){var r=new Date(t);e.text(r.toLocaleString()+"  [UTC"+(r.getTimezoneOffset()/-60<=0?"":"+")+r.getTimezoneOffset()/-60+"]")}else if("dateL"===s){var l=new Date(1e3*t);e.text(l.toLocaleString()+"  [UTC"+(l.getTimezoneOffset()/-60<=0?"":"+")+l.getTimezoneOffset()/-60+"]")}else"hex"===s&&e.text("0x"+t.toString(16))}function U(e,t,o,n,a){var i=d[o]&&d[o][n]&&d[o][n].buffer||"raw";a&&(i="raw"===i?"string":"raw",d[o]=d[o]||{},d[o][n]=d[o][n]||{},d[o][n].buffer=i),"raw"===i?(t.text("raw"),e.removeClass("debug-message-buffer-string").addClass("debug-message-buffer-raw")):"string"===i&&(t.text("string"),e.addClass("debug-message-buffer-string").removeClass("debug-message-buffer-raw"))}function J(e){var t=e.length;if(0===t)throw new Error("Invalid property expression: zero-length");for(var o,n,a=[],i=0,s=!1,r=!1,l=0;l<t;l++){var d=e[l];if(s){if(d===o){if(l-i==0)throw new Error("Invalid property expression: zero-length string at position "+i);if(a.push(e.substring(i,l)),r&&!/\]/.test(e[l+1]))throw new Error("Invalid property expression: unexpected array expression at position "+i);if(!r&&l+1!==t&&!/[\[\.]/.test(e[l+1]))throw new Error("Invalid property expression: unexpected "+e[l+1]+" expression at position "+(l+1));i=l+1,s=!1}}else if("'"===d||'"'===d){if(l!=i)throw new Error("Invalid property expression: unexpected "+d+" at position "+l);s=!0,o=d,i=l+1}else if("."===d){if(0===l)throw new Error("Invalid property expression: unexpected . at position 0");if(i!=l&&(n=e.substring(i,l),/^\d+$/.test(n)?a.push(parseInt(n)):a.push(n)),l===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[l+1]))throw new Error("Invalid property expression: unexpected "+e[l+1]+" at position "+(l+1));i=l+1}else if("["===d){if(0===l)throw new Error("Invalid property expression: unexpected "+d+" at position "+l);if(i!=l&&a.push(e.substring(i,l)),l===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/["'\d]/.test(e[l+1]))throw new Error("Invalid property expression: unexpected "+e[l+1]+" at position "+(l+1));i=l+1,r=!0}else if("]"===d){if(!r)throw new Error("Invalid property expression: unexpected "+d+" at position "+l);if(i!=l){if(n=e.substring(i,l),!/^\d+$/.test(n))throw new Error("Invalid property expression: unexpected array expression at position "+i);a.push(parseInt(n))}i=l+1,r=!1}else if(" "===d)throw new Error("Invalid property expression: unexpected ' ' at position "+l)}if(r||s)throw new Error("Invalid property expression: unterminated expression");return i<t&&a.push(e.substring(i)),a}function F(e,t){var o=null;return("string"==typeof t?(0===t.indexOf("msg.")&&(t=t.substring(4)),J(t)):t).reduce(function(e,t){return void 0===(o=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")&&(o=void 0!==e.data[t]?e.data[t]:void 0),o},e),o}function r(e){var t={module:"",file:""};if(e){var o=e.indexOf("icons/");-1!==o&&(e=e.substring(o+6)),-1!==(o=e.indexOf("/"))?(t.module=e.slice(0,o),t.file=e.slice(o+1)):t.file=e}return t}function n(t,e){var o;if(e&&"subflow"===e.type)o="node-red/subflow.png";else if("function"==typeof t.icon)try{o=t.icon.call(e)}catch(e){console.log("Definition error: "+t.type+".icon",e),o="arrow-in.png"}else o=t.icon;var n=r(o);return n.module||(t.set?n.module=t.set.module:n.module="node-red"),n}function a(e){var t=RED.nodes.getIconSets()[e.module];return!(!t||-1===t.indexOf(e.file))}var l={};return{createObjectElement:function r(o,e){var l,t,n,d,c,p,u=(e=e||{}).key,f=e.typeHint,a=e.hideKey,h=e.path,g=e.sourceId,v=e.rootPath,b=e.expandPaths,m=e.ontoggle,y=e.exposeApi,i=e.tools,w={};void 0!==h&&void 0!==v&&(p=h.substring(v.length+("."===h[v.length]?1:0)));var D=$('<span class="debug-message-element"></span>');if(D.collapse=function(){D.find(".debug-message-expandable").parent().addClass("collapsed")},d=$('<span class="debug-message-row"></span>').appendTo(D),g&&function(o,n,t,a,e,i,s){M.hasOwnProperty(n)||(M[n]={});var r=$('<span class="debug-message-tools"></span>').appendTo(o),l=$('<span class="debug-message-tools-copy button-group"></span>').appendTo(r);if(t)var d=$('<button class="editor-button editor-button-small"><i class="fa fa-terminal"></i></button>').appendTo(l).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(t,d,"clipboard.copyMessagePath")});var c=$('<button class="editor-button editor-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(l).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(a,c,"clipboard.copyMessageValue")});if(void 0!==i&&""!==i){var p=M[n].hasOwnProperty(i);$('<button class="editor-button editor-button-small debug-message-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(r).click(function(e){if(e.preventDefault(),e.stopPropagation(),M[n].hasOwnProperty(i))delete M[n][i],$(this).removeClass("selected"),o.removeClass("debug-message-row-pinned");else{var t="$"+("["===i[0]?"":".")+i;M[n][i]=J(t),$(this).addClass("selected"),o.addClass("debug-message-row-pinned")}}).toggleClass("selected",p),o.toggleClass("debug-message-row-pinned",p)}s&&(s.addClass("debug-message-tools-other"),s.appendTo(r))}(d,g,h,o,0,p,i),u)a||($('<span class="debug-message-object-key"></span>').text(u).appendTo(d),$("<span>: </span>").appendTo(d));else if(D.addClass("debug-message-top-level"),g){var s=M[g];if(b=[],s){for(var E in s)if(s.hasOwnProperty(E))try{void 0!==F({$:o},s[E])&&b.push(E)}catch(e){}b.sort()}D.clearPinned=function(){D.find(".debug-message-row-pinned").removeClass("debug-message-row-pinned"),M[g]={}}}n=$('<span class="debug-message-object-value"></span>').appendTo(d);var R=Array.isArray(o),x=!1;if(o&&"object"==typeof o&&o.hasOwnProperty("type")&&o.hasOwnProperty("data")&&(o.__enc__&&"array"===o.type||"Buffer"===o.type)&&(x=R=!0),null==o)$('<span class="debug-message-type-null">'+o+"</span>").appendTo(n);else if(o.__enc__&&"number"===o.type)t=$('<span class="debug-message-type-number debug-message-object-header"></span>').text(o.data).appendTo(n);else if("function"===f||o.__enc__&&"function"===o.type)t=$('<span class="debug-message-type-meta debug-message-object-header"></span>').text("function").appendTo(n);else if("internal"===f||o.__enc__&&"internal"===o.type)t=$('<span class="debug-message-type-meta debug-message-object-header"></span>').text("[internal]").appendTo(n);else if("string"==typeof o)/[\t\n\r]/.test(o)&&(D.addClass("collapsed"),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(d),A(d,function(){$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').text(f||"string").appendTo(d);var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(D);$('<pre class="debug-message-type-string"></pre>').text(o).appendTo(e)},function(e){m&&m(h,e)},B(p,b))),t=$('<span class="debug-message-type-string debug-message-object-header"></span>').html('"'+I(N(o))+'"').appendTo(n),/^#[0-9a-f]{6}$/i.test(o)&&$('<span class="debug-message-type-string-swatch"></span>').css("backgroundColor",o).appendTo(t);else if("number"==typeof o)t=$('<span class="debug-message-type-number"></span>').appendTo(n),Number.isInteger(o)&&0<=o&&(t.addClass("debug-message-type-number-toggle"),t.click(function(e){e.preventDefault(),q($(this),o,g,h,!0)})),q(t,o,g,h,!1,"hex"===f?"hex":void 0);else if(R){D.addClass("collapsed");var k=o.length;if(f){var T=/\[(\d+)\]/.exec(f);T&&(k=parseInt(T[1]))}var _=o,j="array";x?(_=o.data,void 0===k&&(k=_.length),_.__enc__&&(_=_.data),j=o.type.toLowerCase()):/buffer/.test(f)&&(j="buffer");var C=_.length;if(0<k){$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(d);var S=$('<div class="debug-message-array-rows"></div>').appendTo(D);D.addClass("debug-message-buffer-raw")}if(u)c=$('<span class="debug-message-type-meta"></span>').text(f||j+"["+k+"]").appendTo(n);else{c=$('<span class="debug-message-object-header"></span>').appendTo(n),$("<span>[ </span>").appendTo(c);var O=Math.min(k,10);for(l=0;l<O;l++)z(_[l]).appendTo(c),l<O-1&&$("<span>, </span>").appendTo(c);O<k&&$("<span> &hellip;</span>").appendTo(c),0===O&&$('<span class="debug-message-type-meta">empty</span>').appendTo(c),$("<span> ]</span>").appendTo(c)}0<k&&A(d,function(){if(u||(c=$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').text(f||j+"["+k+"]").appendTo(d)),"buffer"===j){var e=$('<div class="debug-message-string-rows"></div>').appendTo(D),t=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(e),o="";try{o=String.fromCharCode.apply(null,new Uint16Array(_))}catch(e){console.log(e)}$('<pre class="debug-message-type-string"></pre>').text(o).appendTo(t);var n=$('<span class="debug-message-buffer-opts"></span>').appendTo(c),a=$('<a href="#"></a>').addClass("selected").text("raw").appendTo(n).click(function(e){e.preventDefault(),e.stopPropagation(),U(D,$(this),g,h,!0)});U(D,a,g,h,!1)}var i;if(C<=10)for(l=0;l<C;l++)i=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(S),w[h+"["+l+"]"]=r(_[l],{key:""+l,typeHint:"buffer"===j&&"hex",hideKey:!1,path:h+"["+l+"]",sourceId:g,rootPath:v,expandPaths:b,ontoggle:m,exposeApi:y}).appendTo(i);else{for(l=0;l<C;l+=10){var s=l;i=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(S),d=$("<span></span>").appendTo(i),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').appendTo(d),A(d,function(){var o=s,n=Math.min(C-1,s+9),a=i;return function(){for(var e=o;e<=n;e++){var t=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(a);w[h+"["+e+"]"]=r(_[e],{key:""+e,typeHint:"buffer"===j&&"hex",hideKey:!1,path:h+"["+e+"]",sourceId:g,rootPath:v,expandPaths:b,ontoggle:m,exposeApi:y}).appendTo(t)}}}(),function(){var t=t+"["+l+"]";return function(e){m&&m(t,e)}}(),B(p,b,s,Math.min(C-1,s+9))),$('<span class="debug-message-object-key"></span>').html("["+s+" &hellip; "+Math.min(C-1,s+9)+"]").appendTo(d)}C<k&&$('<div class="debug-message-object-entry collapsed"><span class="debug-message-object-key">['+C+" &hellip; "+k+"]</span></div>").appendTo(S)}},function(e){m&&m(h,e)},B(p,b))}else if("object"==typeof o){D.addClass("collapsed");var L=Object.keys(o);if((u||0<L.length)&&($('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(d),A(d,function(){for(u||$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').text("object").appendTo(d),l=0;l<L.length;l++){var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(D),t=h;void 0!==t&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(L[l])?t+=(0<t.length?".":"")+L[l]:t+='["'+L[l].replace(/"/,'\\"')+'"]'),w[t]=r(o[L[l]],{key:L[l],typeHint:!1,hideKey:!1,path:t,sourceId:g,rootPath:v,expandPaths:b,ontoggle:m,exposeApi:y}).appendTo(e)}0===L.length&&$('<div class="debug-message-object-entry debug-message-type-meta collapsed"></div>').text("empty").appendTo(D)},function(e){m&&m(h,e)},B(p,b))),u)$('<span class="debug-message-type-meta"></span>').text("object").appendTo(n);else{c=$('<span class="debug-message-object-header"></span>').appendTo(n),$("<span>{ </span>").appendTo(c);var P=Math.min(L.length,5);for(l=0;l<P;l++)$('<span class="debug-message-object-key"></span>').text(L[l]).appendTo(c),$("<span>: </span>").appendTo(c),z(o[L[l]]).appendTo(c),l<P-1&&$("<span>, </span>").appendTo(c);L.length>P&&$("<span> &hellip;</span>").appendTo(c),0===P&&$('<span class="debug-message-type-meta">empty</span>').appendTo(c),$("<span> }</span>").appendTo(c)}}else $('<span class="debug-message-type-other"></span>').text(""+o).appendTo(n);return y&&D.prop("expand",function(){return function(e,t){if(h===e)d.prop("toggle")&&d.prop("toggle")(t);else if(w[e]&&w[e].prop("expand"))w[e].prop("expand")(e,t);else for(var o in w)if(w.hasOwnProperty(o)&&0===e.indexOf(o)){w[o].prop("expand")&&w[o].prop("expand")(e,t);break}}}),D},getMessageProperty:F,normalisePropertyExpression:J,validatePropertyExpression:function(e){try{return J(e),!0}catch(e){return!1}},separateIconPath:r,getDefaultNodeIcon:n,getNodeIcon:function(e,t){return"config"===e.category?RED.settings.apiRootUrl+"icons/node-red/cog.png":t&&"tab"===t.type?RED.settings.apiRootUrl+"icons/node-red/subflow.png":t&&"unknown"===t.type?RED.settings.apiRootUrl+"icons/node-red/alert.png":t&&t.icon&&a(o=r(t.icon))?"font-awesome"===o.module?t.icon:RED.settings.apiRootUrl+"icons/"+t.icon:a(o=n(e,t))?"font-awesome"===o.module?o.module+"/"+o.file:RED.settings.apiRootUrl+"icons/"+o.module+"/"+o.file:(o.module="node-red",a(o)?RED.settings.apiRootUrl+"icons/"+o.module+"/"+o.file:"subflows"===e.category?RED.settings.apiRootUrl+"icons/node-red/subflow.png":RED.settings.apiRootUrl+"icons/node-red/arrow-in.png");var o},getNodeLabel:function(t,o){var n;if(o=o||"","tab"===t.type)n=t.label||o;else{n=t._def.label;try{n=("function"==typeof n?n.call(t):n)||o}catch(e){console.log("Definition error: "+t.type+".label",e),n=o}}return RED.text.bidi.enforceTextDirectionWithUCC(n)},getNodeColor:function(e,t){var o=t.color,n=RED.settings.theme("palette.theme")||[];if(0<n.length){if(!l.hasOwnProperty(e)){l[e]=t.color;for(var a=n.length,i=0;i<a;i++){var s=n[i];if((!s.hasOwnProperty("category")||(s.hasOwnProperty("_category")||(s._category=new RegExp(s.category)),s._category.test(t.category)))&&(!s.hasOwnProperty("type")||(s.hasOwnProperty("_type")||(s._type=new RegExp(s.type)),s._type.test(e)))){l[e]=s.color||t.color;break}}}o=l[e]}return o||"#ddd"},addSpinnerOverlay:function(e,t){var o=$('<div class="projects-dialog-spinner "><img src="red/images/spin.svg"/></div>').appendTo(e);return t&&o.addClass("projects-dialog-spinner-contain"),o},decodeObject:function(e,t){if("number"===t&&"NaN"===e)e=Number.NaN;else if("number"===t&&"Infinity"===e)e=1/0;else if("number"===t&&"-Infinity"===e)e=-1/0;else if("Object"===t||/^array/.test(t)||"boolean"===t||"number"===t)e=JSON.parse(e);else if(/error/i.test(t))e=((e=JSON.parse(e)).name?e.name+": ":"")+e.message;else if("null"===t)e=null;else if("undefined"===t)e=void 0;else if(/^buffer/.test(t)){var o=e;e=[];for(var n=0;n<o.length;n+=2)e.push(parseInt(o.substr(n,2),16))}return e},parseContextKey:function(e){var t={},o=/^#:\((\S+?)\)::(.*)$/.exec(e);return o?(t.store=o[1],t.key=o[2]):(t.key=e,RED.settings.context&&(t.store=RED.settings.context.default)),t},createIconElement:function(e,t,o){var n=t.find(".palette_icon");0!==n.length&&n.remove(),0!==(i=t.find("i")).length&&i.remove();var a=r(e);if("font-awesome"===a.module){if(RED.nodes.fontAwesome.getIconUnicode(a.file)){var i,s=o?"fa-lg ":"";return void(i=$("<i/>").appendTo(t)).addClass("palette_icon_fa fa fa-fw "+s+a.file)}e=RED.settings.apiRootUrl+"icons/node-red/arrow-in.png"}$("<div/>",{class:"palette_icon"}).appendTo(t).css("backgroundImage","url("+e+")")},sanitize:N}}(),function(r){r.widget("nodered.editableList",{_create:function(){var e,o=this;(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),!1!==this.options.addButton)&&(e="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",r('<a href="#" class="editor-button editor-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+e+"</a>").appendTo(this.topContainer).click(function(e){e.preventDefault(),o.addItem({})}));"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(e){var t=o.element.css(e);"auto"!==t&&""!==t&&(o.topContainer.css(e,t),o.uiContainer.css(e,"0"),o.element.css(e,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var t=this.element.css("minHeight");"0px"!==t&&(this.uiContainer.css("minHeight",t),this.element.css("minHeight",0));var n=this.element.css("maxHeight");"0px"!==n&&(this.uiContainer.css("maxHeight",n),this.element.css("maxHeight",null)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var a,i=this.element.attr("style");if(null!==(a=/width\s*:\s*(\d+%)/i.exec(i))&&(this.element.width("100%"),this.uiContainer.width(a[1])),this.options.sortable){var s={axis:"y",update:function(e,t){o.options.sortItems&&o.options.sortItems(o.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(s.connectWith=this.options.connectWith),this.element.sortable(s)}this._resize()},_resize:function(){var e=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-e),this.options.resize&&this.options.resize(),this.options.resizeItem){var t=this;this.element.children().each(function(e){t.options.resizeItem(r(this).find(".red-ui-editableList-item-content"),e)})}},_destroy:function(){},_refreshFilter:function(){var n=this,a=0;return this.activeFilter?(this.items().each(function(e,t){var o=t.data("data");try{n.activeFilter(o)?(t.parent().show(),a++):t.parent().hide()}catch(e){console.log(e),t.parent().show(),a++}}),a):this.element.children().show()},_refreshSort:function(){if(this.activeSort){var e=this.element.children(),o=this;e.sort(function(e,t){return o.activeSort(r(e).find(".red-ui-editableList-item-content").data("data"),r(t).find(".red-ui-editableList-item-content").data("data"))}),r.each(e,function(e,t){o.element.append(t)})}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},addItem:function(n){var a=this;n=n||{};var i=r("<li>"),s=!1;if(this.activeSort){this.items().each(function(e,t){if(!s){var o=t.data("data");a.activeSort(n,o)<0&&(i.insertBefore(t.closest("li")),s=!0)}})}s||i.appendTo(this.element);var o=r("<div/>").addClass("red-ui-editableList-item-content").appendTo(i);if(o.data("data",n),!0===this.options.sortable&&(r('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(i),i.addClass("red-ui-editableList-item-sortable")),this.options.removable){var e=r("<a/>",{href:"#",class:"red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(i);r("<i/>",{class:"fa fa-remove"}).appendTo(e),i.addClass("red-ui-editableList-item-removable"),e.click(function(e){e.preventDefault();var t=o.data("data");i.addClass("red-ui-editableList-item-deleting"),i.fadeOut(300,function(){r(this).remove(),a.options.removeItem&&a.options.removeItem(t)})})}if(this.options.addItem){var t=a.element.children().length-1;setTimeout(function(){if(a.options.addItem(o,t,n),a.activeFilter)try{a.activeFilter(n)||i.hide()}catch(e){}!a.activeSort&&a.scrollOnAdd&&setTimeout(function(){a.uiContainer.scrollTop(a.element.height())},0)},0)}},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t){this.element.children().filter(function(e){return t===r(this).find(".red-ui-editableList-item-content").data("data")}).remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map(function(e){return r(this).find(".red-ui-editableList-item-content")})},empty:function(){this.element.empty()},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length},show:function(t){var e=this.element.children().filter(function(e){return t===r(this).find(".red-ui-editableList-item-content").data("data")});0<e.length&&this.uiContainer.scrollTop(this.uiContainer.scrollTop()+e.position().top)}})}(jQuery),function(l){l.widget("nodered.treeList",{_create:function(){var n=this;this.element.addClass("red-ui-treeList");var e=l("<div>",{class:"red-ui-treeList-container"}).appendTo(this.element);this._data=[],this._topList=l("<ol>").css({position:"absolute",top:0,left:0,right:0,bottom:0}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,height:"100%",addItem:function(e,t,o){n._addSubtree(e,o,0)}}),this.options.data&&this.data(this.options.data)},_addChildren:function(e,t,n){for(var a=this,o=l("<ol>").appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,height:"auto",addItem:function(e,t,o){a._addSubtree(e,o,n+1)}}),i=0;i<t.length;i++)o.editableList("addItem",t[i])},_addSubtree:function(n,a,i){var s=this,e="<label>";a.children&&a.hasOwnProperty("selected")&&(e="<div>");var t=l(e,{tabindex:"0",class:"red-ui-treeList-label"}).appendTo(n);if(a.class&&t.addClass(a.class),t.css({paddingLeft:15*i+"px"}),t.on("mouseover",function(e){s._trigger("itemmouseover",e,a)}),t.on("mouseout",function(e){s._trigger("itemmouseout",e,a)}),a.children?(l('<span class="red-ui-treeList-icon"><i class="fa fa-angle-right" /></span>').appendTo(t),t.click(function(e){if(!n.hasClass("built")&&"function"==typeof a.children){n.addClass("built");var t,o=!1;a.children(function(e){o=!0,s._addChildren(n,e,i),t&&t.remove()}),o||(t=l('<div class="red-ui-treeList-spinner">').css({"background-position":35+15*i+"px 50%"}).appendTo(n))}n.toggleClass("expanded")})):l('<span class="red-ui-treeList-icon"></span>').appendTo(t),a.hasOwnProperty("selected")){var o=l('<span class="red-ui-treeList-icon"></span>').appendTo(t),r=l('<input type="checkbox">').prop("checked",a.selected).appendTo(o);r.on("click",function(e){e.stopPropagation()}),r.on("change",function(e){a.selected=this.checked,s._trigger("select",e,a)})}else a.children||t.click(function(e){s._trigger("select",e,a)});a.icon&&l('<span class="red-ui-treeList-icon"><i class="'+a.icon+'" /></span>').appendTo(t),l('<span class="red-ui-treeList-label-text"></span>').text(a.label).appendTo(t),a.children&&(Array.isArray(a.children)&&s._addChildren(n,a.children,i),a.expanded&&t.click())},empty:function(){this._topList.editableList("empty")},data:function(e){if(void 0===e)return this._data;this._data=e,this._topList.editableList("empty");for(var t=0;t<e.length;t++)this._topList.editableList("addItem",e[t])},show:function(e){for(var t=0;t<this._data.length;t++)this._data[t].id===e&&this._topList.editableList("show",this._data[t])}})}(jQuery),function(t){t.widget("nodered.checkboxSet",{_create:function(){var o=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var e=this.element.prop("checked");this.options=[t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],e?this.options[1].show():this.options[0].show(),this.element.change(function(){this.checked?(o.options[0].hide(),o.options[1].show()):(o.options[1].hide(),o.options[0].show()),o.options[2].hide();var t=this.checked;o.children.forEach(function(e){e.checkboxSet("state",t,!1,!0)})}),this.uiElement.click(function(e){e.stopPropagation(),o.state(!1===o.state())}),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){var t=this.children.indexOf(e);-1<t&&this.children.splice(t,1)},updateChild:function(e){var o=0;this.children.forEach(function(e,t){!0===e.checkboxSet("state")&&o++}),0===o?this.state(!1,!0):o===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,o){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var n=this.partialFlag||e;this.element.prop("checked",n),!0===e?(this.options[0].hide(),this.options[1].show(),this.options[2].hide()):!1===e?(this.options[2].hide(),this.options[1].hide(),this.options[0].show()):null===e&&(this.options[0].hide(),this.options[1].hide(),this.options[2].show()),t||this.element.trigger("change",null),!o&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){var l={};function d(a){var e,t;if(null!==a&&a.id&&!1===RED.settings.theme("menu."+a.id))return null;if(null===a)e=$('<li class="divider"></li>');else{e=$("<li></li>"),a.group&&e.addClass("menu-group-"+a.group);var o="<a "+(a.id?'id="'+a.id+'" ':"")+'tabindex="-1" href="#">';a.toggle&&(o+='<i class="fa fa-square pull-left"></i>',o+='<i class="fa fa-check-square pull-left"></i>'),void 0!==a.icon&&(/\.png/.test(a.icon)?o+='<img src="'+a.icon+'"/> ':o+='<i class="'+(a.icon?a.icon:'" style="display: inline-block;"')+'"></i> '),a.sublabel?o+='<span class="menu-label-container"><span class="menu-label">'+a.label+'</span><span class="menu-sublabel">'+a.sublabel+"</span></span>":o+='<span class="menu-label">'+a.label+"</span>",o+="</a>";var n=$(o).appendTo(e);if((l[a.id]=a).onselect?(n.click(function(e){if(e.preventDefault(),!$(this).parent().hasClass("disabled"))if(a.toggle){var t=p(a.id);if("string"==typeof a.toggle){if(!t){for(var o in l)if(l.hasOwnProperty(o)){var n=l[o];n.id!=a.id&&a.toggle==n.toggle&&u(n.id,!1)}u(a.id,!0)}}else u(a.id,!t)}else c(a.id)}),a.toggle&&(t=RED.settings.get("menu-"+a.id),a.setting&&(null!==t?(RED.settings.set(a.setting,t),RED.settings.remove("menu-"+a.id)):t=RED.settings.get(a.setting)),t?(n.addClass("active"),c(a.id,!0)):!1===t?(n.removeClass("active"),c(a.id,!1)):a.hasOwnProperty("selected")&&(a.selected?n.addClass("active"):n.removeClass("active"),c(a.id,a.selected)))):a.href?n.attr("target","_blank").attr("href",a.href):a.options||(e.addClass("disabled"),n.click(function(e){e.preventDefault()})),a.options){e.addClass("dropdown-submenu pull-left");for(var i=$('<ul id="'+a.id+'-submenu" class="dropdown-menu"></ul>').appendTo(e),s=0;s<a.options.length;s++){var r=d(a.options[s]);r&&r.appendTo(i)}}a.disabled&&e.addClass("disabled")}return e}function c(e,t){var o=l[e],n=o.onselect;"string"==typeof o.onselect&&(n=RED.actions.get(o.onselect)),n?n.call(o,t):console.log("No callback for",e,o.onselect)}function p(e){return $("#"+e).hasClass("active")}function u(e,t){if(p(e)!=t){var o=l[e];t?$("#"+e).addClass("active"):$("#"+e).removeClass("active"),o&&o.onselect&&c(o.id,t),RED.settings.set(o.setting||"menu-"+o.id,t)}}return{init:function(e){var t=$("<ul/>",{class:"dropdown-menu pull-right"});if(e.id){t.attr({id:e.id+"-submenu"});var o=$("#"+e.id);1===o.length&&t.insertAfter(o)}for(var n=!1,a=0;a<e.options.length;a++){var i=e.options[a];if(null!==i||!n){var s=d(i);s&&(s.appendTo(t),n=null===i)}}return t},setSelected:u,isSelected:p,toggleSelected:function(e){u(e,!p(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(e,t){var o=d(t);if(t.group){var n=$("#"+e+"-submenu").children(".menu-group-"+t.group);if(0===n.length)o.appendTo("#"+e+"-submenu");else{for(var a=0;a<n.length;a++){var i=n[a],s=$(i).find(".menu-label").html();if(t.label<s){$(i).before(o);break}}a===n.length&&o.appendTo("#"+e+"-submenu")}}else o.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(e,t){var o=l[e];o&&(o.onselect=t)}}}(),RED.panels={create:function(i){var s=i.container||$("#"+i.id),r=s.children();if(2!==r.length)throw new Error("Container must have exactly two children");var l=!i.dir||"vertical"===i.dir;s.addClass("red-ui-panels"),l||s.addClass("red-ui-panels-horizontal");var d,t=$('<div class="red-ui-panels-separator"></div>').insertAfter(r[0]),c=[],n=!1,p=.5;t.draggable({axis:l?"y":"x",containment:s,scroll:!1,start:function(e,t){d=l?t.position.top:t.position.left,c=[l?$(r[0]).height():$(r[0]).width(),l?$(r[1]).height():$(r[1]).width()]},drag:function(e,t){var o=l?s.height():s.width(),n=(l?t.position.top:t.position.left)-d,a=[c[0]+n,c[1]-n];l?($(r[0]).height(a[0]),$(r[1]).height(a[1]),t.position.top-=n):($(r[0]).width(a[0]),$(r[1]).width(a[1]),t.position.left-=n),i.resize&&i.resize(a[0],a[1]),p=a[0]/(o-8)},stop:function(e,t){n=!0}});var o={ratio:function(e){n=!0,0===(p=e)||1===e?t.hide():t.show(),l?o.resize(s.height()):o.resize(s.width())},resize:function(e){var t;if(l?(t=[$(r[0]).height(),$(r[1]).height()],s.height(e)):(t=[$(r[0]).width(),$(r[1]).width()],s.width(e)),n){var o=p*(e-8);t=[o,e-o-8],l?($(r[0]).outerHeight(t[0]),$(r[1]).outerHeight(t[1])):($(r[0]).outerWidth(t[0]),$(r[1]).outerWidth(t[1]))}i.resize&&i.resize(t[0],t[1])}};return o}},RED.popover=function(){var E={default:{top:10,topTop:30,leftRight:17,leftLeft:25,leftBottom:8,leftTop:11},small:{top:6,topTop:20,leftRight:8,leftLeft:26,leftBottom:8,leftTop:9}};return{create:function(e){var h=e.target,g=e.direction||"right",t=e.trigger,v=e.content,o=e.delay||{show:750,hide:50},n=e.autoClose,b=e.width||"auto",m=e.size||"default";if(!E[m])throw new Error("Invalid RED.popover size value:",m);var y,w,a=null,i=function(e){if(y){if(w=$('<div class="red-ui-popover"></div>'),"default"!==m&&w.addClass("red-ui-popover-size-"+m),"function"==typeof v){var t=v.call(D);if(null===t)return;"string"==typeof t?w.text(t):w.append(t)}else w.html(v);"auto"!==b&&w.width(b),w.appendTo("body");var o=h.offset(),n=h.outerWidth(),a=h.outerHeight(),i=w.height(),s=w.width(),r=$(window).scrollTop(),l=$(window).scrollLeft(),d=r+$(window).height(),c=l+$(window).width(),p=0,u=0,f=g;"right"===f?(p=o.top+a/2-i/2-E[m].top,u=o.left+n+E[m].leftRight):"left"===f?(p=o.top+a/2-i/2-E[m].top,u=o.left-E[m].leftLeft-s):"bottom"===f?(p=o.top+a+E[m].top,(u=o.left+n/2-s/2-E[m].leftBottom)<0?(f="right",p=o.top+a/2-i/2-E[m].top,u=o.left+n+E[m].leftRight):c<u+s?(f="left",p=o.top+a/2-i/2-E[m].top,u=o.left-E[m].leftLeft-s,d<p+i+a/2+5&&(p-=p+i+a/2-d+5)):d<p+i&&(f="top",p=o.top-E[m].topTop-i,u=o.left+n/2-s/2-E[m].leftTop)):"top"===f&&(p=o.top-E[m].topTop-i,u=o.left+n/2-s/2-E[m].leftTop,p<0&&(f="bottom",p=o.top+a+E[m].top,u=o.left+n/2-s/2-E[m].leftBottom)),w.addClass("red-ui-popover-"+f).css({top:p,left:u}),e?w.show():w.fadeIn("fast")}},s=function(e){$(document).off("mousedown.modal-popover-close"),y||w&&(e?w.remove():w.fadeOut("fast",function(){$(this).remove()}),w=null)};"hover"===t?(h.on("mouseenter",function(e){clearTimeout(a),y=!0,a=setTimeout(i,o.show)}),h.on("mouseleave disabled",function(e){a&&clearTimeout(a),y&&(y=!1,setTimeout(s,o.hide))})):"click"===t?(h.click(function(e){e.preventDefault(),e.stopPropagation(),(y=!y)?i():s()}),n&&h.on("mouseleave disabled",function(e){a&&clearTimeout(a),y&&(y=!1,setTimeout(s,n))})):"modal"===t?$(document).on("mousedown.modal-popover-close",function(e){for(var t=e.target;"BODY"!==t.nodeName&&t!==w[0];)t=t.parentElement;"BODY"===t.nodeName&&(y=!1,s())}):n&&setTimeout(function(){y=!1,s()},n);var D={setContent:function(e){return v=e,D},open:function(e){return y=!0,i(e),D},close:function(e){return y=!1,s(e),D}};return D},tooltip:function(e,o,n){var t=o;return n&&(t=function(){var e=o,t=RED.keyboard.getShortcut(n);return t&&t.key&&(e=$("<span>"+o+' <span class="red-ui-popover-key">'+RED.keyboard.formatKey(t.key,!0)+"</span></span>")),e}),RED.popover.create({target:e,trigger:"hover",size:"small",direction:"bottom",content:t,delay:{show:750,hide:50}})}}}(),function(o){o.widget("nodered.searchBox",{_create:function(){var t=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),o('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=o('<a href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.focus()}),this.resultCount=o("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(e){27===e.keyCode&&t.element.val("")}),this.element.on("keyup",function(e){t._change(o(this).val())}),this.element.on("focus",function(){o("body").one("mousedown",function(){t.element.blur()})})},_change:function(e,t){var o=!1;o=""===e?(this.clearButton.hide(),!0):(this.clearButton.show(),e.length>=(this.options.minimumLength||0));var n=this.element.val();if(o=o&&n!==this.lastSent)if(!t&&0<this.options.delay){clearTimeout(this.currentTimeout);var a=this;this.currentTimeout=setTimeout(function(){a.lastSent=a.element.val(),a._trigger("change")},this.options.delay)}else this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){null==e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){var k="fa fa-lemon-o";return{create:function(u){var s,f,n,a,h={},g=0,r=0,v=u.element||$("#"+u.id),l=v.wrap("<div>").parent(),b=v.wrap("<div>").parent();if(l.addClass("red-ui-tabs"),u.vertical&&l.addClass("red-ui-tabs-vertical"),u.addButton){l.addClass("red-ui-tabs-add");var e=$('<div class="red-ui-tab-button red-ui-tabs-add"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(l);if(e.find("a").click(function(e){e.preventDefault(),"function"==typeof u.addButton?u.addButton():"string"==typeof u.addButton&&RED.actions.invoke(u.addButton)}),"string"==typeof u.addButton){var t=u.addButton;u.addButtonCaption&&(t=u.addButtonCaption),RED.popover.tooltip(e,t,u.addButton)}v.on("dblclick",function(e){var t=v.children(),o=e.clientX,n=0;t.each(function(e){if($(this).offset().left>o)return!1;n=e+1}),"function"==typeof u.addButton?u.addButton({index:n}):"string"==typeof u.addButton&&RED.actions.invoke(u.addButton,{index:n})})}if(u.searchButton){l.addClass("red-ui-tabs-search");var o=$('<div class="red-ui-tab-button red-ui-tabs-search"><a href="#"><i class="fa fa-list-ul"></i></a></div>').appendTo(l);o.find("a").click(function(e){e.preventDefault(),"function"==typeof u.searchButton?u.searchButton():"string"==typeof u.searchButton&&RED.actions.invoke(u.searchButton)}),"string"==typeof u.searchButton&&(t=u.searchButton,u.searchButtonCaption&&(t=u.searchButtonCaption),RED.popover.tooltip(o,t,u.searchButton))}if(u.scrollable&&(l.addClass("red-ui-tabs-scrollable"),b.addClass("red-ui-tabs-scroll-container"),b.scroll(p),(n=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(l).find("a")).on("mousedown",function(e){i(e,"-=150")}).on("click",function(e){e.preventDefault()}),(a=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(l).find("a")).on("mousedown",function(e){i(e,"+=150")}).on("click",function(e){e.preventDefault()})),u.collapsible){l.addClass("red-ui-tabs-collapsible");var m=$('<div class="red-ui-tab-link-buttons"></div>').appendTo(l);if(!1!==u.menu){var d=$('<a href="#"><i class="fa fa-caret-down"></i></a>').appendTo(m);d.addClass("red-ui-tab-link-button-menu"),d.click(function(e){if(e.stopPropagation(),e.preventDefault(),!f){var a=[],i=[];v.children().each(function(e,t){var o=$(t).data("tabId"),n={id:"red-ui-tabs-menu-option-"+o,icon:h[o].iconClass||k,label:h[o].name,onselect:function(){E(o)}};h[o].pinned?a.push(n):i.push(n)}),i=a.concat(i),(f=RED.menu.init({id:"debug-message-option-menu",options:i})).css({position:"absolute"}),f.appendTo("body")}var t=d.offset();f.css({top:t.top+d.height()-2+"px",left:t.left-f.width()+d.width()+"px"}),f.is(":visible")?$(document).off("click.tabmenu"):$(document).on("click.tabmenu",function(e){$(document).off("click.tabmenu"),f.hide()}),f.toggle()})}}function i(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var o=b.scrollLeft();b.animate({scrollLeft:t},100);var n=setInterval(function(){var e=b.scrollLeft();e!==o?(o=e,b.animate({scrollLeft:t},100)):clearInterval(n)},100);$(this).one("mouseup",function(){clearInterval(n)})}}function c(){var e=v.find("li.red-ui-tab.selected"),t=[];return e.each(function(){t.push(h[$(this).find("a").attr("href").slice(1)])}),t}function y(){u.onselect(c())}function w(e){e.preventDefault();var t=v.find("li.red-ui-tab.active"),o=$(this).parent(),n=!1;if(u.onselect)if(e.metaKey){if(o.hasClass("selected")){if(o.removeClass("selected"),o[0]!==t[0])return void y();if(0===(s=v.find("li.red-ui-tab.selected")).length)return void y();o=s.first()}else t.hasClass("selected")||(h[t.find("a").attr("href").slice(1)],t.addClass("selected")),o.addClass("selected");n=!0}else if(e.shiftKey){var a,i;t[0]!==o[0]&&(i=t.index()<o.index()?(a=t,o):(a=o,t),v.find("li.red-ui-tab").removeClass("selected"),a.addClass("selected"),i.addClass("selected"),a.nextUntil(i).addClass("selected")),n=!0}else{var s;0<(s=v.find("li.red-ui-tab.selected")).length&&(s.removeClass("selected"),n=!0)}var r=o.find("a");return u.onclick&&u.onclick(h[r.attr("href").slice(1)]),E(r),n&&y(),!1}function p(){if(0!==v.children().length){var e=b.scrollLeft(),t=b.width(),o=v.width();0===e?n.hide():n.show(),e===o-t?a.hide():a.show()}}function D(e){if(e.preventDefault(),e.stopPropagation(),!e.metaKey&&!e.shiftKey)return u.ondblclick&&u.ondblclick(h[$(this).attr("href").slice(1)]),!1}function E(e){if("string"==typeof e&&(e=v.find("a[href='#"+e+"']")),0!==e.length&&!e.parent().hasClass("active")){v.children().removeClass("active"),v.children().css({transition:"width 100ms"}),e.parent().addClass("active");var t=e.parent().attr("id");if(l.find(".red-ui-tab-link-button").removeClass("active selected"),$("#"+t+"-link-button").addClass("active selected"),u.scrollable){var o=e.parent().position().left;o-21<0?b.animate({scrollLeft:"+="+(o-50)},300):o+120>b.width()&&b.animate({scrollLeft:"+="+(o+140-b.width())},300)}u.onchange&&u.onchange(h[e.attr("href").slice(1)]),R(),setTimeout(function(){v.children().css({transition:""})},100)}}function R(){if(!u.vertical){var e=v.find("li.red-ui-tab"),t=l.width(),o=e.size();if(u.collapsible){if((a=t-m.width()-10)<198){for(var n=m.find("a:last").prev();n.is(":not(:visible)");)n=n.prev();n.hasClass("red-ui-tab-link-button-pinned")||n.hide(),a=t-m.width()-10}else 40<t-198-m.width()&&(m.find("a:not(:visible):first").show(),a=t-m.width()-10);e.css({width:a})}else{var a;if(r=(s=100*(a=(t-12-6*o)/o)/t+"%")+"%",u.scrollable){a=Math.max(a,140),s=a+"px",r=0;var i=Math.max(l.width(),12+(a+6)*o);v.width(i),p()}else u.hasOwnProperty("minimumActiveTabWidth")&&(r=a<u.minimumActiveTabWidth?(o-=1,a=(t-12-u.minimumActiveTabWidth-6*o)/o,s=100*a/t+"%",u.minimumActiveTabWidth+"px"):0);e.css({width:s}),a<50?(v.find(".red-ui-tab-icon").hide(),v.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,a-38))+"px"})):(v.find(".red-ui-tab-icon").show(),v.find(".red-ui-tab-label").css({paddingLeft:""})),0!==r&&(v.find("li.red-ui-tab.active").css({width:u.minimumActiveTabWidth}),v.find("li.red-ui-tab.active .red-ui-tab-icon").show(),v.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}}function x(e){if(u.onselect){var t=v.find("li.red-ui-tab.selected");0<t.length&&(t.removeClass("selected"),y())}var o=v.find("a[href='#"+e+"']").parent();if(o.hasClass("active")){var n=o.prev();0===n.size()&&(n=o.next()),E(n.find("a"))}o.remove(),h[e].pinned&&g--,u.onremove&&u.onremove(h[e]),delete h[e],R(),f=null}return v.children().first().addClass("active"),v.children().addClass("red-ui-tab"),v.find("li.red-ui-tab a").on("click",w).on("dblclick",D),setTimeout(function(){R()},0),{addTab:function(t,e){if(u.onselect){var o=v.find("li.red-ui-tab.selected");0<o.length&&(o.removeClass("selected"),y())}h[t.id]=t;var n=$("<li/>",{class:"red-ui-tab"});0===v.children().length&&(e=void 0),0===e?n.prependTo(v):0<e?n.insertAfter(v.find("li:nth-child("+e+")")):n.appendTo(v),n.attr("id","red-ui-tab-"+t.id.replace(".","-")),n.data("tabId",t.id),u.maximumTabWidth&&n.css("maxWidth",u.maximumTabWidth+"px");var a=$("<a/>",{href:"#"+t.id,class:"red-ui-tab-label"}).appendTo(n);if(t.icon?$('<img src="'+t.icon+'" class="red-ui-tab-icon"/>').appendTo(a):t.iconClass&&$("<i>",{class:"red-ui-tab-icon "+t.iconClass}).appendTo(a),$("<span/>",{class:"bidiAware"}).text(t.label).appendTo(a).attr("dir",RED.text.bidi.resolveBaseTextDir(t.label)),u.collapsible){n.addClass("red-ui-tab-pinned");var i=$('<a href="#'+t.id+'" class="red-ui-tab-link-button"></a>');t.pinned?0===g?i.prependTo(m):i.insertAfter(m.find("a.red-ui-tab-link-button-pinned:last")):!1!==u.menu?i.insertBefore(m.find("a:last")):i.appendTo(m),i.attr("id",n.attr("id")+"-link-button"),t.iconClass?$("<i>",{class:t.iconClass}).appendTo(i):$("<i>",{class:k}).appendTo(i),i.click(function(e){e.preventDefault(),E(t.id)}),t.pinned&&(i.addClass("red-ui-tab-link-button-pinned"),g++),RED.popover.tooltip($(i),t.name,t.action)}if(a.on("click",w),a.on("dblclick",D),t.closeable){n.addClass("red-ui-tabs-closeable");var s=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(n);s.append('<i class="fa fa-times" />'),s.on("click",function(e){e.preventDefault(),x(t.id)})}var r=$('<span class="red-ui-tabs-badges"></span>').appendTo(n);if(u.onselect&&($('<i class="red-ui-tabs-badge-changed fa fa-circle"></i>').appendTo(r),$('<i class="red-ui-tabs-badge-selected fa fa-check-circle"></i>').appendTo(r)),u.onadd&&u.onadd(t),a.attr("title",t.label),1==v.find("li.red-ui-tab").size()&&E(a),u.onreorder){var l,d,c,p=[];n.draggable({axis:"x",distance:20,start:function(e,t){l=[],p=[],v.children().each(function(e){p[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(n)&&(c=d=e),l.push($(this).data("tabId"))}),v.children().each(function(e){e!==d&&$(this).css({position:"absolute",left:p[e].left+"px",width:p[e].width+2,transition:"left 0.3s"})}),n.hasClass("active")||n.css({zIndex:1})},drag:function(e,t){t.position.left+=p[d].left+b.scrollLeft();for(var o=t.position.left+p[d].width/2-b.scrollLeft(),n=0;n<p.length;n++)if(n!==d&&o>p[n].left&&o<p[n].left+p[n].width){n<d?(p[n].left+=p[d].width+8,p[d].el.detach().insertBefore(p[n].el)):(p[n].left-=p[d].width+8,p[d].el.detach().insertAfter(p[n].el)),p[n].el.css({left:p[n].left+"px"}),p.splice(n,0,p.splice(d,1)[0]),d=n;break}},stop:function(e,t){v.children().css({position:"relative",left:"",transition:""}),n.hasClass("active")||n.css({zIndex:""}),R(),c!==d&&u.onreorder(l,$.makeArray(v.children().map(function(){return $(this).data("tabId")}))),E(p[d].el.data("tabId"))}})}setTimeout(function(){R()},10),f=null},removeTab:x,activateTab:E,nextTab:function(){var e=v.find("li.active").next();0<e.length&&E(e.find("a"))},previousTab:function(){var e=v.find("li.active").prev();0<e.length&&E(e.find("a"))},resize:R,count:function(){return v.find("li.red-ui-tab").size()},contains:function(e){return 0<v.find("a[href='#"+e+"']").length},renameTab:function(e,t){h[e].label=t;var o=v.find("a[href='#"+e+"']");o.attr("title",t),o.find("span.bidiAware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),R()},selection:c,order:function(e){var t=$.makeArray(v.children().map(function(){return $(this).data("tabId")}));if(t.length===e.length){var o,n=!0;for(o=0;o<e.length;o++)if(e[o]!==t[o]){n=!1;break}if(!n){var a={};for(v.children().detach().each(function(){a[$(this).data("tabId")]=$(this)}),o=0;o<e.length;o++)a[e[o]].appendTo(v)}}}}}}}(),RED.stack={create:function(n){var a=n.container;a.addClass("red-ui-stack");var i=0,s=[],r=!0,l=function(){if(0<s.length){var t=0;s.forEach(function(e){t+=e.header.outerHeight()});var e=a.innerHeight();i=e-t-(s.length-1),s.forEach(function(e){e.contentWrap.height(i)})}};return n.fill&&n.singleExpanded&&($(window).resize(l),$(window).focus(l)),{add:function(t){s.push(t),t.container=$('<div class="palette-category">').appendTo(a),r||t.container.hide();var e=$('<div class="palette-header"></div>').appendTo(t.container);if(t.header=e,t.contentWrap=$("<div></div>",{style:"position:relative"}).appendTo(t.container),n.fill&&t.contentWrap.css("height",i),t.content=$("<div></div>").appendTo(t.contentWrap),!1!==t.collapsible){e.click(function(){if(n.singleExpanded)if(t.isExpanded())2===s.length&&(s[0]===t?(s[0].collapse(),s[1].expand()):(s[1].collapse(),s[0].expand()));else{for(var e=0;e<s.length;e++)s[e].isExpanded()&&s[e].collapse();t.expand()}else t.toggle()});var o=$('<i class="fa fa-angle-down"></i>').appendTo(e);t.expanded?(t.container.addClass("palette-category-expanded"),o.addClass("expanded")):t.contentWrap.hide()}else $('<i style="opacity: 0.5;" class="fa fa-angle-down expanded"></i>').appendTo(e),e.css("cursor","default");return t.title=$("<span></span>").html(t.title).appendTo(e),t.toggle=function(){return t.isExpanded()?(t.collapse(),!1):(t.expand(),!0)},t.expand=function(){if(!t.isExpanded())return t.onexpand&&t.onexpand.call(t),n.singleExpanded&&s.forEach(function(e){e!==t&&e.collapse()}),o.addClass("expanded"),t.container.addClass("palette-category-expanded"),t.contentWrap.slideDown(200),!0},t.collapse=function(){if(t.isExpanded())return o.removeClass("expanded"),t.container.removeClass("palette-category-expanded"),t.contentWrap.slideUp(200),!0},t.isExpanded=function(){return t.container.hasClass("palette-category-expanded")},n.fill&&n.singleExpanded&&l(),t},hide:function(){return r=!1,s.forEach(function(e){e.container.hide()}),this},show:function(){return r=!0,s.forEach(function(e){e.container.show()}),this},resize:function(){l()}}}},function(c){var e=function(e){var t=RED.utils.parseContextKey(e);return{option:t.store,value:t.key}},t=function(e,t){if(!t)return e;var o="string"==typeof t?t:t.value;return o!==RED.settings.context.default?"#:("+o+")::"+e:e},s={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression},flow:{value:"flow",label:"flow.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:e,export:t},global:{value:"global",label:"global.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:e,export:t},str:{value:"str",label:"string",icon:"red/images/typedInput/az.png"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.png",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.png",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var o=this,e=this.value();try{e=JSON.stringify(JSON.parse(e),null,4)}catch(e){}RED.editor.editJSON({value:e,complete:function(e){var t=e;try{t=JSON.stringify(JSON.parse(e))}catch(e){}o.value(t)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.png"},date:{value:"date",label:"timestamp",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.png",validate:function(e){try{return jsonata(e),!0}catch(e){return!1}},expand:function(){var t=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),complete:function(e){t.value(e.replace(/\n/g,"\t"))}})}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.png",expand:function(){var t=this;RED.editor.editBuffer({value:this.value(),complete:function(e){t.value(e)}})}},env:{value:"env",label:"env variable",icon:"red/images/typedInput/env.png"}},r=!1;c.widget("nodered.typedInput",{_create:function(){try{if(!r&&RED&&RED._){for(var e in s)s.hasOwnProperty(e)&&(s[e].label=RED._("typedInput.type."+e,{defaultValue:s[e].label}));var t=RED.settings.context.stores.map(function(e){return{value:e,label:e,icon:'<i class="red-ui-typedInput-icon fa fa-database" style="color: #'+("memory"===e?"ddd":"777")+'"></i>'}});t.length<2?(s.flow.options=[],s.global.options=[]):(s.flow.options=t,s.global.options=t)}r=!0;var o=this;this.disarmClick=!1,this.input=c('<input type="text"></input>'),this.input.insertAfter(this.element),this.input.val(this.element.val()),this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.input.wrap("<div>").parent().addClass("red-ui-typedInput-input"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var n,a=this.element.attr("style");if(null!==(n=/width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(a))?(this.input.css("width","100%"),this.uiSelect.width(n[1]),this.uiWidth=null):this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(e){var t=o.element.css("margin"+e);o.uiSelect.css("margin"+e,t),o.input.css("margin"+e,0)}),["type","placeholder"].forEach(function(e){var t=o.element.attr(e);o.input.attr(e,t)}),this.uiSelect.addClass("red-ui-typedInput-container"),this.element.attr("type","hidden"),this.options.types=this.options.types||Object.keys(s),this.selectTrigger=c('<button tabindex="0"></button>').prependTo(this.uiSelect),c('<i class="red-ui-typedInput-icon fa fa-sort-desc"></i>').toggle(1<this.options.types.length).appendTo(this.selectTrigger),this.selectLabel=c('<span class="red-ui-typedInput-type-label"></span>').appendTo(this.selectTrigger),this.types(this.options.types),this.options.typeField){this.typeField=c(this.options.typeField).hide();var i=this.typeField.val();i&&this.typeMap[i]&&(this.options.default=i)}else this.typeField=c("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.input.on("focus",function(){o.uiSelect.addClass("red-ui-typedInput-focus")}),this.input.on("blur",function(){o.uiSelect.removeClass("red-ui-typedInput-focus")}),this.input.on("change",function(){o.validate(),o.element.val(o.value()),o.element.trigger("change",o.propertyType,o.value())}),this.selectTrigger.click(function(e){e.preventDefault(),o._showTypeMenu()}),this.selectTrigger.on("keydown",function(e){40===e.keyCode&&o._showTypeMenu()}).on("focus",function(){o.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionSelectTrigger=c('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="red-ui-typedInput-icon fa fa-sort-desc"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=c('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),RED.popover.tooltip(this.optionSelectLabel,function(){return o.optionValue}),this.optionSelectTrigger.click(function(e){e.preventDefault(),o._showOptionSelectMenu()}).on("keydown",function(e){40===e.keyCode&&o._showOptionSelectMenu()}).on("blur",function(){o.uiSelect.removeClass("red-ui-typedInput-focus")}).on("focus",function(){o.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionExpandButton=c('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"><i class="red-ui-typedInput-icon fa fa-ellipsis-h"></i></button>').appendTo(this.uiSelect),this.type(this.options.default||this.typeList[0].value)}catch(e){console.log(e.stack)}},_showTypeMenu:function(){1<this.typeList.length?(this._showMenu(this.menu,this.selectTrigger),this.menu.find("[value='"+this.propertyType+"']").focus()):this.input.focus()},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectTrigger);var e=this.optionMenu.find("[value='"+this.optionValue+"']");0===e.length&&(e=this.optionMenu.children(":first")),e.focus()}},_hideMenu:function(e){c(document).off("mousedown.close-property-select"),e.hide(),this.elementDiv.is(":visible")?this.input.focus():this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.focus():this.selectTrigger.focus()},_createMenu:function(e,o){var n=this,a=c("<div>").addClass("red-ui-typedInput-options");return e.forEach(function(t){"string"==typeof t&&(t={value:t,label:t});var e=c('<a href="#"></a>').attr("value",t.value).appendTo(a);t.label&&e.text(t.label),t.icon?0===t.icon.indexOf("<")?c(t.icon).prependTo(e):-1!==t.icon.indexOf("/")?c("<img>",{src:t.icon,style:"margin-right: 4px; height: 18px;"}).prependTo(e):c("<i>",{class:"red-ui-typedInput-icon "+t.icon}).prependTo(e):e.css({paddingLeft:"18px"}),t.icon||t.label||e.text(t.value),e.click(function(e){e.preventDefault(),o(t.value),n._hideMenu(a)})}),a.css({display:"none"}),a.appendTo(document.body),a.on("keydown",function(e){40===e.keyCode?c(this).children(":focus").next().focus():38===e.keyCode?c(this).children(":focus").prev().focus():27===e.keyCode&&n._hideMenu(a)}),a},_showMenu:function(t,o){if(this.disarmClick)this.disarmClick=!1;else{var n=this,e=o.offset(),a=o.height(),i=t.height(),s=a+e.top-3;s+i>c(window).height()&&(s-=s+i-c(window).height()+5),t.css({top:s+"px",left:2+e.left+"px"}),t.slideDown(100),this._delay(function(){n.uiSelect.addClass("red-ui-typedInput-focus"),c(document).on("mousedown.close-property-select",function(e){c(e.target).closest(t).length||n._hideMenu(t),c(e.target).closest(o).length&&(n.disarmClick=!0,e.preventDefault())})})}},_getLabelWidth:function(e){var t=e.outerWidth();if(0===t){var o=c('<div class="red-ui-typedInput-container"></div>').css({position:"absolute",top:0,left:-1e3}).appendTo(document.body);t=e.clone().appendTo(o).outerWidth(),o.remove()}return t},_resize:function(){null!==this.uiWidth&&this.uiSelect.width(this.uiWidth);var e=this.typeMap[this.propertyType];if(e&&!1===e.hasValue)this.selectTrigger.addClass("red-ui-typedInput-full-width");else{this.selectTrigger.removeClass("red-ui-typedInput-full-width");var t=this._getLabelWidth(this.selectTrigger);if(this.elementDiv.css("left",t+"px"),this.optionExpandButton.is(":visible")?this.elementDiv.css("right","22px"):(this.elementDiv.css("right","0"),this.input.css({"border-top-right-radius":"4px","border-bottom-right-radius":"4px"})),this.optionSelectTrigger)if(e&&e.options&&!0===e.hasValue){this.optionSelectLabel.css({left:"auto"});var o=this._getLabelWidth(this.optionSelectLabel);this.optionSelectTrigger.css({width:23+o+"px"}),this.elementDiv.css("right",23+o+"px"),this.input.css({"border-top-right-radius":0,"border-bottom-right-radius":0})}else this.optionSelectLabel.css({left:"0"}),this.optionSelectTrigger.css({width:"calc( 100% - "+t+"px )"}),this.optionExpandButton.is(":visible")||(this.elementDiv.css({right:0}),this.input.css({"border-top-right-radius":"4px","border-bottom-right-radius":"4px"}))}},_updateOptionSelectLabel:function(e){var t=this.typeMap[this.propertyType];this.optionSelectLabel.empty(),e.icon?0===e.icon.indexOf("<")?c(e.icon).prependTo(this.optionSelectLabel):-1!==e.icon.indexOf("/")?c("<img>",{src:e.icon,style:"height: 18px;"}).prependTo(this.optionSelectLabel):c("<i>",{class:"red-ui-typedInput-icon "+e.icon}).prependTo(this.optionSelectLabel):e.label?this.optionSelectLabel.text(e.label):this.optionSelectLabel.text(e.value),t.hasValue&&(this.optionValue=e.value,this._resize(),this.input.trigger("change",this.propertyType,this.value()))},_destroy:function(){this.optionMenu&&this.optionMenu.remove(),this.menu.remove()},types:function(e){var o=this,t=this.type();this.typeMap={},this.typeList=e.map(function(e){var t;return t="string"==typeof e?s[e]:e,o.typeMap[t.value]=t}),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.selectTrigger.find(".fa-sort-desc").toggle(1<this.typeList.length),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,function(e){o.type(e)}),t&&!this.typeMap.hasOwnProperty(t)?this.type(this.typeList[0].value):(this.propertyType=null,this.type(t)),setTimeout(function(){o._resize()},0)},width:function(e){this.uiWidth=e,this._resize()},value:function(e){if(!arguments.length){var t=this.input.val();return this.typeMap[this.propertyType].export&&(t=this.typeMap[this.propertyType].export(t,this.optionValue)),t}var o;if(this.typeMap[this.propertyType].options){for(var n=0;n<this.typeMap[this.propertyType].options.length;n++){var a=this.typeMap[this.propertyType].options[n];if("string"==typeof a){if(a===e){o=this.activeOptions[a];break}}else if(a.value===e){o=a;break}}o||(o={value:""}),this._updateOptionSelectLabel(o)}this.input.val(e),this.input.trigger("change",this.type(),e)},type:function(e){if(!arguments.length)return this.propertyType;var t=this,o=this.typeMap[e];if(o&&this.propertyType!==e){var n,a;if(this.propertyType=e,this.typeField&&this.typeField.val(e),this.selectLabel.empty(),o.icon?0===o.icon.indexOf("<")?c(o.icon).prependTo(this.selectLabel):-1!==o.icon.indexOf("/")?((n=new Image).name=o.icon,n.src=o.icon,c("<img>",{src:o.icon,style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):c("<i>",{class:"red-ui-typedInput-icon "+o.icon}).prependTo(this.selectLabel):this.selectLabel.text(o.label),this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),o.options){if(this.optionExpandButton&&this.optionExpandButton.hide(),this.optionSelectTrigger)if(this.optionSelectTrigger.show(),o.hasValue?this.elementDiv.show():this.elementDiv.hide(),this.activeOptions={},o.options.forEach(function(e){"string"==typeof e?t.activeOptions[e]={label:e,value:e}:t.activeOptions[e.value]=e}),t.activeOptions.hasOwnProperty(t.optionValue)||(t.optionValue=null),this.optionMenu=this._createMenu(o.options,function(e){t._updateOptionSelectLabel(t.activeOptions[e]),o.hasValue||t.value(t.activeOptions[e].value)}),o.hasValue){var i=this.optionValue||o.options[0];if(o.parse){var s=o.parse(this.input.val());s.option&&(i=s.option,this.activeOptions.hasOwnProperty(i)||(s.option=Object.keys(this.activeOptions)[0],i=s.option)),this.input.val(s.value),o.export&&this.element.val(o.export(s.value,s.option||i))}"string"==typeof i?(this.optionValue=i,this.activeOptions.hasOwnProperty(i)||(i=Object.keys(this.activeOptions)[0]),i?this._updateOptionSelectLabel(this.activeOptions[i]):this.optionSelectTrigger.hide()):i?(this.optionValue=i.value,this._updateOptionSelectLabel(i)):this.optionSelectTrigger.hide()}else{for(var r=this.input.val(),l=!1,d=0;d<o.options.length;d++){if("string"==typeof(a=o.options[d])&&a===r){t._updateOptionSelectLabel({value:r}),l=!0;break}if(a.value===r){t._updateOptionSelectLabel(a),l=!0;break}}l||("string"==typeof(a=o.options[0])?(this.value(a),t._updateOptionSelectLabel({value:a})):(this.value(a.value),t._updateOptionSelectLabel(a)))}}else this.optionSelectTrigger&&this.optionSelectTrigger.hide(),!1===o.hasValue?(this.oldValue=this.input.val(),this.input.val(""),this.elementDiv.hide()):(void 0!==this.oldValue&&(this.input.val(this.oldValue),delete this.oldValue),this.elementDiv.show()),this.optionExpandButton&&(o.expand&&"function"==typeof o.expand?(this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",function(e){e.preventDefault(),o.expand.call(t)})):this.optionExpandButton.hide()),this.input.trigger("change",this.propertyType,this.value());n?(n.onload=function(){t._resize()},n.onerror=function(){t._resize()}):this._resize()}},validate:function(){var e,t=this.value(),o=this.type();if(this.typeMap[o]&&this.typeMap[o].validate){var n=this.typeMap[o].validate;e="function"==typeof n?n(t):n.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show(),this._resize()},hide:function(){this.uiSelect.hide()}})}(jQuery),RED.actions=function(){var n={};return{add:function(e,t){n[e]=t},remove:function(e){delete n[e]},get:function(e){return n[e]},invoke:function(e,t){n.hasOwnProperty(e)&&n[e](t)},list:function(){var o=[];return Object.keys(n).forEach(function(e){var t=RED.keyboard.getShortcut(e);o.push({id:e,scope:t?t.scope:void 0,key:t?t.key:void 0,user:t?t.user:void 0})}),o}}}(),RED.deploy=function(){var t={full:{img:"red/images/deploy-full-o.png"},nodes:{img:"red/images/deploy-nodes-o.png"},flows:{img:"red/images/deploy-flows-o.png"}},g={unknown:!1,unusedConfig:!1,invalid:!1},v="full",b=!1,d=null;function i(e){v=e,$("#btn-deploy-icon").attr("src",t[e].img)}function m(e){var t="";if(e.z){var o=RED.nodes.workspace(e.z);t=o?o.label:(o=RED.nodes.subflow(e.z)).name}var n=RED.utils.getNodeLabel(e,e.id);return{tab:t,type:e.type,label:n}}function y(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function w(e,t){var o=$("<div>");$('<p data-i18n="deploy.confirm.conflict"></p>').appendTo(o);var n=$('<div id="node-dialog-confirm-deploy-conflict-checking" class="node-dialog-confirm-conflict-row"><img src="red/images/spin.svg"/><div data-i18n="deploy.confirm.conflictChecking"></div></div>').appendTo(o),a=$('<div class="node-dialog-confirm-conflict-row"><i style="color: #3a3;" class="fa fa-check"></i><div data-i18n="deploy.confirm.conflictAutoMerge"></div></div>').hide().appendTo(o),i=$('<div id="node-dialog-confirm-deploy-conflict-manual-merge" class="node-dialog-confirm-conflict-row"><i style="color: #999;" class="fa fa-exclamation"></i><div data-i18n="deploy.confirm.conflictManualMerge"></div></div>').hide().appendTo(o);o.i18n(),d=null;var s=[{text:RED._("common.label.cancel"),click:function(){r.close()}},{id:"node-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),r.close())}},{id:"node-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-merge").hasClass("disabled")||(RED.diff.mergeDiff(d),r.close())}}];t&&s.push({id:"node-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){R(!0,t),r.close()}});var r=RED.notify(o,{modal:!0,fixed:!0,width:600,buttons:s}),l=Date.now();RED.diff.getRemoteDiff(function(e){var t=Math.max(1e3-(Date.now()-l),0);d=e,setTimeout(function(){n.hide(),0===Object.keys(e.conflicts).length?(a.show(),$("#node-dialog-confirm-deploy-merge").removeClass("disabled")):i.show(),$("#node-dialog-confirm-deploy-review").removeClass("disabled")},t)})}function D(e){if(5<e.length){var t=e.length-5;(e=e.slice(0,5)).push(RED._("deploy.confirm.plusNMore",{count:t}))}return e}function E(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function s(){var t=Date.now();$(".deploy-button-content").css("opacity",0),$(".deploy-button-spinner").show();var n=!$("#btn-deploy").hasClass("disabled");$("#btn-deploy").addClass("disabled"),b=!0,$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$.ajax({url:"flows",type:"POST",headers:{"Node-RED-Deployment-Type":"reload"}}).done(function(e,t,o){n&&$("#btn-deploy").removeClass("disabled"),RED.notify("<p>"+RED._("deploy.successfulRestart")+"</p>","success")}).fail(function(e,t,o){n&&$("#btn-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?w(nns,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){b=!1;var e=Math.max(0,300-(Date.now()-t));setTimeout(function(){$(".deploy-button-content").css("opacity",1),$(".deploy-button-spinner").hide(),$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide()},e)})}function R(e,t){if(!$("#btn-deploy").hasClass("disabled")){if(!RED.user.hasPermission("flows.write"))return void RED.notify(RED._("user.errors.deploy"),"error");if(!e){var o,n=!1,a=!1,i=[],s=[];RED.nodes.eachNode(function(e){n=n||!e.valid,e.valid||s.push(m(e)),"unknown"===e.type&&-1==i.indexOf(e.name)&&i.push(e.name)}),o=0<i.length;var r=[];RED.nodes.eachConfig(function(e){!1!==e._def.hasUsers&&0===e.users.length&&(r.push(m(e)),a=!0)});var l,d,c=!1,p=[];if(o&&!g.unknown?(c=!0,l="<p>"+RED._("deploy.confirm.unknown")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+D(i).map(function(e){return E(e)}).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",p=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){R(!0),d.close()}}]):n&&!g.invalid&&(c=!0,s.sort(y),l="<p>"+RED._("deploy.confirm.improperlyConfigured")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+D(s.map(function(e){return E((e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")")})).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",p=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){R(!0),d.close()}}]),c)return p.unshift({text:RED._("common.label.cancel"),click:function(){d.close()}}),void(d=RED.notify(l,{modal:!0,fixed:!0,buttons:p}))}var u=RED.nodes.createCompleteNodeSet(),f=Date.now();$(".deploy-button-content").css("opacity",0),$(".deploy-button-spinner").show(),$("#btn-deploy").addClass("disabled");var h={flows:u};t||(h.rev=RED.nodes.version()),b=!0,$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":v}}).done(function(e,t,o){RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(u),a?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p>","success"),RED.nodes.eachNode(function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials}),RED.nodes.eachConfig(function(e){e.changed=!1,e.credentials&&delete e.credentials}),RED.nodes.eachSubflow(function(e){e.changed=!1}),RED.nodes.eachWorkspace(function(e){e.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(e,t,o){RED.nodes.dirty(!0),$("#btn-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?w(0,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){b=!1;var e=Math.max(0,300-(Date.now()-f));setTimeout(function(){$(".deploy-button-content").css("opacity",1),$(".deploy-button-spinner").hide(),$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide()},e)})}}return{init:function(e){var a,t=(e=e||{}).type||"default";if("default"==t)$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content"><img id="btn-deploy-icon" src="red/images/deploy-full-o.png"> <span>'+RED._("deploy.deploy")+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="btn-deploy-options" data-toggle="dropdown" class="deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.png",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&i("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.png",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&i("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.png",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&i("nodes")}},null,{id:"deploymenu-item-reload",icon:"red/images/deploy-reload.png",label:RED._("deploy.restartFlows"),sublabel:RED._("deploy.restartFlowsDesc"),onselect:"core:restart-flows"}]});else if("simple"==t){var o=e.label||RED._("deploy.deploy"),n="red/images/deploy-full-o.png";e.hasOwnProperty("icon")&&(n=e.icon),$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content">'+(n?'<img id="btn-deploy-icon" src="'+n+'"> ':"")+"<span>"+o+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".header-toolbar")}$("#btn-deploy").click(function(e){e.preventDefault(),R()}),RED.actions.add("core:deploy-flows",R),RED.actions.add("core:restart-flows",s),RED.events.on("nodes:change",function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#btn-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#btn-deploy").addClass("disabled"))}),RED.comms.subscribe("notification/runtime-deploy",function(e,t){if(!a){var o=RED.nodes.version();if(null===o||b||o===t.revision)return;var n=$("<p>").text(RED._("deploy.confirm.backgroundUpdate"));a=RED.notify(n,{modal:!0,fixed:!0,buttons:[{text:RED._("deploy.confirm.button.ignore"),click:function(){a.close(),a=null}},{text:RED._("deploy.confirm.button.review"),class:"primary",click:function(){a.close(),w(RED.nodes.createCompleteNodeSet(),!1),a=null}}]})}})},setDeployInflight:function(e){b=e}}}(),RED.diff=function(){var c=!1;function R(e,t,o){var n=$('<div class="node-dialog-view-diff-panel"></div>').appendTo(e),a=$('<div class="node-dialog-view-diff-headers"></div>').appendTo(n);"merge"===o.mode&&n.addClass("node-dialog-view-diff-panel-merge");var i,O,s,r=(i=n,O=t,(s=$('<ol class="node-dialog-view-diff-diff"></ol>').appendTo(i)).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(e,t,o){var n=o.diff,a=o.remoteDiff,i=o.tab.n,s=o.def,r=O.conflicts,l=$("<div>",{class:"node-diff-tab"}).appendTo(e);l.addClass("collapsed");var d,c,p=$("<div>",{class:"node-diff-tab-title"}).appendTo(l),u=$("<div>").appendTo(l),f=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(p),h=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(p);a&&(d=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(p)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(f),L(i,s).appendTo(f);var g=(o.newTab||o.tab).n,v=$("<span>",{class:"node-diff-tab-title-meta"}).appendTo(f);"tab"===g.type?v.text(g.label||g.id):"subflow"===i.type?v.text(g.name||g.id):v.text(RED._("diff.globalNodes"));var b={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(o.newTab||o.remoteTab){var m,y={node:n.newConfig.all[i.id],all:n.newConfig.all,diff:n};if(a&&(m={node:a.newConfig.all[i.id]||null,all:a.newConfig.all,diff:a}),void 0!==i.type){var w,D=$("<div>",{class:"node-diff-node-entry node-diff-node-props collapsed"}).appendTo(u),E=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(D),R=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(E),x=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(E);n.newConfig.all[i.id]?n.added[i.id]?(x.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(x)):n.changed[i.id]?(x.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(x)):(x.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(x)):x.addClass("node-diff-empty"),a&&(w=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(E),a.newConfig.all[i.id]?a.added[i.id]?(w.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(w)):a.changed[i.id]?(w.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(w)):(w.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(w)):(w.addClass("node-diff-empty"),a.deleted[i.id])),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(R),$("<span>").text(RED._("diff.flowProperties")).appendTo(R),E.click(function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")}),I(s,i,y,m).appendTo(D),c="",r[i.id]?(b.conflicts++,x.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(x),w.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(w),D.addClass("node-diff-node-entry-conflict")):c=O.resolutions[i.id],N(i,D,x,w,!0,!r[i.id],c,O)}}var k=0,T=0,_={};if(o.tab.nodes.forEach(function(e){_[e.id]=!0,P(e,b,O).appendTo(u)}),o.newTab&&(k=o.newTab.nodes.length,o.newTab.nodes.forEach(function(e){_[e.id]||(_[e.id]=!0,P(e,b,O).appendTo(u))})),o.remoteTab&&(T=o.remoteTab.nodes.length,o.remoteTab.nodes.forEach(function(e){_[e.id]||P(e,b,O).appendTo(u)})),p.click(function(e){p.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".node-diff-node-entry").addClass("collapsed"),$(this).parent().find(".debug-message-element").addClass("collapsed"))}),n.deleted[i.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(h);else if(o.newTab)if(n.added[i.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(h);else{i.id&&(n.changed[i.id]?b.local.changedCount++:b.local.unchangedCount++);var j=$("<span>",{class:"node-diff-tab-stats"}).appendTo(h);$('<span class="node-diff-status"></span>').text(RED._("diff.nodeCount",{count:k})).appendTo(j),0<b.conflicts+b.local.addedCount+b.local.changedCount+b.local.deletedCount&&($('<span class="node-diff-status"> [ </span>').appendTo(j),0<b.conflicts&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+b.conflicts+"</span></span>").appendTo(j),0<b.local.addedCount&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+b.local.addedCount+"</span></span>").appendTo(j),0<b.local.changedCount&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+b.local.changedCount+"</span></span>").appendTo(j),0<b.local.deletedCount&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+b.local.deletedCount+"</span></span>").appendTo(j),$('<span class="node-diff-status"> ] </span>').appendTo(j))}else h.addClass("node-diff-empty");if(a){if(a.deleted[i.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(d);else if(o.remoteTab)if(a.added[i.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(d);else{i.id&&(a.changed[i.id]?b.remote.changedCount++:b.remote.unchangedCount++);var C=$("<span>",{class:"node-diff-tab-stats"}).appendTo(d);$('<span class="node-diff-status"></span>').text(RED._("diff.nodeCount",{count:T})).appendTo(C),0<b.conflicts+b.remote.addedCount+b.remote.changedCount+b.remote.deletedCount&&($('<span class="node-diff-status"> [ </span>').appendTo(C),0<b.conflicts&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+b.conflicts+"</span></span>").appendTo(C),0<b.remote.addedCount&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+b.remote.addedCount+"</span></span>").appendTo(C),0<b.remote.changedCount&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+b.remote.changedCount+"</span></span>").appendTo(C),0<b.remote.deletedCount&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+b.remote.deletedCount+"</span></span>").appendTo(C),$('<span class="node-diff-status"> ] </span>').appendTo(C))}else d.addClass("node-diff-empty");if(c="",0<b.conflicts?p.addClass("node-diff-node-entry-conflict"):c=O.resolutions[i.id],i.id){var S=!(0<b.conflicts&&(n.deleted[i.id]||a.deleted[i.id]));N(i,p,h,d,!1,S,c,O)}}0===l.find(".node-diff-node-entry").length&&l.addClass("node-diff-tab-empty"),e.i18n()}}),s),l=t.localDiff,d=t.remoteDiff,c=(t.conflicts,l.currentConfig),p=l.newConfig;if(void 0!==d){n.addClass("node-diff-three-way");var u=o.oldRevTitle||RED._("diff.local"),f=o.newRevTitle||RED._("diff.remote");$("<div></div>").text(u).appendTo(a),$("<div></div>").text(f).appendTo(a)}else n.removeClass("node-diff-three-way");return{list:r,finish:function(){var e={diff:l,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:c.globals},newTab:{n:{},nodes:p.globals}};void 0!==d&&(e.remoteTab={n:{},nodes:d.newConfig.globals},e.remoteDiff=d),r.editableList("addItem",e);var t,n={};for(t in c.tabOrder.forEach(function(e){var t=c.tabs[e],o={diff:l,def:RED.nodes.getType("tab"),tab:t};p.tabs.hasOwnProperty(e)&&(o.newTab=p.tabs[e]),void 0!==d&&(o.remoteTab=d.newConfig.tabs[e],o.remoteDiff=d),n[e]=!0,r.editableList("addItem",o)}),p.tabOrder.forEach(function(e){if(!n[e]){n[e]=!0;var t=p.tabs[e],o={diff:l,def:RED.nodes.getType("tab"),tab:t,newTab:t};void 0!==d&&(o.remoteDiff=d),r.editableList("addItem",o)}}),void 0!==d&&d.newConfig.tabOrder.forEach(function(e){if(!n[e]){var t=d.newConfig.tabs[e],o={diff:l,remoteDiff:d,def:RED.nodes.getType("tab"),tab:t,remoteTab:t};r.editableList("addItem",o)}}),c.subflows)c.subflows.hasOwnProperty(t)&&(n[t]=!0,e={diff:l,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:c.subflows[t]},p.subflows.hasOwnProperty(t)&&(e.newTab=p.subflows[t]),void 0!==d&&(e.remoteTab=d.newConfig.subflows[t],e.remoteDiff=d),r.editableList("addItem",e));for(t in p.subflows)p.subflows.hasOwnProperty(t)&&!n[t]&&(n[t]=!0,e={diff:l,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:p.subflows[t],newTab:p.subflows[t]},void 0!==d&&(e.remoteDiff=d),r.editableList("addItem",e));if(void 0!==d)for(t in d.newConfig.subflows)d.newConfig.subflows.hasOwnProperty(t)&&!n[t]&&(e={diff:l,remoteDiff:d,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:d.newConfig.subflows[t],remoteTab:d.newConfig.subflows[t]},r.editableList("addItem",e))}}}function E(e,a){var t=$("<div>",{class:"node-diff-property-wires"}),i=$("<ol></ol>"),s=0;return e.forEach(function(e,t){var o=$("<li>").appendTo(i);if(e&&0<e.length){$("<span>").text(t+1).appendTo(o);var n=$("<ul>").appendTo(o);e.forEach(function(e){s++;var t=$("<li>").appendTo(n),o=a[e];o?w(o,RED.nodes.getType(o.type)||{}).appendTo(t):t.text(e)})}else o.text("none")}),0===s?t.text("none"):i.appendTo(t),t}function L(e,t){var o=$("<div>",{class:"node-diff-node-entry-node"}),n=RED.utils.getNodeColor(e.type,t),a=RED.utils.getNodeIcon(t,e);"tab"===e.type&&(n="#C0DEED"),o.css("backgroundColor",n);var i=$("<div/>",{class:"palette_icon_container"}).appendTo(o);return RED.utils.createIconElement(a,i,!1),o}function w(e,t){var o=$("<div>",{class:"node-diff-node-entry-title"});L(e,t).appendTo(o);var n=$("<div>",{class:"node-diff-node-description"}).appendTo(o),a=e.label||e.name||e.id;return $("<span>",{class:"node-diff-node-label"}).text(a).appendTo(n),o}function P(t,e,o){var n=o.localDiff,a=o.remoteDiff,i=o.conflicts[t.id],s=!0;n.added[t.id]&&(e.local.addedCount++,s=!1),a&&a.added[t.id]&&(e.remote.addedCount++,s=!1),n.deleted[t.id]&&(e.local.deletedCount++,s=!1),a&&a.deleted[t.id]&&(e.remote.deletedCount++,s=!1),n.changed[t.id]&&(e.local.changedCount++,s=!!0),a&&a.changed[t.id]&&(e.remote.changedCount++,s=!!0);var r=RED.nodes.getType(t.type);void 0===r&&(r=/^subflow:/.test(t.type)?{icon:"subflow.png",category:"subflows",color:"#da9",defaults:{name:{value:""}}}:{});var l,d=$("<div>",{class:"node-diff-node-entry collapsed"}),c=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(d),p=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(c),u=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(c);if(a&&(l=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(c)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(p),s)e.local.unchangedCount++,w(t,r).appendTo(p),u.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(u),a&&(e.remote.unchangedCount++,l.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(l)),d.addClass("node-diff-node-unchanged");else if(n.added[t.id])u.addClass("node-diff-node-added"),l&&l.addClass("node-diff-empty"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(u),w(t,r).appendTo(p);else if(a&&a.added[t.id])u.addClass("node-diff-empty"),l.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(l),w(t,r).appendTo(p);else{if(w(t,r).appendTo(p),n.moved[t.id]){var f=n.newConfig.all[t.id];if(n.deleted[t.z]||t.z===f.z||""===t.z||n.newConfig.all[t.z]){u.addClass("node-diff-node-moved");var h="";h=t.z===f.z?RED._("diff.type.movedFrom",{id:n.currentConfig.all[t.id].z||"global"}):RED._("diff.type.movedTo",{id:f.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+h+"</span>").appendTo(u)}else u.addClass("node-diff-empty");!0}else n.deleted[t.z]?(u.addClass("node-diff-empty"),!0):n.deleted[t.id]?(u.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(u),!0):n.changed[t.id]?n.newConfig.all[t.id].z!==t.z?u.addClass("node-diff-empty"):(u.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(u),!0):n.newConfig.all[t.id].z!==t.z?u.addClass("node-diff-empty"):(e.local.unchangedCount++,u.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(u));if(a)if(a.moved[t.id]){var g=a.newConfig.all[t.id];if(a.deleted[t.z]||t.z===g.z||""===t.z||a.newConfig.all[t.z]){l.addClass("node-diff-node-moved");var v="";v=t.z===g.z?RED._("diff.type.movedFrom",{id:a.currentConfig.all[t.id].z||"global"}):RED._("diff.type.movedTo",{id:g.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+v+"</span>").appendTo(l)}else l.addClass("node-diff-empty")}else a.deleted[t.z]?l.addClass("node-diff-empty"):a.deleted[t.id]?(l.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(l)):a.changed[t.id]?a.newConfig.all[t.id].z!==t.z?l.addClass("node-diff-empty"):(l.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(l)):a.newConfig.all[t.id].z!==t.z?l.addClass("node-diff-empty"):(e.remote.unchangedCount++,l.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(l))}var b,m={node:n.newConfig.all[t.id],all:n.newConfig.all,diff:n};a&&(b={node:a.newConfig.all[t.id]||null,all:a.newConfig.all,diff:a});var y="";return i?(e.conflicts++,u.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(u),l.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(l),d.addClass("node-diff-node-entry-conflict")):y=o.resolutions[t.id],N(t,d,u,l,!1,!i,y,o),c.click(function(e){$(this).parent().toggleClass("collapsed"),0===$(this).siblings(".node-diff-node-entry-properties").length&&I(r,t,m,b).appendTo(d)}),d}function I(t,n,a,i){var s,r={},l=a.node;i&&(s=i.node);var e=$("<div>",{class:"node-diff-node-entry-properties"}),o=$("<table>").appendTo(e),d=$("<colgroup><col/><col/></colgroup>").appendTo(o);void 0!==s&&$("<col/>").appendTo(d);var c,p,u,f,h,g,v,b=$("<tbody>").appendTo(o),m=!1,y=!1,w=!1;c=$("<tr>").appendTo(b),$("<td>",{class:"node-diff-property-cell-label"}).text("id").appendTo(c),p=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(c),l?(p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"></span>').appendTo(p),f=$('<span class="node-diff-element"></span>').appendTo(p),r["local.id"]=RED.utils.createObjectElement(l.id).appendTo(f)):p.addClass("node-diff-empty"),void 0!==s&&((u=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(c)).addClass("node-diff-node-unchanged"),s?($('<span class="node-diff-status"></span>').appendTo(u),f=$('<span class="node-diff-element"></span>').appendTo(u),r["remote.id"]=RED.utils.createObjectElement(s.id).appendTo(f)):u.addClass("node-diff-empty")),n.hasOwnProperty("x")&&(l&&(l.x===n.x&&l.y===n.y||(m=!0,0)),s&&(s.x===n.x&&s.y===n.y||(y=!0,0)),(y&&m&&(l.x!==s.x||l.y!==s.y)||!m&&y&&a.diff.deleted[n.id]||m&&!y&&i.diff.deleted[n.id])&&(w=!0),c=$("<tr>").appendTo(b),$("<td>",{class:"node-diff-property-cell-label"}).text("position").appendTo(c),p=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(c),l?(p.addClass("node-diff-node-"+(m?"changed":"unchanged")),$('<span class="node-diff-status">'+(m?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p),f=$('<span class="node-diff-element"></span>').appendTo(p),r["local.position"]=RED.utils.createObjectElement({x:l.x,y:l.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){r["remote."+e]&&r["remote."+e].prop("expand")(e,t)}}).appendTo(f)):p.addClass("node-diff-empty"),void 0!==s&&((u=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(c)).addClass("node-diff-node-"+(y?"changed":"unchanged")),s?($('<span class="node-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u),f=$('<span class="node-diff-element"></span>').appendTo(u),r["remote.position"]=RED.utils.createObjectElement({x:s.x,y:s.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){r["local."+e]&&r["local."+e].prop("expand")(e,t)}}).appendTo(f)):u.addClass("node-diff-empty"))),m=y=w=!1,n.hasOwnProperty("wires")&&(h=JSON.stringify(n.wires),l&&(g=JSON.stringify(l.wires),h!==g&&(m=!0,0)),s&&(v=JSON.stringify(s.wires),h!==v&&(y=!0,0)),(y&&m&&g!==v||!m&&y&&a.diff.deleted[n.id]||m&&!y&&i.diff.deleted[n.id])&&(w=!0),c=$("<tr>").appendTo(b),$("<td>",{class:"node-diff-property-cell-label"}).text("wires").appendTo(c),p=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(c),l?(w?(p.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(p)):(p.addClass("node-diff-node-"+(m?"changed":"unchanged")),$('<span class="node-diff-status">'+(m?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p)),E(l.wires,a.all).appendTo(p)):p.addClass("node-diff-empty"),void 0!==s&&(u=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(c),s?(w?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(y?"changed":"unchanged")),$('<span class="node-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),E(s.wires,i.all).appendTo(u)):u.addClass("node-diff-empty")));var D=Object.keys(n).filter(function(e){return!("inputLabels"==e||"outputLabels"==e||"z"==e||"wires"==e||"x"===e||"y"===e||"id"===e||"type"===e||t.defaults&&t.defaults.hasOwnProperty(e))});return t.defaults&&(D=D.concat(Object.keys(t.defaults))),"tab"!==n.type&&(D=D.concat(["inputLabels","outputLabels"])),(l&&l.hasOwnProperty("icon")||s&&s.hasOwnProperty("icon"))&&-1===D.indexOf("icon")&&D.unshift("icon"),D.forEach(function(o){w=y=m=!1,h=JSON.stringify(n[o]),l&&(g=JSON.stringify(l[o]),h!==g&&(m=!0,0)),s&&(v=JSON.stringify(s[o]),h!==v&&(y=!0,0)),(y&&m&&g!==v||!m&&y&&a.diff.deleted[n.id]||m&&!y&&i.diff.deleted[n.id])&&(w=!0),c=$("<tr>").appendTo(b);var e=$("<td>",{class:"node-diff-property-cell-label"}).text(o).appendTo(c);p=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(c),l?(w?(p.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(p)):(p.addClass("node-diff-node-"+(m?"changed":"unchanged")),$('<span class="node-diff-status">'+(m?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(p)),f=$('<span class="node-diff-element"></span>').appendTo(p),r["local."+o]=RED.utils.createObjectElement(l[o],{path:o,exposeApi:!0,ontoggle:function(e,t){r["remote."+o]&&r["remote."+o].prop("expand")(e,t)}}).appendTo(f)):p.addClass("node-diff-empty"),void 0!==s&&(u=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(c),s?(w?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(y?"changed":"unchanged")),$('<span class="node-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),f=$('<span class="node-diff-element"></span>').appendTo(u),r["remote."+o]=RED.utils.createObjectElement(s[o],{path:o,exposeApi:!0,ontoggle:function(e,t){r["local."+o]&&r["local."+o].prop("expand")(e,t)}}).appendTo(f)):u.addClass("node-diff-empty")),l&&s&&"string"==typeof l[o]&&(/\n/.test(l[o])||/\n/.test(s[o]))&&$('<button class="editor-button editor-button-small node-diff-text-diff-button"><i class="fa fa-file-o"> <i class="fa fa-caret-left"></i> <i class="fa fa-caret-right"></i> <i class="fa fa-file-o"></i></button>').click(function(){_(l[o],s[o])}).appendTo(e)}),e}function N(a,i,e,t,s,o,n,r){var l="node-diff-selectbox-"+a.id.replace(/\./g,"-")+(s?"-props":""),d="";(a.z||s)&&(d="node-diff-selectbox-tab-"+(s?a.id:a.z).replace(/\./g,"-"));var c=!s&&("tab"===a.type||"subflow"===a.type),p=function(e){var t;if(void 0===a.type);else if(c)t="node-diff-selectbox-tab-"+a.id.replace(/\./g,"-"),$("."+t+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+t+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-local"),$("."+t+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-remote")):($("."+t+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-local"),$("."+t+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-remote"));else{var o="node-diff-selectbox-"+(s?a.id:a.z).replace(/\./g,"-");$("#"+o+"-local").prop("checked",!1),$("#"+o+"-remote").prop("checked",!1);var n=$("#"+o+"-local").closest(".node-diff-tab").find(".node-diff-tab-title");n.removeClass("node-diff-select-local"),n.removeClass("node-diff-select-remote")}"local"===this.value?(i.removeClass("node-diff-select-remote"),i.addClass("node-diff-select-local")):"remote"===this.value&&(i.addClass("node-diff-select-remote"),i.removeClass("node-diff-select-local")),x(r)},u=$("<label>",{class:"node-diff-selectbox",for:l+"-local"}).click(function(e){e.stopPropagation()}).appendTo(e),f=$("<input>",{id:l+"-local",type:"radio",value:"local",name:l,class:d+"-local"+(c?"":" node-diff-select-node")}).data("node-id",a.id).change(p).appendTo(u),h=$("<label>",{class:"node-diff-selectbox",for:l+"-remote"}).click(function(e){e.stopPropagation()}).appendTo(t),g=$("<input>",{id:l+"-remote",type:"radio",value:"remote",name:l,class:d+"-remote"+(c?"":" node-diff-select-node")}).data("node-id",a.id).change(p).appendTo(h);"local"===n?f.prop("checked",!0):"remote"===n&&g.prop("checked",!0),(o||e.hasClass("node-diff-empty")||t.hasClass("node-diff-empty"))&&(u.hide(),h.hide())}function x(e){var t=0;$(".node-diff-selectbox>input:checked").each(function(){e.conflicts[$(this).data("node-id")]&&t++,e.resolutions[$(this).data("node-id")]=$(this).val()});var o=Object.keys(e.conflicts).length;o-t==0?$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:o-t})):$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:o-t})),o===t&&($("#node-diff-view-diff-merge").removeClass("disabled"),$("#node-diff-view-resolve-diff").removeClass("disabled"))}function t(s){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(e){var t=RED.nodes.createCompleteNodeSet(),o=RED.nodes.originalFlow(),n=e.flows,a=k(o,t),i=k(o,n);i.rev=e.rev,s(T(a,i))}})}function o(e){void 0===e?t(o):function(a,i){if(c)return;(i=i||{}).mode,a.localDiff;var s=a.remoteDiff,r=a.conflicts,e={title:i.title||RED._("diff.reviewChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("merge"===i.mode?"common.label.cancel":"common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".editor-tray-body"),o=($('<div class="node-diff-toolbar"><span><span id="node-diff-toolbar-resolved-conflicts"></span></span> </div>').prependTo(t),$('<div class="node-diff-container"></div>').appendTo(t)),n=R(o,a,i);n.list.hide(),s?($("#node-diff-view-diff-merge").show(),0===Object.keys(r).length?$("#node-diff-view-diff-merge").removeClass("disabled"):$("#node-diff-view-diff-merge").addClass("disabled")):$("#node-diff-view-diff-merge").hide(),x(a),setTimeout(function(){n.finish(),n.list.show()},300),$("#sidebar-shade").show()},close:function(){c=!1,$("#sidebar-shade").hide()},show:function(){}};"merge"===i.mode&&e.buttons.push({id:"node-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-diff-view-diff-merge").hasClass("disabled")||(x(a),n(a),RED.tray.close())}});RED.tray.show(e)}(e,{mode:"merge"})}function l(e){var t=[],o={},n={},a=[],i={};return e.forEach(function(e){"tab"===(i[e.id]=e).type?(t.push(e.id),o[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(n[e.id]={n:e,nodes:[]})}),e.forEach(function(e){"tab"!==e.type&&"subflow"!==e.type&&(o[e.z]?o[e.z].nodes.push(e):n[e.z]?n[e.z].nodes.push(e):a.push(e))}),{all:i,tabOrder:t,tabs:o,subflows:n,globals:a}}function k(e,t){var o=l(e),n=l(t),a={},i={},s={},r={};return Object.keys(o.all).forEach(function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);n.all.hasOwnProperty(e)?JSON.stringify(o.all[e])!==JSON.stringify(n.all[e])&&(s[e]=!0,o.all[e].z!==n.all[e].z&&(r[e]=!0)):i[e]=!0}),Object.keys(n.all).forEach(function(e){o.all.hasOwnProperty(e)||(a[e]=!0)}),{currentConfig:o,newConfig:n,added:a,deleted:i,changed:s,moved:r}}function T(e,t){var o,n,a={},i={},s={localDiff:e,remoteDiff:t,conflicts:a,resolutions:i},r={};for(o in e.currentConfig.all)if(e.currentConfig.all.hasOwnProperty(o)){r[o]=!0;var l=e.newConfig.all[o];if(e.changed[o]&&t.deleted[o])a[o]=!0;else if(e.deleted[o]&&t.changed[o])a[o]=!0;else if(e.changed[o]&&t.changed[o]){var d=t.newConfig.all[o];JSON.stringify(l)!==JSON.stringify(d)&&(a[o]=!0)}a[o]||(t.added[o]||t.changed[o]||t.deleted[o]?i[o]="remote":i[o]="local")}for(o in e.added)e.added.hasOwnProperty(o)&&(n=e.newConfig.all[o],t.deleted[n.z]?a[o]=!0:i[o]="local");for(o in t.added)t.added.hasOwnProperty(o)&&(n=t.newConfig.all[o],e.deleted[n.z]?a[o]=!0:i[o]="remote");return s}function p(e){e.localDiff.currentConfig;var t,o=e.localDiff,n=e.remoteDiff,a=e.conflicts,i=e.resolutions;for(t in a)if(a.hasOwnProperty(t)&&!i.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var s,r=[],l={},d={};for(t in o.newConfig.all)o.newConfig.all.hasOwnProperty(t)&&(s=RED.nodes.node(t),"local"===i[t]?(s&&(l[t]=s.changed),r.push(o.newConfig.all[t])):"remote"===i[t]?!n.deleted[t]&&n.newConfig.all.hasOwnProperty(t)&&(s&&(l[t]=s.changed),d[t]=1,r.push(n.newConfig.all[t])):console.log("Unresolved",t));for(t in n.added)n.added.hasOwnProperty(t)&&((s=RED.nodes.node(t))&&(l[t]=s.changed),o.added.hasOwnProperty(t)||(d[t]=2,r.push(n.newConfig.all[t])));return{config:r,nodeChangedStates:l,localChangedStates:d}}function n(e){var t=p(e),o=t.config,n=t.nodeChangedStates,a=t.localChangedStates,i=RED.nodes.dirty(),s={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:n,dirty:i,rev:RED.nodes.version()};RED.history.push(s);var r=RED.nodes.originalFlow();for(var l in e.remoteDiff.added)e.remoteDiff.added.hasOwnProperty(l)&&e.remoteDiff.newConfig.all.hasOwnProperty(l)&&r.push(JSON.parse(JSON.stringify(e.remoteDiff.newConfig.all[l])));RED.nodes.clear();var d=RED.nodes.import(o);RED.nodes.originalFlow(r),d[0].forEach(function(e){(n[e.id]||a[e.id])&&(e.changed=!0)}),RED.nodes.version(e.remoteDiff.rev),i&&RED.nodes.dirty(!0),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}function _(y,w){var e={title:RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".editor-tray-body"),o=$('<div class="node-text-diff"></div>').appendTo(t),n=$("<table>",{class:"node-text-diff-content"}).appendTo(o);$('<colgroup><col width="50"><col width="50%"><col width="50"><col width="50%"></colgroup>').appendTo(n);for(var a,i=$("<tbody>").appendTo(n),s=function(e,t,o){var n,a,i=e.split(/\r?\n/),s=t.split(/\r?\n/),r=i.length,l=s.length,d={a:[],b:[]},c=[];for(n=0;n<r+1;n++)for(c[n]=[],a=0;a<l+1;a++)c[n][a]=0;for(n=r-1;0<=n;n--)for(a=l-1;0<=a;a--)0,1!==C(i[n],s[a],o)?c[n][a]=c[n+1][a+1]+1:c[n][a]=Math.max(c[n+1][a],c[n][a+1]);a=n=0;for(;n<r&&a<l;){var p=C(i[n],s[a],o);if(1!==p){var u=0;0===p?u=0:2==p&&(u=3),d.a.push({i:n+1,j:a+1,line:i[n],type:u}),d.b.push({i:a+1,j:n+1,line:s[a],type:u}),n++,a++}else c[n+1][a]>=c[n][a+1]?(d.a.push({i:n+1,line:i[n],type:1}),n++):(d.b.push({i:a+1,line:s[a],type:4}),a++)}for(;n<r||a<l;)n==r?(d.b.push({i:a+1,line:s[a],type:4}),a++):a==l&&(d.a.push({i:n+1,line:i[n],type:1}),n++);return d}(y||"",w||""),r=0,l=0,d=Math.max(s.a.length,s.b.length),c=[],p=[],u=0,f=0,h=0;h<d;h++){s[h];var g=r<s.a.length?s.a[r]:{type:2,line:""},v=l<s.b.length?s.b[l]:{type:2,line:""};0===g.type&&0!==v.type?(g={type:2,line:""},l++):0===v.type&&0!==g.type?(v={type:2,line:""},r++):(r++,l++),c.push({a:g,b:v}),void 0===a?(a={start:h,end:h},f=(u=0)===g.type&&0===v.type?0:1):0===g.type&&0===v.type?0===f?(a.end=h,u++):1===f?(a.end=h,f=2,u=0):2===f&&(a.end=h,8===++u&&(a.end-=5,p.push(a),a={start:h-5,end:h-5},u=f=0)):(a.end=h,u++,0===f?(3<a.end&&(a.end-=3,a.empty=!0,p.push(a),a={start:h-3,end:h-3}),f=1):2===f&&(f=1))}0===f&&(a.empty=!0),a.end=d,p.push(a);for(var b=0;b<p.length;b++)if((a=p[b]).empty)D(a.start,a.end,c).appendTo(i);else for(h=a.start;h<a.end;h++){var m=j(c[h]).appendTo(i);h===a.start?m.addClass("start-block"):h===a.end-1&&m.addClass("end-block")}},close:function(){c=!1},show:function(){}};RED.tray.show(e)}function D(a,i,s){diffRow=$('<tr class="node-text-diff-header node-text-diff-expand">');var e=$('<td colspan="4"> <i class="fa fa-arrows-v"></i> </td>').appendTo(diffRow),r=$("<span></span>").appendTo(e);return i<s.length-1&&r.text("@@ -"+(s[i-1].a.i+1)+" +"+(s[i-1].b.i+1)),diffRow.click(function(e){if(20<i-a){var t=$(this).offset();if(0<a){for(var o=a;o<a+10;o++)j(s[o]).addClass("unchanged").insertBefore($(this));a+=10}if(i<s.length-1){for(o=i-1;i-11<o;o--)j(s[o]).addClass("unchanged").insertAfter($(this));i-=10}i<s.length-1&&r.text("@@ -"+(s[i-1].a.i+1)+" +"+(s[i-1].b.i+1));var n=$(this).offset().top-t.top;$(".node-text-diff").scrollTop($(".node-text-diff").scrollTop()+n)}else{for(o=a;o<i;o++)j(s[o]).addClass("unchanged").insertBefore($(this));$(this).remove()}}),diffRow}function j(e){var t=$("<tr>"),o=e.a,n=e.b,a=$('<td class="lineno">').text(2===o.type?"":o.i).appendTo(t),i=$('<td class="linetext">').text(o.line).appendTo(t);return 2===o.type?(a.addClass("blank"),i.addClass("blank")):4===o.type?(a.addClass("added"),i.addClass("added")):1===o.type&&(a.addClass("removed"),i.addClass("removed")),a=$('<td class="lineno">').text(2===n.type?"":n.i).appendTo(t),i=$('<td class="linetext">').text(n.line).appendTo(t),2===n.type?(a.addClass("blank"),i.addClass("blank")):4===n.type?(a.addClass("added"),i.addClass("added")):1===n.type&&(a.addClass("removed"),i.addClass("removed")),t}function C(e,t,o){return o?e===t?0:e.trim()===t.trime()?2:1:e===t?0:1}function u(e,E){var g=$("<div></div>");return e.forEach(function(v){var e=v.hunks,t=v.binary,o=$("<table>",{class:"node-text-diff-content"}).appendTo(g);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(o);var b=$("<tbody>").appendTo(o),n=$('<tr class="node-text-diff-file-header">').appendTo(b),a=$('<td colspan="3"></td>').appendTo(n);$('<i class="node-diff-chevron fa fa-angle-down"></i>').appendTo(a);n.click(function(e){n.toggleClass("collapsed");var t=n.hasClass("collapsed");n.nextUntil(".node-text-diff-file-header").toggle(!t)});$('<span class="filename"></span>').text(v.file).appendTo(a);var m,y=0,w=0,D={};if(E.project.files&&E.project.files.flow===v.file){E.unmerged&&$('<span style="float: right;"><span id="node-diff-toolbar-resolved-conflicts"></span></span>').appendTo(a);var i=$('<tr class="node-text-diff-header">').appendTo(b),d=$('<td class="flow-diff" colspan="3"></td>').appendTo(i),s=E.project.name,c=E.project.files.flow,p="projects/"+s+"/files/"+E.commonRev+"/"+c,u="projects/"+s+"/files/"+E.oldRev+"/"+c,r="projects/"+s+"/files/"+E.newRev+"/"+c,l=[$.Deferred(),$.Deferred(),$.Deferred()];if(E.commonRev){p="projects/"+s+"/files/"+E.commonRev+"/"+c;$.ajax({dataType:"json",url:p}).then(function(e){l[0].resolve(e)}).fail(function(){l[0].resolve(null)})}else l[0].resolve(null);$.ajax({dataType:"json",url:u}).then(function(e){l[1].resolve(e)}).fail(function(){l[1].resolve({content:"[]"})}),$.ajax({dataType:"json",url:r}).then(function(e){l[2].resolve(e)}).fail(function(){l[2].resolve({content:"[]"})}),$.when.apply($,l).always(function(e,t,o){var n,a,i;if(e)try{n=JSON.parse(e.content||"[]")}catch(e){return console.log(RED._("diff.commonVersionError"),p),void console.log(e)}try{a=JSON.parse(t.content||"[]")}catch(e){return console.log(RED._("diff.oldVersionError"),u),void console.log(e)}n||(n=a);try{i=JSON.parse(o.content||"[]")}catch(e){return console.log(RED._("diff.newVersionError"),i),void console.log(e)}var s=k(n,a),r=k(n,i);E.currentDiff=T(s,r);var l=R(d,E.currentDiff,{title:c,mode:E.commonRev?"merge":"view",oldRevTitle:E.oldRevTitle,newRevTitle:E.newRevTitle});l.list.hide(),x(E.currentDiff),setTimeout(function(){l.finish(),l.list.show()},300)})}else if(t){var f=$('<tr class="node-text-diff-header">').appendTo(b),h=$('<td colspan="3"></td>').appendTo(f);$("<span></span>").text(RED._("diff.noBinaryFileShowed")).appendTo(h)}else E.unmerged&&(m=$('<span style="float: right;">'+RED._("diff.conflictHeader",{resolved:w,unresolved:y})+"</span>").appendTo(a)),e.forEach(function(u){var e=$('<tr class="node-text-diff-header">').appendTo(b),t=$('<td colspan="3"></td>').appendTo(e),f=($("<span></span>").text(u.header).appendTo(t),u.conflict),h=u.localStartLine,g=u.remoteStartLine;f&&y++,u.lines.forEach(function(e,t){var o,n=u.diffStart+t,a=f&&/^\+\+(<<<<<<<|=======$|>>>>>>>)/.test(e),i=$("<tr>").appendTo(b),s=$('<td class="lineno">').appendTo(i);a?s.attr("colspan",2):o=$('<td class="lineno">').appendTo(i);var r=$('<td class="linetext">').appendTo(i),l=1;if(f&&(l=2),a){if(i.addClass("mergeHeader"),/^\+\+=======$/.test(e))u.changeSeparator=n,i.addClass("mergeHeader-separator");else{var d=/^..<<<<<<</.test(e);d?($("<span>").text("<<<<<<< Local Changes").appendTo(r),u.localChangeStart=n):(u.remoteChangeEnd=n,$("<span>").text(">>>>>>> Remote Changes").appendTo(r)),i.addClass("mergeHeader-"+(d?"ours":"theirs")),$('<button class="editor-button editor-button-small" style="float: right; margin-right: 20px;"><i class="fa fa-angle-double-'+(d?"down":"up")+'"></i> use '+(d?"local":"remote")+" changes</button>").appendTo(r).click(function(e){var t,o;e.preventDefault(),w++,d?((o=(t=i.nextUntil(".mergeHeader-separator")).last().next()).nextUntil(".mergeHeader").remove(),o.next().remove()):((o=(t=i.prevUntil(".mergeHeader-separator")).last().prev()).prevUntil(".mergeHeader").remove(),o.prev().remove()),o.remove(),i.remove(),t.find(".linetext").addClass("added"),m.empty(),$("<span>"+RED._("diff.conflictHeader",{resolved:w,unresolved:y})+"</span>").appendTo(m),D[v.file]=D[v.file]||{},D[v.file][u.localChangeStart]={changeStart:u.localChangeStart,separator:u.changeSeparator,changeEnd:u.remoteChangeEnd,selection:d?"A":"B"},E.resolveConflict&&E.resolveConflict({conflicts:y,resolved:w,resolutions:D})})}}else{var c=e[0];f&&!E.unmerged&&" "===c&&(c=e[1]),$('<span class="prefix">').text(c).appendTo(r);var p=!1;f&&E.unmerged?($('<span class="prefix">').text(e[1]).appendTo(r),"+"===e[0]&&(s.text(h++),p=!0),"+"===e[1]&&(o.text(g++),p=!0)):"+"===e[0]||f&&"+"===e[1]?(s.addClass("added"),o.addClass("added"),r.addClass("added"),o.text(g++),p=!0):("-"===e[0]||f&&"-"===e[1])&&(s.addClass("removed"),o.addClass("removed"),r.addClass("removed"),s.text(h++),p=!0),p||(r.addClass("unchanged"),0<h&&"\\"!==e[0]&&""!==e&&s.text(h++),0<g&&"\\"!==e[0]&&""!==e&&o.text(g++)),$("<span>").text(e.substring(l)).appendTo(r)}})})}),g}function s(e){var t;t=Array.isArray(e)?e:e.split("\n");for(var o,n,a=/^diff (?:(?:--git a\/(.*) b\/(.*))|(?:--cc (.*)))$/,i=/^\+\+\+ b\/(.*)\t?/,s=/^Binary files /,r=/^@@ -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @@ ?(.*)$/,l=/^@+ -((\d+)(,(\d+))?) -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @+/,d=[],c=0;c<t.length;c++){var p=t[c],u=a.exec(p);if(u)n&&(o.hunks.push(n),d.push(o)),n=null,o={file:u[1]||u[3],hunks:[]};else if(s.test(p))o&&(o.binary=!0);else{var f=i.exec(p);if(f)o.file=f[1];else{var h=r.exec(p);if(h){n&&o.hunks.push(n),n={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,lines:[],conflict:!1};continue}if(h=l.exec(p)){n&&o.hunks.push(n),n={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,diffStart:parseInt(h[10]),lines:[],conflict:!0};continue}n&&n.lines.push(p)}}}return n&&o.hunks.push(n),d.push(o),d}return{init:function(){RED.actions.add("core:show-remote-diff",o)},getRemoteDiff:t,showRemoteDiff:o,showUnifiedDiff:function(n){var t,e=n.diff,o=n.title,a=s(e);n.unmerged&&(n.resolveConflict=function(e){(t=e).conflicts===e.resolved&&$("#node-diff-view-resolve-diff").removeClass("disabled")});var i={title:o||RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._(n.unmerged?"common.label.cancel":"common.label.close"),click:function(){n.oncancel&&n.oncancel(),RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".editor-tray-body"),o=$('<div class="node-text-diff"></div>').appendTo(t);u(a,n).appendTo(o)},close:function(){c=!1},show:function(){}};n.unmerged&&i.buttons.push({id:"node-diff-view-resolve-diff",text:RED._("diff.saveConflict"),class:"primary disabled",click:function(){if(!$("#node-diff-view-resolve-diff").hasClass("disabled")){if(n.currentDiff){var e=p(n.currentDiff);(t={resolutions:{}}).resolutions[n.project.files.flow]=JSON.stringify(e.config,"",4)}n.onresolve&&n.onresolve(t),RED.tray.close()}}}),RED.tray.show(i)},showCommitDiff:function(l){var d=function(e){for(var t={},o=e.split("\n"),n=[],a=0;a<o.length;a++)if(/^commit /.test(o[a]))t.sha=o[a].substring(7);else if(/^Author: /.test(o[a])){t.author=o[a].substring(8);var i=/^(.*) <(.*)>$/.exec(t.author);i&&(t.authorName=i[1],t.authorEmail=i[2])}else if(/^Date: /.test(o[a]))t.date=o[a].substring(8);else if(/^    /.test(o[a]))t.title?(4!==o[a].length||0<n.length)&&n.push(o[a].substring(4)):t.title=o[a].substring(4);else if(/^diff /.test(o[a])){t.files=s(o.slice(a));break}return t.comment=n.join("\n"),t}(l.commit),e={title:RED._("diff.viewCommitDiff"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var t=e.find(".editor-tray-body"),o=$('<div class="node-text-diff"></div>').appendTo(t),n=$("<table>",{class:"node-text-diff-content"}).appendTo(o);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(n);var a=$("<tbody>").appendTo(n),i=$('<tr class="node-text-diff-commit-header">').appendTo(a),s=$('<td colspan="3"></td>').appendTo(i);$("<h3>").text(d.title).appendTo(s),$('<div class="commit-body"></div>').text(d.comment).appendTo(s);var r=$('<div class="commit-summary"></div>').appendTo(s);$('<div style="float: right">').text("Commit "+d.sha).appendTo(r),$("<div>").text((d.authorName||d.author)+" - "+l.date).appendTo(r),d.files&&u(d.files,l).appendTo(o)},close:function(){c=!1},show:function(){}};RED.tray.show(e)},mergeDiff:n}}(),RED.keyboard=function(){var c,n=/Mac/i.test(window.navigator.platform),p={};RED.h=p;var s={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191},t={16:!0,17:!0,18:!0,91:!0,93:!0},u={},r={},f={59:186,61:187,173:189};function h(e){for(var t,o=e.toLowerCase().split("-"),n={},a=0;a<o.length;a++)switch(o[a]){case"ctrl":case"cmd":n.ctrl=!0,n.meta=!0;break;case"alt":n.alt=!0;break;case"shift":n.shift=!0;break;case"":0,t=s["-"];break;default:if(s.hasOwnProperty(o[a]))t=s[o[a]];else{if(1<o[a].length)return null;t=o[a].toUpperCase().charCodeAt(0)}}return[t,n]}function g(e,t){for(var o=e.target,n=0;"BODY"!==o.nodeName&&o.id!==t.scope;)o=o.parentElement,n++;return"BODY"===o.nodeName&&"*"!==t.scope&&(n=-1),n}function l(e,t,o,n){var a=o,i=n;"function"!=typeof o&&"string"!=typeof o||(a={},i=o);var s=[],r=0;if("string"==typeof t){"string"==typeof i&&(u[i]={scope:e,key:t},"boolean"==typeof n&&(u[i].user=n));var l=t.split(" ");for(r=0;r<l.length;r++){var d=h(l[r]);if(!d)return;s.push(d)}}else s.push([t,a]);var c=p;for(r=0;r<s.length;r++)t=s[r][0],(a=s[r][1]).ctrl&&(c.ctrl=c.ctrl||{},c=c.ctrl),a.shift&&(c.shift=c.shift||{},c=c.shift),a.alt&&(c.alt=c.alt||{},c=c.alt),c[t]=c[t]||{},c=c[t];c.handlers=c.handlers||[],c.handlers.push({scope:e,ondown:i}),c.scope=e,c.ondown=i}function a(e,t){var o=t||{},n=[],a=0;if("string"==typeof e){var i=e.split(" ");for(a=0;a<i.length;a++){var s=h(i[a]);if(!s)return void console.log("Unrecognised key specifier:",e);n.push(s)}}else n.push([e,o]);var r=p;for(a=0;a<n.length;a++){if(e=n[a][0],(o=n[a][1]).ctrl&&(r=r.ctrl),r&&o.shift&&(r=r.shift),r&&o.alt&&(r=r.alt),!r[e])return;r=r[e]}"string"==typeof r.ondown&&("boolean"==typeof t&&t?u[r.ondown]={user:t}:delete u[r.ondown]),delete r.scope,delete r.ondown,delete r.handlers}d3.select(window).on("keydown",function(){if(!t[d3.event.keyCode]){var e=function e(t){var o=c||p;(t.ctrlKey||t.metaKey)&&(o=o.ctrl),o&&t.shiftKey&&(o=o.shift),o&&t.altKey&&(o=o.alt);var n=f[t.keyCode]||t.keyCode;if(o&&o[n]){var a=o[n];if(!a.handlers)return c?(c=null,e(t)):(0<Object.keys(a).length&&(c=a,t.preventDefault()),null);var i,s=1/0,r=0,l=a.handlers.length;for(r=0;r<l;r++){var d=g(t,a.handlers[r]);-1<d&&d<s&&(s=d,i=a.handlers[r])}return c=null,a=i}if(c)return c=null,e(t)}(d3.event);e&&e.ondown&&("string"==typeof e.ondown?RED.actions.invoke(e.ondown):e.ondown(),d3.event.preventDefault())}});function d(e){e.preventDefault();var i=$(this),s=i.data("data");if(!i.hasClass("keyboard-shortcut-entry-expanded")){v();var t=i.find(".keyboard-shortcut-entry-key"),o=i.find(".keyboard-shortcut-entry-scope");i.addClass("keyboard-shortcut-entry-expanded");var n=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(s.key||"").appendTo(t);n.on("keyup",function(e){if(13===e.keyCode)return v();var t=$(this).val(),o=""===(t=t.trim())||RED.keyboard.validateKey(t);$(this).toggleClass("input-error",!o)});var a=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(o);a.i18n(),a.val(s.scope||"*");var r=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(o),l=$('<button class="editor-button editor-button-small"><i class="fa fa-check"></i></button>').appendTo(r),d=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(r);l.click(function(e){e.stopPropagation(),v()}),d.click(function(e){e.stopPropagation(),RED.keyboard.revertToDefault(s.id),i.empty(),i.removeClass("keyboard-shortcut-entry-expanded");var t=RED.keyboard.getShortcut(s.id),o=RED.settings.get("keymap")||{},n=RED.settings.get("editor")||{};(o=n.keymap||{})[s.id]=null,n.keymap=o,RED.settings.set("editor",n);var a={id:s.id,scope:t?t.scope:void 0,key:t?t.key:void 0,user:t?t.user:void 0};b(i,a)}),n.focus()}}function v(e){var t=$(".keyboard-shortcut-entry-expanded");if(1===t.length){var o=t.data("data"),n=t.find(".keyboard-shortcut-entry-key input"),a=t.find(".keyboard-shortcut-entry-scope select");if(!e){var i=n.val().trim(),s=a.val();if(""===i||RED.keyboard.validateKey(i)){var r=RED.keyboard.getShortcut(o.id);if(!r&&i||r&&(r.scope!==s||r.key!==i)){var l=t.find(".keyboard-shortcut-entry-key"),d=t.find(".keyboard-shortcut-entry-scope");l.empty(),d.empty(),o.key&&RED.keyboard.remove(o.key,!0),t.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===i?(l.parent().addClass("keyboard-shortcut-entry-unassigned"),l.append($("<span>").text(RED._("keyboard.unassigned"))),delete o.key,delete o.scope):(l.parent().removeClass("keyboard-shortcut-entry-unassigned"),l.append(RED.keyboard.formatKey(i)),$("<span>").text(s).appendTo(d),o.key=i,o.scope=s,RED.keyboard.add(o.scope,o.key,o.id,!0));var c=RED.settings.get("editor")||{},p=c.keymap||{};p[o.id]=RED.keyboard.getShortcut(o.id),c.keymap=p,RED.settings.set("editor",c)}}}n.remove(),a.remove(),$(".keyboard-shortcut-edit").remove(),t.removeClass("keyboard-shortcut-entry-expanded")}}function b(e,t){var o=$('<div class="keyboard-shortcut-entry">').appendTo(e);e.data("data",t);var n=t.id.replace(/(^.+:([a-z]))|(-([a-z]))/g,function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}),a=$("<div>").addClass("keyboard-shortcut-entry-text").text(n).appendTo(o),i=$('<i class="fa fa-user"></i>').prependTo(a);t.user||i.css("opacity",0);var s=$('<div class="keyboard-shortcut-entry-key">').appendTo(o);t.key?s.append(RED.keyboard.formatKey(t.key)):(o.addClass("keyboard-shortcut-entry-unassigned"),s.append($("<span>").text(RED._("keyboard.unassigned"))));var r=$('<div class="keyboard-shortcut-entry-scope">').appendTo(o);$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(r),e.click(d)}function e(){var e=$('<div id="user-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input id="user-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(e),e.find("input").searchBox({delay:100,change:function(){var t=$(this).val().trim();""===t?o.editableList("filter",null):(t=t.replace(/\s/g,""),o.editableList("filter",function(e){return-1<e.id.toLowerCase().replace(/^.*:/,"").replace("-","").indexOf(t)}))}});var o=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){b(e,o)}}),t=RED.actions.list();return t.sort(function(e,t){var o=e.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase(),n=t.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase();return o.localeCompare(n)}),t.forEach(function(e){o.editableList("addItem",e)}),e}return{init:function(){!function(){if("localStorage"in window&&null!==window.localStorage){var e=localStorage.getItem("keymap");if(null!==e){localStorage.removeItem("keymap");var t=RED.settings.get("editor")||{};t.keymap=JSON.parse(e),RED.settings.set("editor",t)}}}();var s=(RED.settings.get("editor")||{}).keymap||{};$.getJSON("red/keymap.json",function(e){for(var t in e)if(e.hasOwnProperty(t)){var o=e[t];for(var n in o)o.hasOwnProperty(n)&&(s.hasOwnProperty(o[n])||l(t,n,o[n],!1),r[o[n]]={scope:t,key:n,user:!1})}for(var a in s)if(s.hasOwnProperty(a)){var i=s[a];i.hasOwnProperty("key")&&l(i.scope,i.key,a,!0)}}),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:e,focus:function(){setTimeout(function(){$("#user-settings-tab-keyboard-filter").focus()},200)}})},add:l,remove:a,getShortcut:function(e){return u[e]},revertToDefault:function(e){var t=u[e];if(t&&a(t.key),r.hasOwnProperty(e)){var o=r[e];l(o.scope,o.key,e,!1)}},formatKey:function(e,t){var o=n?e.replace(/ctrl-?/,"&#8984;"):e;return o=(o=(o=(o=(o=(o=n?o.replace(/alt-?/,"&#8997;"):e).replace(/shift-?/,"&#8679;")).replace(/left/,"&#x2190;")).replace(/up/,"&#x2191;")).replace(/right/,"&#x2192;")).replace(/down/,"&#x2193;"),t?o:'<span class="help-key-block"><span class="help-key">'+o.split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var t=(e=e.trim()).split(" ");for(i=0;i<t.length;i++)if(!h(t[i]))return!1;return!0}}}(),RED.workspaces=function(){var d,o=0,a=0;function n(e,t,o){if(e)d.addTab(e,o),d.resize();else{for(var n=RED.nodes.id();a+=1,0!==$("#workspace-tabs a[title='"+RED._("workspace.defaultName",{number:a})+"']").size(););e={type:"tab",id:n,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:a})},RED.nodes.addWorkspace(e,o),d.addTab(e,o),d.activateTab(n),t||(RED.history.push({t:"add",workspaces:[e],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return RED.view.focus(),e}function i(e){if(1!==s){var t=RED.nodes.getWorkspaceOrder();e._index=t.indexOf(e.id),c(e);var o=RED.nodes.removeWorkspace(e.id);o.t="delete",o.dirty=RED.nodes.dirty(),o.workspaces=[e],RED.history.push(o),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function t(e){var r,l=RED.nodes.workspace(e);RED.view.state(RED.state.EDITING);var t={title:RED._("workspace.editFlow",{name:l.label}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1===s?" disabled":""),text:RED._("common.label.delete"),click:function(){i(l),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e=$("#node-input-name").val(),t=!1,o={};l.label!=e&&(o.label=l.label,t=!0,l.label=e,d.renameTab(l.id,e));var n=$("#node-input-disabled").prop("checked");l.disabled!==n&&(o.disabled=l.disabled,t=!0,l.disabled=n);var a=r.getValue();if(l.info!==a&&(o.info=l.info,t=!0,l.info=a),$("#red-ui-tab-"+l.id.replace(".","-")).toggleClass("workspace-disabled",!!l.disabled),$("#workspace").toggleClass("workspace-disabled",!!l.disabled),t){var i={t:"edit",changes:o,node:l,dirty:RED.nodes.dirty()};l.changed=!0,RED.history.push(i),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var s=RED.view.selection();s.nodes||s.links||RED.sidebar.info.refresh(l),o.hasOwnProperty("disabled")&&(RED.nodes.eachNode(function(e){e.z===l.id&&(e.dirty=!0)}),RED.view.redraw())}RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),n=0;n<t.size();n++)o-=$(t[n]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",o+"px"),r.resize()},open:function(e){var t=e.find(".editor-tray-body"),o=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name"></div>').appendTo(o),$('<div class="form-row"><label for="node-input-disabled-btn" data-i18n="editor:workspace.status"></label><button type="button" id="node-input-disabled-btn" class="editor-button"><i class="fa fa-toggle-on"></i> <span id="node-input-disabled-label"></span></button> <input type="checkbox" id="node-input-disabled" style="display: none;"/></div>').appendTo(o);$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="min-height:250px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(o);r=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$("#node-info-input-info-expand").click(function(e){e.preventDefault();var t=r.getValue();RED.editor.editMarkdown({value:t,width:"Infinity",cursor:r.getCursorPosition(),complete:function(e,t){r.setValue(e,-1),r.gotoLine(t.row+1,t.column,!1),setTimeout(function(){r.focus()},300)}})}),o.find("#node-input-disabled-btn").on("click",function(e){var t=$(this).find("i");t.hasClass("fa-toggle-off")?(t.addClass("fa-toggle-on"),t.removeClass("fa-toggle-off"),$("#node-input-disabled").prop("checked",!1),$("#node-input-disabled-label").text(RED._("editor:workspace.enabled"))):(t.addClass("fa-toggle-off"),t.removeClass("fa-toggle-on"),$("#node-input-disabled").prop("checked",!0),$("#node-input-disabled-label").text(RED._("editor:workspace.disabled")))}),l.hasOwnProperty("disabled")?($("#node-input-disabled").prop("checked",l.disabled),l.disabled?(o.find("#node-input-disabled-btn i").removeClass("fa-toggle-on").addClass("fa-toggle-off"),$("#node-input-disabled-label").text(RED._("editor:workspace.disabled"))):$("#node-input-disabled-label").text(RED._("editor:workspace.enabled"))):(l.disabled=!1,$("#node-input-disabled-label").text(RED._("editor:workspace.enabled"))),$('<input type="text" style="display: none;" />').prependTo(o),o.submit(function(e){e.preventDefault()}),$("#node-input-name").val(l.label),RED.text.bidi.prepareInput($("#node-input-name")),r.getSession().setValue(l.info||"",-1),o.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(l),r.destroy()}};RED.tray.show(t)}var s=0;function e(){d=RED.tabs.create({id:"workspace-tabs",onchange:function(e){var t={old:o};o=e.id,t.workspace=o,RED.events.emit("workspace:change",t),window.location.hash="flow/"+e.id,$("#workspace").toggleClass("workspace-disabled",!!e.disabled),RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(e){RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?t(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(e){"tab"===e.type&&s++,$('<span class="workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+e.id.replace(".","-")+" .red-ui-tab-label"),e.disabled&&$("#red-ui-tab-"+e.id.replace(".","-")).addClass("workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",s<=1),1===s&&($("#workspace .red-ui-tabs").show(),$("#chart").show(),$("#workspace-footer").children().show())},onremove:function(e){"tab"===e.type&&s--,RED.menu.setDisabled("menu-item-workspace-delete",s<=1),0===s&&r()},onreorder:function(e,t){RED.history.push({t:"reorder",order:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),p(t)},onselect:function(e){RED.view.select(!1),0===e.length?($("#chart svg").css({"pointer-events":"auto",filter:"none"}),$("#workspace-toolbar").css({"pointer-events":"auto",filter:"none"}),$("#palette-container").css({"pointer-events":"auto",filter:"none"}),$(".sidebar-shade").hide()):(RED.view.select(!1),$("#chart svg").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#workspace-toolbar").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#palette-container").css({"pointer-events":"none",filter:"opacity(60%)"}),$(".sidebar-shade").show())},minimumActiveTabWidth:150,scrollable:!0,addButton:"core:add-flow",addButtonCaption:RED._("workspace.addFlow"),searchButton:"core:list-flows",searchButtonCaption:RED._("workspace.listFlows")}),s=0}function r(){$("#workspace .red-ui-tabs").hide(),$("#chart").hide(),$("#workspace-footer").children().hide()}function l(e){t(e||o)}function c(e){e?(d.contains(e.id)&&d.removeTab(e.id),e.id===o&&(o=0)):i(RED.nodes.workspace(o))}function p(e){RED.nodes.setWorkspaceOrder(e.filter(function(e){return void 0!==RED.nodes.workspace(e)})),d.order(e)}return{init:function(){e(),RED.events.on("sidebar:resize",d.resize),RED.actions.add("core:show-next-tab",d.nextTab),RED.actions.add("core:show-previous-tab",d.previousTab),RED.menu.setAction("menu-item-workspace-delete",function(){i(RED.nodes.workspace(o))}),$(window).resize(function(){d.resize()}),RED.actions.add("core:add-flow",function(e){n(void 0,void 0,e?e.index:void 0)}),RED.actions.add("core:edit-flow",l),RED.actions.add("core:remove-flow",c),RED.actions.add("core:list-flows",function(){RED.actions.invoke("core:search","type:tab ")}),r()},add:n,remove:c,order:p,edit:l,contains:function(e){return d.contains(e)},count:function(){return s},active:function(){return o},selection:function(){return d.selection()},show:function(e){if(!d.contains(e)){var t=RED.nodes.subflow(e);if(!t)return;n({type:"subflow",id:e,icon:"red/images/subflow_tab.png",label:t.name,closeable:!0})}d.activateTab(e)},refresh:function(){RED.nodes.eachWorkspace(function(e){d.renameTab(e.id,e.label)}),RED.nodes.eachSubflow(function(e){d.contains(e.id)&&d.renameTab(e.id,e.name)}),RED.sidebar.config.refresh()},resize:function(){d.resize()}}}(),RED.view=function(){var x,k,T=5e3,_=5e3,w=.75,p=1,j=100,C=30,h=1e3,g=0,v=[],D=0,i={},S=20,O=!1,L=!1,P=null,d=[],m=[],c=[],I={},N=null,E=null,z=null,A=null,M=0,y=null,B=[0,0],q=null,U=0,J=[],F=null,R=null,V=!1,u=null,f=null,b=0,G=0,W=[],K=null,H=-1,r="",Y={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},X=1,Q=0,Z=$("#chart"),ee=d3.select("#chart").append("svg:svg").attr("width",T).attr("height",_).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){Ae()}).on("contextmenu",function(){d3.event.preventDefault()}),te=ee.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","innerCanvas").on("mousemove",ce).on("mousedown",function(){var v;if(1===d3.event.button)return U=RED.state.PANNING,q=[d3.event.pageX,d3.event.pageY],void(W=[Z.scrollLeft(),Z.scrollTop()]);z||E||(N=null,ge());0===U&&F&&(F.remove(),F=null);if((0===U||U===RED.state.QUICK_JOINING)&&(d3.event.metaKey||d3.event.ctrlKey)){var e=(v=d3.mouse(this))[0],t=v[1];RED.settings.get("editor").view["view-snap-grid"]&&(v[0]=Math.round(v[0]/S)*S,v[1]=Math.round(v[1]/S)*S),d3.event.stopPropagation();var o=$("#main-container").position();U!==RED.state.QUICK_JOINING&&(U=RED.state.QUICK_JOINING,$(window).on("keyup",Ee)),!0,R&&R.remove(),(R=te.append("g").attr("transform","translate("+(v[0]-j/2)+","+(v[1]-C/2)+")")).append("rect").attr("class","node_placeholder").attr("rx",5).attr("ry",5).attr("width",j).attr("height",C).attr("fill","none");var n=void 0;0<ae.length&&(n=ae[0].virtualLink?{type:"link in"===ae[0].node.type?"link out":"link in"}:ae[0].portType===Q?{input:!0}:{output:!0},K={node:ae[0].node,port:ae[0].port,portType:ae[0].portType},ae[0].virtualLink&&(K.virtualLink=!0),se());var b,m,y=function(){if(K){K.el||(K.el=a.append("svg:path").attr("class","drag_line"));var e=K.portType===Q&&K.node.outputs||1,t=K.port,o=-(e-1)/2*13+13*t,n=K.portType===Q?1:-1;K.el.attr("d",le(K.node.x+n*K.node.w/2,K.node.y+o,v[0]-n*j/2,v[1],n))}};K&&y(),RED.typeSearch.show({x:d3.event.clientX-o.left-j/2-(e-v[0]),y:d3.event.clientY-o.top+C/2+5-(t-v[1]),filter:n,cancel:function(){K&&(K.el&&K.el.remove(),K=null),!1,R&&R.remove(),De(),ge(),se(),ze()},add:function(e,t){var o=de(e);if(o){t&&(U=RED.state.QUICK_JOINING);var n=o.node,a=o.historyEvent;n.x=v[0],n.y=v[1];var i=RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label");if(void 0===i||/^link (in|out)$/.test(n._def.type)||n._def.defaults.hasOwnProperty("l")||(n.l=i),K){var s,r,l=K,d=null;if(l.portType===Q&&(0<n.inputs||l.virtualLink)?(d=l.node,r=l.port,s=n):l.portType===X&&(0<n.outputs||l.virtualLink)&&(d=n,s=l.node,r=0),null!==d){if(l.virtualLink){a={t:"multi",events:[a]};var c=$.extend(!0,{},{v:d.links}).v,p=$.extend(!0,{},{v:s.links}).v;d.links.push(s.id),s.links.push(d.id),d.dirty=!0,s.dirty=!0,a.events.push({t:"edit",node:d,dirty:RED.nodes.dirty(),changed:d.changed,changes:{links:c}}),a.events.push({t:"edit",node:s,dirty:RED.nodes.dirty(),changed:s.changed,changes:{links:p}}),d.changed=!0,s.changed=!0}else{var u={source:d,sourcePort:r,target:s};RED.nodes.addLink(u),a.links=[u]}t?(K.node=n,K.port=0):(K.el.remove(),K=null,U===RED.state.QUICK_JOINING&&(l.portType===Q&&0<n.outputs?ie([{node:n,port:0,portType:Q}]):!K&&l.portType===X&&0<n.inputs?ie([{node:n,port:0,portType:X}]):De()))}else se(),De()}else t?0<n.outputs?K={node:n,port:0,portType:Q}:0<n.inputs?K={node:n,port:0,portType:X}:De():U===RED.state.QUICK_JOINING&&(0<n.outputs?ie([{node:n,port:0,portType:Q}]):0<n.inputs?ie([{node:n,port:0,portType:X}]):De());if(RED.history.push(a),RED.nodes.add(n),RED.editor.validateNode(n),RED.nodes.dirty(!0),fe(),n.selected=!0,J.push({n:n}),re(),ge(),ze(),void 0!==b){var f=b+m/2,h=n.x-n.w/2,g=h-f;g!=2*S&&(n.x=n.x+2*S-g,n.dirty=!0,n.x=Math.ceil(n.x/S)*S,ze())}t?(void 0===b&&setTimeout(function(){RED.typeSearch.refresh({filter:{input:!0}})},100),b=n.x,m=n.w,v[0]=n.x+n.w/2+j/2+2*S,R.attr("transform","translate("+(v[0]-j/2)+","+(v[1]-C/2)+")"),y()):(!1,R.remove())}}}),re(),ge(),ze()}0!==U||d3.event.metaKey||d3.event.ctrlKey||D||(v=d3.mouse(this),F=te.append("rect").attr("ox",v[0]).attr("oy",v[1]).attr("rx",1).attr("ry",1).attr("x",v[0]).attr("y",v[1]).attr("width",0).attr("height",0).attr("class","lasso"),d3.event.preventDefault())}).on("mouseup",n).on("mouseenter",function(){F?1!==d3.event.buttons&&(F.remove(),F=null):U===RED.state.PANNING&&4!==d3.event.buttons&&De()}).on("touchend",function(){clearTimeout(D),D=null,RED.touch.radialMenu.active()||(F&&e.attr("fill","#fff"),n.call(this))}).on("touchcancel",n).on("touchstart",function(){var e;if(1<d3.event.touches.length){clearTimeout(D),D=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),o=e.pageY-t.pageY,n=e.pageX-t.pageX,a=$("#chart").offset(),i=[$("#chart").scrollLeft(),$("#chart").scrollTop()];v=[(t.pageX+n/2-a.left+i[0])/p,(t.pageY+o/2-a.top+i[1])/p],[t.pageX+n/2,t.pageY+o/2],g=Math.sqrt(o*o+n*n)}else{var s=d3.select(document.body),r=[(e=d3.event.touches.item(0)).pageX,e.pageY];v=[e.pageX,e.pageY],g=0;d3.touches(this)[0];D=setTimeout(function(){D=null,Ie(s,r)},h)}}).on("touchmove",function(){var e;if(RED.touch.radialMenu.active())d3.event.preventDefault();else if(d3.event.touches.length<2){if(D){var t=(e=d3.event.touches.item(0)).pageX-v[0],o=e.pageY-v[1];64<Math.abs(t*t+o*o)&&(clearTimeout(D),D=null)}else F&&d3.event.preventDefault();ce.call(this)}else{e=d3.event.touches.item(0);var n=d3.event.touches.item(1),a=e.pageY-n.pageY,i=e.pageX-n.pageX,s=($("#chart").offset(),[$("#chart").scrollLeft(),$("#chart").scrollTop()]),r=Math.sqrt(a*a+i*i),l=[n.pageX+i/2,n.pageY+a/2];if(!isNaN(r)){oldScaleFactor=p,p=Math.min(2,Math.max(.3,p+Math.floor(100*r-100*g)/1e4));var d=[v[0]*(p-oldScaleFactor),v[1]*(p-oldScaleFactor)];g=r,l,$("#chart").scrollLeft(s[0]+d[0]),$("#chart").scrollTop(s[1]+d[1]),ze()}}}),e=te.append("svg:rect").attr("width",T).attr("height",_).attr("fill","#fff"),o=te.append("g");function t(){for(var e=[],t=0;t<T;t+=+S)e.push(t);o.selectAll("line.horizontal").remove(),o.selectAll("line.horizontal").data(e).enter().append("line").attr({class:"horizontal",x1:0,x2:T,y1:function(e){return e},y2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),o.selectAll("line.vertical").remove(),o.selectAll("line.vertical").data(e).enter().append("line").attr({class:"vertical",y1:0,y2:T,x1:function(e){return e},x2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"})}t();var oe=te.append("g"),a=te.append("g"),ne=te.append("g"),ae=[];function ie(e){H=-1;for(var t=0;t<e.length;t++){var o=e[t];o.el=a.append("svg:path").attr("class","drag_line"),("link out"===o.node.type&&o.portType===Q||"link in"===o.node.type&&o.portType===X)&&(o.el.attr("class","link_link drag_line"),o.virtualLink=!0,H=o.portType===Q?X:Q),ae.push(o)}-1!==H&&d.forEach(function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)})}function se(){for(-1!==H&&d.forEach(function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)}),H=-1;ae.length;){var e=ae.pop();e.el&&e.el.remove()}}function re(){var e=RED.workspaces.active();d=RED.nodes.filterNodes({z:e}),m=RED.nodes.filterLinks({source:{z:e},target:{z:e}})}function le(e,t,o,n,a){var i=n-t,s=o-e,r=Math.sqrt(i*i+s*s),l=w;if(0<s*a?r<j&&(l=.75-(j-r)/j*.75):l=.4-.2*Math.max(0,(j-Math.min(Math.abs(s),Math.abs(i)))/j),0<s*a)return"M "+e+" "+t+" C "+(e+a*(j*l))+" "+(t+0*C)+" "+(o-a*l*j)+" "+(n-0*C)+" "+o+" "+n;var d=Math.floor(o-s/2),c=Math.floor(n-i/2);0===i&&(c=n+C);var p=C/2,u=(n+c)/2,f=e+a*j*l,h=0<i?Math.min(u-i/2,t+p):Math.max(u-i/2,t-p),g=o-a*j*l,v=0<i?Math.max(u,n-p):Math.min(u,n+p),b=(e+f)/2,m=0<i?1:-1,y=[[b,t],[f,0<i?Math.max(t,h-p):Math.min(t,h+p)],[b,0<i?Math.min(c,h+p):Math.max(c,h-p)],[g,0<i?Math.max(c,v-p):Math.min(c,v+p)],[(o+g)/2,n]];return y[2][1]===h+m*p&&(Math.abs(i)<10*p&&(y[1][1]=h-m*p/2,y[3][1]=v-m*p/2),y[2][0]=f),"M "+e+" "+t+" C "+y[0][0]+" "+y[0][1]+" "+y[1][0]+" "+y[1][1]+" "+f+" "+h+" S "+y[2][0]+" "+y[2][1]+" "+d+" "+c+" S "+y[3][0]+" "+y[3][1]+" "+g+" "+v+" S "+y[4][0]+" "+y[4][1]+" "+o+" "+n}function de(e,t,o){var n=/^subflow:(.+)$/.exec(e);if(P&&n){if(n[1]===P.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(n[1],P.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var a={id:RED.nodes.id(),z:RED.workspaces.active()};if(a.type=e,a._def=RED.nodes.getType(a.type),n){var i=RED.nodes.subflow(n[1]);a.name="",a.inputs=i.in.length,a.outputs=i.out.length}else{for(var s in a.inputs=a._def.inputs||0,a.outputs=a._def.outputs,a._def.defaults)a._def.defaults.hasOwnProperty(s)&&void 0!==a._def.defaults[s].value&&(a[s]=JSON.parse(JSON.stringify(a._def.defaults[s].value)));if(a._def.onadd)try{a._def.onadd.call(a)}catch(e){console.log("Definition error: "+a.type+".onadd:",e)}}a.changed=!0,a.moved=!0,a.w=j,a.h=Math.max(C,15*(a.outputs||0));var r={t:"add",nodes:[a.id],dirty:RED.nodes.dirty()};if(P){var l=RED.subflow.refresh(!0);l&&(r.subflow={id:P.id,changed:P.changed,instances:l.instances})}return{node:a,historyEvent:r}}function ce(){var e,p;if(U===RED.state.PANNING){var t=[d3.event.pageX,d3.event.pageY],o=[q[0]-t[0],q[1]-t[1]];return Z.scrollLeft(W[0]+o[0]),void Z.scrollTop(W[1]+o[1])}if(q=d3.touches(this)[0]||d3.mouse(this),F){var n,a,i=parseInt(F.attr("ox")),s=parseInt(F.attr("oy")),r=parseInt(F.attr("x")),l=parseInt(F.attr("y"));return n=q[0]<i?i-(r=q[0]):q[0]-r,a=q[1]<s?s-(l=q[1]):q[1]-l,void F.attr("x",r).attr("y",l).attr("width",n).attr("height",a)}if(U==RED.state.QUICK_JOINING||U==RED.state.IMPORT_DRAGGING||z||null!=N){var d;if(U==RED.state.JOINING||U===RED.state.QUICK_JOINING){if(0===ae.length&&null!==A){if(d3.event.shiftKey){var c,u=[],f=[];if(N&&(A===Q&&N.source===z&&N.sourcePort===M||A===X&&N.target===z))f=[N];else c=A===Q?{source:z,sourcePort:M}:{target:z},f=RED.nodes.filterLinks(c);for(e=0;e<f.length;e++){var h=f[e];RED.nodes.removeLink(h),u.push({link:h,node:A===Q?h.target:h.source,port:A===Q?0:h.sourcePort,portType:A===Q?X:Q})}0===u.length?(De(),ze()):(ie(u),U=0,re(),ze(),U=RED.state.JOINING)}else z&&!K&&ie([{node:z,port:M,portType:A}]);N=null}for(d=q,e=0;e<ae.length;e++){var g=ae[e],v=-((g.portType===Q&&g.node.outputs||1)-1)/2*13+13*g.port,b=g.portType===Q?1:-1;g.el.attr("d",le(g.node.x+b*g.node.w/2,g.node.y+v,d[0],d[1],b))}d3.event.preventDefault()}else if(U==RED.state.MOVING){d=d3.mouse(document.body),isNaN(d[0])&&(d=d3.touches(document.body)[0]),3<(B[0]-d[0])*(B[0]-d[0])+(B[1]-d[1])*(B[1]-d[1])&&(U=RED.state.MOVING_ACTIVE,G=0,L=!1,1===J.length&&(p=J[0],L=p.n.hasOwnProperty("_def")&&0<p.n._def.inputs&&0<p.n._def.outputs&&0===RED.nodes.filterLinks({source:p.n}).length&&0===RED.nodes.filterLinks({target:p.n}).length))}else if(U==RED.state.MOVING_ACTIVE||U==RED.state.IMPORT_DRAGGING){d=q;for(var m=0,y=0,w=T,D=_,E=0;E<J.length;E++)p=J[E],d3.event.shiftKey&&(p.n.ox=p.n.x,p.n.oy=p.n.y),p.n.x=d[0]+p.dx,p.n.y=d[1]+p.dy,p.n.dirty=!0,m=Math.min(p.n.x-p.n.w/2-5,m),y=Math.min(p.n.y-p.n.h/2-5,y),w=Math.max(p.n.x+p.n.w/2+5,w),D=Math.max(p.n.y+p.n.h/2+5,D);if(0!==m||0!==y)for(e=0;e<J.length;e++)(p=J[e]).n.x-=m,p.n.y-=y;if(w!==T||D!==_)for(e=0;e<J.length;e++)(p=J[e]).n.x-=w-T,p.n.y-=D-_;if(O!=d3.event.shiftKey&&0<J.length){var R=[0,0];if(p=J[0],R[0]=p.n.x-(S*Math.floor((p.n.x-p.n.w/2)/S)+p.n.w/2),R[1]=p.n.y-S*Math.floor(p.n.y/S),0!==R[0]||0!==R[1])for(e=0;e<J.length;e++)(p=J[e]).n.x-=R[0],p.n.y-=R[1],p.n.x==p.n.ox&&p.n.y==p.n.oy&&(p.dirty=!1)}U!=RED.state.MOVING_ACTIVE&&U!=RED.state.IMPORT_DRAGGING||1!==J.length||(p=J[0],L&&(k||(k=setTimeout(function(){var e=[],t=1/0,o=null,n=p.n.x,a=p.n.y;if(ee[0][0].getIntersectionList){var i=ee[0][0].createSVGRect();i.x=n,i.y=a,i.width=1,i.height=1,e=ee[0][0].getIntersectionList(i,ee[0][0])}else e=RED.view.getLinksAtPoint(n,a);for(var s=0;s<e.length;s++)if(d3.select(e[s]).classed("link_background"))for(var r=e[s].getTotalLength(),l=0;l<r;l+=10){var d=e[s].getPointAtLength(l),c=(d.x-n)*(d.x-n)+(d.y-a)*(d.y-a);c<200&&c<t&&(t=c,o=e[s])}x&&x!==o&&d3.select(x.parentNode).classed("link_splice",!1),o?d3.select(o.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),x=o,k=null},100))))}0!==U&&ze()}}function n(){var e,t;if(U!==RED.state.PANNING){if(U!==RED.state.QUICK_JOINING){if(z&&U==RED.state.JOINING){var o=[];for(e=0;e<ae.length;e++)ae[e].link&&o.push(ae[e].link);t={t:"delete",links:o,dirty:RED.nodes.dirty()},RED.history.push(t),se()}if(F){var n=parseInt(F.attr("x")),a=parseInt(F.attr("y")),i=n+parseInt(F.attr("width")),s=a+parseInt(F.attr("height"));d3.event.ctrlKey||fe(),RED.nodes.eachNode(function(e){e.z!=RED.workspaces.active()||e.selected||(e.selected=e.x>n&&e.x<i&&e.y>a&&e.y<s,e.selected&&(e.dirty=!0,J.push({n:e})))}),P&&(P.in.forEach(function(e){e.selected=e.x>n&&e.x<i&&e.y>a&&e.y<s,e.selected&&(e.dirty=!0,J.push({n:e}))}),P.out.forEach(function(e){e.selected=e.x>n&&e.x<i&&e.y>a&&e.y<s,e.selected&&(e.dirty=!0,J.push({n:e}))}),P.status&&(P.status.selected=P.status.x>n&&P.status.x<i&&P.status.y>a&&P.status.y<s,P.status.selected&&(P.status.dirty=!0,J.push({n:P.status})))),ge(),F.remove(),F=null}else U!=RED.state.DEFAULT||null!=E||d3.event.ctrlKey||d3.event.metaKey||(fe(),ge());if(U==RED.state.MOVING_ACTIVE&&0<J.length){for(var r=[],l=0;l<J.length;l++){var d=J[l];d.ox===d.n.x&&d.oy===d.n.y||(r.push({n:d.n,ox:d.ox,oy:d.oy,moved:d.n.moved}),d.n.dirty=!0,d.n.moved=!0)}if(0<r.length){if(t={t:"move",nodes:r,dirty:RED.nodes.dirty()},x){var c=d3.select(x).data()[0];RED.nodes.removeLink(c);var p={source:c.source,sourcePort:c.sourcePort,target:J[0].n},u={source:J[0].n,sourcePort:0,target:c.target};RED.nodes.addLink(p),RED.nodes.addLink(u),t.links=[p,u],t.removedLinks=[c],re()}RED.nodes.dirty(!0),RED.history.push(t)}}if(U==RED.state.MOVING||U==RED.state.MOVING_ACTIVE)for(e=0;e<J.length;e++)delete J[e].ox,delete J[e].oy;U==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove("escape"),re(),RED.nodes.dirty(!0)),De(),ze()}}else De()}function s(){p<2&&(p+=.1,RED.view.navigator.resize(),ze())}function l(){.3<p&&(p-=.1,RED.view.navigator.resize(),ze())}function pe(){p=1,RED.view.navigator.resize(),ze()}function ue(){RED.nodes.eachNode(function(e){e.z==RED.workspaces.active()&&(e.selected||(e.selected=!0,e.dirty=!0,J.push({n:e})))}),P&&(P.in.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,J.push({n:e}))}),P.out.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,J.push({n:e}))}),P.status&&(P.status.selected||(P.status.selected=!0,P.status.dirty=!0,J.push({n:P.status})))),N=null,ge(),ze()}function fe(){for(var e=0;e<J.length;e++){var t=J[e];t.n.dirty=!0,t.n.selected=!1}J=[],N=null}var he=null;function ge(){var e={},t=RED.workspaces.selection();if(0===t.length){0<J.length&&(e.nodes=J.map(function(e){return e.n})),null!=N&&(e.link=N);var o=RED.workspaces.active();m=RED.nodes.filterLinks({source:{z:o},target:{z:o}});RED.nodes.getWorkspaceOrder();var n={};c=[],Object.keys(I).forEach(function(e){I[e].dirty=!0}),I={};for(var a=0;a<J.length;a++)if("link out"===J[a].n.type||"link in"===J[a].n.type){var i=J[a].n;I[i.id]=i;var s={};i.links.forEach(function(e){var t=RED.nodes.node(e);t&&("link out"===i.type?t.z===i.z?n[i.id+":"+t.id]||(m.push({source:i,sourcePort:0,target:t,link:!0}),n[i.id+":"+t.id]=!0,(I[t.id]=t).dirty=!0):(s[t.z]=s[t.z]||[],s[t.z].push(t)):t.z===i.z?n[t.id+":"+i.id]||(m.push({source:t,sourcePort:0,target:i,link:!0}),n[t.id+":"+i.id]=!0,(I[t.id]=t).dirty=!0):(s[t.z]=s[t.z]||[],s[t.z].push(t)))}),0<Object.keys(s).length&&c.push({refresh:Math.floor(1e4*Math.random()),node:i,links:s})}0===c.length&&null!==N&&N.link&&(m.push(N),I[N.source.id]=N.source,N.source.dirty=!0,I[N.target.id]=N.target,N.target.dirty=!0)}else e.flows=t;var r=o+":"+JSON.stringify(e,function(e,t){return"nodes"===e||"flows"===e?t.map(function(e){return e.id}):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:t});r!==he&&(he=r,RED.events.emit("view:selection-changed",e))}function ve(){if(0<J.length){var e=J[0].n;"subflow"===e.type?RED.editor.editSubflow(P):RED.editor.edit(e)}}function be(){ke&&(ke.remove(),ke=null);var e=RED.workspaces.selection();if(0<e.length){var t=0;if(e.forEach(function(e){"tab"===e.type&&t++}),t===RED.workspaces.count())return;for(var o={t:"delete",dirty:RED.nodes.dirty(),nodes:[],links:[],workspaces:[],subflows:[]},n=RED.nodes.getWorkspaceOrder().slice(0),a=0;a<e.length;a++){var i,s=e[a];s._index=n.indexOf(s.id),RED.workspaces.remove(s),"tab"===s.type?(o.workspaces.push(s),i=RED.nodes.removeWorkspace(s.id)):(i=RED.subflow.removeSubflow(s.id),o.subflows=o.subflows.concat(i.subflows)),o.nodes=o.nodes.concat(i.nodes),o.links=o.links.concat(i.links)}RED.history.push(o),RED.nodes.dirty(!0),re(),ge(),ze()}else if(0<J.length||null!=N){var r,l=[],d=[],c=[],p=[],u=void 0,f=[],h=RED.nodes.dirty();if(0<J.length){for(a=0;a<J.length;a++){var g=J[a].n;if(g.selected=!1,"subflow"!=g.type){g.x<0&&(g.x=25);var v=RED.nodes.remove(g.id);l.push(g),l=l.concat(v.nodes),d=d.concat(v.links)}else"out"===g.direction?c.push(g):"in"===g.direction?p.push(g):"status"===g.direction&&(u=g),g.dirty=!0}0<c.length&&(r=RED.subflow.removeOutput(c))&&(d=d.concat(r.links)),1==p.length&&(r=RED.subflow.removeInput())&&(d=d.concat(r.links)),u&&(r=RED.subflow.removeStatus())&&(d=d.concat(r.links));var b=RED.subflow.refresh(!0);b&&(f=b.instances),J=[],(0<l.length||0<c.length||0<p.length||u)&&RED.nodes.dirty(!0)}if(N&&N.link){var m=N.source.id,y=N.target.id,w=N.target.links.indexOf(m),D=N.source.links.indexOf(y);o={t:"multi",events:[{t:"edit",node:N.source,changed:N.source.changed,changes:{links:$.extend(!0,{},{v:N.source.links}).v}},{t:"edit",node:N.target,changed:N.target.changed,changes:{links:$.extend(!0,{},{v:N.target.links}).v}}],dirty:RED.nodes.dirty()},N.source.changed=!0,N.target.changed=!0,N.target.links.splice(w,1),N.source.links.splice(D,1),N.source.dirty=!0,N.target.dirty=!0}else N&&(RED.nodes.removeLink(N),d.push(N)),RED.nodes.dirty(!0),o={t:"delete",nodes:l,links:d,subflowOutputs:c,subflowInputs:p,subflow:{id:P?P.id:void 0,instances:f},dirty:h},u&&(o.subflow.status=u);RED.history.push(o),N=null,re(),ge(),ze()}}function me(){var t=[],e=RED.workspaces.selection();if(0<e.length?(t=[],e.forEach(function(e){"tab"===e.type&&(t.push(e),t=t.concat(RED.nodes.filterNodes({z:e.id})))})):0<J.length&&(t=J.map(function(e){return e.n})),0<t.length){for(var o=[],n=0;n<t.length;n++){var a=t[n];if("subflow"!=a.type){for(var i in a._def.defaults)if(a._def.defaults.hasOwnProperty(i)&&a._def.defaults[i].type){var s=RED.nodes.node(a[i]);s&&s._def.exclusive&&o.push(RED.nodes.convertNode(s))}o.push(RED.nodes.convertNode(a))}}r=JSON.stringify(o),RED.notify(RED._("clipboard.nodeCopied",{count:o.length}),{id:"clipboard"})}}function ye(e,t,o){return we(e,t,o,0)[0]}function we(e,t,o,n){var a=document.createElement("span");a.className=t,a.style.position="absolute",a.style.top="-1000px",a.textContent=e||"",document.body.appendChild(a);var i=a.offsetWidth,s=a.offsetHeight;return document.body.removeChild(a),[o+i,n+s]}function De(){U=0,x=A=E=y=z=null,L=!1,d3.select(".link_splice").classed("link_splice",!1),k&&(clearTimeout(k),k=null)}function Ee(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(De(),se(),ze(),$(window).off("keyup",Ee))}function Re(e,t,o){1!==d3.event.button&&(z=e,A=t,M=o||0,U!==RED.state.QUICK_JOINING&&(U=RED.state.JOINING,document.body.style.cursor="crosshair",(d3.event.ctrlKey||d3.event.metaKey)&&(U=RED.state.QUICK_JOINING,ie([{node:z,port:M,portType:A}]),$(window).on("keyup",Ee))),d3.event.stopPropagation(),d3.event.preventDefault())}function $e(e,n,a){var t;if(U===RED.state.QUICK_JOINING&&0<ae.length){if(ae[0].node===e)return;if(ae[0].virtualLink&&("link in"===ae[0].node.type&&"link out"!==e.type||"link out"===ae[0].node.type&&"link in"!==e.type))return}if(document.body.style.cursor="",U==RED.state.JOINING||U==RED.state.QUICK_JOINING){"undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(e){if(e.z==RED.workspaces.active()){var t=e.w/2,o=e.h/2;e.x-t<q[0]&&e.x+t>q[0]&&e.y-o<q[1]&&e.y+o>q[1]&&(n=0<(y=e).inputs?X:Q,a=0)}}):y=e;var o=[],i=[],s=[],r=null;for(t=0;t<ae.length;t++)ae[t].link&&i.push(ae[t].link);var l=[];for(t=0;t<ae.length;t++)if(n!=ae[t].portType&&y!==ae[t].node){var d,c,p,u=ae[t];u.portType===Q?(d=u.node,p=u.port,c=y):u.portType===X&&(d=y,c=u.node,p=a);var f={source:d,sourcePort:p,target:c};if(u.virtualLink){if(/^link (in|out)$/.test(d.type)&&/^link (in|out)$/.test(c.type)&&-1===d.links.indexOf(c.id)&&-1===c.links.indexOf(d.id)){var h=$.extend(!0,{},{v:d.links}).v,g=$.extend(!0,{},{v:c.links}).v;d.links.push(c.id),c.links.push(d.id),d.dirty=!0,c.dirty=!0,s.push(d),s.push(c),f.link=!0,m.push(f),I[d.id]=d,I[c.id]=c,r=f,l.push({t:"edit",node:d,dirty:RED.nodes.dirty(),changed:d.changed,changes:{links:h}}),l.push({t:"edit",node:c,dirty:RED.nodes.dirty(),changed:c.changed,changes:{links:g}}),d.changed=!0,c.changed=!0}}else if(!("link out"===e.type&&n===Q||"link in"===e.type&&n===X))0!==RED.nodes.filterLinks({source:d,target:c,sourcePort:p}).length||(RED.nodes.addLink(f),o.push(f))}if(0<o.length||0<i.length||0<s.length){var v;if(v=0<s.length?{t:"multi",events:l,dirty:RED.nodes.dirty()}:{t:"add",links:o,removedLinks:i,dirty:RED.nodes.dirty()},P){var b=RED.subflow.refresh(!0);b&&(v.subflow={id:P.id,changed:P.changed,instances:b.instances})}RED.history.push(v),re(),RED.nodes.dirty(!0)}if(U===RED.state.QUICK_JOINING)return(0<o.length||0<s.length)&&(se(),n===X&&0<e.outputs?ie([{node:e,port:0,portType:Q}]):n===Q&&0<e.inputs?ie([{node:e,port:0,portType:X}]):De(),(E=N=r)&&ge()),void ze();De(),se(),(E=N=r)&&ge(),ze()}}var xe=null,ke=null;function Te(e){var t=d3.select(e);if("innerCanvas"===t.attr("class"))return[0,0];var o=[0,0];if("g"===e.nodeName.toLowerCase()){var n=t.attr("transform");n&&(o=d3.transform(n).translate)}else o=[t.attr("x")||0,t.attr("y")||0];var a=Te(e.parentNode);return[o[0]+a[0],o[1]+a[1]]}function _e(e,t,o,n){var a=te.append("g").attr("transform","translate("+e+","+t+")").attr("class","port_tooltip"),i=o.split("\n"),s=0,r=4,l=[];i.forEach(function(e){var t=we(e,"port_tooltip_label",8,0);s=Math.max(s,t[0]),l.push(.8*t[1]),r+=.8*t[1]});var d,c,p,u=s/2-5-2,f=r/2-5-2,h=r-4,g=-r/2-2;return"left"===n?(d="M0 0 l -5 -5 v -"+f+" q 0 -2 -2 -2 h -"+s+" q -2 0 -2 2 v "+h+" q 0 2 2 2 h "+s+" q 2 0 2 -2 v -"+f+" l 5 -5",c=-10,p="end"):"right"===n?(d="M0 0 l 5 -5 v -"+f+" q 0 -2 2 -2 h "+s+" q 2 0 2 2 v "+h+" q 0 2 -2 2 h -"+s+" q -2 0 -2 -2 v -"+f+" l -5 -5",c=10,p="start"):"top"===n&&(d="M0 0 l 5 -5 h "+u+" q 2 0 2 -2 v -"+r+" q 0 -2 -2 -2 h -"+(s-4)+" q -2 0 -2 2 v "+r+" q 0 2 2 2 h "+u+" l 5 5",c=s/2-4,g=-r-r/2+2,p="end"),a.append("path").attr("d",d),i.forEach(function(e,t){g+=l[t],a.append("svg:text").attr("class","port_tooltip_label").attr("x",c).attr("y",g).attr("text-anchor",p).text(e)}),a}function je(o,n,a,i){clearTimeout(xe);var e=U!=RED.state.JOINING&&U!=RED.state.QUICK_JOINING||0<ae.length&&ae[0].portType!==a&&(!ae[0].virtualLink||"link in"===ae[0].node.type&&"link out"===n.type||"link out"===ae[0].node.type&&"link in"===n.type);e&&(a===X&&(n._def&&n._def.inputLabels||n.inputLabels)||a===Q&&(n._def&&n._def.outputLabels||n.outputLabels))&&(xe=setTimeout(function(){var e=function(t,o,e){var n,a=o===X?t.inputLabels:t.outputLabels;if(a&&a[e])return a[e];var i=o===X?t._def.inputLabels:t._def.outputLabels;if("string"==typeof i)n=i;else if("function"==typeof i)try{n=i.call(t,e)}catch(e){console.log("Definition error: "+t.type+"."+(o===X?"inputLabels":"outputLabels"),e),n=null}else $.isArray(i)&&(n=i[e]);return n}(n,a,i);if(e){var t=Te(o.node());xe=null,ke=_e(t[0]+(a===X?-2:12),t[1]+5,e,a===X?"left":"right")}},500)),o.classed("port_hovered",e)}function Ce(e,t,o,n){clearTimeout(xe),ke&&(ke.remove(),ke=null),e.classed("port_hovered",!1)}function Se(e){if(f&&z==e&&0<G&&G<750)return U=RED.state.DEFAULT,"subflow"!=e.type?RED.editor.edit(e):RED.editor.editSubflow(P),G=0,void d3.event.stopPropagation();var t=e._def?0<e.inputs?1:0:"in"==e.direction?0:1,o=!1;U!==RED.state.JOINING&&U!==RED.state.QUICK_JOINING||(o=!0,0<ae.length&&ae[0].virtualLink&&("link in"===e.type?t=1:"link out"===e.type&&(t=0))),$e(e,t,0),o&&d3.selectAll(".port_hovered").classed("port_hovered",!1)}function Oe(e){if(Ae(),1!==d3.event.button){if(U==RED.state.IMPORT_DRAGGING){if(RED.keyboard.remove("escape"),x){var t=d3.select(x).data()[0];RED.nodes.removeLink(t);var o={source:t.source,sourcePort:t.sourcePort,target:J[0].n},n={source:J[0].n,sourcePort:0,target:t.target};RED.nodes.addLink(o),RED.nodes.addLink(n);var a=RED.history.peek();a.links=[o,n],a.removedLinks=[t],re()}return ge(),RED.nodes.dirty(!0),ze(),De(),void d3.event.stopPropagation()}if(U!=RED.state.QUICK_JOINING){z=e;var i,s=Date.now();if(G=s-b,b=s,f=!(u!=z||0!==d3.event.button||d3.event.shiftKey||d3.event.metaKey||d3.event.altKey||d3.event.ctrlKey),u=z,e.selected&&(d3.event.ctrlKey||d3.event.metaKey)){for(z.selected=!1,i=0;i<J.length;i+=1)if(J[i].n===z){J.splice(i,1);break}}else{if(d3.event.shiftKey){fe();for(var r=RED.nodes.getAllFlowNodes(z),l=0;l<r.length;l++)r[l].selected=!0,r[l].dirty=!0,J.push({n:r[l]})}else e.selected||(d3.event.ctrlKey||d3.event.metaKey||fe(),z.selected=!0,J.push({n:z}));if(N=null,2!=d3.event.button){U=RED.state.MOVING;var d=d3.touches(this)[0]||d3.mouse(this);for(d[0]+=e.x-e.w/2,d[1]+=e.y-e.h/2,i=0;i<J.length;i++)J[i].ox=J[i].n.x,J[i].oy=J[i].n.y,J[i].dx=J[i].n.x-d[0],J[i].dy=J[i].n.y-d[1];B=d3.mouse(document.body),isNaN(B[0])&&(B=d3.touches(document.body)[0])}}e.dirty=!0,ge(),ze(),d3.event.stopPropagation()}else d3.event.stopPropagation()}}function Le(e){var t=!0,o=RED.nodes.workspace(RED.workspaces.active());return o&&!o.disabled?e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled):t=!1,t}function Pe(t){var e=RED.workspaces.active(),o=RED.nodes.workspace(e);if(o&&!o.disabled){if(t._def.button.toggle&&(t[t._def.button.toggle]=!t[t._def.button.toggle],t.dirty=!0),t._def.button.onclick)try{t._def.button.onclick.call(t)}catch(e){console.log("Definition error: "+t.type+".onclick",e)}t.dirty&&ze()}else P?RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabledSubflow")}),"warning"):RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");d3.event.preventDefault()}function Ie(e,t){var o=z,n=[];n.push({name:"delete",disabled:0===J.length&&null===N,onselect:function(){be()}}),n.push({name:"cut",disabled:0===J.length,onselect:function(){me(),be()}}),n.push({name:"copy",disabled:0===J.length,onselect:function(){me()}}),n.push({name:"paste",disabled:0===r.length,onselect:function(){Me(r,!1,!0)}}),n.push({name:"edit",disabled:1!=J.length,onselect:function(){RED.editor.edit(o)}}),n.push({name:"select",onselect:function(){ue()}}),n.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(e,t,n),De()}function Ne(e,t,o){var n=null;if(0===e.indexOf("font-awesome/")){var a=e.substr(13);if(!(n=RED.nodes.fontAwesome.getIconUnicode(a))){var i=RED.utils.getDefaultNodeIcon(o._def,o);e=RED.settings.apiRootUrl+"icons/"+i.module+"/"+i.file}}if(n)t.append("text").attr("xlink:href",e).attr("class","fa-lg").attr("x",15).attr("stroke","none").attr("fill","#ffffff").attr("text-anchor","middle").attr("font-family","FontAwesome").text(n);else{var s=t.append("image").attr("xlink:href",e).attr("class","node_icon").attr("x",0).attr("width","30").attr("height","30"),r=new Image;r.src=e,r.onload=function(){s.attr("width",Math.min(r.width,30)),s.attr("height",Math.min(r.height,30)),s.attr("x",15-Math.min(r.width,30)/2),s.attr("xlink:href",e),s.style("display",null)}}}function ze(){if(te.attr("transform","scale("+p+")"),ee.attr("width",T*p).attr("height",_*p),-1!==H||U!=RED.state.JOINING){var $={};if(P){var e=ne.selectAll(".subflowoutput").data(P.out,function(e,t){return e.id});e.exit().remove();var t=e.enter().insert("svg:g").attr("class","node subflowoutput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});t.each(function(e,t){e.w=40,e.h=40}),t.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Se).on("mousedown",Oe).on("touchstart",function(e){var t=d3.select(this),o=d3.event.touches.item(0),n=[o.pageX,o.pageY];v=[o.pageX,o.pageY],g=0,D=setTimeout(function(){Ie(t,n)},h),Oe.call(this,e)}).on("touchend",function(e){clearTimeout(D),D=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Se.call(this,e)}),t.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){Re(e,X,0)}).on("touchstart",function(e,t){Re(e,X,0)}).on("mouseup",function(e,t){$e(e,X,0)}).on("touchend",function(e,t){$e(e,X,0)}).on("mouseover",function(e){je(d3.select(this),e,X,0)}).on("mouseout",function(e){Ce(d3.select(this))}),t.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("output"),t.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(e,t){return t+1});var o=ne.selectAll(".subflowinput").data(P.in,function(e,t){return e.id});o.exit().remove();var n=o.enter().insert("svg:g").attr("class","node subflowinput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});n.each(function(e,t){e.w=40,e.h=40}),n.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Se).on("mousedown",Oe).on("touchstart",function(e){var t=d3.select(this),o=d3.event.touches.item(0),n=[o.pageX,o.pageY];v=[o.pageX,o.pageY],g=0,D=setTimeout(function(){Ie(t,n)},h),Oe.call(this,e)}).on("touchend",function(e){clearTimeout(D),D=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Se.call(this,e)}),n.append("g").attr("transform","translate(35,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){Re(e,Q,t)}).on("touchstart",function(e,t){Re(e,Q,t)}).on("mouseup",function(e,t){$e(e,Q,t)}).on("touchend",function(e,t){$e(e,Q,t)}).on("mouseover",function(e){je(d3.select(this),e,Q,0)}).on("mouseout",function(e){Ce(d3.select(this))}),n.append("svg:text").attr("class","port_label").attr("x",18).attr("y",20).style("font-size","10px").text("input");var a=ne.selectAll(".subflowstatus").data(P.status?[P.status]:[],function(e,t){return e.id});a.exit().remove();var i=a.enter().insert("svg:g").attr("class","node subflowstatus").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});i.each(function(e,t){e.w=40,e.h=40}),i.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Se).on("mousedown",Oe).on("touchstart",function(e){var t=d3.select(this),o=d3.event.touches.item(0),n=[o.pageX,o.pageY];v=[o.pageX,o.pageY],g=0,D=setTimeout(function(){Ie(t,n)},h),Oe.call(this,e)}).on("touchend",function(e){clearTimeout(D),D=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Se.call(this,e)}),i.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){Re(e,X,0)}).on("touchstart",function(e,t){Re(e,X,0)}).on("mouseup",function(e,t){$e(e,X,0)}).on("touchend",function(e,t){$e(e,X,0)}).on("mouseover",function(e){je(d3.select(this),e,X,0)}).on("mouseout",function(e){Ce(d3.select(this))}),i.append("svg:text").attr("class","port_label").attr("x",22).attr("y",20).style("font-size","10px").text("status"),e.each(function(e,t){if(e.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.selectAll(".port_index").text(function(e){return e.i+1}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),($[e.id]=e).dirty=!1}}),o.each(function(e,t){if(e.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),($[e.id]=e).dirty=!1}}),a.each(function(e,t){if(e.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.selectAll(".port_index").text(function(e){return e.i+1}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),($[e.id]=e).dirty=!1}})}else ne.selectAll(".subflowoutput").remove(),ne.selectAll(".subflowinput").remove(),ne.selectAll(".subflowstatus").remove();var s=ne.selectAll(".nodegroup").data(d,function(e){return e.id});s.exit().remove(),s.enter().insert("svg:g").attr("class","node nodegroup").classed("node_subflow",function(e){return null!=P}).classed("node_link",function(e){return"link in"===e.type||"link out"===e.type}).each(function(e,t){var n=d3.select(this),o="link in"===e.type||"link out"===e.type,a=e.hasOwnProperty("l")?!e.l:o;n.attr("id",e.id);var i=RED.utils.getNodeLabel(e);if(e.w=a?C:Math.max(j,20*Math.ceil((ye(i,"node_label",50)+(0<e._def.inputs?7:0))/20)),e.h=Math.max(C,15*(e.outputs||0)),e._def.badge){var s=n.append("svg:g").attr("class","node_badge_group"),r=s.append("rect").attr("class","node_badge").attr("rx",5).attr("ry",5).attr("width",40).attr("height",15);s.append("svg:text").attr("class","node_badge_label").attr("x",35).attr("y",11).attr("text-anchor","end").text(e._def.badge()),e._def.onbadgeclick&&r.attr("cursor","pointer").on("click",function(e){e._def.onbadgeclick.call(e),d3.event.preventDefault()})}if(e._def.button){var l=n.append("svg:g").attr("transform",function(e){return"translate("+("right"==e._def.align?94:-25)+",2)"}).attr("class",function(e){return"node_button "+("right"==e._def.align?"node_right_button":"node_left_button")});l.append("rect").attr("rx",5).attr("ry",5).attr("width",32).attr("height",C-4).attr("fill","#eee"),l.append("rect").attr("class","node_button_button").attr("x",function(e){return"right"==e._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",C-12).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)}).attr("cursor","pointer").on("mousedown",function(e){!F&&Le(e)&&(Ae(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(e){!F&&Le(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(e){!F&&Le(e)&&d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(e){if(!F&&Le(e)){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}}).on("click",Pe).on("touchstart",Pe)}n.append("rect").attr("class","node").classed("node_unknown",function(e){return"unknown"==e.type}).attr("rx",5).attr("ry",5).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)}).on("mouseup",Se).on("mousedown",Oe).on("touchstart",function(e){var t=d3.select(this),o=d3.event.touches.item(0),n=[o.pageX,o.pageY];v=[o.pageX,o.pageY],g=0,D=setTimeout(function(){Ie(t,n)},h),Oe.call(this,e)}).on("touchend",function(e){clearTimeout(D),D=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Se.call(this,e)}).on("mouseover",function(o){if(0===U)d3.select(this).classed("node_hovered",!0),clearTimeout(xe),(o.hasOwnProperty("l")?o.l:"link in"!==o.type&&"link out"!==o.type)||(xe=setTimeout(function(){var t;if(o._def.label){t=o._def.label;try{t=("function"==typeof t?t.call(o):t)||""}catch(e){console.log("Definition error: "+o.type+".label",e),t=o.type}}if(""!==t){var e=Te(n.node());xe=null,ke=_e(e[0]+o.w/2,e[1]-1,t,"top")}},500));else if(U===RED.state.JOINING||U===RED.state.QUICK_JOINING){var e,t;if(0<ae.length)t=ae[0].virtualLink&&ae[0].portType===X||ae[0].portType===Q?(e=".port_input .port",X):(e=".port_output .port",Q),je(d3.select(this.parentNode).selectAll(e),o,t,0)}}).on("mouseout",function(e){var t;(d3.select(this).classed("node_hovered",!1),clearTimeout(xe),ke&&(ke.remove(),ke=null),U===RED.state.JOINING||U===RED.state.QUICK_JOINING)&&(0<ae.length&&(ae[0].virtualLink&&ae[0].portType===X||ae[0].portType===Q?t=".port_input .port":t=".port_output .port",Ce(d3.select(this.parentNode).selectAll(t))))});if(e._def.icon){var d=RED.utils.getNodeIcon(e._def,e),c=n.append("g").attr("class","node_icon_group").attr("x",0).attr("y",0);c.append("rect").attr("x",0).attr("y",0).attr("class","node_icon_shade").attr("width","30").attr("stroke","none").attr("fill","#000").attr("fill-opacity","0.05").attr("height",function(e){return Math.min(50,e.h-4)});Ne(d,c,e);var p=c.append("path").attr("d",function(e){return"M 30 1 l 0 "+(e.h-2)}).attr("class","node_icon_shade_border").attr("stroke-opacity","0.1").attr("stroke","#000").attr("stroke-width","1");"right"==e._def.align&&(c.attr("class","node_icon_group node_icon_group_"+e._def.align),p.attr("d",function(e){return"M 0 1 l 0 "+(e.h-2)})),c.style("pointer-events","none")}var u=n.append("svg:text").attr("class","node_label").attr("x",38).attr("dy",".35em").attr("text-anchor","start").classed("hidden",a);e._def.align&&(u.attr("class","node_label node_label_"+e._def.align),"right"===e._def.align&&u.attr("text-anchor","end"));var f=n.append("svg:g").attr("class","node_status_group").style("display","none");f.append("rect").attr("class","node_status").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),f.append("svg:text").attr("class","node_status_label").attr("x",20).attr("y",10);n.append("image").attr("class","node_error hidden").attr("xlink:href","red/images/icons/node-error.png").attr("x",0).attr("y",-6).attr("width",10).attr("height",9),n.append("image").attr("class","node_changed hidden").attr("xlink:href","red/images/icons/node-changed.png").attr("x",12).attr("y",-6).attr("width",10).attr("height",10)}),s.each(function(e,t){if(e.dirty){var o="link in"===e.type||"link out"===e.type,n=e.hasOwnProperty("l")?!e.l:o;if(($[e.id]=e).resize){var a=RED.utils.getNodeLabel(e),i=e.w;e.w=n?C:Math.max(j,20*Math.ceil((ye(a,"node_label",50)+(0<e._def.inputs?7:0))/20)),e.h=Math.max(C,15*(e.outputs||0)),e.x+=(e.w-i)/2,e.resize=!1}var s=d3.select(this);if(s.classed("node_subflow",function(e){return null!=P}),s.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),U!=RED.state.MOVING_ACTIVE){s.selectAll(".node").attr("width",function(e){return e.w}).attr("height",function(e){return e.h}).classed("node_selected",function(e){return e.selected}).classed("node_highlighted",function(e){return e.highlighted}),!e._def.align&&0!==e.inputs&&0===e.outputs||"right"===e._def.align?(s.selectAll(".node_icon_group").classed("node_icon_group_right",!0),s.selectAll(".node_label").classed("node_label_right",!0).attr("text-anchor","end")):(s.selectAll(".node_icon_group").classed("node_icon_group_right",!1),s.selectAll(".node_label").classed("node_label_right",!1).attr("text-anchor","start")),s.selectAll(".node_icon_group").attr("transform",function(e){return"translate(0, 0)"}),s.selectAll(".node_label").attr("x",function(e){return 38}),s.selectAll(".node_icon_group_right").attr("transform",function(e){return"translate("+(e.w-30)+",0)"}),s.selectAll(".node_label_right").attr("x",function(e){return e.w-38});var r=s.selectAll(".port_input");if(!o||-1!==H||I[e.id]||0!==e.inputs||r.empty()){if((o&&(H===X||I[e.id])||1===e.inputs)&&r.empty()){var l=s.append("g").attr("class","port_input");("link in"===e.type?l.append("circle").attr("cx",-1).attr("cy",5).attr("r",5).attr("class","port link_port"):l.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10)).on("mousedown",function(e){Re(e,X,0)}).on("touchstart",function(e){Re(e,X,0)}).on("mouseup",function(e){$e(e,X,0)}).on("touchend",function(e){$e(e,X,0)}).on("mouseover",function(e){je(d3.select(this),e,X,0)}).on("mouseout",function(e){Ce(d3.select(this))})}}else r.remove();var d=e.outputs;o&&"link out"===e.type&&(d=H===Q||I[e.id]?(e.ports=[0],1):(e.ports=[],0));var c=e.h/2-(d-1)/2*13;e.ports=e.ports||d3.range(d),e._ports=s.selectAll(".port_output").data(e.ports);var p=e._ports.enter().append("g").attr("class","port_output");if(("link out"===e.type?p.append("circle").attr("cx",11).attr("cy",5).attr("r",5).attr("class","port link_port"):p.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10)).on("mousedown",(R=e,function(e,t){Re(R,Q,t)})).on("touchstart",(E=e,function(e,t){Re(E,Q,t)})).on("mouseup",(D=e,function(e,t){$e(D,Q,t)})).on("touchend",(w=e,function(e,t){$e(w,Q,t)})).on("mouseover",(y=e,function(e,t){je(d3.select(this),y,Q,t)})).on("mouseout",function(e,t){Ce(d3.select(this))}),e._ports.exit().remove(),e._ports){d=e.outputs||1,c=e.h/2-(d-1)/2*13;var u=e.w-5;e._ports.each(function(e,t){d3.select(this).attr("transform",function(e){return"translate("+u+","+(c+13*t-5)+")"})})}if(s.selectAll("text.node_label").text(function(t,e){var o="";if(t._def.label){o=t._def.label;try{o=("function"==typeof o?o.call(t):o)||"",o=RED.text.bidi.enforceTextDirectionWithUCC(o)}catch(e){console.log("Definition error: "+t.type+".label",e),o=t.type}}return o}).attr("y",function(e){return e.h/2-1}).attr("class",function(t){var o="";if(t._def.labelStyle){o=t._def.labelStyle;try{o=("function"==typeof o?o.call(t):o)||""}catch(e){console.log("Definition error: "+t.type+".labelStyle",e),o=""}o=" "+o}return"node_label"+(t._def.align?" node_label_"+t._def.align:"")+o}).classed("hidden",n),e._def.icon){var f,h=s.select(".node_icon"),g=s.select(".fa-lg");f=h.empty()?g.attr("xlink:href"):h.attr("xlink:href");var v=RED.utils.getNodeIcon(e._def,e);if(v!==f)h.empty()?g.remove():h.remove(),Ne(v,s.select(".node_icon_group"),e)}s.selectAll(".node_tools").attr("x",function(e){return e.w-35}).attr("y",function(e){return e.h-20}),s.selectAll(".node_changed").attr("x",function(e){return e.w-10}).classed("hidden",function(e){return!(e.changed||e.moved)}),s.selectAll(".node_error").attr("x",function(e){return e.w-10-(e.changed||e.moved?13:0)}).classed("hidden",function(e){return e.valid}),s.selectAll(".port_input").each(function(e,t){d3.select(this).attr("transform",function(e){return"translate(-5,"+(e.h/2-5)+")"})}),s.selectAll(".node_icon").attr("y",function(e){return(e.h-d3.select(this).attr("height"))/2}),s.selectAll(".node_icon_shade").attr("height",function(e){return e.h}),s.selectAll(".node_icon_shade_border").attr("d",function(e){return"M "+(!e._def.align&&0!==e.inputs&&0===e.outputs||"right"===e._def.align?0:30)+" 1 l 0 "+(e.h-2)}),s.selectAll(".fa-lg").attr("y",function(e){return(e.h+13)/2}),s.selectAll(".node_button").attr("opacity",function(e){return Le(e)?1:.4}),s.selectAll(".node_button_button").attr("cursor",function(e){return Le(e)?"pointer":""}),s.selectAll(".node_button").attr("transform",function(e){var t="right"==e._def.align?e.w-6:-25;return e._def.button.toggle&&!e[e._def.button.toggle]&&(t-="right"==e._def.align?8:-8),"translate("+t+",2)"}),s.selectAll(".node_button rect").attr("fill-opacity",function(e){return e._def.button.toggle?e[e._def.button.toggle]?1:.2:1}),e._def.button&&"function"==typeof e._def.button.visible&&(!1===e._def.button.visible.call(e)?s.selectAll(".node_button").style("display","none"):s.selectAll(".node_button").style("display","inherit")),s.selectAll(".node_badge_group").attr("transform",function(e){return"translate("+(e.w-40)+","+(e.h+3)+")"}),s.selectAll("text.node_badge_label").text(function(t,e){if(t._def.badge){if("function"!=typeof t._def.badge)return t._def.badge;try{return t._def.badge.call(t)}catch(e){return console.log("Definition error: "+t.type+".badge",e),""}}return""})}if(V&&e.status){var b,m=Y[e.status.fill];if(null==e.status.shape&&null==m)s.selectAll(".node_status").style("display","none"),s.selectAll(".node_status_group").style("display","inline").attr("transform","translate(-14,"+(e.h+3)+")");else s.selectAll(".node_status_group").style("display","inline").attr("transform","translate(3,"+(e.h+3)+")"),null==e.status.shape||"dot"==e.status.shape?b={display:"inline",fill:m,stroke:m}:"ring"==e.status.shape&&(b={display:"inline",fill:"#fff",stroke:m}),s.selectAll(".node_status").style(b);e.status.text?s.selectAll(".node_status_label").text(e.status.text):s.selectAll(".node_status_label").text("")}else s.selectAll(".node_status_group").style("display","none");e.dirty=!1}var y,w,D,E,R});var r=oe.selectAll(".link").data(m,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i});r.enter().insert("g",".node").attr("class","link").each(function(e,t){var o=d3.select(this);e.added=!0,o.append("svg:path").attr("class","link_background link_path").classed("link_link",function(e){return e.link}).on("mousedown",function(e){E=e,fe(),N=E,ge(),ze(),Ae(),d3.event.stopPropagation()}).on("touchstart",function(e){E=e,fe(),N=E,ge(),ze(),Ae(),d3.event.stopPropagation();var t=d3.select(document.body),o=d3.event.touches.item(0),n=[o.pageX,o.pageY];D=setTimeout(function(){D=null,Ie(t,n)},h)}),o.append("svg:path").attr("class","link_outline link_path"),o.append("svg:path").attr("class","link_line link_path").classed("link_link",function(e){return e.link}).classed("link_subflow",function(e){return!e.link&&P})}),r.exit().remove(),oe.selectAll(".link_path").each(function(e){var t=d3.select(this);(e.added||e===N||e.selected||$[e.source.id]||$[e.target.id])&&(/link_line/.test(t.attr("class"))&&t.classed("link_subflow",function(e){return!e.link&&P}),t.attr("d",function(e){var t=-((e.source.outputs||1)-1)/2*13+13*(e.sourcePort||0);e.x1=e.source.x+e.source.w/2,e.y1=e.source.y+t,e.x2=e.target.x-e.target.w/2,e.y2=e.target.y;var o=le(e.x1,e.y1,e.x2,e.y2,1);return/NaN/.test(o)?"":o}))}),r.classed("link_selected",function(e){return e===N||e.selected}),r.classed("link_unknown",function(e){return delete e.added,"unknown"==e.target.type||"unknown"==e.source.type});var l=oe.selectAll(".link_flow_link_g").data(c,function(e){return e.node.id+":"+e.refresh});l.enter().insert("g",".node").attr("class","link_flow_link_g").each(function(o,e){var t=d3.select(this),a=1,i="start";"link in"===o.node.type&&(a=-1,i="end");var s=30*a,r=20*a,n=(t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M 0 0 h "+s),o.links),l=Object.keys(n),d=RED.nodes.getWorkspaceOrder();l.sort(function(e,t){return d.indexOf(e)-d.indexOf(t)});var c=C,p=-(l.length-1)*c/2,u=t.selectAll(".link_group").data(l);u.enter().append("g").attr("class","link_group").on("mouseover",function(){0===U&&d3.select(this).classed("link_group_active",!0)}).on("mouseout",function(){0===U&&d3.select(this).classed("link_group_active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(e){if(0===U){d3.event.stopPropagation();var t=o.links[e];RED.workspaces.show(e),t.forEach(function(e){e.selected=!0,e.dirty=!0,J.push({n:e})}),ge(),ze()}}).each(function(e){var t=d3.select(this);t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M "+s+" 0 C "+(s+1.7*r)+" 0 "+(s+.1*r)+" "+p+" "+(s+1.5*r)+" "+p+" "),t.append("svg:path").attr("class","link_port").attr("d","M "+(s+1.5*r+17*a)+" "+(p-12)+" h "+10*-a+" a 3 3 45 0 "+(1===a?"0":"1")+" "+-3*a+" 3 v 18 a 3 3 45 0 "+(1===a?"0":"1")+" "+3*a+" 3 h "+10*a),t.append("svg:path").attr("class","link_port").attr("d","M "+(s+1.5*r+20*a)+" "+(p-12)+" h "+30*a+" M "+(s+1.5*r+20*a)+" "+(p+12)+" h "+30*a).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","port link_port").attr("x",s+1.5*r-4+4*a).attr("y",p-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",s+1.5*r-(-1===a?j:0)).attr("y",p-12).attr("width",j).attr("height",24).style("stroke","none").style("fill","transparent");var o,n=RED.nodes.workspace(e);n&&(o=n.label||n.id),t.append("svg:text").attr("class","port_label").attr("x",s+1.5*r+15*a).attr("y",p+1).style("font-size","10px").style("text-anchor",i).text(o),p+=c}),u.exit().remove()}),l.exit().remove(),(l=oe.selectAll(".link_flow_link_g")).each(function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"})})}else oe.selectAll(".link_selected").data(m,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}).classed("link_selected",!1);RED.view.navigator.refresh(),d3.event&&d3.event.preventDefault()}function Ae(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;$("#chart").focus(),window.parent.window.scrollTo(e,t)}catch(e){$("#chart").focus()}}function Me(e,t,o){try{var n;P&&(n=P.changed);var a=RED.nodes.import(e,!0,t);if(a){var i=a[0],s=a[1],r=a[2],l=a[3],d=a[4];t&&d&&RED.workspaces.show(d.id);var c=i.filter(function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}).map(function(e){return{n:e}}),p=i.map(function(e){return e.changed=!0,e.id});if(0<c.length){var u=c[0].n,f=u.x,h=u.y;null==q&&(q=[0,0]);var g,v,b=0,m=0;for(g=0;g<c.length;g++)(v=c[g]).n.selected=!0,v.n.changed=!0,v.n.moved=!0,v.n.x-=f-q[0],v.n.y-=h-q[1],v.dx=v.n.x-q[0],v.dy=v.n.y-q[1],b=Math.min(v.n.x-j/2-5,b),m=Math.min(v.n.y-C/2-5,m);for(g=0;g<c.length;g++)if((v=c[g]).n.x-=b,v.n.y-=m,v.dx-=b,v.dy-=m,v.n._def.onadd)try{v.n._def.onadd.call(v.n)}catch(e){console.log("Definition error: "+v.n.type+".onadd:",e)}o||(U=RED.state.IMPORT_DRAGGING,L=!1,1===c.length&&(v=c[0],L=v.n.hasOwnProperty("_def")&&0<v.n._def.inputs&&0<v.n._def.outputs)),RED.keyboard.add("*","escape",function(){RED.keyboard.remove("escape"),fe(),RED.history.pop(),U=0}),fe(),J=c}var y={t:"add",nodes:p,links:s,workspaces:r,subflows:l,dirty:RED.nodes.dirty()};if(0===c.length&&RED.nodes.dirty(!0),P){var w=RED.subflow.refresh(!0);w&&(y.subflow={id:P.id,changed:n,instances:w.instances})}RED.history.push(y),re(),ze();var D=[],E=0,R=0;if(i.forEach(function(e){e.hasOwnProperty("x")&&e.hasOwnProperty("y")?E++:R++}),0<r.length&&D.push(RED._("clipboard.flow",{count:r.length})),0<E&&D.push(RED._("clipboard.node",{count:E})),0<R&&D.push(RED._("clipboard.configNode",{count:E})),0<l.length&&D.push(RED._("clipboard.subflow",{count:l.length})),0<D.length){var $="<ul><li>"+D.join("</li><li>")+"</li></ul>";RED.notify("<p>"+RED._("clipboard.nodesImported")+"</p>"+$,{id:"clipboard"})}}}catch(e){"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}return{init:function(){RED.events.on("workspace:change",function(e){0!==e.old&&(i[e.old]={left:Z.scrollLeft(),top:Z.scrollTop()});var t=Z.scrollLeft(),o=Z.scrollTop();P=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",P),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||P),i[e.workspace]?(Z.scrollLeft(i[e.workspace].left),Z.scrollTop(i[e.workspace].top)):(Z.scrollLeft(0),Z.scrollTop(0));var n=Z.scrollLeft()-t,a=Z.scrollTop()-o;null!=q&&(q[0]+=n,q[1]+=a),0===RED.workspaces.selection().length&&fe(),RED.nodes.eachNode(function(e){e.dirty=!0}),ge(),re(),ze()}),RED.view.navigator.init(),$("#btn-zoom-out").click(function(){l()}),RED.popover.tooltip($("#btn-zoom-out"),RED._("actions.zoom-out"),"core:zoom-out"),$("#btn-zoom-zero").click(function(){pe()}),RED.popover.tooltip($("#btn-zoom-zero"),RED._("actions.zoom-reset"),"core:zoom-reset"),$("#btn-zoom-in").click(function(){s()}),RED.popover.tooltip($("#btn-zoom-in"),RED._("actions.zoom-in"),"core:zoom-in"),$("#chart").on("DOMMouseScroll mousewheel",function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?l():s())}),$("#chart").droppable({accept:".palette_node",drop:function(e,t){d3.event=e;var o=de(t.draggable[0].type);if(o){var n=o.historyEvent,a=o.node,i=RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label");void 0===i||/^link (in|out)$/.test(a._def.type)||a._def.defaults.hasOwnProperty("l")||(a.l=i);var s=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),r=d3.touches(this)[0]||d3.mouse(this);r[1]+=this.scrollTop+(a.h/2-s[1]),r[0]+=this.scrollLeft+(a.w/2-s[0]),r[1]/=p,r[0]/=p,O&&(r[0]=S*Math.ceil(r[0]/S),r[1]=S*Math.ceil(r[1]/S)),a.x=r[0],a.y=r[1];var l=$(t.helper).data("splice");if(l){RED.nodes.removeLink(l);var d={source:l.source,sourcePort:l.sourcePort,target:a},c={source:a,sourcePort:0,target:l.target};RED.nodes.addLink(d),RED.nodes.addLink(c),n.links=[d,c],n.removedLinks=[l]}RED.history.push(n),RED.nodes.add(a),RED.editor.validateNode(a),RED.nodes.dirty(!0),fe(),a.selected=!0,J.push({n:a}),re(),ge(),ze(),a._def.autoedit&&RED.editor.edit(a)}}}),$("#chart").focus(function(){$("#workspace-tabs").addClass("workspace-focussed")}),$("#chart").blur(function(){$("#workspace-tabs").removeClass("workspace-focussed")}),RED.actions.add("core:copy-selection-to-internal-clipboard",me),RED.actions.add("core:cut-selection-to-internal-clipboard",function(){me(),be()}),RED.actions.add("core:paste-from-internal-clipboard",function(){Me(r)}),RED.actions.add("core:delete-selection",be),RED.actions.add("core:edit-selected-node",ve),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:select-all-nodes",ue),RED.actions.add("core:zoom-in",s),RED.actions.add("core:zoom-out",l),RED.actions.add("core:zoom-reset",pe),RED.actions.add("core:toggle-show-grid",function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):e?o.style("visibility","visible"):o.style("visibility","hidden")}),RED.actions.add("core:toggle-snap-grid",function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):(O=e,ze())}),RED.actions.add("core:toggle-status",function(e){void 0===e?RED.userSettings.toggle("view-node-status"):(V=e,RED.nodes.eachNode(function(e){e.dirty=!0}),ze())}),RED.view.tools.init()},state:function(e){if(null==e)return U;U=e},redraw:function(e){e&&(re(),ge()),ze()},focus:Ae,importNodes:Me,calculateTextWidth:ye,select:function(e){if(void 0!==e&&(fe(),"string"==typeof e)){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,J=[{n:t}])}ge(),ze()},selection:function(){var e={};return 0<J.length&&(e.nodes=J.map(function(e){return e.n})),null!=N&&(e.link=N),e},scale:function(){return p},getLinksAtPoint:function(e,t){for(var o=[],n=ee.selectAll(".link_background")[0],a=0;a<n.length;a++){var i=n[a].getBBox();e>=i.x&&t>=i.y&&e<=i.x+i.width&&t<=i.y+i.height&&o.push(n[a])}return o},reveal:function(e){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e);else{var t=RED.nodes.node(e);if("config"!==t._def.category&&t.z){t.highlighted=!0,t.dirty=!0,RED.workspaces.show(t.z);var o=[$("#chart").width(),$("#chart").height()],n=[$("#chart").scrollLeft(),$("#chart").scrollTop()];if(t.x<n[0]||t.y<n[1]||t.x>o[0]+n[0]||t.y>o[1]+n[1]){var a="-="+(n[0]-t.x+o[0]/2),i="-="+(n[1]-t.y+o[1]/2);$("#chart").animate({scrollLeft:a,scrollTop:i},200)}if(!t._flashing){t._flashing=!0;var s=22,r=function(){s--,t.dirty=!0,0<=s?(t.highlighted=!t.highlighted,setTimeout(r,100)):(t.highlighted=!1,delete t._flashing),RED.view.redraw()};r()}}else"config"===t._def.category&&RED.sidebar.config.show(e)}},gridSize:function(e){if(void 0===e)return S;S=Math.max(5,e),t()},getActiveNodes:function(){return d}}}(),RED.view.navigator=function(){var e,t,o,n,a,i,s,r,l,d=25,c=5e3/d,p=5e3/d,u=!1;function f(){if(u){var e=n.selectAll(".navnode").data(RED.view.getActiveNodes(),function(e){return e.id});e.exit().remove(),e.enter().insert("rect").attr("class","navnode").attr("pointer-events","none"),e.each(function(e){d3.select(this).attr("x",function(e){return(e.x-e.w/2)/d}).attr("y",function(e){return(e.y-e.h/2)/d}).attr("width",function(e){return Math.max(9,e.w/d)}).attr("height",function(e){return Math.max(3,e.h/d)}).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)})})}}function h(){l||g()}function g(){o&&(i=RED.view.scale(),s=[$("#chart").width(),$("#chart").height()],a=[$("#chart").scrollLeft(),$("#chart").scrollTop()],o.attr("x",a[0]/d).attr("y",a[1]/d).attr("width",s[0]/d/i).attr("height",s[1]/d/i))}function v(){u?(u=!1,e.fadeOut(100),$("#chart").off("scroll",h),$("#btn-navigate").removeClass("selected")):(u=!0,$("#btn-navigate").addClass("selected"),g(),f(),$("#chart").on("scroll",h),e.fadeIn(200))}return{init:function(){$(window).resize(g),RED.events.on("sidebar:resize",g),RED.actions.add("core:toggle-navigator",v),e=$("<div>").css({position:"absolute",bottom:$("#workspace-footer").height(),right:0,zIndex:1}).appendTo("#workspace").hide(),(t=d3.select(e[0]).append("svg:svg").attr("width",c).attr("height",p).attr("pointer-events","all").style({position:"absolute",bottom:0,right:0,zIndex:101,"border-left":"1px solid #ccc","border-top":"1px solid #ccc",background:"rgba(245,245,245,0.8)","box-shadow":"-1px 0 3px rgba(0,0,0,0.1)"})).append("rect").attr("x",0).attr("y",0).attr("width",c).attr("height",p).style({fill:"none",stroke:"none",pointerEvents:"all"}).on("mousedown",function(){i=RED.view.scale(),s=[$("#chart").width(),$("#chart").height()],r=[s[0]/d/i,s[1]/d/i];var e=Math.max(0,Math.min(d3.event.offsetX+r[0]/2,c)-r[0]),t=Math.max(0,Math.min(d3.event.offsetY+r[1]/2,p)-r[1]);o.attr("x",e).attr("y",t),l=!0,$("#chart").scrollLeft(e*d*i),$("#chart").scrollTop(t*d*i)}).on("mousemove",function(){if(l)if(0!==d3.event.buttons){var e=Math.max(0,Math.min(d3.event.offsetX+r[0]/2,c)-r[0]),t=Math.max(0,Math.min(d3.event.offsetY+r[1]/2,p)-r[1]);o.attr("x",e).attr("y",t),$("#chart").scrollLeft(e*d*i),$("#chart").scrollTop(t*d*i)}else l=!1}).on("mouseup",function(){l=!1}),o=t.append("rect").attr("stroke-dasharray","5,5").attr("pointer-events","none").style({stroke:"#999",strokeWidth:1,fill:"white"}),n=t.append("svg:g"),$("#btn-navigate").click(function(e){e.preventDefault(),v()}),RED.popover.tooltip($("#btn-navigate"),RED._("actions.toggle-navigator"),"core:toggle-navigator")},refresh:f,resize:g,toggle:v}}(),RED.view.tools=function(){function e(){var e=RED.view.selection();if(e.nodes){var n=[];e.nodes.forEach(function(e){var t=e.w/2+Math.round((e.x-e.w/2)/RED.view.gridSize())*RED.view.gridSize(),o=Math.round(e.y/RED.view.gridSize())*RED.view.gridSize();e.x===t&&e.y===o||(n.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=t,e.y=o,e.dirty=!0,e.moved=!0)}),0<n.length&&(RED.history.push({t:"move",nodes:n,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}var l=null,d=!1;function c(){if(d=!1,0<l.length){for(var e=[],t=0;t<l.length;t++)e.push({n:l[t].n,ox:l[t].ox,oy:l[t].oy,moved:l[t].moved}),l[t].n.moved=!0,l[t].n.dirty=!0,delete l[t].ox,delete l[t].oy;RED.view.redraw(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),l=null}}function t(e,t){if(null===l){var o=RED.view.selection();o.nodes&&(l=o.nodes.map(function(e){return{n:e}}))}if(l&&0<l.length){d||($(document).one("keyup",c),d=!0);for(var n,a=0,i=0,s=0;s<l.length;s++)null==(n=l[s]).ox&&null==n.oy&&(n.ox=n.n.x,n.oy=n.n.y,n.moved=n.n.moved),n.n.moved=!0,n.n.dirty=!0,n.n.x+=e,n.n.y+=t,n.n.dirty=!0,a=Math.min(n.n.x-n.n.w/2-5,a),i=Math.min(n.n.y-n.n.h/2-5,i);if(0!==a||0!==i)for(var r=0;r<l.length;r++)(n=l[r]).n.x-=a,n.n.y-=i;RED.view.redraw()}}return{init:function(){RED.actions.add("core:align-selection-to-grid",e),RED.actions.add("core:move-selection-up",function(){t(0,-1)}),RED.actions.add("core:move-selection-right",function(){t(1,0)}),RED.actions.add("core:move-selection-down",function(){t(0,1)}),RED.actions.add("core:move-selection-left",function(){t(-1,0)}),RED.actions.add("core:step-selection-up",function(){t(0,-RED.view.gridSize())}),RED.actions.add("core:step-selection-right",function(){t(RED.view.gridSize(),0)}),RED.actions.add("core:step-selection-down",function(){t(0,RED.view.gridSize())}),RED.actions.add("core:step-selection-left",function(){t(-RED.view.gridSize(),0)})},alignSelectionToGrid:e,moveSelection:t}}(),RED.sidebar=function(){var i=RED.tabs.create({id:"sidebar-tabs",onchange:function(e){$("#sidebar-content").children().hide(),$("#sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show()},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},collapsible:!0}),s={};var r={dragging:!1};$("#sidebar-separator").draggable({axis:"x",start:function(e,t){r.closing=!1,r.opening=!1;var o=$(window).width();if(r.start=t.position.left,r.chartWidth=$("#workspace").width(),r.chartRight=o-$("#workspace").width()-$("#workspace").offset().left-2,r.dragging=!0,!RED.menu.isSelected("menu-item-sidebar")){r.opening=!0;$("#sidebar").addClass("closing"),$("#workspace").css("right",7),$("#editor-stack").css("right",8),$("#sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}r.width=$("#sidebar").width()},drag:function(e,t){var o=t.position.left-r.start,n=r.width-o;r.opening&&(n-=3),150<n&&r.chartWidth+o<200&&(t.position.left=200+r.start-r.chartWidth,o=t.position.left-r.start,n=r.width-o),n<150?(r.closing||($("#sidebar").addClass("closing"),r.closing=!0),r.opening||(n=150,t.position.left=r.width-(150-r.start),o=t.position.left-r.start)):150<n&&(r.closing||r.opening)&&(r.closing=!1,$("#sidebar").removeClass("closing"));var a=r.chartRight-o;$("#workspace").css("right",a),$("#editor-stack").css("right",a+1),$("#sidebar").width(n),i.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){r.dragging=!1,r.closing&&($("#sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#sidebar").width()<180&&($("#sidebar").width(180),$("#workspace").css("right",187),$("#editor-stack").css("right",188))),$("#sidebar-separator").css("left","auto"),$("#sidebar-separator").css("right",$("#sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}});var e=$('<div class="sidebar-control-right"><i class="fa fa-chevron-right"</div>').appendTo($("#sidebar-separator"));function t(e){e?($("#main-container").removeClass("sidebar-closed"),i.resize()):$("#main-container").addClass("sidebar-closed"),RED.events.emit("sidebar:resize")}function l(e){e&&(o(e)||i.addTab(s[e]),i.activateTab(e),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function o(e){return i.contains(e)}return e.click(function(){e.hide(),RED.menu.toggleSelected("menu-item-sidebar")}),$("#sidebar-separator").on("mouseenter",function(){r.dragging||(RED.menu.isSelected("menu-item-sidebar")?e.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left"):e.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left"),e.toggle("slide",{direction:"right"},200))}),$("#sidebar-separator").on("mouseleave",function(){r.dragging||e.hide()}),{init:function(){RED.actions.add("core:toggle-sidebar",function(e){void 0===e?RED.menu.toggleSelected("menu-item-sidebar"):t(e)}),RED.popover.tooltip($("#sidebar-separator").find(".sidebar-control-right"),RED._("keyboard.toggleSidebar"),"core:toggle-sidebar"),l(),RED.sidebar.info.init(),RED.sidebar.config.init(),RED.sidebar.context.init(),$(window).width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(e,t,o,n){var a;"string"==typeof e?a={id:t.id,label:e,name:e,content:t,closeable:o,visible:n}:"object"==typeof e&&(a=e),delete a.closeable,a.wrapper=$("<div>",{style:"height:100%"}).appendTo("#sidebar-content"),a.wrapper.append(a.content),a.wrapper.hide(),a.enableOnEdit||(a.shade=$("<div>",{class:"sidebar-shade hide"}).appendTo(a.wrapper)),a.toolbar&&($("#sidebar-footer").append(a.toolbar),$(a.toolbar).hide()),a.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+a.id,label:a.name,onselect:function(){l(a.id)},group:"sidebar-tabs"}),a.iconClass=a.iconClass||"fa fa-square-o",!1!==(s[a.id]=a).visible&&i.addTab(s[a.id])},removeTab:function(e){i.removeTab(e),$(s[e].wrapper).remove(),s[e].footer&&s[e].footer.remove(),delete s[e],RED.menu.removeItem("menu-item-view-menu-"+e)},show:l,containsTab:o,toggleSidebar:t}}(),RED.palette=function(){var t,E=["config","unknown","deprecated"],R=["subflows","input","output","function","social","mobile","storage","analysis","advanced"],x={};function k(e,t,o,n){0===$("#palette-base-category-"+t).length&&a(e,t,n+":palette.label."+t),$("#palette-container-"+t).show(),0===$("#palette-"+o).length&&$("#palette-base-category-"+t).append('<div id="palette-'+o+'"></div>')}function a(e,t,o){var n=RED._(o,{defaultValue:t});n=(n||t).replace(/_/g," ");var a=$('<div id="palette-container-'+t+'" class="palette-category palette-close hide"><div id="palette-header-'+t+'" class="palette-header"><i class="expanded fa fa-angle-down"></i><span>'+n+'</span></div><div class="palette-content" id="palette-base-category-'+t+'"><div id="palette-'+t+'-input"></div><div id="palette-'+t+'-output"></div><div id="palette-'+t+'-function"></div></div></div>').appendTo("#palette-container");a.data("category",e),a.data("label",n),x[t]={container:a,close:function(){a.removeClass("palette-open"),a.addClass("palette-closed"),$("#palette-base-category-"+t).slideUp(),$("#palette-header-"+t+" i").removeClass("expanded")},open:function(){a.addClass("palette-open"),a.removeClass("palette-closed"),$("#palette-base-category-"+t).slideDown(),$("#palette-header-"+t+" i").addClass("expanded")},toggle:function(){a.hasClass("palette-open")?x[t].close():x[t].open()}},$("#palette-header-"+t).on("click",function(e){x[t].toggle()})}function T(t,e,o,n){for(var a=(o=RED.utils.sanitize(o)).split(/[ -]/),i=[],s=a[0],r=(RED.view.calculateTextWidth(s,"palette_label",0),1);r<a.length;r++){var l=RED.view.calculateTextWidth(s+" "+a[r],"palette_label",0);l<82?(s+=" "+a[r],l):(i.push(s),s=a[r],RED.view.calculateTextWidth(s,"palette_label",0))}i.push(s);var d,c=i.join("<br/>"),p=8+20*i.length;e.css({height:p+"px"}),e.find(".palette_label").html(c).attr("dir",RED.text.bidi.resolveBaseTextDir(c)),e.find(".palette_port").css({top:p/2-5+"px"});try{var u="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(o)+"</b></p>";(d=$("<div></div>").append($(u+(n||($("script[data-help-name='"+t+"']").html()||"<p>"+RED._("palette.noInfo")+"</p>")).trim()).filter(function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&0<this.textContent.trim().length}).slice(0,2))).find("a").each(function(){var e=$(this).text();$(this).before(e),$(this).remove()});var f=RED.nodes.getType(t);if(f){var h="";f&&!/^subflow:/.test(t)&&(h=f.set.module+" : "),h+=t,$("<p>",{style:"font-size: 0.8em"}).text(h).appendTo(d)}}catch(e){console.log("Error generating pop-over label for ",t),console.log(e.toString()),d="<p><b>"+o+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}e.data("popover").setContent(d)}function _(e){return e.replace(" ","_").replace(".","_").replace(":","_")}function o(t,o){var e=_(t);if(!$("#palette_node_"+e).length&&-1===E.indexOf(o.category)){o.category;var n=o.category.replace(/ /g,"_"),a=n.split("-")[0],i=document.createElement("div");i.id="palette_node_"+e,i.type=t;var s=/^(.*?)([ -]in|[ -]out)?$/.exec(t)[1];if(void 0!==o.paletteLabel)try{s=("function"==typeof o.paletteLabel?o.paletteLabel.call(o):o.paletteLabel)||""}catch(e){console.log("Definition error: "+t+".paletteLabel",e)}if($("<div/>",{class:"palette_label"+(!o.align&&0!==o.inputs&&0===o.outputs||"right"===o.align?" palette_label_right":"")}).appendTo(i),i.className="palette_node",o.icon){var r=RED.utils.getNodeIcon(o),l=$("<div/>",{class:"palette_icon_container"+(!o.align&&0!==o.inputs&&0===o.outputs||"right"===o.align?" palette_icon_container_right":"")}).appendTo(i);RED.utils.createIconElement(r,l,!0)}if(i.style.backgroundColor=RED.utils.getNodeColor(t,o),0<o.outputs){var d=document.createElement("div");d.className="palette_port palette_port_output",i.appendChild(d)}if(0<o.inputs){var c=document.createElement("div");c.className="palette_port palette_port_input",i.appendChild(c)}k(o.category,a,n,-1!==R.indexOf(a)?"node-red":o.set.id),$("#palette-"+n).append(i),$(i).data("category",a),i.onmousedown=function(e){e.preventDefault()};var p=RED.popover.create({target:$(i),trigger:"hover",width:"300px",content:"hi",delay:{show:750,hide:50}});$(i).data("popover",p),$(i).click(function(){var e;RED.view.focus(),e=0===t.indexOf("subflow:")?marked(RED.nodes.subflow(t.substring(8)).info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>":$("script[data-help-name='"+i.type+"']").html()||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",RED.sidebar.info.set(e,RED._("sidebar.info.nodeHelp"))});var u,f,h,g,v,b,m=$("#chart"),y=m.offset(),w=$("#chart>svg").get(0);$(i).draggable({helper:"clone",appendTo:"body",revert:!0,revertDuration:50,containment:"#main-container",start:function(){v=$("#palette").width(),b=$("#palette").parent().position().top+$("#palette-container").position().top,RED.view.focus()},stop:function(){d3.select(".link_splice").classed("link_splice",!1),g&&(clearTimeout(g),g=null)},drag:function(e,c){c.position.left+=17.5,0<o.inputs&&0<o.outputs&&(f=c.position.left-v+c.helper.width()/2-y.left+m.scrollLeft(),h=c.position.top-b+c.helper.height()/2-y.top+m.scrollTop(),g||(g=setTimeout(function(){var e=[],t=1/0,o=null;if(w.getIntersectionList){var n=w.createSVGRect();n.x=f,n.y=h,n.width=1,n.height=1,e=w.getIntersectionList(n,w),f/=RED.view.scale(),h/=RED.view.scale()}else f/=RED.view.scale(),h/=RED.view.scale(),e=RED.view.getLinksAtPoint(f,h);for(var a=0;a<e.length;a++){var i=d3.select(e[a]);if(i.classed("link_background")&&!i.classed("link_link"))for(var s=e[a].getTotalLength(),r=0;r<s;r+=10){var l=e[a].getPointAtLength(r),d=(l.x-f)*(l.x-f)+(l.y-h)*(l.y-h);d<200&&d<t&&(t=d,o=e[a])}}u&&u!==o&&d3.select(u.parentNode).classed("link_splice",!1),o?d3.select(o.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),u!==o&&(o?$(c.helper).data("splice",d3.select(o).data()[0]):$(c.helper).removeData("splice")),u=o,g=null},200)))}});var D=null;0===t.indexOf("subflow:")&&($(i).dblclick(function(e){RED.workspaces.show(t.substring(8)),e.preventDefault()}),D=marked(o.info||"")),T(t,$(i),s,D),1===$("#palette-container-"+a).find(".palette_node").length&&x[a].open()}}function n(e){var t=_(e),o=$("#palette_node_"+t),n=o.closest(".palette-category");o.remove(),0===n.find(".palette_node").length&&n.find("i").hasClass("expanded")&&(n.find(".palette-content").slideToggle(),n.find("i").toggleClass("expanded"))}function i(e){var t=_(e),o=$("#palette_node_"+t);o.hide();for(var n=o.closest(".palette-category"),a=n.find(".palette_node"),i=0,s=0;s<a.length;s++)"none"===$(a[s]).css("display")&&(i+=1);i===a.length&&n.hide()}function s(e){var t=_(e),o=$("#palette_node_"+t);o.closest(".palette-category").show(),o.show()}return{init:function(){RED.events.on("registry:node-type-added",function(e){var t=RED.nodes.getType(e);o(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)}),RED.events.on("registry:node-type-removed",function(e){n(e)}),RED.events.on("registry:node-set-enabled",function(e){for(var t=0;t<e.types.length;t++){s(e.types[t]);var o=RED.nodes.getType(e.types[t]);o&&o.onpaletteadd&&"function"==typeof o.onpaletteadd&&o.onpaletteadd.call(o)}}),RED.events.on("registry:node-set-disabled",function(e){for(var t=0;t<e.types.length;t++){i(e.types[t]);var o=RED.nodes.getType(e.types[t]);o&&o.onpaletteremove&&"function"==typeof o.onpaletteremove&&o.onpaletteremove.call(o)}}),RED.events.on("registry:node-set-removed",function(e){if(e.added)for(var t=0;t<e.types.length;t++){n(e.types[t]);var o=RED.nodes.getType(e.types[t]);o&&o.onpaletteremove&&"function"==typeof o.onpaletteremove&&o.onpaletteremove.call(o)}}),$("#palette > .palette-spinner").show(),$("#palette-search input").searchBox({delay:100,change:function(){!function(n){var a=new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");for(var e in $("#palette-container .palette_node").each(function(e,t){var o=$(t).find(".palette_label").text();""===n||a.test(t.id)||a.test(o)?$(this).show():$(this).hide()}),x)x.hasOwnProperty(e)&&(0===x[e].container.find(".palette_node").filter(function(){return"none"!==$(this).css("display")}).length?x[e].close():x[e].open())}($(this).val())}}),t=$('<div class="sidebar-control-left"><i class="fa fa-chevron-left"</div>').appendTo($("#palette")),RED.popover.tooltip(t,RED._("keyboard.togglePalette"),"core:toggle-palette"),t.click(function(){RED.menu.toggleSelected("menu-item-palette")}),$("#palette").on("mouseenter",function(){t.toggle("slide",{direction:"left"},200)}),$("#palette").on("mouseleave",function(){t.hide()});var e=R;RED.settings.paletteCategories?e=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(e=RED.settings.theme("palette.categories")),Array.isArray(e)||(e=R),e.forEach(function(e){a(e,e,"palette.label."+e)}),$("#palette-collapse-all").on("click",function(e){for(var t in e.preventDefault(),x)x.hasOwnProperty(t)&&x[t].close()}),RED.popover.tooltip($("#palette-collapse-all"),RED._("palette.actions.collapse-all")),$("#palette-expand-all").on("click",function(e){for(var t in e.preventDefault(),x)x.hasOwnProperty(t)&&x[t].open()}),RED.popover.tooltip($("#palette-expand-all"),RED._("palette.actions.expand-all")),RED.actions.add("core:toggle-palette",function(e){void 0===e?RED.menu.toggleSelected("menu-item-palette"):(e?($("#main-container").removeClass("palette-closed"),t.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left")):($("#main-container").addClass("palette-closed"),t.hide(),t.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left")),setTimeout(function(){$(window).resize()},200))})},add:o,remove:n,hide:i,show:s,refresh:function(){RED.nodes.eachSubflow(function(e){var t,o,n,a,i=$("#palette_node_subflow_"+e.id.replace(".","_")),s=i.find(".palette_port_input"),r=i.find(".palette_port_output");if(i.find(".palette_label").attr("class","palette_label"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" palette_label_right":"")),i.find(".palette_icon_container").attr("class","palette_icon_container"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" palette_icon_container_right":"")),0===s.length&&0<e.in.length){var l=document.createElement("div");l.className="palette_port palette_port_input",i.append(l)}else 0!==s.length&&0===e.in.length&&s.remove();if(0===r.length&&0<e.out.length){var d=document.createElement("div");d.className="palette_port palette_port_output",i.append(d)}else 0!==r.length&&0===e.out.length&&r.remove();T(e.type+":"+e.id,i,e.name,marked(e.info||"")),t=i,o=e,n=RED.utils.getNodeIcon(o._def),a=t.find(".palette_icon_container"),RED.utils.createIconElement(n,a,!0);var c=i.data("category"),p=e.category||"subflows";if(c!==p){var u=p.replace(/ /g,"_");k(p,u,u,"node-red");var f=i.closest(".palette-category"),h=$("#palette-"+u);h.append(i),1===h.find(".palette_node").length&&x[u].open(),i.data("category",p),0===f.find(".palette_node").length&&f.find("i").hasClass("expanded")&&(f.find(".palette-content").slideToggle(),f.find("i").toggleClass("expanded"))}})},getCategories:function(){var o=[];return $("#palette-container .palette-category").each(function(e,t){o.push({id:$(t).data("category"),label:$(t).data("label")})}),o}}}(),RED.sidebar.info=function(){var n,j,C,S,O,d;marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var L={property:!1};function a(){RED.sidebar.show("info")}function i(e){if(void 0!==e){var t;j.show(),$(C.content).empty(),$(S.content).empty(),$(O.content).empty();var o,n,a=$('<table class="node-info"></table>').appendTo(C.content),i=$("<tbody>").appendTo(a),s=RED.projects.getActiveProject();if(s){t=$('<tr class="node-info-node-row"><td>Project</td><td></td></tr>').appendTo(i),$(t.children()[1]).text(s.name||""),$('<tr class="node-info-property-expand blank"><td colspan="2"></td></tr>').appendTo(i);var r=$('<button class="editor-button editor-button-small" style="position:absolute;right:2px;"><i class="fa fa-ellipsis-h"></i></button>').appendTo(t.children()[1]).click(function(e){e.preventDefault(),RED.projects.editProject()});RED.popover.tooltip(r,RED._("sidebar.project.showProjectSettings"))}if(C.container.show(),S.container.show(),O.container.show(),null!==e)if(Array.isArray(e)){var l={nodes:0,flows:0,subflows:0};e.forEach(function(e){"tab"===e.type?(l.flows++,l.nodes+=RED.nodes.filterNodes({z:e.id}).length):"subflow"===e.type?l.subflows++:l.nodes++}),O.container.hide(),S.container.hide(),t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.selection")+"</td><td></td></tr>").appendTo(i);var d=$("<div>").appendTo($(t.children()[1]));0<l.flows&&$("<div>").text(RED._("clipboard.flow",{count:l.flows})).appendTo(d),0<l.subflows&&$("<div>").text(RED._("clipboard.subflow",{count:l.subflows})).appendTo(d),0<l.nodes&&$("<div>").text(RED._("clipboard.node",{count:l.nodes})).appendTo(d)}else{var c=/^subflow(:(.+))?$/.exec(e.type);if(c){o=c[2]?RED.nodes.subflow(c[2]):e,n=0;var p="subflow:"+o.id;RED.nodes.eachNode(function(e){e.type===p&&n++})}if("tab"===e.type||"subflow"===e.type)t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info."+("tab"===e.type?"flow":"subflow"))+"</td><td></td></tr>").appendTo(i),RED.utils.createObjectElement(e.id).appendTo(t.children()[1]),t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.tabName")+"</td><td></td></tr>").appendTo(i),$(t.children()[1]).text(e.label||e.name||""),"tab"===e.type&&(t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.status")+"</td><td></td></tr>").appendTo(i),$(t.children()[1]).text(e.disabled?RED._("sidebar.info.disabled"):RED._("sidebar.info.enabled")));else{t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.node")+"</td><td></td></tr>").appendTo(i),RED.utils.createObjectElement(e.id).appendTo(t.children()[1]),"subflow"!==e.type&&"unknown"!==e.type&&e.name&&(t=$('<tr class="node-info-node-row"><td>'+RED._("common.label.name")+"</td><td></td></tr>").appendTo(i),$('<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e.name)+'"></span>').text(e.name).appendTo(t.children()[1])),c||(t=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.type")+"</td><td></td></tr>").appendTo(i),$(t.children()[1]).text("unknown"===e.type?e._orig.type:e.type),"unknown"===e.type&&$('<span style="float: right; font-size: 0.8em"><i class="fa fa-warning"></i></span>').prependTo($(t.children()[1])));var u=0;if(!c&&"subflow"!=e.type){var f;if("unknown"===e.type?(f={},Object.keys(e._orig).forEach(function(e){"type"!==e&&(f[e]={})})):e._def&&(f=e._def.defaults,t=$('<tr class="node-info-property-row'+(L.property?"":" hide")+'"><td>'+RED._("sidebar.info.module")+"</td><td></td></tr>").appendTo(i),$(t.children()[1]).text(RED.nodes.getType(e.type).set.module),u++),$('<tr class="node-info-property-expand node-info-property-row blank'+(L.property?"":" hide")+'"><td colspan="2"></td></tr>').appendTo(i),f)for(var h in f)if("name"!=h&&"info"!=h&&f.hasOwnProperty(h)){var g=e[h];if(u++,t=$('<tr class="node-info-property-row'+(L.property?"":" hide")+'"><td>'+h+"</td><td></td></tr>").appendTo(i),f[h].type){var v=RED.nodes.node(g);if(v){var b=RED.utils.getNodeLabel(v,g),m=t.children()[1],y=$("<span>",{class:""}).appendTo(m),w=$("<div>",{class:"palette_node palette_node_small"}).appendTo(y),D=RED.utils.getNodeColor(v.type,v._def),E=RED.utils.getNodeIcon(v._def);w.css({backgroundColor:D,cursor:"pointer"});var R=$("<div/>",{class:"palette_icon_container"}).appendTo(w);$("<div/>",{class:"palette_icon",style:"background-image: url("+E+")"}).appendTo(R);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).text(b).appendTo(m);w.on("dblclick",function(){RED.editor.editConfig("",v.type,v.id)})}else RED.utils.createObjectElement(void 0).appendTo(t.children()[1])}else RED.utils.createObjectElement(g).appendTo(t.children()[1])}0<u&&$('<tr class="node-info-property-expand blank"><td colspan="2"><a href="#" class=" node-info-property-header'+(L.property?" expanded":"")+'"><span class="node-info-property-show-more">'+RED._("sidebar.info.showMore")+'</span><span class="node-info-property-show-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a></td></tr>').appendTo(i)}"tab"!==e.type&&c&&($('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(i),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(o.name)+'">'+RED.utils.sanitize(o.name)+"</span></td></tr>").appendTo(i))}if(c){t=$('<tr class="node-info-node-row"><td>'+RED._("subflow.category")+"</td><td></td></tr>").appendTo(i);var x=o.category||"subflows";$(t.children()[1]).text(RED._("palette.label."+x,{defaultValue:x})),$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+n+"</td></tr>").appendTo(i)}"tab"===e.type||"subflow"===e.type?$(O.container).hide():($(O.container).show(),P(o&&"subflow"!==e.type?marked(o.info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>":$("script[data-help-name='"+e.type+"']").html()||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",O.content));var k="";if(e._def&&e._def.info){var T=e._def.info,_="function"==typeof T?T.call(e):T;k+=marked(_)}e.info&&(k+=marked(e.info||"")),P(k,S.content),$(".sidebar-node-info-stack").scrollTop(0),$(".node-info-property-header").click(function(e){e.preventDefault(),L.property=!L.property,$(this).toggleClass("expanded",L.property),$(".node-info-property-row").toggle(L.property)})}}else I()}function P(e,t){var o,n=(o=$('<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>"),$(o).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),o).appendTo(t);n.find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");n.find("H3").wrapInner('<a class="node-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').click(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),o=$(this).parent().next();1===o.length&&"H3"!==o[0].nodeName;)o.toggle(!t),o=o.next();$(this).toggleClass("expanded",!t)})}var s=function(){var a,i,t=!0,s=15e3,r=-1;function e(){for(var e,t=Math.floor(Math.random()*r),o=RED._("infotips:info.tip"+t);e=/({{(.*?)}})/.exec(o);){var n=RED.keyboard.getShortcut(e[2]);if(!n)return;o=o.replace(e[1],RED.keyboard.formatKey(n.key))}for(;e=/(\[(.*?)\])/.exec(o);)o=o.replace(e[1],RED.keyboard.formatKey(e[2]));d.html(o).fadeIn(200),a&&(a=null,i=setInterval(l,s))}function l(){d.fadeOut(300,function(){e()})}function o(){if($(".sidebar-node-info").addClass("show-tips"),t&&!a&&!i){if(-1===r)for(;r++,RED._("infotips:info.tip"+r)!=="infotips:info.tip"+r;);a=setTimeout(e,1e3)}}function n(){$(".sidebar-node-info").removeClass("show-tips"),clearInterval(i),clearTimeout(a),a=i=null}return RED.actions.add("core:toggle-show-tips",function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):(t=e)?o():n()}),{start:o,stop:n,next:function(){clearInterval(i),a=!0,e()},enabled:function(){return t}}}();function I(e){if(void 0===e&&(e=RED.view.selection()),e.nodes)if(1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction?i(RED.nodes.subflow(t.z)):i(t)}else i(e.nodes);else if(e.flows||e.subflows)i(e.flows);else{var o=RED.workspaces.active(),n=RED.nodes.workspace(o)||RED.nodes.subflow(o);if(n)i(n);else{var a=RED.nodes.workspace(RED.workspaces.active());a&&a.info?i(a):i(null)}}}return RED.events.on("view:selection-changed",I),{init:function(){(n=document.createElement("div")).className="sidebar-node-info",RED.actions.add("core:show-info-tab",a);var e=$("<div>",{class:"sidebar-node-info-stack"}).appendTo(n);j=RED.stack.create({container:e}).hide(),(C=j.add({title:RED._("sidebar.info.info"),collapsible:!0})).expand(),(S=j.add({title:RED._("sidebar.info.desc"),collapsible:!0})).expand(),S.content.css("padding","6px"),(O=j.add({title:RED._("sidebar.info.nodeHelp"),collapsible:!0})).expand(),O.content.css("padding","6px");var t=$('<div class="node-info-tips"></div>').appendTo(n);d=$('<div class="node-info-tip"></div>').appendTo(t);var o=$('<div class="node-info-tips-buttons"></div>').appendTo(t);$('<a href="#" class="workspace-footer-button"><i class="fa fa-refresh"></a>').appendTo(o).click(function(e){e.preventDefault(),s.next()}),$('<a href="#" class="workspace-footer-button"><i class="fa fa-times"></a>').appendTo(o).click(function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))}),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),iconClass:"fa fa-info",action:"core:show-info-tab",content:n,pinned:!0,enableOnEdit:!0}),s.enabled()?s.start():s.stop()},show:a,refresh:i,clear:function(){i(null)},set:function(e,t){i(null),C.container.hide(),O.container.hide(),S.container.show(),P(e,S.content),$(".sidebar-node-info-stack").scrollTop(0)}}}(),RED.sidebar.config=function(){var r=document.createElement("div");r.className="sidebar-node-config",r.id="sidebar-node-config",r.tabIndex=0,$('<div class="sidebar-header"><span class="button-group"><a class="sidebar-header-button-toggle selected" id="workspace-config-node-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="sidebar-header-button-toggle" id="workspace-config-node-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </span></div>').appendTo(r);var e=$('<div><a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),a=$("<div>").appendTo(r),i=$("<div>").appendTo(r),s=$("<div>").appendTo(r),l=!1,d={};function c(e,t,o){if(e=e.replace(/\./i,"-"),d[e])d[e].label!==o&&(d[e].list.parent().find(".config-node-label").text(o),d[e].label=o);else{var n=$('<div class="palette-category workspace-config-node-category" id="workspace-config-node-category-'+e+'"></div>').appendTo(t),a=$('<div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(n);o?$('<span class="config-node-label"/>').text(o).appendTo(a):$('<span class="config-node-label" data-i18n="sidebar.config.'+e+'">').appendTo(a),$('<span class="config-node-filter-info"></span>').appendTo(a),category=$('<ul class="palette-content config-node-list"></ul>').appendTo(n),n.i18n();var i=a.find("i"),s={label:o,list:category,size:function(){return s.list.find("li:not(.config_node_none)").length},open:function(e){i.hasClass("expanded")||(i.addClass("expanded"),e?s.list.show():s.list.slideDown())},close:function(e){i.hasClass("expanded")&&(i.removeClass("expanded"),e?s.list.hide():s.list.slideUp())},isOpen:function(){return i.hasClass("expanded")}};a.on("click",function(e){s.isOpen()?s.close():s.open()}),d[e]=s}return d[e]}function p(e,t){var o=c(e.replace(/\./i,"-")),i=o.list;if(t.sort(function(e,t){return e.type<t.type?-1:e.type>t.type?1:0}),l){var n=t.length;0<(n-=(t=t.filter(function(e){return!1!==e._def.hasUsers&&0===e.users.length})).length)?i.parent().find(".config-node-filter-info").text(RED._("sidebar.config.filtered",{count:n})).show():i.parent().find(".config-node-filter-info").hide()}else i.parent().find(".config-node-filter-info").hide();if(i.empty(),0===t.length)$('<li class="config_node_none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(i),o.close(!0);else{var s="";t.forEach(function(t){var e=RED.utils.getNodeLabel(t,t.id);t.type!=s&&($('<li class="config_node_type">'+t.type+"</li>").appendTo(i),s=t.type);var o=$('<li class="palette_node config_node palette_node_id_'+t.id.replace(/\./g,"-")+'"></li>').appendTo(i);if(o.data("node",t.id),$('<div class="palette_label"></div>').text(e).appendTo(o),!1!==t._def.hasUsers){var n=$("<div/>",{class:"palette_icon_container palette_icon_container_right"}).appendTo(o);0===t.users.length?n.text(0):$('<a href="#"/>').click(function(e){e.stopPropagation(),e.preventDefault(),RED.search.show(t.id)}).text(t.users.length).appendTo(n),RED.popover.tooltip(n,RED._("editor.nodesUse",{count:t.users.length})),0===t.users.length&&o.addClass("config_node_unused")}o.on("click",function(e){RED.view.select(!1),e.metaKey?$(this).toggleClass("selected"):($(r).find(".palette_node").removeClass("selected"),$(this).addClass("selected")),RED.sidebar.info.refresh(t)}),o.on("dblclick",function(e){RED.editor.editConfig("",t.type,t.id)});var a=t.users.map(function(e){return e.id});o.on("mouseover",function(e){RED.nodes.eachNode(function(e){-1!=a.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)}),RED.view.redraw()}),o.on("mouseout",function(e){RED.nodes.eachNode(function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)}),RED.view.redraw()})}),o.open(!0)}}function t(){var t={global:!0};c("global",a),RED.nodes.eachWorkspace(function(e){t[e.id.replace(/\./g,"-")]=!0,c(e.id,i,e.label)}),RED.nodes.eachSubflow(function(e){t[e.id.replace(/\./g,"-")]=!0,c(e.id,s,e.name)}),$(".workspace-config-node-category").each(function(){var e=$(this).attr("id").substring("workspace-config-node-category-".length);t[e]||($(this).remove(),delete d[e])});var o=[],n={};for(var e in RED.nodes.eachConfig(function(e){e.z?(n[e.z.replace(/\./g,"-")]=n[e.z.replace(/\./g,"-")]||[],n[e.z.replace(/\./g,"-")].push(e)):e.z||o.push(e)}),t)t.hasOwnProperty(e)&&p(e,n[e]||[]);p("global",o)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:r,toolbar:e,iconClass:"fa fa-cog",action:"core:show-config-tab",onchange:function(){t()}}),RED.actions.add("core:show-config-tab",function(){RED.sidebar.show("config")}),RED.actions.add("core:select-all-config-nodes",function(){$(r).find(".palette_node").addClass("selected")}),RED.actions.add("core:delete-config-selection",function(){var e=[];if($(r).find(".palette_node.selected").each(function(){e.push($(this).data("node"))}),0<e.length){var i={t:"delete",nodes:[],changes:{},dirty:RED.nodes.dirty()};e.forEach(function(e){var t=RED.nodes.node(e);try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}i.nodes.push(t);for(var o=0;o<t.users.length;o++){var n=t.users[o];for(var a in i.changes[n.id]={changed:n.changed,valid:n.valid},n._def.defaults)n._def.defaults.hasOwnProperty(a)&&n[a]==e&&(i.changes[n.id][a]=e,n[a]="",n.changed=!0,n.dirty=!0);RED.editor.validateNode(n)}RED.nodes.remove(e)}),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(i)}}),RED.events.on("view:selection-changed",function(){$(r).find(".palette_node").removeClass("selected")}),$("#workspace-config-node-collapse-all").on("click",function(e){for(var t in e.preventDefault(),d)d.hasOwnProperty(t)&&d[t].close()}),$("#workspace-config-node-expand-all").on("click",function(e){for(var t in e.preventDefault(),d)d.hasOwnProperty(t)&&0<d[t].size()&&d[t].open()}),$("#workspace-config-node-filter-all").on("click",function(e){e.preventDefault(),l&&($(this).addClass("selected"),$("#workspace-config-node-filter-unused").removeClass("selected"),l=!l,t())}),$("#workspace-config-node-filter-unused").on("click",function(e){e.preventDefault(),l||($(this).addClass("selected"),$("#workspace-config-node-filter-all").removeClass("selected"),l=!l,t())}),RED.popover.tooltip($("#workspace-config-node-filter-all"),"Show all config nodes"),RED.popover.tooltip($("#workspace-config-node-filter-unused"),"Show all unused config nodes")},show:function(r){"boolean"==typeof r&&(r?$("#workspace-config-node-filter-unused").click():$("#workspace-config-node-filter-all").click()),t(),"string"==typeof r&&($("#workspace-config-node-filter-all").click(),r=r.replace(/\./g,"-"),setTimeout(function(){var e=$(".palette_node_id_"+r),t=e.position().top,o=e.height(),n=$(".sidebar-node-config"),a=n.height();a<t+o?n.animate({scrollTop:"-="+(a-(t+o)-30)},150):t<0&&n.animate({scrollTop:"+="+(t-10)},150);var i=21,s=function(){i%2==0?e.removeClass("node_highlighted"):e.addClass("node_highlighted"),0<=--i&&setTimeout(s,100)};s()},100)),RED.sidebar.show("config")},refresh:t}}(),RED.sidebar.context=function(){var a,i,s,r,l,d,c;function p(e,t){d=e,t?e?f(s,"context/node/"+e.id,e.id):f(s):($(s.table).empty(),e?$('<tr class="node-info-node-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(s.table).i18n():$('<tr class="node-info-node-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(s.table).i18n(),s.timestamp.html("&nbsp;"))}function u(e){(c=e)?f(r,"context/flow/"+e.id,e.id):f(r)}function f(e,t,o){var i,u,f,h,g,n=e.table;o?(i=e,u=t,f=o,h=RED.settings.context.stores,g=i.table,$.getJSON(u,function(e){$(g).empty();var t={};for(var o in e)if(e.hasOwnProperty(o))for(var n in e[o])e[o].hasOwnProperty(n)&&(t.hasOwnProperty(n)||(t[n]=[]),e[o][n].store=o,t[n].push(e[o][n]));var c=Object.keys(t);c.sort();for(var a=c.length,p=0;p<a;p++)t[c[p]].forEach(function(a){var i=c[p],s=(t[i].length,$('<tr class="node-info-node-row"><td class="sidebar-context-property"></td><td></td></tr>').appendTo(g));$(s.children()[0]).text(i);var r=$('<span class="button-group"></span>'),l=($('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(r).click(function(e){e.preventDefault(),e.stopPropagation(),$.getJSON(u+"/"+i+"?store="+a.store,function(e){e.msg===l&&e.format===d||(l=e.msg,d=e.format,r.detach(),$(s.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(l,d),{typeHint:e.format,sourceId:f+"."+i,tools:r}).appendTo(s.children()[1]))})}),$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(r).click(function(e){e.preventDefault(),e.stopPropagation();var n=RED.popover.create({trigger:"modal",target:s,direction:"left",content:function(){var e=$("<div>");$('<p data-i18n="sidebar.context.deleteConfirm"></p>').appendTo(e);var t=$("<p>").appendTo(e),o=$('<span class="button-group"></span>').appendTo(t);return $('<button class="editor-button" data-i18n="common.label.cancel"></button>').appendTo(o).click(function(e){e.preventDefault(),n.close()}),o=$('<span class="button-group"></span>').appendTo(t),$('<button class="editor-button primary" data-i18n="common.label.delete"></button>').appendTo(o).click(function(e){e.preventDefault(),n.close(),$.ajax({url:u+"/"+i+"?store="+a.store,type:"DELETE"}).done(function(e,t,o){$.getJSON(u+"/"+i+"?store="+a.store,function(e){"undefined"===e.format?(s.remove(),0===g.children().length&&$('<tr class="node-info-node-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(g).i18n()):(l=e.msg,d=e.format,r.detach(),$(s.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(l,d),{typeHint:e.format,sourceId:f+"."+i,tools:r}).appendTo(s.children()[1]))})}).fail(function(e,t,o){})}),e.i18n()}});n.open()}),a.msg),d=a.format;RED.utils.createObjectElement(RED.utils.decodeObject(l,d),{typeHint:a.format,sourceId:f+"."+i,tools:r}).appendTo(s.children()[1]),1<h.length&&$("<span>",{class:"sidebar-context-property-storename"}).text(a.store).appendTo($(s.children()[0]))});0===a&&$('<tr class="node-info-node-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(g).i18n(),$(i.timestamp).text((new Date).toLocaleString())})):($(n).empty(),$('<tr class="node-info-node-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(n).i18n())}function h(){RED.sidebar.show("context")}return{init:function(){(a=$("<div>").css({position:"relative",height:"100%"})).className="sidebar-context";var e=$("<div></div>"),t=$("<div>",{class:"sidebar-context-stack"}).appendTo(a);i=RED.stack.create({container:t}),(s=i.add({title:RED._("sidebar.context.node"),collapsible:!0})).expand(),s.content.css({height:"100%"}),s.timestamp=$('<div class="sidebar-context-updated">&nbsp;</div>').appendTo(s.content);var o=$('<table class="node-info"></table>').appendTo(s.content);s.table=$("<tbody>").appendTo(o);var n=$('<div style="float: right"></div>').appendTo(s.header);$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(n).click(function(e){e.stopPropagation(),e.preventDefault(),p(d,!0)}),(r=i.add({title:RED._("sidebar.context.flow"),collapsible:!0})).expand(),r.content.css({height:"100%"}),r.timestamp=$('<div class="sidebar-context-updated">&nbsp;</div>').appendTo(r.content),o=$('<table class="node-info"></table>').appendTo(r.content),r.table=$("<tbody>").appendTo(o),n=$('<div style="float: right"></div>').appendTo(r.header),$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(n).click(function(e){e.stopPropagation(),e.preventDefault(),u(c)}),(l=i.add({title:RED._("sidebar.context.global"),collapsible:!0})).expand(),l.content.css({height:"100%"}),l.timestamp=$('<div class="sidebar-context-updated">&nbsp;</div>').appendTo(l.content),o=$('<table class="node-info"></table>').appendTo(l.content),l.table=$("<tbody>").appendTo(o),n=$('<div style="float: right"></div>').appendTo(l.header),$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(n).click(function(e){e.stopPropagation(),e.preventDefault(),f(l,"context/global","global")}),RED.actions.add("core:show-context-tab",h),RED.sidebar.addTab({id:"context",label:RED._("sidebar.context.label"),name:RED._("sidebar.context.name"),iconClass:"fa fa-database",content:a,toolbar:e,enableOnEdit:!0,action:"core:show-context-tab"}),RED.events.on("view:selection-changed",function(e){p(e.nodes&&1===e.nodes.length&&e.nodes[0])}),RED.events.on("workspace:change",function(e){u(RED.nodes.workspace(e.workspace))}),f(l,"context/global","global")}}}(),RED.palette.editor=function(){var p,u,f,b,g,i,h=[],v=[],w={},m={},y={},t={},D="";function s(e,t){var o=Date.now()-e;o=o<300?300:0,setTimeout(function(){t()},o)}function E(e,t,n,a){n.show();var i=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done(function(e,t,o){s(i,function(){n.hide(),a()})}).fail(function(e,t,o){s(i,function(){n.hide(),a(e)})})}function R(e,t,n){var o={module:e};t&&(o.version=t),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(o),contentType:"application/json; charset=utf-8"}).done(function(e,t,o){n()}).fail(function(e,t,o){n(e)})}function x(e){t.hasOwnProperty(e)||(t[e]=setTimeout(function(){delete t[e],o(e)},100))}function k(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var o=parseInt(t[1]),n=parseInt(t[2]),a=parseInt(t[3]);if(160<(299*o+587*n+114*a)/1e3)return"rgb("+(o=Math.floor(.8*o))+","+(n=Math.floor(.8*n))+","+(a=Math.floor(.8*a))+")"}return e}function o(e){if(y.hasOwnProperty(e)){var t=y[e].info,o=y[e].elements;if(o){var n=0,a=0,i=0;for(var s in o.errorList.empty(),y[e].totalUseCount=0,y[e].setUseCount={},t.sets)if(t.sets.hasOwnProperty(s)){var r=0,l=t.sets[s],d=o.sets[s];l.err&&(i++,$("<li>").text(l.err).appendTo(o.errorList)),l.enabled&&(n+=l.types.length),a+=l.types.length;for(var c=0;c<t.sets[s].types.length;c++){var p=t.sets[s].types[c];r+=m[p]||0;var u=d.swatches[p];if(l.enabled){var f=RED.nodes.getType(p);f&&f.color?(u.css({background:RED.utils.getNodeColor(p,f)}),u.css({border:"1px solid "+k(u.css("backgroundColor"))})):u.css({background:"#eee",border:"1px dashed #999"})}else u.css({background:"#eee",border:"1px dashed #999"})}y[e].setUseCount[s]=r,y[e].totalUseCount+=r,0<r?(d.enableButton.text(RED._("palette.editor.inuse")),d.enableButton.addClass("disabled")):(d.enableButton.removeClass("disabled"),l.enabled?d.enableButton.text(RED._("palette.editor.disable")):d.enableButton.text(RED._("palette.editor.enable"))),d.setRow.toggleClass("palette-module-set-disabled",!l.enabled)}0===i?o.errorRow.hide():o.errorRow.show();var h=n===a?a:n+" / "+a;o.setCount.text(RED._("palette.editor.nodeCount",{count:a,label:h})),0<y[e].totalUseCount?(o.enableButton.text(RED._("palette.editor.inuse")),o.enableButton.addClass("disabled"),o.removeButton.hide()):(o.enableButton.removeClass("disabled"),t.local&&o.removeButton.css("display","inline-block"),0===n?o.enableButton.text(RED._("palette.editor.enableall")):o.enableButton.text(RED._("palette.editor.disableall")),o.container.toggleClass("disabled",0===n))}t.pending_version?(o.versionSpan.html(t.version+' <i class="fa fa-long-arrow-right"></i> '+t.pending_version).appendTo(o.metaRow),o.updateButton.text(RED._("palette.editor.updated")).addClass("disabled").css("display","inline-block")):w.hasOwnProperty(e)&&1===function(e,t){for(var o=e.split(".").map(function(e){return parseInt(e)}),n=t.split(".").map(function(e){return parseInt(e)}),a=0;a<3;a++){var i=o[a]-n[a];if(i<0)return-1;if(0<i)return 1}return 0}(w[e].version,t.version)?(o.updateButton.show(),o.updateButton.text(RED._("palette.editor.update",{version:w[e].version}))):o.updateButton.hide()}else{y[e]={info:RED.nodes.registry.getModule(e)};var g=[e];for(var v in y[e].info.sets)y[e].info.sets.hasOwnProperty(v)&&(g.push(v),g=g.concat(y[e].info.sets[v].types));y[e].index=g.join(",").toLowerCase(),b.editableList("addItem",y[e])}}var r,T,l=[],d=!1,_=S;function a(e,t,o,n){if(l.push(e||n),e?d=!0:(n.modules&&(n.modules.forEach(function(e){(w[e.id]=e).index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.types&&(e.index=e.index.concat(e.types)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase()}),h=h.concat(n.modules)),f.searchBox("count",h.length)),1<i&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+l.length+"/"+i),l.length===i){d&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3);var a=250-(Date.now()-r);setTimeout(function(){$("#palette-module-install-shade").hide()},Math.max(a,0))}}function j(){if(0===h.length){h=[],w={},g.editableList("empty"),$(".palette-module-shade-status").text(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"];d=!(l=[]),i=e.length,1<e.length&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#palette-module-install-shade").show(),r=Date.now();var t=0;e.forEach(function(n,e){$.getJSON(n,{_:(new Date).getTime()},function(e){a(null,n,0,e),function(){for(var e in y)y.hasOwnProperty(e)&&o(e)}()}).fail(function(e,t,o){a(e,n)}).always(function(){++t===i&&f.searchBox("change")})})}}function C(){if(g.editableList("empty"),""!==f.searchBox("value").trim()){v.sort(_);for(var e=0;e<Math.min(10,v.length);e++)g.editableList("addItem",v[e]);0===v.length&&g.editableList("addItem",{}),10<v.length&&g.editableList("addItem",{start:10,more:v.length-10})}else g.editableList("addItem",{count:h.length})}function S(e,t){var o=f.searchBox("value").trim();if(""===o)return O(e,t);var n=e.info.index.indexOf(o)-t.info.index.indexOf(o);return 0===n?O(e,t):n}function O(e,t){return e.info.id.localeCompare(t.info.id)}function L(e,t){return-1*(e.info.timestamp-t.info.timestamp)}function e(){return j(),p.activateTab("nodes"),T}function P(n,t,a){if(!1!==RED.settings.theme("palette.editable")){var e=[{text:RED._("common.label.cancel"),click:function(){i.close()}}];n.url&&e.push({text:RED._("palette.editor.confirm.button.review"),class:"primary palette-module-install-confirm-button-install",click:function(){var e=n.url||"";window.open(e)}}),e.push({text:RED._("palette.editor.confirm.button.install"),class:"primary palette-module-install-confirm-button-install",click:function(){var o=RED.utils.addSpinnerOverlay(t,!0),e=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(o);$('<button class="editor-button"></button>').text(RED._("eventLog.view")).appendTo(e).click(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+n.id+" "+n.version),R(n.id,n.version,function(e){if(o.remove(),e&&e.responseJSON)var t=RED.notify(RED._("palette.editor.errors.installFailed",{module:n.id,message:e.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){t.close()}},{text:RED._("eventLog.view"),click:function(){t.close(),RED.actions.invoke("core:show-event-log")}}]});a(e)}),i.close()}});var i=RED.notify(RED._("palette.editor.confirm.install.body",{module:n.id}),{modal:!0,fixed:!0,buttons:e})}else a(new Error("Palette not editable"))}return{init:function(){!1!==RED.settings.theme("palette.editable")&&(function(){T=$('<div id="user-settings-tab-palette"></div>');var t=$('<div id="palette-editor"><ul id="palette-editor-tabs"></ul></div>').appendTo(T);p=RED.tabs.create({element:T.find("#palette-editor-tabs"),onchange:function(e){t.find(".palette-editor-tab").hide(),e.content.show(),u&&u.searchBox("value",""),f&&f.searchBox("value",""),"install"===e.id?f&&f.focus():u&&u.focus()},minimumActiveTabWidth:110});var e=$("<div>",{class:"palette-editor-tab"}).appendTo(t);p.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:e});var o=$("<div>",{class:"palette-search"}).appendTo(e);u=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(o).searchBox({delay:200,change:function(){!function(e){D=e.toLowerCase();var t=b.editableList("filter"),o=b.editableList("length");""===e?u.searchBox("count"):u.searchBox("count",t+" / "+o)}($(this).val())}}),b=$("<ol>",{id:"palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===D||""===D||-1<e.index.indexOf(D)},addItem:function(t,e,s){var r=s.info;if(r){var o=$("<div>",{class:"palette-module-header"}).appendTo(t),n=$('<div class="palette-module-meta palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(o);$("<span>").text(r.name).appendTo(n);var a=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(o),i=$("<span>").text(r.version).appendTo(a),l=$('<div class="palette-module-meta palette-module-errors"><i class="fa fa-warning"></i></div>').hide().appendTo(o),d=$('<ul class="palette-module-error-list"></ul>').appendTo(l),c=$("<div>",{class:"palette-module-meta"}).appendTo(o),p=$('<a href="#" class="editor-button editor-button-small palette-module-set-button"><i class="fa fa-angle-right palette-module-node-chevron"></i> </a>').appendTo(c),u=$("<span>").appendTo(p),f=$("<div>",{class:"palette-module-button-group"}).appendTo(c),h=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.update")).appendTo(f);h.attr("id","up_"+Math.floor(1e9*Math.random())),h.click(function(e){e.preventDefault(),$(this).hasClass("disabled")||function(n,t,a,i){if(!1===RED.settings.theme("palette.editable"))return i(new Error("Palette not editable"));var s=RED.notify(RED._("palette.editor.confirm.update.body",{module:n.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){s.close()}},{text:RED._("palette.editor.confirm.button.update"),class:"primary palette-module-install-confirm-button-update",click:function(){var o=RED.utils.addSpinnerOverlay(a,!0),e=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(o);$('<button class="editor-button"></button>').text(RED._("eventLog.view")).appendTo(e).click(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+n.name+" "+t),R(n.name,t,function(e){if(o.remove(),e&&e.responseJSON)var t=RED.notify(RED._("palette.editor.errors.updateFailed",{module:n.name,message:e.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){t.close()}},{text:RED._("eventLog.view"),click:function(){t.close(),RED.actions.invoke("core:show-event-log")}}]});i(e)}),s.close()}}]})}(r,w[r.name].version,t,function(e){})});var g=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.remove")).appendTo(f);g.attr("id","up_"+Math.floor(1e9*Math.random())),g.click(function(e){e.preventDefault(),function(a,i,e){if(!1===RED.settings.theme("palette.editable"))return e(new Error("Palette not editable"));var s=RED.notify(RED._("palette.editor.confirm.remove.body",{module:a.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){s.close()}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary palette-module-install-confirm-button-remove",click:function(){var e,n,o=RED.utils.addSpinnerOverlay(i,!0),t=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(o);$('<button class="editor-button"></button>').text(RED._("eventLog.view")).appendTo(t).click(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.remove")+" : "+a.name),e=a.name,n=function(e){if(o.remove(),e&&e.responseJSON)var t=RED.notify(RED._("palette.editor.errors.removeFailed",{module:a.name,message:e.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){t.close()}},{text:RED._("eventLog.view"),click:function(){t.close(),RED.actions.invoke("core:show-event-log")}}]})},$.ajax({url:"nodes/"+e,type:"DELETE"}).done(function(e,t,o){n()}).fail(function(e,t,o){n(e)}),s.close()}}]})}(r,t,function(e){})}),r.local||g.hide();var v=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.disableall")).appendTo(f),b=$("<div>",{class:"palette-module-content"}).appendTo(t),m=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(t);s.elements={updateButton:h,removeButton:g,enableButton:v,errorRow:l,errorList:d,setCount:u,container:t,shade:m,versionSpan:i,sets:{}},p.click(function(e){e.preventDefault(),t.hasClass("expanded")?(t.removeClass("expanded"),b.slideUp()):(t.addClass("expanded"),b.slideDown())});var y=Object.keys(r.sets);y.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),y.forEach(function(n){var a=r.sets[n],o=$("<div>",{class:"palette-module-set"}).appendTo(b),e=$("<div>",{class:"palette-module-set-button-group"}).appendTo(o),i={};a.types.forEach(function(e){var t=$("<div>",{class:"palette-module-type"}).appendTo(o);i[e]=$("<span>",{class:"palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"palette-module-type-node"}).text(e).appendTo(t)});var t=$('<a href="#" class="editor-button editor-button-small"></a>').appendTo(e);t.click(function(e){if(e.preventDefault(),0===s.setUseCount[n]){var t=RED.nodes.registry.getNodeSet(a.id);m.show();var o=!t.enabled;E(a.id,o,m,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors."+(o?"enable":"disable")+"Failed",{module:id,message:e.responseJSON.message}))})}}),s.elements.sets[a.name]={setRow:o,enableButton:t,swatches:i}}),v.click(function(e){e.preventDefault(),0===s.totalUseCount&&E(r.name,t.hasClass("disabled"),m,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:e.responseJSON.message}))})}),x(r.name)}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(t)}});var n=$("<div>",{class:"palette-editor-tab hide"}).appendTo(t);p.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:n});var a=$("<div>",{class:"palette-editor-toolbar"}).appendTo(n),i=$("<div>",{class:"palette-search"}).appendTo(n);f=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(i).searchBox({delay:300,change:function(){var t=$(this).val().trim().toLowerCase();0<t.length?(v=h.filter(function(e){return-1<e.index.indexOf(t)}).map(function(e){return{info:e}}),C(),f.searchBox("count",v.length+" / "+h.length)):(f.searchBox("count",h.length),g.editableList("empty"),g.editableList("addItem",{count:h.length}))}}),$("<span>").text(RED._("palette.editor.sort")+" ").appendTo(a);var s=$('<span class="button-group"></span>').appendTo(a),r=$('<a href="#" class="palette-editor-install-sort-option sidebar-header-button-toggle selected"><i class="fa fa-sort-amount-desc"></i></a>').appendTo(s),l=$('<a href="#" class="palette-editor-install-sort-option sidebar-header-button-toggle" data-i18n="palette.editor.sortAZ"></a>').appendTo(s),d=$('<a href="#" class="palette-editor-install-sort-option sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(s);[{button:r,func:S},{button:l,func:O},{button:d,func:L}].forEach(function(t){t.button.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(".palette-editor-install-sort-option").removeClass("selected"),$(this).addClass("selected"),_=t.func,C())})});var c=$("<span>").appendTo(a);$('<a href="#" class="sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(c).click(function(e){e.preventDefault(),h=[],w={},j()}),g=$("<ol>",{style:"position: absolute;top: 78px;bottom: 0;left: 0;right: 0px;"}).appendTo(n).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,e,o){if(o.count)$("<div>",{class:"red-ui-search-empty"}).text(RED._("palette.editor.moduleCount",{count:o.count})).appendTo(t);else if(o.more){t.addClass("palette-module-more");var n=$("<div>",{class:"palette-module-header palette-module"}).appendTo(t),a=$('<a href="#"></a>').text(RED._("palette.editor.more",{count:o.more})).appendTo(n);a.click(function(e){e.preventDefault(),g.editableList("removeItem",o);for(var t=o.start;t<Math.min(o.start+10,o.start+o.more);t++)g.editableList("addItem",v[t]);10<o.more&&g.editableList("addItem",{start:o.start+10,more:o.more-10})})}else if(o.info){var i=o.info,s=$("<div>",{class:"palette-module-header"}).appendTo(t),r=$('<div class="palette-module-meta"><i class="fa fa-cube"></i></div>').appendTo(s);$("<span>",{class:"palette-module-name"}).text(i.name||i.id).appendTo(r),$('<a target="_blank" class="palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",i.url).appendTo(r);var l=$('<div class="palette-module-meta"></div>').appendTo(s);$("<div>",{class:"palette-module-description"}).text(i.description).appendTo(l);var d=$('<div class="palette-module-meta"></div>').appendTo(s);$('<span class="palette-module-version"><i class="fa fa-tag"></i> '+i.version+"</span>").appendTo(d),$('<span class="palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var o=Math.floor(t/7);if(o<4)return RED._("palette.editor.times.weeksV",{count:o});var n=Math.floor(o/4);if(o%=4,n<12)return RED._("palette.editor.times.monthsV",{count:n});var a=Math.floor(n/12);return 0==(n%=12)?RED._("palette.editor.times.yearsV",{count:a}):RED._("palette.editor.times.year"+(1<a?"s":"")+"MonthsV",{y:a,count:n})}(i.updated_at)+"</span>").appendTo(d);var c=!1;if(i.types&&0<i.types.length)for(var e=0;e<i.types.length;e++){var p=RED.nodes.registry.getNodeSetForType(i.types[e]);if(p){c=p.module;break}}var u=$("<div>",{class:"palette-module-meta"}).appendTo(s),f=$("<div>",{class:"palette-module-button-group"}).appendTo(u),h=$('<a href="#" class="editor-button editor-button-small"></a>').text(RED._("palette.editor.install")).appendTo(f);h.click(function(e){e.preventDefault(),$(this).hasClass("disabled")||P(i,t,function(e){})}),y.hasOwnProperty(i.id)?(h.addClass("disabled"),h.text(RED._("palette.editor.installed"))):c&&(h.addClass("disabled"),h.text(RED._("palette.editor.conflict")),RED.popover.create({target:h,content:RED._("palette.editor.conflictTip",{module:c}),trigger:"hover",direction:"bottom",delay:{show:750,hide:50}})),o.elements={installButton:h}}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(t)}}),$('<div id="palette-module-install-shade" class="palette-module-shade hide"><div class="palette-module-shade-status"></div><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(n)}(),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:e,close:function(){T.detach()},focus:function(){p.resize(),setTimeout(function(){u.focus()},200)}}),RED.actions.add("core:manage-palette",function(){RED.userSettings.show("palette")}),RED.events.on("registry:module-updated",function(e){x(e.module)}),RED.events.on("registry:node-set-enabled",function(e){x(e.module)}),RED.events.on("registry:node-set-disabled",function(e){x(e.module)}),RED.events.on("registry:node-type-added",function(e){/^subflow:/.test(e)||x(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-type-removed",function(e){/^subflow:/.test(e)||x(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-set-added",function(e){x(e.module);for(var t=0;t<v.length;t++)if(v[t].info.id===e.module){var o=v[t].elements.installButton;o.addClass("disabled"),o.text(RED._("palette.editor.installed"));break}}),RED.events.on("registry:node-set-removed",function(e){if(!RED.nodes.registry.getModule(e.module)){var t=y[e.module];if(t){b.editableList("removeItem",t),delete y[e.module];for(var o=0;o<v.length;o++)if(v[o].info.id===e.module){var n=v[o].elements.installButton;n.removeClass("disabled"),n.text(RED._("palette.editor.install"));break}}}}),RED.events.on("nodes:add",function(e){/^subflow:/.test(e.type)||(m[e.type]=(m[e.type]||0)+1,1===m[e.type]&&x(RED.nodes.registry.getNodeSetForType(e.type).module))}),RED.events.on("nodes:remove",function(e){m.hasOwnProperty(e.type)&&(m[e.type]--,0===m[e.type]&&(delete m[e.type],x(RED.nodes.registry.getNodeSetForType(e.type).module)))}))},install:P}}(),RED.editor=function(){var i=[],s={},o={};function L(e){var t,o,n,a=e.valid,i=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))o=(t=RED.nodes.subflow(e.type.substring(8))).valid,n=t.changed,void 0===o&&(o=L(t),n=t.changed),e.valid=o&&c(e,e._def.defaults,e),e.changed=e.changed||n;else if(e._def)e.valid=c(e,e._def.defaults,e),e._def._creds&&(e.valid=e.valid&&c(e,e._def.credentials,e._def._creds));else if("subflow"==e.type){for(var s=RED.nodes.filterNodes({z:e.id}),r=0;r<s.length;r++)o=s[r].valid,n=s[r].changed,void 0===o&&(o=L(s[r]),n=s[r].changed),e.valid=e.valid&&o,e.changed=e.changed||n;var l=RED.nodes.filterNodes({type:"subflow:"+e.id}),d={};for(r=0;r<l.length;r++)l[r].valid=e.valid,l[r].changed=l[r].changed||e.changed,l[r].dirty=!0,d[l[r].z]=!0;Object.keys(d).forEach(function(e){var t=RED.nodes.subflow(e);t&&L(t)})}return a===e.valid&&i===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&L(t)),e.valid}function c(e,t,o){var n=!0;for(var a in t)t.hasOwnProperty(a)&&(r(e,t,a,o[a])||(n=!1));return n}function r(t,e,o,n){var a=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(n))return!0;if(/^\$\{[a-zA-Z_][a-zA-Z0-9_]*\}$/.test(n))return!0;if("required"in e[o]&&e[o].required&&(a=""!==n),a&&"validate"in e[o])try{a=e[o].validate.call(t,n)}catch(e){console.log("Validation error:",t.type,t.id,"property: "+o,"value:",n,e)}if(a&&e[o].type&&RED.nodes.getType(e[o].type)&&!("validate"in e[o]))if(n&&"_ADD_"!=n){var i=RED.nodes.node(n);a=null!==i&&(null==i.valid||i.valid)}else a=e[o].hasOwnProperty("required")&&!e[o].required;return a}function d(e,t){for(var o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&n(e,e._def.defaults,o,t);if(e._def.credentials)for(o in e._def.credentials)e._def.credentials.hasOwnProperty(o)&&n(e,e._def.credentials,o,t)}function n(e,t,o,n){var a=$("#"+n+"-"+o);if(0<a.length){var i=a.val();t[o].hasOwnProperty("format")&&""!==t[o].format&&"DIV"===a[0].nodeName&&(i=a.text()),r(e,t,o,i)?a.removeClass("input-error"):a.addClass("input-error")}}function P(t,o){t.resize=!0,t.dirty=!0;var n=[];if(t.ports)if(o&&RED.nodes.eachLink(function(e){e.source===t&&o.hasOwnProperty(e.sourcePort)&&("-1"===o[e.sourcePort]?n.push(e):e.sourcePort=o[e.sourcePort])}),t.outputs<t.ports.length){for(;t.outputs<t.ports.length;)t.ports.pop();RED.nodes.eachLink(function(e){e.source===t&&e.sourcePort>=t.outputs&&-1===n.indexOf(e)&&n.push(e)})}else if(t.outputs>t.ports.length)for(;t.outputs>t.ports.length;)t.ports.push(t.ports.length);0===t.inputs&&n.concat(RED.nodes.filterLinks({target:t}));for(var e=0;e<n.length;e++)RED.nodes.removeLink(n[e]);return n}function p(e,t,o,n){var a=$("#"+n+"-"+t);if(0!==a.length){var i,s=a.width(),r=a.attr("style");s=null!==(i=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(r))?i[1]:"70%";var l=$("<div></div>").css({display:"inline-block",position:"relative"}),d=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(l),c=$('<select id="'+n+"-"+t+'"></select>').appendTo(d);l.width(s).height(a.height()),0===l.width()&&l.width("70%"),a.replaceWith(l),c.attr("style","width:100%"),x(t,o,e[t],n),$('<a id="'+n+"-lookup-"+t+'" class="editor-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(l),$("#"+n+"-lookup-"+t).click(function(e){m(t,o,c.find(":selected").val(),n),e.preventDefault()});var p="",u=RED.nodes.node(e[t]);RED.nodes.getType(o);u&&(p=RED.utils.getNodeLabel(u,u.id)),a.val(p)}}function u(e,t,o,n){var a=$("#"+n+"-"+t);a.val(e[t]),a.attr("type","hidden");var i=$("<a>",{id:n+"-edit-"+t,class:"editor-button"});a.after(i),e[t]?i.text(RED._("editor.configEdit")):i.text(RED._("editor.configAdd")),i.click(function(e){m(t,o,a.val()||"_ADD_",n),e.preventDefault()})}function f(e,t,o,n){var a=$("#"+o+"-"+t);if(0!==a.length)if("checkbox"===a.attr("type"))a.prop("checked",e[t]);else{var i=e[t];null==i&&(i=""),void 0!==n&&n[t].hasOwnProperty("format")&&""!==n[t].format&&"DIV"===a[0].nodeName?(a.html(RED.text.format.getHtml(i,n[t].format,{},!1,"en")),RED.text.format.attach(a[0],n[t].format,{},!1,"en")):(a.val(i),"INPUT"!==a[0].nodeName&&"TEXTAREA"!==a[0].nodeName||RED.text.bidi.prepareInput(a))}}function h(o,e,t,n){var a=$("#"+n+"-"+t);void 0!==e&&"format"in e[t]&&""!==e[t].format&&"DIV"===a[0].nodeName?$("#"+n+"-"+t).on("change keyup",function(e,t){t||d(o,n)}):$("#"+n+"-"+t).change(function(e,t){t||d(o,n)})}function g(e,t,o,n){var a;for(a in t)t.hasOwnProperty(a)&&("password"==t[a].type?o[a]?$("#"+n+"-"+a).val(o[a]):o["has_"+a]?$("#"+n+"-"+a).val("__PWRD__"):$("#"+n+"-"+a).val(""):f(o,a,n,t),h(e,t,a,n))}function I(e,t,o){var n=!1;for(var a in e.credentials||(e.credentials={_:{}}),t)if(t.hasOwnProperty(a)){var i=$("#"+o+"-"+a).val();if("password"==t[a].type){if(e.credentials["has_"+a]=""!==i,"__PWRD__"==i)continue;n=!0}(e.credentials[a]=i)!=e.credentials._[a]&&(n=!0)}return n}function D(t,o,n,a){for(var e in o.defaults)if(o.defaults.hasOwnProperty(e)){if(o.defaults[e].type){var i=RED.nodes.getType(o.defaults[e].type);i?i.exclusive?u(t,e,o.defaults[e].type,n):p(t,e,o.defaults[e].type,n):(console.log("Unknown type:",o.defaults[e].type),f(t,e,n,o.defaults))}else f(t,e,n,o.defaults);h(t,o.defaults,e,n)}var s,r,l=function(){if(o.oneditprepare)try{o.oneditprepare.call(t)}catch(e){console.log("oneditprepare",t.id,t.type,e.toString())}for(var e in o.defaults)o.defaults.hasOwnProperty(e)&&$("#"+n+"-"+e).trigger("change",[!0]);if(o.credentials)for(e in o.credentials)o.credentials.hasOwnProperty(e)&&$("#"+n+"-"+e).trigger("change",[!0]);d(t,n),a&&a()};o.credentials?t.credentials?(g(t,o.credentials,t.credentials,n),l()):$.getJSON((s=t.type,r=t.id,"credentials/"+s.replace(/\s+/g,"-")+"/"+r),function(e){t.credentials=e,t.credentials._=$.extend(!0,{},e),g(t,o.credentials,t.credentials,n),l()}):l()}function l(){for(var e,t=i.length-1;t<i.length;t++){var o=i[t];if(e=o.type,"_expression"===o.type)e=RED._("expressionEditor.title");else if("_js"===o.type)e=RED._("jsEditor.title");else if("_json"===o.type)e=RED._("jsonEditor.title");else if("_markdown"===o.type)e=RED._("markdownEditor.title");else if("_buffer"===o.type)e=RED._("bufferEditor.title");else if("subflow"===o.type)e=RED._("subflow.editSubflow",{name:RED.utils.sanitize(o.name)});else if(0===o.type.indexOf("subflow:")){var n=RED.nodes.subflow(o.type.substring(8));e=RED._("subflow.editSubflowInstance",{name:RED.utils.sanitize(n.name)})}else{if(void 0!==o._def.paletteLabel)try{e=RED.utils.sanitize(("function"==typeof o._def.paletteLabel?o._def.paletteLabel.call(o._def):o._def.paletteLabel)||"")}catch(e){console.log("Definition error: "+o.type+".paletteLabel",e)}t===i.length-1&&(e=RED.nodes.node(o.id)?RED._("editor.editNode",{type:RED.utils.sanitize(e)}):RED._("editor.addNewConfig",{type:RED.utils.sanitize(e)}))}}return e}function N(e){if(e){var r=[];return e.each(function(e){var t=$(this),o=(s=t.data("data")).parent?s.name:t.find(".node-input-env-name").val(),n=t.find(".node-input-env-value"),a=n.typedInput("value"),i=n.typedInput("type");if(!s.parent||s.parent.value!==a||s.parent.type!==i){var s={name:o,type:i,value:a};r.push(s)}}),r}return null}function z(e,t){return JSON.stringify(e)===JSON.stringify(t)}function E(e,t,o,i,n){var a=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e);return a.html($("script[data-template-name='"+o+"']").html()),i=i||"node-red",a.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var o=e[t];if(-1===o.indexOf(":")){var n="";if(0===o.indexOf("[")){var a=o.split("]");n=a[0]+"]",o=a[1]}e[t]=n+i+":"+o}}$(this).attr("data-i18n",e.join(";"))}),"subflow"!==o&&"subflow-template"!==o||function(e,t){var l=$("#node-input-env-container");l.css({"min-height":"150px","min-width":"450px"}).editableList({addItem:function(t,e,n){var o=$("<div/>").appendTo(t);n.parent?$("<div/>",{class:"uneditable-input",style:"margin-left: 5px; width: calc(40% - 8px)"}).appendTo(o).text(n.name):$("<input/>",{class:"node-input-env-name",type:"text",style:"margin-left: 5px; width: calc(40% - 8px)",placeholder:RED._("common.label.name")}).appendTo(o).val(n.name);var a=$("<input/>",{class:"node-input-env-value",type:"text",style:"margin-left: 5px; width: calc(60% - 8px)"}).appendTo(o);a.typedInput({default:"str",types:["str","num","bool","json","bin","env"]}),a.typedInput("type",n.parent?n.type||n.parent.type:n.type),a.typedInput("value",n.parent?void 0!==n.value?n.value:n.parent.value:n.value);var i=$("<a/>",{href:"#",class:"red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(t);if($("<i/>",{class:"fa "+(n.parent?"fa-reply":"fa-remove")}).appendTo(i),t.parent().addClass("red-ui-editableList-item-removable"),n.parent){void 0===n.value||n.value===n.parent.value&&n.type===n.parent.type?i.hide():i.show();var s=RED.popover.tooltip(i,RED._("subflow.env.restore"));a.change(function(e){var t=a.typedInput("type"),o=a.typedInput("value");t===n.parent.type&&o===n.parent.value?i.hide():i.show()}),i.click(function(e){e.preventDefault(),s.close(),a.typedInput("type",n.parent.type),a.typedInput("value",n.parent.value)})}else{var r=RED.popover.tooltip(i,RED._("subflow.env.remove"));i.click(function(e){e.preventDefault(),r.close(),t.parent().addClass("red-ui-editableList-item-deleting"),t.fadeOut(300,function(){l.editableList("removeItem",n)})})}},sortable:!1,removable:!1});var o={},n=[];if(/^subflow:/.test(t.type)){var a=RED.nodes.subflow(t.type.substring(8));a.env&&a.env.forEach(function(e){var t={name:e.name,parent:{type:e.type,value:e.value}};n.push(t),o[e.name]=t})}if(t.env)for(var i=0;i<t.env.length;i++){var s=t.env[i];o.hasOwnProperty(s.name)?(o[s.name].type=s.type,o[s.name].value=s.value):n.push({name:s.name,type:s.type,value:s.value})}n.forEach(function(e){l.editableList("addItem",e)})}(0,n),$('<input type="password" style="display: none;" />').prependTo(a),$('<input type="text" style="display: none;" />').prependTo(a),a.submit(function(e){e.preventDefault()}),a}function v(e,t){var o,n=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),a=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),i=$("#node-label-form-inputs"),s=$("#node-label-form-outputs");o="subflow"===t.type?t.in.length:t.inputs||t._def.inputs||0;var r,l,d=i.children(),c=d.length;if(1===c&&$(d[0]).hasClass("node-label-form-none")&&c--,c<o)for(0===c&&$(d[0]).remove(),l=c;l<o;l++)y("input",l,"",n).appendTo(i);else if(o<c){for(l=o;l<c;l++)$(d[l]).remove();0===o&&y().appendTo(i)}var p=$("#node-input-outputs").val();if(void 0===p)"subflow"===t.type?r=t.out.length:o=t.outputs||t._def.outputs||0;else if(isNaN(p)){var u=JSON.parse(p),f=Object.keys(u);d=s.children(),1===(c=d.length)&&$(d[0]).hasClass("node-label-form-none")&&c--,r=0;var h=[];f.forEach(function(e){var t=$("#node-label-form-output-"+e).parent();0===t.length&&-1!==u[e]?(0===c&&($(d[0]).remove(),c=-1),t=y("output",e,"",a)):t.detach(),-1!==u[e]&&(r++,h.push({i:parseInt(u[e]),r:t}))}),h.sort(function(e,t){return e.i-t.i}),h.forEach(function(e,t){e.r.find("label").text(t+1+"."),e.r.appendTo(s)}),0===h.length&&y("output",l,"").appendTo(s)}else r=Math.max(0,parseInt(p));if(d=s.children(),1===(c=d.length)&&$(d[0]).hasClass("node-label-form-none")&&c--,c<r)for(0===c&&$(d[0]).remove(),l=c;l<r;l++)y("output",l,"").appendTo(s);else if(r<c){for(l=r;l<c;l++)$(d[l]).remove();0===r&&y().appendTo(s)}}function y(e,t,o,n){var a=$("<div>",{class:"node-label-form-row"});if(void 0===e)$("<span>").text(RED._("editor.noDefaultLabel")).appendTo(a),a.addClass("node-label-form-none");else{a.addClass("");var i="node-label-form-"+e+"-"+t;$("<label>",{for:i}).text(t+1+".").appendTo(a);var s=$("<input>",{type:"text",id:i,placeholder:n}).val(o).appendTo(a);$('<button type="button" class="editor-button editor-button-small"><i class="fa fa-times"></i></button>').appendTo(a).click(function(e){e.preventDefault(),s.val("")})}return a}function b(e,n){var t,o=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e);$('<div class="form-row"><label for="node-input-show-label-btn" data-i18n="editor.label"></label><button type="button" id="node-input-show-label-btn" class="editor-button" style="min-width: 80px; text-align: left;" type="button"><i id="node-input-show-label-btn-i" class="fa fa-toggle-on"></i> <span id="node-input-show-label-label"></span></button> <input type="checkbox" id="node-input-show-label" style="display: none;"/></div>').appendTo(o);var a=function(e){var t=$("#node-input-show-label-btn-i");e?(t.addClass("fa-toggle-on"),t.removeClass("fa-toggle-off"),$("#node-input-show-label").prop("checked",!0),$("#node-input-show-label-label").text(RED._("editor.show"))):(t.addClass("fa-toggle-off"),t.removeClass("fa-toggle-on"),$("#node-input-show-label").prop("checked",!1),$("#node-input-show-label-label").text(RED._("editor.hide")))};if(o.find("#node-input-show-label-btn").on("click",function(e){e.preventDefault();var t=$("#node-input-show-label-btn-i");a(t.hasClass("fa-toggle-off"))}),n.hasOwnProperty("l")||(n.l=!/^link (in|out)$/.test(n._def.type)),a(n.l),!n._def.defaults||!n._def.defaults.hasOwnProperty("icon")){var i=$('<div class="form-row"></div>').appendTo(o);$('<label data-i18n="editor.settingIcon">').appendTo(i);var s=$('<button type="button" class="editor-button" id="node-settings-icon-button">').appendTo(i),r=$("<div>",{class:"red-ui-search-result-node"}).appendTo(s),l=RED.utils.getNodeColor(n.type,n._def),d=RED.utils.getNodeIcon(n._def,n);r.css("backgroundColor",l);var c=$("<div/>",{class:"palette_icon_container"}).appendTo(r);RED.utils.createIconElement(d,c,!0),s.click(function(e){var t;e.preventDefault();var o=$("#node-settings-icon").text()||"";t=o?RED.utils.separateIconPath(o):RED.utils.getDefaultNodeIcon(n._def,n),function(e,r,l,d){var t=e.offset(),o=$("<div>").css({position:"absolute",top:0,bottom:0,left:0,right:0,zIndex:20}).appendTo("body"),n=t.top-30;n+280>$(window).height()&&(n=$(window).height()-280);var a=$('<div class="red-ui-icon-picker">').css({top:n+"px",left:t.left+"px"}).appendTo("body"),c=function(){o.remove(),a.remove(),RED.keyboard.remove("escape")};RED.keyboard.add("*","escape",function(){c()}),o.on("mousedown",c);var i=$("<div>",{class:"red-ui-search-container"}).appendTo(a);searchInput=$('<input type="text">').attr("placeholder",RED._("editor.searchIcons")).appendTo(i).searchBox({delay:50,change:function(){var o=$(this).val().trim();""===o?(p.find(".red-ui-icon-list-module").show(),p.find(".red-ui-icon-list-icon").show()):(p.find(".red-ui-icon-list-module").hide(),p.find(".red-ui-icon-list-icon").each(function(e,t){-1===$(t).data("icon").indexOf(o)?$(t).hide():$(t).show()}))}}),$("<div>").appendTo(a);var p=$('<div class="red-ui-icon-list">').appendTo(a),s=$('<div class="red-ui-icon-meta"></div>').appendTo(a),u=$("<span>").appendTo(s),f=($('<button type="button" class="editor-button editor-button-small">'+RED._("editor.useDefault")+"</button>").appendTo(s).click(function(e){e.preventDefault(),c(),d(null)}),RED.nodes.getIconSets());Object.keys(f).forEach(function(s){var e=f[s];if(0<e.length){var t=$('<div class="red-ui-icon-list-module"></div>').text(s).appendTo(p);$('<i class="fa fa-cube"></i>').prependTo(t),e.forEach(function(e){var t=$("<div>",{class:"red-ui-icon-list-icon"}).appendTo(p),o=$("<div>",{class:"red-ui-search-result-node"}).appendTo(t),n=RED.utils.getNodeColor(r.type,r._def),a=RED.settings.apiRootUrl+"icons/"+s+"/"+e;t.data("icon",a),o.css("backgroundColor",n);var i=$("<div/>",{class:"palette_icon_container"}).appendTo(o);RED.utils.createIconElement(a,i,!0),l.module===s&&l.file===e&&t.addClass("selected"),t.on("mouseover",function(){u.text(e)}),t.on("mouseout",function(){u.html("&nbsp;")}),t.click(function(){c(),d(s+"/"+e)})})}}),a.slideDown(100),searchInput.focus()}(i,n,t,function(e){$("#node-settings-icon").text(e||"");var t=RED.utils.getNodeIcon(n._def,{type:n.type,icon:e});RED.utils.createIconElement(t,c,!0)})}),$('<div id="node-settings-icon">').text(n.icon).appendTo(s)}$('<div class="form-row"><span data-i18n="editor.portLabels"></span></div>').appendTo(o);var p=n.inputs||n._def.inputs||0,u=n.outputs||n._def.outputs||0;"subflow"===n.type&&(p=n.in.length,u=n.out.length);var f=n.inputLabels||[],h=n.outputLabels||[],g=n._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),v=n._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel");$('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelInputs"></span><div id="node-label-form-inputs"></div></div>').appendTo(o);var b=$("#node-label-form-inputs");if(0<p)for(t=0;t<p;t++)y("input",t,f[t],g).appendTo(b);else y().appendTo(b);$('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelOutputs"></span><div id="node-label-form-outputs"></div></div>').appendTo(o);var m=$("#node-label-form-outputs");if(0<u)for(t=0;t<u;t++)y("output",t,h[t],v).appendTo(m);else y().appendTo(m)}function A(e,t,o){var n=$("#node-label-form-inputs").children().find("input"),a=$("#node-label-form-outputs").children().find("input"),i=!1,s=!1,r=n.map(function(){var e=$(this).val();return i=i||""!==e,e}).toArray().slice(0,e.inputs);return(void 0===e.inputLabels&&i||void 0!==e.inputLabels&&JSON.stringify(r)!==JSON.stringify(e.inputLabels))&&(t.inputLabels=e.inputLabels,e.inputLabels=r,s=!0),i=!1,r=new Array(e.outputs),a.each(function(){var e=$(this).attr("id").substring(23);if(!o||!o.hasOwnProperty(e)||-1!==(e=parseInt(o[e]))){var t=$(this).val();i=i||""!==t,r[e]=t}}),(void 0===e.outputLabels&&i||void 0!==e.outputLabels&&JSON.stringify(r)!==JSON.stringify(e.outputLabels))&&(t.outputLabels=e.outputLabels,e.outputLabels=r,s=!0),s}function R(e,t){var o=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),n=($("<div></div>").appendTo(o),$('<div class="form-row node-text-editor-row" style="position:relative; padding-top: 4px; height: 100%"></div>').appendTo(o));$('<div style="height: 100%" class="node-text-editor" id="node-info-input-info-editor" ></div>').appendTo(n);var a=RED.editor.createEditor({id:"node-info-input-info-editor",mode:"ace/mode/markdown",value:""});return t.info&&a.getSession().setValue(t.info,-1),a}function m(g,v,e,b){var m,d,y="_ADD_"==e,c=RED.nodes.getType(v),w=RED.nodes.node(e),p=!1;d="node-red"===c.set.module?"node-red":c.set.id;var t="",o=RED.nodes.subflow(RED.workspaces.active());if(o&&(t=o.id),null==w){for(var n in w={id:RED.nodes.id(),_def:c,type:v,z:t,users:[]},c.defaults)c.defaults[n].value&&(w[n]=JSON.parse(JSON.stringify(c.defaults[n].value)));w._=c._}i.push(w),RED.view.state(RED.state.EDITING);var a={title:l(),resize:function(e){if($(".editor-tray-content").height(e.height-50),w&&w._def.oneditresize){var t=$("#node-config-dialog-edit-form");try{w._def.oneditresize.call(w,{width:t.width(),height:t.height()})}catch(e){console.log("oneditresize",w.id,w.type,e.toString())}}},open:function(e,a){e.find(".editor-tray-header");var i=e.find(".editor-tray-body"),s=e.find(".editor-tray-footer");!1!==c.hasUsers&&s.prepend('<div id="node-config-dialog-user-count"><i class="fa fa-info-circle"></i> <span></span></div>'),s.append('<span id="node-config-dialog-scope-container"><span id="node-config-dialog-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="node-config-dialog-scope"></select></span>');var t=$("<ul></ul>").appendTo(i),o=$("<div></div>").appendTo(i),n=RED.tabs.create({element:t,onchange:function(e){o.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),p&&RED.tray.resize()},collapsible:!0}),r={id:"editor-tab-cproperties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"editor-tray-content"}).appendTo(o).hide(),iconClass:"fa fa-cog"};if(n.addTab(r),E(r.content,"node-config-dialog-edit-form",v,d),!c.defaults||!c.defaults.hasOwnProperty("info")){var l={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"editor-tray-content"}).appendTo(o).hide(),iconClass:"fa fa-file-text-o",onchange:function(){m.focus()}};n.addTab(l),m=R(l.content,w)}D(w,c,"node-config-input",function(){w._def.exclusive?$("#node-config-dialog-scope").hide():$("#node-config-dialog-scope").show(),$("#node-config-dialog-scope-warning").hide();var o={};w.users.forEach(function(e){o[e.z]=!0});var t=Object.keys(o).length,n=$("#node-config-dialog-scope").empty();n.off("change"),n.append('<option value=""'+(w.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),n.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(e){var t=e.label;o[e.id]&&(t="* "+t),$('<option value="'+e.id+'"'+(e.id==w.z?" selected":"")+"></option>").text(t).appendTo(n)}),n.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(e){var t=e.name;o[e.id]&&(t="* "+t),$('<option value="'+e.id+'"'+(e.id==w.z?" selected":"")+"></option>").text(t).appendTo(n)}),0<t&&n.on("change",function(){var e=$(this).val();""===e?$("#node-config-dialog-scope-warning").hide():!o[e]||1<t?$("#node-config-dialog-scope-warning").show():$("#node-config-dialog-scope-warning").hide()}),!1!==c.hasUsers&&$("#node-config-dialog-user-count").find("span").text(RED._("editor.nodesUse",{count:w.users.length})).parent().show(),i.i18n(),s.i18n(),p=!0,a()})},close:function(){RED.workspaces.refresh(),m&&(m.destroy(),m=null),i.pop()},show:function(){w&&RED.sidebar.info.refresh(w)}};a.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var t=v,o=w.id,e=RED.nodes.getType(t);if(e.oneditcancel&&e.oneditcancel){var n=RED.nodes.node(o);if(n)try{e.oneditcancel.call(n,!1)}catch(e){console.log("oneditcancel",n.id,n.type,e.toString())}else try{e.oneditcancel.call({id:o},!0)}catch(e){console.log("oneditcancel",o,t,e.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:y?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,t,o=g,n=(w.id,v),a=y,i=RED.nodes.getType(n),s=$("#node-config-dialog-scope").val();if(i.oneditsave)try{i.oneditsave.call(w)}catch(e){console.log("oneditsave",w.id,w.type,e.toString())}for(e in i.defaults){var r;if(i.defaults.hasOwnProperty(e))if(null!=(r="checkbox"===(t=$("#node-config-input-"+e)).attr("type")?t.prop("checked"):"format"in i.defaults[e]&&""!==i.defaults[e].format&&"DIV"===t[0].nodeName?t.text():t.val())&&r!==w[e]){if(w._def.defaults[e].type){"_ADD_"==r&&(r="");var l=RED.nodes.node(w[e]);if(l){var d=l.users;d.splice(d.indexOf(w),1)}(l=RED.nodes.node(r))&&l.users.push(w)}w[e]=r}}if(m){w.info=m.getValue();var c=w.info;if(m){var p=m.getValue();c?""===p.trim()?delete w.info:p!==c&&(w.info=p):""!==p.trim()&&(w.info=p)}}w.label=i.label,(w.z=s)&&(w.users=w.users.filter(function(e){var t=!0;for(var o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&e._def.defaults[o].type===w.type&&e[o]===w.id&&e.z!==s&&(t=!1,e[o]=null,e.dirty=!0,e.changed=!0,L(e));return t})),a&&RED.nodes.add(w),i.credentials&&I(w,i.credentials,"node-config-input"),L(w);var u={};u[w.id]=!0;for(var f=w.users.slice();0<f.length;){var h=f.pop();u[h.id]||(u[h.id]=!0,h.users&&(f=f.concat(h.users)),L(h))}RED.nodes.dirty(!0),RED.view.redraw(!0),a||RED.events.emit("editor:save",w),RED.tray.close(function(){x(o,n,w.id,b)})}}],y||a.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var e=g,t=w.id,o=v,n=RED.nodes.getType(o);try{n.ondelete&&(console.log("Deprecated API warning: config node type ",o," has an ondelete function - should be oneditdelete"),n.ondelete.call(w)),n.oneditdelete&&n.oneditdelete.call(w)}catch(e){console.log("oneditdelete",w.id,w.type,e.toString())}for(var a={t:"delete",nodes:[w],changes:{},dirty:RED.nodes.dirty()},i=0;i<w.users.length;i++){var s=w.users[i];for(var r in a.changes[s.id]={changed:s.changed,valid:s.valid},s._def.defaults)s._def.defaults.hasOwnProperty(r)&&s[r]==t&&(a.changes[s.id][r]=t,s[r]="",s.changed=!0,s.dirty=!0);L(s)}RED.nodes.remove(t),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(a),RED.tray.close(function(){x(e,o,"",b)})}}),RED.tray.show(a)}function w(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function x(e,o,t,n){if(n){var a=$("#"+n+"-edit-"+e);if(a.length)t?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),$("#"+n+"-"+e).val(t);else{var i=$("#"+n+"-"+e),s=RED.nodes.getType(o);i.children().remove();var r=RED.nodes.workspace(RED.workspaces.active());r||(r=RED.nodes.subflow(RED.workspaces.active()));var l=[];RED.nodes.eachConfig(function(e){if(e.type==o&&(!e.z||e.z===r.id)){var t=RED.utils.getNodeLabel(e,e.id);e.__label__=t,l.push(e)}});var d=w;"function"==typeof s.sort&&(d=s.sort);try{l.sort(d)}catch(e){console.log("Definition error: "+s.type+".sort",e)}l.forEach(function(e){$('<option value="'+e.id+'"'+(t==e.id?" selected":"")+"></option>").text(RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)).appendTo(i),delete e.__label__}),i.append('<option value="_ADD_"'+(""===t?" selected":"")+">"+RED._("editor.addNewType",{type:o})+"</option>"),window.setTimeout(function(){i.change()},50)}}}function t(e,t){s.hasOwnProperty(e)?(0<i.length&&(t.parent=i[i.length-1].id),i.push({type:e}),t.title=t.title||l(),t.onclose=function(){i.pop()},s[e].show(t)):console.log("Unknown type editor:",e)}return{init:function(){RED.tray.init(),RED.actions.add("core:confirm-edit-tray",function(){$("#node-dialog-ok").click(),$("#node-config-dialog-ok").click()}),RED.actions.add("core:cancel-edit-tray",function(){$("#node-dialog-cancel").click(),$("#node-config-dialog-cancel").click()})},edit:function(T){var _,j,C,S=T,p=!1;i.push(T),RED.view.state(RED.state.EDITING);var O=T.type;"subflow:"==T.type.substring(0,8)&&(O="subflow");var e={title:l(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],o=[],n=RED.nodes.remove(S.id);t.push(S);var a={t:"delete",nodes:t=t.concat(n.nodes),links:o=o.concat(n.links),changes:{},dirty:e};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(a),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(S._def){if(S._def.oneditcancel)try{S._def.oneditcancel.call(S)}catch(e){console.log("oneditcancel",S.id,S.type,e.toString())}for(var e in S._def.defaults)if(S._def.defaults.hasOwnProperty(e)){var t=S._def.defaults[e];if(t.type){var o=RED.nodes.getType(t.type);if(o&&o.exclusive){var n=$("#node-input-"+e).val()||"";""===n||S[e]||RED.nodes.remove(n)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,t,o,n={},a=!1,i=RED.nodes.dirty();if(S._def.oneditsave){var s={};for(e in S._def.defaults)S._def.defaults.hasOwnProperty(e)&&("string"==typeof S[e]||"number"==typeof S[e]?s[e]=S[e]:s[e]=$.extend(!0,{},{v:S[e]}).v);try{!0===S._def.oneditsave.call(S)&&(a=!0)}catch(e){console.log("oneditsave",S.id,S.type,e.toString())}for(e in S._def.defaults)S._def.defaults.hasOwnProperty(e)&&(null===s[e]||"string"==typeof s[e]||"number"==typeof s[e]?s[e]!==S[e]&&(n[e]=s[e],a=!0):JSON.stringify(s[e])!==JSON.stringify(S[e])&&(n[e]=s[e],a=!0))}if(S._def.defaults)for(e in S._def.defaults)if(S._def.defaults.hasOwnProperty(e)){var r=$("#node-input-"+e);if("checkbox"===r.attr("type")?o=r.prop("checked"):"select"===r.prop("nodeName")&&"multiple"===r.attr("multiple")?null==(o=r.val())&&(o=[]):o="format"in S._def.defaults[e]&&""!==S._def.defaults[e].format&&"DIV"===r[0].nodeName?r.text():r.val(),null!=o){if("outputs"===e){if(""===o.trim())continue;if(isNaN(o)){t=JSON.parse(o);var l=0,d=!1;Object.keys(t).forEach(function(e){isNaN(e)?(l++,delete t[e]):(t[e]=t[e]+"","-1"!==t[e]?(l++,t[e]!==e?d=!0:delete t[e]):d=!0)}),o=l,d&&(a=!0)}else o=parseInt(o)}if(S[e]!=o){if(S._def.defaults[e].type){"_ADD_"==o&&(o="");var c=RED.nodes.node(S[e]);if(c){var p=c.users;p.splice(p.indexOf(S),1)}(c=RED.nodes.node(o))&&c.users.push(S)}n[e]=S[e],S[e]=o,a=!0}}}if(S._def.credentials){var u=S._def.credentials,f=I(S,u,"node-input");a=a||f}var h=P(S,t);if(A(S,n,t)&&(a=!0),!S._def.defaults||!S._def.defaults.hasOwnProperty("icon")){var g=$("#node-settings-icon").text()||"";if(_)if(""!==g&&g!==j)n.icon=S.icon,S.icon=g,a=!0;else{var v=RED.utils.getDefaultNodeIcon(S._def,S),b=v.module+"/"+v.file;j!==b&&(n.icon=S.icon,S.icon=b,a=!0)}else g!==S.icon&&(n.icon=S.icon,S.icon=g,a=!0)}$("#node-input-show-label").prop("checked")?/^link (in|out)$/.test(T.type)?(T.l||(n.l=T.l,a=!0),T.l=!0):(T.hasOwnProperty("l")&&!T.l&&(n.l=T.l,a=!0),delete T.l):/^link (in|out)$/.test(T.type)?(T.hasOwnProperty("l")&&T.l&&(n.l=T.l,a=!0),delete T.l):(!1!==T.l&&(n.l=T.l,a=!0),T.l=!1),T.resize=!0;var m=T.info;if(C){var y=C.getValue();m?""===y.trim()?(a=!0,n.info=m,delete T.info):y!==m&&(a=!0,n.info=m,T.info=y):""!==y.trim()&&(a=!0,n.info=void 0,T.info=y)}if("subflow"===O){var w=S.env,D=N($("#node-input-env-container").editableList("items"));z(w,D)||(S.env=D,n.env=S.env,a=!0)}if(a){var E=S.changed;S.changed=!0,RED.nodes.dirty(!0);var R=RED.nodes.subflow(RED.workspaces.active()),x=null;R&&(x=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+RED.workspaces.active()&&(x.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,P(e))}));var k={t:"edit",node:S,changes:n,links:h,dirty:i,changed:E};t&&(k.outputMap=t),x&&(k.subflow={instances:x}),RED.history.push(k)}S.dirty=!0,L(S),RED.events.emit("editor:save",S),RED.tray.close()}}],resize:function(e){o[O]=e.width,$(".editor-tray-content").height(e.height-50);var t=$(".editor-tray-content form").height(e.height-50-40);if(S&&S._def.oneditresize)try{S._def.oneditresize.call(S,{width:t.width(),height:t.height()})}catch(e){console.log("oneditresize",S.id,S.type,e.toString())}},open:function(e,t){e.find(".editor-tray-footer");var o=e.find(".editor-tray-body");o.parent().css("overflow","hidden");var n,a=$("<ul></ul>").appendTo(o),i=$("<div></div>").appendTo(o),s=RED.tabs.create({element:a,onchange:function(e){i.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),p&&RED.tray.resize()},collapsible:!0,menu:!1});S&&RED.sidebar.info.refresh(S),n="node-red"===T._def.set.module?"node-red":T._def.set.id;var r=RED.utils.getDefaultNodeIcon(T._def,T);j=r.module+"/"+r.file,_=!T.icon||T.icon===j;var l={id:"editor-tab-properties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"editor-tray-content"}).appendTo(i).hide(),iconClass:"fa fa-cog"};if(E(l.content,"dialog-form",O,n,T),s.addTab(l),!T._def.defaults||!T._def.defaults.hasOwnProperty("info")){var d={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"editor-tray-content"}).appendTo(i).hide(),iconClass:"fa fa-file-text-o",onchange:function(){C.focus()}};s.addTab(d),C=R(d.content,T)}var c={id:"editor-tab-appearance",label:RED._("editor-tab.appearance"),name:RED._("editor-tab.appearance"),content:$("<div>",{class:"editor-tray-content"}).appendTo(i).hide(),iconClass:"fa fa-object-group",onchange:function(){v(this.content,T)}};b(c.content,T),s.addTab(c),D(T,T._def,"node-input",function(){o.i18n(),p=!0,t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),S&&RED.sidebar.info.refresh(S),RED.workspaces.refresh(),C&&(C.destroy(),C=null),RED.view.redraw(!0),i.pop()},show:function(){S&&RED.sidebar.info.refresh(S)}};if(o.hasOwnProperty(O)&&(e.width=o[O]),"subflow"===O){var t=S.type.substring(8);e.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(t),$("#node-dialog-ok").click()}})}RED.tray.show(e)},editConfig:m,editSubflow:function(p){var u,f=p;i.push(p),RED.view.state(RED.state.EDITING);var h=!1,e={title:l(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={},t=!1,o=RED.nodes.dirty(),n=$("#subflow-input-name").val();n!=f.name&&(e.name=f.name,f.name=n,t=!0);var a=u.getValue();a!=f.info&&(e.info=f.info,f.info=a,t=!0),A(f,e,null)&&(t=!0);var i=$("#node-settings-icon").text()||"";(void 0===f.icon&&"node-red/subflow.png"!==i||void 0!==f.icon&&f.icon!==i)&&(e.icon=f.icon,f.icon=i,t=!0);var s=$("#subflow-input-category").val().trim();"_custom_"===s&&""===(s=$("#subflow-input-custom-category").val().trim())&&(s=f.category),"subflows"===s&&(s=""),s!=f.category&&(e.category=f.category,f.category=s,t=!0);var r=f.env,l=N($("#node-input-env-container").editableList("items"));if(z(r,l)||(f.env=l,e.env=f.env,t=!0),RED.palette.refresh(),t){var d=f.changed;f.changed=!0,L(f);var c=[];RED.nodes.eachNode(function(e){e.type=="subflow:"+f.id&&(c.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,P(e),L(e))}),RED.nodes.dirty(!0);var p={t:"edit",node:f,changes:e,dirty:o,changed:d,subflow:{instances:c}};RED.history.push(p)}f.dirty=!0,RED.tray.close()}}],resize:function(e){$(".editor-tray-content").height(e.height-50);for(var t=$("#dialog-form>div:not(.node-input-env-container-row)"),o=e.height,n=0;n<t.size();n++)o-=$(t[n]).outerHeight(!0);var a=$("#dialog-form>div.node-input-env-container-row");o-=parseInt(a.css("marginTop"))+parseInt(a.css("marginBottom")),$("#node-input-env-container").editableList("height",o-80)},open:function(e){e.find(".editor-tray-footer");var t=e.find(".editor-tray-body");t.parent().css("overflow","hidden"),f&&RED.sidebar.info.refresh(f);var o=$("<ul></ul>").appendTo(t),n=$("<div></div>").appendTo(t),a=RED.tabs.create({element:o,onchange:function(e){n.children().hide(),e.onchange&&e.onchange.call(e),e.content.show(),h&&RED.tray.resize()},collapsible:!0}),i={id:"editor-tab-properties",label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),content:$("<div>",{class:"editor-tray-content"}).appendTo(n).hide(),iconClass:"fa fa-cog"};E(i.content,"dialog-form","subflow-template",void 0,f),a.addTab(i);var s={id:"editor-tab-description",label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),content:$("<div>",{class:"editor-tray-content"}).appendTo(n).hide(),iconClass:"fa fa-file-text-o",onchange:function(){u.focus()}};a.addTab(s),u=R(s.content,f);var r={id:"editor-tab-appearance",label:RED._("editor-tab.appearance"),name:RED._("editor-tab.appearance"),content:$("<div>",{class:"editor-tray-content"}).appendTo(n).hide(),iconClass:"fa fa-object-group",onchange:function(){v(this.content,f)}};b(r.content,f),a.addTab(r),$("#subflow-input-name").val(p.name),RED.text.bidi.prepareInput($("#subflow-input-name")),$("#subflow-input-category").empty();var l=RED.palette.getCategories();l.sort(function(e,t){return e.label.localeCompare(t.label)}),l.forEach(function(e){$("#subflow-input-category").append($("<option></option>").val(e.id).text(e.label))}),$("#subflow-input-category").append($("<option></option>").attr("disabled",!0).text("---")),$("#subflow-input-category").append($("<option></option>").val("_custom_").text(RED._("palette.addCategory"))),$("#subflow-input-category").change(function(){"_custom_"===$(this).val()?($("#subflow-input-category").width(120),$("#subflow-input-custom-category").show()):($("#subflow-input-category").width(250),$("#subflow-input-custom-category").hide())}),$("#subflow-input-category").val(p.category||"subflows");var d=0,c="subflow:"+f.id;RED.nodes.eachNode(function(e){e.type===c&&d++}),$("#subflow-dialog-user-count").text(RED._("subflow.subflowInstances",{count:d})).show(),t.i18n(),h=!0},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(f),RED.workspaces.refresh(),u.destroy(),u=null,i.pop(),f=null},show:function(){}};RED.tray.show(e)},editJavaScript:function(e){t("_js",e)},editExpression:function(e){t("_expression",e)},editJSON:function(e){t("_json",e)},editMarkdown:function(e){t("_markdown",e)},editBuffer:function(e){t("_buffer",e)},buildEditForm:E,validateNode:L,updateNodeProperties:P,showTypeEditor:t,registerTypeEditor:function(e,t){s[e]=t},createEditor:function(e){var t=e.element||$("#"+e.id)[0],o=$("<div>").appendTo(t);t=$("<div>").appendTo(t).addClass("node-text-editor-container")[0];var n=ace.edit(t);n.setTheme("ace/theme/tomorrow");var a=n.getSession();if(a.on("changeAnnotation",function(){for(var e=a.getAnnotations()||[],t=e.length,o=e.length;t--;)/doctype first\. Expected/.test(e[t].text)?e.splice(t,1):/Unexpected End of file\. Expected/.test(e[t].text)&&e.splice(t,1);o>e.length&&a.setAnnotations(e)}),e.mode&&a.setMode(e.mode),e.foldStyle?a.setFoldStyle(e.foldStyle):a.setFoldStyle("markbeginend"),e.options?n.setOptions(e.options):n.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,tooltipFollowsMouse:!1}),e.readOnly&&(n.setOption("readOnly",e.readOnly),n.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&n.renderer.setOption("showGutter",e.lineNumbers),n.$blockScrolling=1/0,e.value&&a.setValue(e.value,-1),e.globals&&setTimeout(function(){a.$worker&&a.$worker.send("setOptions",[{globals:e.globals,esversion:6,sub:!0,asi:!0,maxerr:1e3}])},100),"ace/mode/markdown"===e.mode){$(t).addClass("node-text-editor-container-toolbar"),n.toolbar=s._markdown.buildToolbar(o,n),!1!==e.expandable&&$('<button type="button" class="editor-button" style="float: right;"><i class="fa fa-expand"></i></button>').appendTo(n.toolbar).click(function(e){e.preventDefault();var t=n.getValue();RED.editor.editMarkdown({value:t,width:"Infinity",cursor:n.getCursorPosition(),complete:function(e,t){n.setValue(e,-1),n.gotoLine(t.row+1,t.column,!1),setTimeout(function(){n.focus()},300)}})});var i=$('<button type="button" class="node-text-editor-help editor-button editor-button-small"><i class="fa fa-question"></i></button>').appendTo($(t).parent());RED.popover.create({target:i,trigger:"click",size:"small",direction:"left",content:RED._("markdownEditor.format"),autoClose:50})}return n}}}(),function(){var e={show:function(e){var i=e.value,t=e.complete;RED.view.state(RED.state.EDITING);var r,s,l=[],o={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){t(JSON.stringify(r)),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();s&&s.resize(t)},open:function(e){e.find(".editor-tray-body");var t,o=RED.editor.buildEditForm(e.find(".editor-tray-body"),"dialog-form","_buffer","editor");(l=RED.editor.createEditor({id:"node-input-buffer-str",value:"",mode:"ace/mode/text"})).getSession().setValue(i||"",-1),bufferBinEditor=RED.editor.createEditor({id:"node-input-buffer-bin",value:"",mode:"ace/mode/text",readOnly:!0});var n=function(e){var t=!0,o="string"==typeof e,n=[],a=0,i=(r=o?function(e){var t=[],o=0,n=e.length;for(o=0;o<n;o++){var a=e.charCodeAt(o);a<128?t.push(a):(a<2048?t.push(192|a>>6):(a<55296||57344<=a?t.push(224|a>>12):(o++,a=65536+((1023&a)<<10|1023&e.charAt(o)),t.push(240|a>>18),t.push(128|a>>12&63)),t.push(128|a>>6&63)),t.push(128|63&a))}return t}(e):e).length;for(a=0;a<i;a++){var s=parseInt(r[a]);if(!o&&(isNaN(s)||s<0||255<s)){t=!1;break}0<a&&(a%8==0?a%16==0?n.push("\n"):n.push("  "):n.push(" ")),n.push((s<16?"0":"")+s.toString(16).toUpperCase())}return t&&($("#node-input-buffer-type-string").toggle(o),$("#node-input-buffer-type-array").toggle(!o),bufferBinEditor.setValue(n.join(""),1)),t},a=function(){var e=l.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var o=JSON.parse(e);t=n(o)}catch(e){t=!1}}t||n(e)};l.getSession().on("change",function(){clearTimeout(t),t=setTimeout(a,200)}),a(),o.i18n(),s=RED.panels.create({id:"node-input-buffer-panels",resize:function(e,t){var o=$("#node-input-buffer-panel-str");e-=$(o.children()[0]).outerHeight(!0);var n=$(o.children()[1]);e-=parseInt(n.css("marginTop"))+parseInt(n.css("marginBottom")),$("#node-input-buffer-str").css("height",e-5+"px"),l.resize();var a=$("#node-input-buffer-panel-bin");n=$(a.children()[0]),t-=parseInt(n.css("marginTop"))+parseInt(n.css("marginBottom")),$("#node-input-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".node-input-buffer-type").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("bufferEditor.modeDesc")),RED.sidebar.info.show()})},close:function(){e.onclose&&e.onclose(),l.destroy(),bufferBinEditor.destroy()},show:function(){}};RED.tray.show(o)}};$('<script type="text/x-red" data-template-name="_buffer"><div id="node-input-buffer-panels"><div id="node-input-buffer-panel-str" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><span class="node-input-buffer-type"><i class="fa fa-exclamation-circle"></i> <span id="node-input-buffer-type-string" data-i18n="bufferEditor.modeString"></span><span id="node-input-buffer-type-array" data-i18n="bufferEditor.modeArray"></span></span></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="node-input-buffer-str"></div></div></div><div id="node-input-buffer-panel-bin" class="red-ui-panel"><div class="form-row node-text-editor-row" style="margin-top: 10px"><div class="node-text-editor" id="node-input-buffer-bin"></div></div></div></div><\/script>').appendTo(document.body),RED.editor.registerTypeEditor("_buffer",e)}(),function(){var g={},e={show:function(e){var u,l,f,i,s=e.parent||"_",r=e.value,t=e.complete;RED.view.state(RED.state.EDITING);var h={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#node-input-expression-help").text(""),t(u.getValue()),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();i&&i.resize(t)},open:function(e){e.find(".editor-tray-body").addClass("node-input-expression-editor");var t=RED.editor.buildEditForm(e.find(".editor-tray-body"),"dialog-form","_expression","editor"),d=$("#node-input-expression-func");Object.keys(jsonata.functions).forEach(function(e){d.append($("<option></option>").val(e).text(e))}),d.change(function(e){var t=$(this).val(),o="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",n=marked(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#node-input-expression-help").html(o+"<p>"+n+"</p>")}),u=RED.editor.createEditor({id:"node-input-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}});var c=null,p=-1;u.getSession().setValue(r||"",-1),u.on("changeSelection",function(){var e=u.getCursorPosition(),t=u.getSession().getTokenAt(e.row,e.column);if(t!==c||t&&/paren/.test(t.type)&&e.column!==p){var o,n,a=null;if((c=t)&&"keyword"===t.type)o=e.row,a=t;else{var i=0,s=!1;for(n=t?("paren.rparen"===t.type&&(p=e.column,i=e.column-(t.start+t.value.length)),o=e.row,t.index):(o=e.row-1,-1);null===a&&-1<o;){var r=u.getSession().getTokens(o);for(-1===n&&(n=r.length-1);-1<n;){var l=r[n].type;if(s){if("keyword"===l){a=r[n];break}s=!1}"paren.lparen"===l?i-=r[n].value.length:"paren.rparen"===l&&(i+=r[n].value.length),i<0&&(s=!0,i=0),n--}a||o--}}u.session.removeMarker(null),a&&d.val(a.value).change()}}),t.i18n(),$("#node-input-expression-func-insert").click(function(e){e.preventDefault();u.getCursorPosition();var t=d.val(),o=jsonata.getFunctionSnippet(t);u.insertSnippet(o),u.focus()}),$("#node-input-expression-reformat").click(function(e){e.preventDefault();var t=u.getValue()||"";try{t=jsonata.format(t)}catch(e){}u.getSession().setValue(t||"",-1)});var o,n=RED.tabs.create({element:$("#node-input-expression-tabs"),onchange:function(e){$(".node-input-expression-tab-content").hide(),e.content.show(),h.resize()}});n.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#node-input-expression-tab-help")}),n.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#node-input-expression-tab-test")}),l=RED.editor.createEditor({id:"node-input-expression-test-data",value:g[s]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1}),$(".node-input-expression-legacy").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("expressionEditor.compatModeDesc")),RED.sidebar.info.show()});var a=function(){var e,t,o=l.getValue(),n=u.getValue(),a=!1,i=/(^|[^a-zA-Z0-9_'"])msg([^a-zA-Z0-9_'"]|$)/.test(n);$(".node-input-expression-legacy").toggle(i);try{(t=jsonata(n)).assign("flowContext",function(e){return a=!0,null}),t.assign("globalContext",function(e){return a=!0,null})}catch(e){return void f.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(o)}catch(e){return void f.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var s,r=t.evaluate(i?{msg:e}:e);if(a)return void f.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);s=void 0!==r?JSON.stringify(r,null,4):RED._("expressionEditor.noMatch"),f.setValue(s,-1)}catch(e){f.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}};l.getSession().on("change",function(){clearTimeout(o),o=setTimeout(a,200),g[s]=l.getValue()}),u.getSession().on("change",function(){clearTimeout(o),o=setTimeout(a,200)}),f=RED.editor.createEditor({id:"node-input-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),i=RED.panels.create({id:"node-input-expression-panels",resize:function(e,t){var o=$("#node-input-expression-panel-expr");e-=$(o.children()[0]).outerHeight(!0);var n=$(o.children()[1]);e-=parseInt(n.css("marginTop"))+parseInt(n.css("marginBottom")),$("#node-input-expression").css("height",e-5+"px"),u.resize(),t-=$("#node-input-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".node-input-expression-tab-content").height(t),$("#node-input-expression-test-data").css("height",t-5+"px"),l.resize(),$("#node-input-expression-test-result").css("height",t-5+"px"),f.resize()}}),$("#node-input-example-reformat").click(function(e){e.preventDefault();var t=l.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}l.getSession().setValue(t||"",-1)}),a()},close:function(){e.onclose&&e.onclose(),u.destroy(),l.destroy()},show:function(){}};RED.tray.show(h)}};$('<script type="text/x-red" data-template-name="_expression"><div id="node-input-expression-panels"><div id="node-input-expression-panel-expr" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><span class="node-input-expression-legacy"><i class="fa fa-exclamation-circle"></i> <span data-i18n="expressionEditor.compatMode"></span></span><button id="node-input-expression-reformat" class="editor-button editor-button-small"><span data-i18n="expressionEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="node-input-expression"></div></div></div><div id="node-input-expression-panel-info" class="red-ui-panel"><div class="form-row"><ul id="node-input-expression-tabs"></ul><div id="node-input-expression-tab-help" class="node-input-expression-tab-content hide"><div><select id="node-input-expression-func"></select><button id="node-input-expression-func-insert" class="editor-button" data-i18n="expressionEditor.insert"></button></div><div id="node-input-expression-help"></div></div><div id="node-input-expression-tab-test" class="node-input-expression-tab-content hide"><div><span style="display: inline-block; width: calc(50% - 5px);"><span data-i18n="expressionEditor.data"></span><button style="float: right; margin-right: 5px;" id="node-input-example-reformat" class="editor-button editor-button-small"><span data-i18n="jsonEditor.format"></span></button></span><span style="display: inline-block; width: calc(50% - 5px);" data-i18n="expressionEditor.result"></span></div><div style="display: inline-block; width: calc(50% - 5px);" class="node-text-editor" id="node-input-expression-test-data"></div><div style="display: inline-block; width: calc(50% - 5px);" class="node-text-editor" id="node-input-expression-test-result"></div></div></div></div></div><\/script>').appendTo(document.body),RED.editor.registerTypeEditor("_expression",e)}(),function(){var e={show:function(o){var a,n=o.value,e=o.complete;RED.view.state(RED.state.EDITING);var t={title:o.title,width:o.width||"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e(a.getValue(),a.getCursorPosition()),RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),n=0;n<t.size();n++)o-=$(t[n]).outerHeight(!0);$(".node-text-editor").css("height",o+"px"),a.resize()},open:function(e){e.find(".editor-tray-body");var t=RED.editor.buildEditForm(e.find(".editor-tray-body"),"dialog-form","_js","editor");a=RED.editor.createEditor({id:"node-input-js",mode:o.mode||"ace/mode/javascript",value:n,globals:{msg:!0,context:!0,RED:!0,util:!0,flow:!0,global:!0,console:!0,Buffer:!0,setTimeout:!0,clearTimeout:!0,setInterval:!0,clearInterval:!0}}),o.cursor&&a.gotoLine(o.cursor.row+1,o.cursor.column,!1),t.i18n()},close:function(){a.destroy(),o.onclose&&o.onclose()},show:function(){}};RED.tray.show(t)}};$('<script type="text/x-red" data-template-name="_js"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-js"></div></div><\/script>').appendTo(document.body),RED.editor.registerTypeEditor("_js",e)}(),function(){var e={show:function(o){var a,n,i=o.value,e=o.complete;RED.view.state(RED.state.EDITING);var s=function(){var e=a.getValue();try{return JSON.parse(e),$("#node-dialog-ok").removeClass("disabled"),!0}catch(e){return $("#node-dialog-ok").addClass("disabled"),!1}},t={title:o.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){o.requireValid&&!s()||(e(a.getValue()),RED.tray.close())}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),n=0;n<t.size();n++)o-=$(t[n]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",o+"px"),a.resize()},open:function(e){e.find(".editor-tray-body");var t=RED.editor.buildEditForm(e.find(".editor-tray-body"),"dialog-form","_json","editor");(a=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"})).getSession().setValue(i||"",-1),o.requireValid&&(a.getSession().on("change",function(){clearTimeout(n),n=setTimeout(s,200)}),s()),$("#node-input-json-reformat").click(function(e){e.preventDefault();var t=a.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}a.getSession().setValue(t||"",-1)}),t.i18n()},close:function(){a.destroy(),o.onclose&&o.onclose()},show:function(){}};RED.tray.show(t)}};$('<script type="text/x-red" data-template-name="_json"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button id="node-input-json-reformat" class="editor-button editor-button-small"><span data-i18n="jsonEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-json"></div></div><\/script>').appendTo(document.body),RED.editor.registerTypeEditor("_json",e)}(),function(){var s,e={show:function(n){var a,i=n.value,e=n.complete;RED.view.state(RED.state.EDITING);var t={title:n.title,width:n.width||1/0,buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e(a.getValue(),a.getCursorPosition()),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").width();s&&s.resize(t)},open:function(e){e.find(".editor-tray-body").addClass("node-input-markdown-editor");var t,o=RED.editor.buildEditForm(e.find(".editor-tray-body"),"dialog-form","_markdown","editor");(a=RED.editor.createEditor({id:"node-input-markdown",value:i,mode:"ace/mode/markdown",expandable:!1})).getSession().on("change",function(){clearTimeout(t),t=setTimeout(function(){var e=$(".node-input-markdown-panel-preview").scrollTop();$(".node-input-markdown-panel-preview").html(marked(a.getValue())),$(".node-input-markdown-panel-preview").scrollTop(e)},200)}),n.header&&n.header.appendTo(e.find("#node-input-markdown-title")),i&&$(".node-input-markdown-panel-preview").html(marked(a.getValue())),(s=RED.panels.create({id:"node-input-markdown-panels",dir:"horizontal",resize:function(e,t){a.resize()}})).ratio(1),$('<span class="button-group" style="float:right"><button type="button" id="node-btn-markdown-preview" class="editor-button toggle single"><i class="fa fa-eye"></i></button></span>').appendTo(a.toolbar),$("#node-btn-markdown-preview").click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),s.ratio(1)):($(this).addClass("selected"),s.ratio(.5))}),RED.popover.tooltip($("#node-btn-markdown-preview"),RED._("markdownEditor.toggle-preview")),n.cursor&&a.gotoLine(n.cursor.row+1,n.cursor.column,!1),o.i18n()},close:function(){a.destroy(),n.onclose&&n.onclose()},show:function(){}};RED.tray.show(t)},buildToolbar:function(e,l){var t={h1:{newline:!0,before:"# ",tooltip:RED._("markdownEditor.heading1")},h2:{newline:!0,before:"## ",tooltip:RED._("markdownEditor.heading2")},h3:{newline:!0,before:"### ",tooltip:RED._("markdownEditor.heading3")},b:{before:"**",after:"**",tooltip:RED._("markdownEditor.bold")},i:{before:"_",after:"_",tooltip:RED._("markdownEditor.italic")},code:{before:"`",after:"`",tooltip:RED._("markdownEditor.code")},ol:{before:" * ",newline:!0,tooltip:RED._("markdownEditor.ordered-list")},ul:{before:" - ",newline:!0,tooltip:RED._("markdownEditor.unordered-list")},bq:{before:"> ",newline:!0,tooltip:RED._("markdownEditor.quote")},link:{before:"[",after:"]()",tooltip:RED._("markdownEditor.link")},hr:{before:"\n---\n\n",tooltip:RED._("markdownEditor.horizontal-rule")}},o=$('<div style="margin-bottom: 5px"><span class="button-group"><button type="button" class="editor-button" data-style="h1" style="font-size:1.1em; font-weight: bold">h1</button><button type="button" class="editor-button" data-style="h2" style="font-size:1.0em; font-weight: bold">h2</button><button type="button" class="editor-button" data-style="h3" style="font-size:0.9em; font-weight: bold">h3</button></span><span class="button-group"><button type="button" class="editor-button" data-style="b"><i class="fa fa-bold"></i></button><button type="button" class="editor-button" data-style="i"><i class="fa fa-italic"></i></button><button type="button" class="editor-button" data-style="code"><i class="fa fa-code"></i></button></span><span class="button-group"><button type="button" class="editor-button" data-style="ol"><i class="fa fa-list-ol"></i></button><button type="button" class="editor-button" data-style="ul"><i class="fa fa-list-ul"></i></button><button type="button" class="editor-button" data-style="bq"><i class="fa fa-quote-left"></i></button><button type="button" class="editor-button" data-style="hr"><i class="fa fa-minus"></i></button><button type="button" class="editor-button" data-style="link"><i class="fa fa-link"></i></button></span>').appendTo(e);return o.find("button[data-style]").each(function(e){var r=t[$(this).data("style")];$(this).click(function(e){e.preventDefault();var t=l.getSelectedText(),o=l.selection.getRange();if(r.newline)for(var n=0,a=((r.before||"").match(/\n/g)||[]).length,i=((r.after||"").match(/\n/g)||[]).length,s=o.start.row;s<=o.end.row+n;s++)r.before&&(l.session.insert({row:s,column:0},r.before),n+=a,s+=a),r.after&&(l.session.insert({row:s,column:1/0},r.after),n+=i,s+=i);else l.session.replace(l.selection.getRange(),(r.before||"")+t+(r.after||"")),""===t&&l.gotoLine(o.start.row+1,o.start.column+(r.before||"").length,!1);l.focus()}),r.tooltip&&RED.popover.tooltip($(this),r.tooltip)}),o}};$('<script type="text/x-red" data-template-name="_markdown"><div id="node-input-markdown-panels"><div id="node-input-markdown-panel-editor" class="red-ui-panel"><div style="height: 100%; margin: auto; max-width: 1000px;"><div id="node-input-markdown-toolbar"></div><div class="node-text-editor" style="height: 100%" id="node-input-markdown"></div></div></div><div class="red-ui-panel"><div class="node-input-markdown-panel-preview node-help"></div></div><\/script>').appendTo(document.body),RED.editor.registerTypeEditor("_markdown",e)}(),RED.eventLog=function(){var a,i=[],t=!1;return{init:function(){$('<script type="text/x-red" data-template-name="_eventLog"><div class="form-row node-text-editor-row"><div style="height: 100%;min-height: 150px;" class="node-text-editor" id="event-log-editor"></div></div><\/script>').appendTo(document.body),RED.actions.add("core:show-event-log",RED.eventLog.show)},show:function(){if(!t){t=!0;var e={title:RED._("eventLog.title"),width:1/0,buttons:[{id:"node-dialog-close",text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),n=0;n<t.size();n++)o-=$(t[n]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",o+"px"),a.resize()},open:function(e){e.find(".editor-tray-body");var t=RED.editor.buildEditForm(e.find(".editor-tray-body"),"dialog-form","_eventLog","editor");a=RED.editor.createEditor({id:"event-log-editor",value:i.join("\n"),lineNumbers:!1,readOnly:!0,options:{showPrintMargin:!1}}),setTimeout(function(){a.scrollToLine(a.getSession().getLength())},200),t.i18n()},close:function(){a.destroy(),a=null,t=!1},show:function(){}};RED.tray.show(e)}},log:function(e,t){var o=new Date(t.ts).toISOString()+" ";if(t.type&&(o+="["+t.type+"] "),t.data){var n=t.data;n.endsWith("\n")&&(n=n.substring(0,n.length-1)),n.split(/\n/).forEach(function(e){var t;t=o+e,i.push(t),500<i.length&&(i=i.slice(-500)),a&&(a.getSession().insert({row:a.getSession().getLength(),column:0},"\n"+t),a.scrollToLine(a.getSession().getLength()))})}},startEvent:function(e){i.push(""),i.push("-----------------------------------------------------------"),i.push((new Date).toISOString()+" "+e),i.push("")}}}(),RED.tray=function(){var v=[],b=$("#editor-stack"),m=!1;function o(e){var o=$('<div class="editor-tray"></div>'),t=$('<div class="editor-tray-header"></div>').appendTo(o),n=$('<div class="editor-tray-body-wrapper"></div>').appendTo(o),a=$('<div class="editor-tray-body"></div>').appendTo(n),i=$('<div class="editor-tray-footer"></div>').appendTo(o),s=$('<div class="editor-tray-resize-handle"></div>').appendTo(o);if(e.title){var r=v.map(function(e){return e.options.title});r.push(e.title);var l='<ul class="editor-tray-breadcrumbs"><li>'+r.join("</li><li>")+"</li></ul>";$('<div class="editor-tray-titlebar">'+l+"</div>").appendTo(t)}e.width===1/0&&(e.maximized=!0,s.addClass("editor-tray-resize-maximised"));var d,c=$('<div class="editor-tray-toolbar"></div>').appendTo(t);if(e.buttons)for(var p=0;p<e.buttons.length;p++){var u=e.buttons[p],f=$("<button>").button().appendTo(c);u.id&&f.attr("id",u.id),u.text&&f.text(u.text),u.click&&f.click(function(t){return function(e){$(this).hasClass("disabled")||t(e)}}(u.click)),u.class&&(f.addClass(u.class),"primary"===u.class&&(d=u))}o.appendTo(b);var h={tray:o,header:t,body:a,footer:i,options:e,primaryButton:d};function g(){$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$(".sidebar-shade").show(),h.preferredWidth=Math.max(o.width(),500),e.maximized||a.css({minWidth:h.preferredWidth-40}),e.width?(e.width>$("#editor-stack").position().left-8&&(e.width=$("#editor-stack").position().left-8),o.width(e.width)):o.width(h.preferredWidth),h.width=o.width(),h.width>$("#editor-stack").position().left-8&&(h.width=Math.max(0,$("#editor-stack").position().left-8),o.width(h.width)),$("#main-container").scrollLeft(0),o.css({right:-(o.width()+10)+"px",transition:"right 0.25s ease"}),y(),m=!0,setTimeout(function(){setTimeout(function(){e.width||o.width(Math.min(h.preferredWidth,$("#editor-stack").position().left-8)),e.resize&&e.resize({width:o.width()}),e.show&&e.show(),setTimeout(function(){m=!1},200),a.find(":focusable:first").focus()},150),o.css({right:0})},0)}v.push(h),e.maximized||o.draggable({handle:s,axis:"x",start:function(e,t){o.width("auto")},drag:function(e,t){var o=b.position().left+t.position.left;o<7?t.position.left+=7-o:t.position.left>-h.preferredWidth-1&&(t.position.left=-Math.min(b.position().left-7,h.preferredWidth-1)),h.options.resize&&setTimeout(function(){h.options.resize({width:-t.position.left})},0),h.width=-t.position.left},stop:function(e,t){o.width(-t.position.left),o.css({left:""}),h.options.resize&&h.options.resize({width:-t.position.left}),h.width=-t.position.left}}),e.open?1===e.open.length?(e.open(o),g()):e.open(o,g):g()}function y(){if(0<v.length){var e=v[v.length-1],t=e.tray.height()-e.header.outerHeight()-e.footer.outerHeight();e.body.height(t),e.options.maximized||e.width>$("#editor-stack").position().left-8?(e.width=$("#editor-stack").position().left-8,e.tray.width(e.width)):e.width<e.preferredWidth&&(e.width=Math.min($("#editor-stack").position().left-8,e.preferredWidth),e.tray.width(e.width)),e.options.resize&&e.options.resize({width:e.width,height:t})}}return{init:function(){$(window).resize(y),RED.events.on("sidebar:resize",y),$("#editor-shade").click(function(){if(!m){var e=v[v.length-1];e&&e.primaryButton&&e.primaryButton.click()}})},show:function(e){if(0<v.length&&!e.overlay){var t=v[v.length-1];"inherit"===e.width&&(e.width=t.tray.width()),t.tray.css({right:-(t.tray.width()+10)+"px"}),setTimeout(function(){t.tray.detach(),o(e)},250)}else RED.events.emit("editor:open"),o(e)},resize:y,close:function(t){if(0<v.length){var o=v.pop();o.tray.css({right:-(o.tray.width()+10)+"px"}),setTimeout(function(){if(o.options.close&&o.options.close(),o.tray.remove(),0<v.length){var e=v[v.length-1];e.options.overlay?(y(),e.options.show&&e.options.show()):(e.tray.appendTo("#editor-stack"),setTimeout(function(){y(),e.tray.css({right:0}),e.options.show&&e.options.show()},0))}t&&t(),0===v.length&&($("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$(".sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())},250)}}}}(),RED.clipboard=function(){var t,o,n,e,f,h,a,i=!1;function s(){a&&clearTimeout(a),a=setTimeout(function(){var t=$("#clipboard-import"),o=t.val().trim();if(""===o)return f.close(!0),h=null,t.removeClass("input-error"),void $("#clipboard-dialog-ok").button("disable");try{if(!/^\[[\s\S]*\]$/m.test(o))throw new Error(RED._("clipboard.import.errors.notArray"));for(var e=JSON.parse(o),n=0;n<e.length;n++){if("object"!=typeof e[n])throw new Error(RED._("clipboard.import.errors.itemNotObject",{index:n}));if(!e[n].hasOwnProperty("id"))throw new Error(RED._("clipboard.import.errors.missingId",{index:n}));if(!e[n].hasOwnProperty("type"))throw new Error(RED._("clipboard.import.errors.missingType",{index:n}))}h=null,f.close(!0),t.removeClass("input-error"),t.val(o),$("#clipboard-dialog-ok").button("enable")}catch(e){if(""!==o){t.addClass("input-error");var a=e.toString();if(a!==h){var i,s=$('<div class="clipboard-import-error"></div>').text(a),r=/at position (\d+)/i.exec(a);if(r)i=parseInt(r[1]);else if(r=/at line (\d+) column (\d+)/i.exec(a)){var l=parseInt(r[1])-1,d=parseInt(r[2])-1,c=o.split("\n");for(n=i=0;n<l;n++)i+=c[n].length+1;i+=d}if(void 0!==i){o=o.replace(/\n/g,"↵");parseInt(r[1]);var p=$("<div>").appendTo(s),u=$("<pre>").appendTo(p);$("<span>").text(o.substring(i-12,i)).appendTo(u),$('<span class="error">').text(o.charAt(i)).appendTo(u),$("<span>").text(o.substring(i+1,i+12)).appendTo(u)}f.close(!0).setContent(s).open(),h=a}}else h=null;$("#clipboard-dialog-ok").button("disable")}},100)}function r(){i||(o.empty(),o.append($(e)),o.i18n(),$("#clipboard-dialog-ok").show(),$("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-close").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-download").hide(),$("#clipboard-dialog-ok").button("disable"),$("#clipboard-import").keyup(s),$("#clipboard-import").on("paste",function(){setTimeout(s,10)}),$("#import-tab > a").click(function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),$("#import-file-upload").change(function(){var e=new FileReader;e.onload=function(){$("#clipboard-import").val(e.result),s()},e.readAsText($(this).prop("files")[0])}),$("#import-file-upload-btn").click(function(e){e.preventDefault(),$("#import-file-upload").click()}),t.dialog("option","title",RED._("clipboard.importNodes")).dialog("open"),f=RED.popover.create({target:$("#clipboard-import"),trigger:"manual",direction:"bottom",content:""}))}function l(){if(!i){o.empty(),o.append($(n)),o.i18n();var r=RED.settings.flowFilePretty?"export-format-full":"export-format-mini";$("#export-format-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$("#clipboard-export").val();if(0<t.length){var o=JSON.parse(t);t="export-format-full"===(r=$(this).attr("id"))?JSON.stringify(o,null,4):JSON.stringify(o),$("#clipboard-export").val(t),$("#clipboard-export").focus()}}}),$("#export-range-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("id"),o="",n=null;if("export-range-selected"===t){var a=RED.workspaces.selection();0<a.length?(n=[],a.forEach(function(e){n.push(e),n=n.concat(RED.nodes.filterNodes({z:e.id}))})):n=RED.view.selection().nodes||[],n=RED.nodes.createExportableNodeSet(n.filter(function(e){return"subflow"!==e.type}))}else if("export-range-flow"===t){var i=RED.workspaces.active();n=RED.nodes.filterNodes({z:i});var s=RED.nodes.workspace(i)||RED.nodes.subflow(i);n.unshift(s),n=RED.nodes.createExportableNodeSet(n)}else"export-range-full"===t&&(n=RED.nodes.createCompleteNodeSet(!1));null!==n&&(o="export-format-full"===r?JSON.stringify(n,null,4):JSON.stringify(n)),0<o.length?$("#export-copy").removeClass("disabled"):$("#export-copy").addClass("disabled"),$("#clipboard-export").val(o),$("#clipboard-export").focus()}}),$("#clipboard-dialog-ok").hide(),$("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-close").hide();var e=RED.workspaces.selection();0<e.length?$("#export-range-selected").click():(e=RED.view.selection()).nodes?$("#export-range-selected").click():($("#export-range-selected").addClass("disabled").removeClass("selected"),$("#export-range-flow").click()),"export-format-full"===r?$("#export-format-full").click():$("#export-format-mini").click(),$("#clipboard-export").focus(function(){var e=$(this);e.select(),e.mouseup(function(){return e.unbind("mouseup"),!1})}),t.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open"),$("#clipboard-export").focus(),document.queryCommandSupported("copy")?($("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-copy").show()):($("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-close").show()),$("#clipboard-dialog-download").show()}}function d(){$("#dropTarget").hide(),RED.keyboard.remove("escape")}return{init:function(){t=$('<div id="clipboard-dialog" class="hide node-red-dialog"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,buttons:[{id:"clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-close",class:"primary",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-download",class:"primary",text:RED._("clipboard.download"),click:function(){var e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent($("#clipboard-export").val())),e.setAttribute("download","flows.json"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e),$(this).dialog("close")}},{id:"clipboard-dialog-copy",class:"primary",text:RED._("clipboard.export.copy"),click:function(){$("#clipboard-export").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported"),{id:"clipboard"}),$(this).dialog("close")}},{id:"clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){RED.view.importNodes($("#clipboard-import").val(),"import-tab-new"===$("#import-tab > a.selected").attr("id")),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){f&&(f.close(!0),h=null)}}),o=t.children(".dialog-form"),n='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.export.copy"></label><span id="export-range-group" class="button-group"><a id="export-range-selected" class="editor-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="export-range-flow" class="editor-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="export-range-full" class="editor-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="form-row"><textarea readonly style="resize: none; width: 100%; border-radius: 4px;font-family: monospace; font-size: 12px; background:#f3f3f3; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-export" rows="5"></textarea></div><div class="form-row" style="text-align: right;"><span id="export-format-group" class="button-group"><a id="export-format-mini" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="export-format-full" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div>',e='<div class="form-row"><span data-i18n="clipboard.pasteNodes"></span> <a class="editor-button" id="import-file-upload-btn"><i class="fa fa-upload"></i> <span data-i18n="clipboard.selectFile"></span></a><input type="file" id="import-file-upload" accept=".json" style="display:none"></div><div class="form-row"><textarea style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-import" rows="5"></textarea></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="import-tab" class="button-group"><a id="import-tab-current" class="editor-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="import-tab-new" class="editor-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',$('<input type="text" id="clipboard-hidden">').appendTo("body"),RED.actions.add("core:show-export-dialog",l),RED.actions.add("core:show-import-dialog",r),RED.events.on("editor:open",function(){i=!0}),RED.events.on("editor:close",function(){i=!1}),RED.events.on("search:open",function(){i=!0}),RED.events.on("search:close",function(){i=!1}),RED.events.on("type-search:open",function(){i=!0}),RED.events.on("type-search:close",function(){i=!1}),$("#chart").on("dragenter",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||($("#dropTarget").css({display:"table"}),RED.keyboard.add("*","escape",d))}),$("#dropTarget").on("dragover",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()}).on("dragleave",function(e){d()}).on("drop",function(e){if(-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)){var t=e.originalEvent.dataTransfer.getData("text/plain");t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1),RED.view.importNodes(t)}else if(-1!=$.inArray("Files",e.originalEvent.dataTransfer.types)){var o=e.originalEvent.dataTransfer.files;if(1===o.length){var n=o[0],a=new FileReader;a.onload=function(e){RED.view.importNodes(e.target.result)},a.readAsText(n)}}d(),e.preventDefault()})},import:r,export:l,copyText:function(e,t,o){var n=!1;"string"!=typeof e&&(e=JSON.stringify(e,function(e,t){if(null!==t&&"object"==typeof t&&t.__enc__){if(t.hasOwnProperty("data")&&t.hasOwnProperty("length"))return n=t.data.length!==t.length,t.data;if("function"===t.type||"internal"===t.type)return;if("number"===t.type)return null}return t})),n&&(o+="_truncated"),$("#clipboard-hidden").val(e).select();var a=document.execCommand("copy");if(a&&t){var i=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(o)});setTimeout(function(){i.close()},1e3),i.open()}return a}}}(),RED.library=function(){var t,p="node-input-";function e(){$.getJSON("library/flows",function(e){var t,r=function(e,t){var o,n,a,i=document.createElement("ul");if(""===t&&(i.id="menu-item-import-library-submenu"),i.className="dropdown-menu",e.d)for(o in e.d)if(e.d.hasOwnProperty(o)){(n=document.createElement("li")).className="dropdown-submenu pull-left",(a=document.createElement("a")).href="#";var s=o.replace(/^@.*\//,"").replace(/^node-red-contrib-/,"").replace(/^node-red-node-/,"").replace(/-/g," ").replace(/_/g," ");a.innerText=s,n.appendChild(a),n.appendChild(r(e.d[o],t+(""!==t?"/":"")+o)),i.appendChild(n)}if(e.f)for(o in e.f)e.f.hasOwnProperty(o)&&(n=document.createElement("li"),(a=document.createElement("a")).href="#",a.innerText=e.f[o],a.flowName=t+(""!==t?"/":"")+e.f[o],a.onclick=function(){$.get("library/flows/"+this.flowName,function(e){RED.view.importNodes(e)})},n.appendChild(a),i.appendChild(n));return i};e.d&&e.d._examples_&&(t=e.d._examples_,delete e.d._examples_);var o=r(e,"");$("#menu-item-import-examples").remove(),t&&(RED.menu.addItem("menu-item-import",{id:"menu-item-import-examples",label:RED._("menu.label.examples"),options:[]}),$("#menu-item-import-examples-submenu").replaceWith(r(t,"_examples_"))),$("#menu-item-import-library-submenu").replaceWith(o)})}function o(){var e=RED.nodes.createExportableNodeSet(RED.view.selection().nodes);$("#node-input-library-filename").attr("nodes",JSON.stringify(e)),t.dialog("open")}return{init:function(){$('<div id="node-dialog-library-save" class="hide"><form class="form-horizontal"><div class="form-row"><label for="node-dialog-library-save-folder" data-i18n="[append]library.folder"><i class="fa fa-folder-open"></i> </label><input type="text" id="node-dialog-library-save-folder" data-i18n="[placeholder]library.folderPlaceholder"></div><div class="form-row"><label for="node-dialog-library-save-filename" data-i18n="[append]library.filename"><i class="fa fa-file"></i> </label><input type="text" id="node-dialog-library-save-filename" data-i18n="[placeholder]library.filenamePlaceholder"></div></form></div>').appendTo(document.body),$('<div id="node-dialog-library-save-confirm" class="hide"><form class="form-horizontal"><div style="text-align: center; padding-top: 30px;" id="node-dialog-library-save-content"></div></form></div>').appendTo(document.body),$('<div id="node-dialog-library-lookup" class="hide"><form class="form-horizontal"><div class="form-row"><ul id="node-dialog-library-breadcrumbs" class="breadcrumb"><li class="active"><a href="#" data-i18n="[append]library.breadcrumb"></a></li></ul></div><div class="form-row"><div style="vertical-align: top; display: inline-block; height: 100%; width: 30%; padding-right: 20px;"><div id="node-select-library" style="border: 1px solid #999; width: 100%; height: 100%; overflow:scroll;"><ul></ul></div></div><div style="vertical-align: top; display: inline-block;width: 65%; height: 100%;"><div style="height: 100%; width: 95%;" class="node-text-editor" id="node-select-library-text" ></div></div></div></form></div>').appendTo(document.body),RED.actions.add("core:library-export",o),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-export-library",!1):RED.menu.setDisabled("menu-item-export-library",!0)}),!1!==RED.settings.theme("menu.menu-item-import-library")&&e(),(t=$('<div id="library-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,title:RED._("library.exportToLibrary"),buttons:[{id:"library-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"library-dialog-ok",class:"primary",text:RED._("common.label.export"),click:function(){var e=$("#node-input-library-filename").val();""===(e=e.trim())||e.endsWith("/")?RED.notify(RED._("library.invalidFilename"),"warning"):$.ajax({url:"library/flows/"+e,type:"POST",data:$("#node-input-library-filename").attr("nodes"),contentType:"application/json; charset=utf-8"}).done(function(){RED.library.loadFlowLibrary(),RED.notify(RED._("library.savedNodes"),"success")}).fail(function(e,t,o){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}})).children(".dialog-form").append($('<div class="form-row"><label for="node-input-library-filename" data-i18n="[append]editor:library.filename"><i class="fa fa-file"></i> </label><input type="text" id="node-input-library-filename" data-i18n="[placeholder]editor:library.fullFilenamePlaceholder"><input type="text" style="display: none;" /></div>'))},create:function(l){var s=null,r=null;function d(e){var t=document.createElement("li");return t.onmouseover=function(e){$(this).addClass("list-hover")},t.onmouseout=function(e){$(this).removeClass("list-hover")},t}function c(a,e){for(var t,o=document.createElement("ul"),n=0;n<e.length;n++){var i=e[n];"string"==typeof i?((t=d()).onclick=function(){var n=i;return function(e){var t=$('<li class="active"><span class="divider">/</span> </li>');$('<a href="#"></a>').text(n).appendTo(t).click(function(e){$(this).parent().nextAll().remove(),$.getJSON("library/"+l.url+a+n,function(e){$("#node-select-library").children().first().replaceWith(c(a+n+"/",e))}),e.stopPropagation()});var o=$("#node-dialog-library-breadcrumbs");$(".active",o).removeClass("active"),o.append(t),$.getJSON("library/"+l.url+a+n,function(e){$("#node-select-library").children().first().replaceWith(c(a+n+"/",e))})}}(),$('<i class="fa fa-folder"></i>').appendTo(t),$("<span>").text(" "+i).appendTo(t)):((t=d()).innerText=i.name,t.onclick=function(){var t=i;return function(e){$(".list-selected",o).removeClass("list-selected"),$(this).addClass("list-selected"),$.get("library/"+l.url+a+t.fn,function(e){s=t,r.setValue(e,-1)})}}()),o.appendChild(t)}return o}function e(e){var t=$("#"+p+"name").val().replace(/(^\s*)|(\s*$)/g,"");""===t&&(t=RED._("library.unnamedType",{type:l.type}));var o=$("#node-dialog-library-save-filename").val().replace(/(^\s*)|(\s*$)/g,""),n=$("#node-dialog-library-save-folder").val().replace(/(^\s*)|(\s*$)/g,"");if(""!==o&&/.+\.js$/.test(o)){for(var a=n+(""===n?"":"/")+o,i={},s=0;s<l.fields.length;s++){var r=l.fields[s];"name"==r?i.name=t:i[r]=$("#"+p+r).val()}i.text=l.editor.getValue(),$.ajax({url:"library/"+l.url+"/"+a,type:"POST",data:JSON.stringify(i),contentType:"application/json; charset=utf-8"}).done(function(e,t,o){RED.notify(RED._("library.savedType",{type:l.type}),"success")}).fail(function(e,t,o){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}else RED.notify(RED._("library.invalidFilename"),"warning")}p=l.elementPrefix||"node-input-",l.editor.setText&&(l.editor.setValue=function(e,t){l.editor.setText.call(l.editor,e)}),l.editor.getText&&(l.editor.getValue=l.editor.getText),$("#"+p+"name").css("width","calc(100% - 52px)").after('<div class="btn-group" style="margin-left:5px;"><a id="node-input-'+l.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu pull-right" role="menu"><li><a id="node-input-'+l.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li><li><a id="node-input-'+l.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+"</a></li></ul></div>"),$("#node-input-"+l.type+"-menu-open-library").click(function(e){$("#node-select-library").children().remove(),$("#node-dialog-library-breadcrumbs").children().first().nextAll().remove(),r.setValue("",-1),$.getJSON("library/"+l.url,function(t){$("#node-select-library").append(c("/",t)),$("#node-dialog-library-breadcrumbs a").click(function(e){$(this).parent().nextAll().remove(),$("#node-select-library").children().first().replaceWith(c("/",t)),e.stopPropagation()}),$("#node-dialog-library-lookup").dialog("open")}),e.preventDefault()}),$("#node-input-"+l.type+"-menu-save-library").click(function(e){var t=$("#"+p+"name").val().replace(/(^\s*)|(\s*$)/g,"");$("#node-dialog-library-save-folder").attr("value","");var o=t.replace(/[^\w-]/g,"-");""===o&&(o="unnamed-"+l.type),$("#node-dialog-library-save-filename").attr("value",o+".js"),$("#node-dialog-library-save").dialog("open"),e.preventDefault()}),(r=ace.edit("node-select-library-text")).setTheme("ace/theme/tomorrow"),l.mode&&r.getSession().setMode(l.mode),r.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),r.renderer.$cursorLayer.element.style.opacity=0,r.$blockScrolling=1/0,$("#node-dialog-library-lookup").dialog({title:RED._("library.typeLibrary",{type:l.type}),modal:!0,autoOpen:!1,width:800,height:450,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(s){for(var e=0;e<l.fields.length;e++){var t=l.fields[e];$("#"+p+t).val(s[t])}l.editor.setValue(r.getValue(),-1)}$(this).dialog("close")}}],open:function(e){var t=$("form",this);t.height(t.parent().height()-30),$("#node-select-library-text").height("100%"),$(".form-row:last-child",t).children().height(t.height()-60)},resize:function(e){var t=$("form",this);t.height(t.parent().height()-30),$(".form-row:last-child",t).children().height(t.height()-60)}}),$("#node-dialog-library-save-confirm").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){e(),$(this).dialog("close")}}]}),$("#node-dialog-library-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){e(),$(this).dialog("close")}}]})},loadFlowLibrary:e,export:o}}(),RED.notifications=function(){var b,m={},y=[],w=0;function e(e,t,o,n){var a={};if(null!==t&&"object"==typeof t&&(o=(a=t).fixed,n=a.timeout,t=a.type),a.id&&m.hasOwnProperty(a.id))return m[a.id].update(e,a),m[a.id];if(a.modal&&$("#full-shade").show(),4<y.length)for(var i=y.length,s=0;4<i&&s<y.length;s+=1){var r=y[s];r.fixed||(window.clearTimeout(r.timeoutid),r.close(),i-=1)}var l,d,c,p,u,f=document.createElement("div");if(f.id="red-notification-"+w,f.className="notification",f.fixed=o,t&&(f.className="notification notification-"+t),a.width){var h=$("#notifications").width();if(a.width>h){var g=-(a.width-h)/2;$(f).css({width:a.width+"px",marginLeft:g+"px"})}}if(f.style.display="none","string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),f.innerHTML=e):$(f).append(e),a.buttons){var v=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(f);a.buttons.forEach(function(e){var t=$("<button>").html(e.text).click(e.click).appendTo(v);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}return $("#notifications").append(f),RED.notifications.hide||$(f).slideDown(300),f.close=(l=f,function(){l.closed||(l.closed=!0,y.splice(y.indexOf(l),1),a.id&&(delete m[a.id],0===Object.keys(m).length&&b.hide()),RED.notifications.hide?l.parentNode.removeChild(l):$(l).slideUp(300,function(){l.parentNode.removeChild(l)}),a.modal&&$("#full-shade").hide())}),f.hideNotification=(d=f,function(){d.closed||(d.hidden=!0,RED.notifications.hide||$(d).slideUp(300))}),f.showNotification=(c=f,function(){!c.closed&&c.hidden&&(c.hidden=!1,RED.notifications.hide||$(c).slideDown(300))}),f.update=(p=f,function(e,t){var o;if("string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),p.innerHTML=e):$(p).empty().append(e),"number"==typeof t)o=t;else if(void 0!==t&&(t.fixed||(o=t.timeout||5e3),t.buttons)){var n=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(p);t.buttons.forEach(function(e){var t=$("<button>").text(e.text).click(e.click).appendTo(n);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}void 0!==o&&0<o?(window.clearTimeout(p.timeoutid),p.timeoutid=window.setTimeout(p.close,o)):window.clearTimeout(p.timeoutid),p.hidden?p.showNotification():t&&t.silent||($(p).addClass("notification-shake-horizontal"),setTimeout(function(){$(p).removeClass("notification-shake-horizontal")},300))}),o||($(f).click((u=f,function(){u.close(),window.clearTimeout(u.timeoutid)})),f.timeoutid=window.setTimeout(f.close,n||5e3)),y.push(f),a.id&&(m[a.id]=f,a.fixed&&b.show()),w+=1,f}return{init:function(){b=$('<li><a id="btn-notifications" class="button" href="#"><i class="fa fa-warning"></i></a></li>').prependTo(".header-toolbar").hide(),$("#btn-notifications").click(function(){!function(){for(var e in m)m.hasOwnProperty(e)&&m[e].showNotification()}()})},notify:RED.notify=e}}(),RED.search=function(){var o,c,t=!1,n=null,p=-1,a=!1,u={},f=[],h=[];function i(t,o,e){if("string"==typeof e||"number"==typeof e)e=(""+e).toLowerCase(),u[e]=u[e]||{},u[e][t.id]={node:t,label:o};else if(Array.isArray(e))e.forEach(function(e){i(t,o,e)});else if("object"==typeof e)for(var n in e)e.hasOwnProperty(n)&&i(t,o,e[n])}function s(e){var t=RED.utils.getNodeLabel(e);t&&(t=(""+t).toLowerCase(),u[t]=u[t]||{},u[t][e.id]={node:e,label:t}),t=t||e.label||e.name||e.id||"";var o=["id","type","name","label","info"];e._def&&e._def.defaults&&(o=o.concat(Object.keys(e._def.defaults)));for(var n=0;n<o.length;n++)e.hasOwnProperty(o[n])&&i(e,t,e[o[n]])}function r(){var e=c.find("li.selected");if(1===e.length){var t=c.parent(),o=t.height(),n=(t.scrollTop(),e.position().top),a=e.height();o<n+a?t.animate({scrollTop:"-="+(o-(n+a)-10)},50):n<0&&t.animate({scrollTop:"+="+(n-10)},50)}}function l(){n=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(n);(o=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(e).searchBox({delay:200,change:function(){!function(e){var t;c.editableList("empty");var o=/(?:^| )type:([^ ]+)/.exec(e);if(o&&(e=e.replace(/(?:^| )type:[^ ]+/,""),t=o[1]),e=e.trim(),p=-1,h=[],0<e.length||t){var n,a;e=e.toLowerCase();var i=[],s={};for(n=0;n<f.length;n++){var r=f[n],l=f[n].indexOf(e);if(-1<l)for(a=0;a<u[r].length;a++){var d=u[r][a];t&&d.node.type!==t||(s[d.node.id]=s[d.node.id]=d,s[d.node.id].index=Math.min(s[d.node.id].index||1/0,l))}}for((i=Object.keys(s)).sort(function(e,t){return s[e].index-s[t].index}),n=0;n<i.length;n++)h.push(s[i[n]]);if(0<h.length)for(n=0;n<Math.min(h.length,25);n++)c.editableList("addItem",h[n]);else c.editableList("addItem",{})}}($(this).val())}})).on("keydown",function(e){var t;0<h.length&&(40===e.keyCode?(t=c.children(),p<t.length-1&&(-1<p&&$(t[p]).removeClass("selected"),p++),$(t[p]).addClass("selected"),r(),e.preventDefault()):38===e.keyCode?(t=c.children(),0<p&&(p<t.length&&$(t[p]).removeClass("selected"),p--),$(t[p]).addClass("selected"),r(),e.preventDefault()):13===e.keyCode&&0<h.length&&g(h[Math.max(0,p)].node))}),o.i18n();var t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(n);c=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(t).editableList({addButton:!1,addItem:function(e,t,o){var n=o.node;if(void 0===n)$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e);else{var a=n._def,i=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),s=$("<div>",{class:"red-ui-search-result-node"}).appendTo(i),r=RED.utils.getNodeColor(n.type,a),l=RED.utils.getNodeIcon(a,n);"tab"===n.type&&(r="#C0DEED"),s.css("backgroundColor",r);var d=$("<div/>",{class:"palette_icon_container"}).appendTo(s);RED.utils.createIconElement(l,d,!0);var c=$("<div>",{class:"red-ui-search-result-description"}).appendTo(i);if(n.z){var p=RED.nodes.workspace(n.z);p=p?"flow:"+p.label:"subflow:"+(p=RED.nodes.subflow(n.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).text(p).appendTo(c)}$("<div>",{class:"red-ui-search-result-node-label"}).text(o.label||n.id).appendTo(c),$("<div>",{class:"red-ui-search-result-node-type"}).text(n.type).appendTo(c),$("<div>",{class:"red-ui-search-result-node-id"}).text(n.id).appendTo(c),i.click(function(e){e.preventDefault(),g(n)})}},scrollOnAdd:!1})}function g(e){d(),RED.view.reveal(e.id)}function e(e){t||(a||(RED.keyboard.add("*","escape",function(){d()}),$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$("#sidebar-separator").hide(),u={},RED.nodes.eachWorkspace(s),RED.nodes.eachSubflow(s),RED.nodes.eachConfig(s),RED.nodes.eachNode(s),(f=Object.keys(u)).sort(),f.forEach(function(t){u[t]=Object.keys(u[t]).map(function(e){return u[t][e]})}),null===n&&l(),n.slideDown(300),o.searchBox("value",e),RED.events.emit("search:open"),a=!0),o.focus())}function d(){a&&(RED.keyboard.remove("escape"),a=!1,$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide(),$("#sidebar-separator").show(),null!==n&&n.slideUp(200,function(){o.searchBox("value","")}),RED.events.emit("search:close"))}return{init:function(){RED.actions.add("core:search",e),RED.events.on("editor:open",function(){t=!0}),RED.events.on("editor:close",function(){t=!1}),RED.events.on("type-search:open",function(){t=!0}),RED.events.on("type-search:close",function(){t=!1}),$("#header-shade").on("mousedown",d),$("#editor-shade").on("mousedown",d),$("#palette-shade").on("mousedown",d),$("#sidebar-shade").on("mousedown",d)},show:e,hide:d}}(),RED.typeSearch=function(){var l,d,t,a,o,n=null,c=-1,i=!1,s="",p={};function r(){var e=d.find("li.selected");if(1===e.length){var t=d.parent(),o=t.height(),n=(t.scrollTop(),e.position().top),a=e.height();o<n+a?t.animate({scrollTop:"-="+(o-(n+a)-10)},50):n<0&&t.animate({scrollTop:"+="+(n-10)},50)}}function u(){n=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(n);(l=$('<input type="text" id="red-ui-type-search-input">').attr("placeholder",RED._("search.addNode")).appendTo(e).searchBox({delay:50,change:function(){var e;e=$(this).val(),s=e.toLowerCase(),d.editableList("filter"),d.editableList("sort"),setTimeout(function(){c=0,d.children().removeClass("selected"),d.children(":visible:first").addClass("selected")},100)}})).on("keydown",function(e){var t=d.children(":visible");if(0<t.length)if(40===e.keyCode)c<t.length-1&&(-1<c&&$(t[c]).removeClass("selected"),c++),$(t[c]).addClass("selected"),r(),e.preventDefault();else if(38===e.keyCode)0<c&&(c<t.length&&$(t[c]).removeClass("selected"),c--),$(t[c]).addClass("selected"),r(),e.preventDefault();else if((e.metaKey||e.ctrlKey)&&13===e.keyCode){if((n=Math.max(0,c))<t.length){var o=$(t[n]).find(".red-ui-editableList-item-content").data("data");p[o.type]=Date.now(),0===o.def.outputs?f(o):a(o.type,!0),$("#red-ui-type-search-input").val("").keyup()}}else if(13===e.keyCode){var n;(n=Math.max(0,c))<t.length&&f($(t[n]).find(".red-ui-editableList-item-content").data("data"))}}),t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(n),d=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(t).editableList({addButton:!1,filter:function(e){return""===s||!e.recent&&!e.common&&(""===s||-1<e.index.indexOf(s))},sort:function(e,t){if(""===s)return e.i-t.i;var o=e.index.indexOf(s),n=t.index.indexOf(s);return-1===o?1:-1===n?-1:o===n?b(e,t):o-n},addItem:function(e,t,o){var n=o.def;o.index=o.type.toLowerCase(),o.separator&&e.addClass("red-ui-search-result-separator");var a=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),i=$("<div>",{class:"red-ui-search-result-node"}).appendTo(a),s=RED.utils.getNodeColor(o.type,n),r=RED.utils.getNodeIcon(n);i.css("backgroundColor",s);var l=$("<div/>",{class:"palette_icon_container"}).appendTo(i);RED.utils.createIconElement(r,l,!1),0<n.inputs&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(i),0<n.outputs&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(i);var d=$("<div>",{class:"red-ui-search-result-description"}).appendTo(a),c=o.label;o.index+="|"+c.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).text(c).appendTo(d),a.click(function(e){e.preventDefault(),f(o)})},scrollOnAdd:!1})}function f(e){g(),p[e.type]=Date.now(),a(e.type)}function h(e){if(i){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}g(!0),o&&o()}}function g(e){i&&(RED.keyboard.remove("escape"),i=!1,null!==n&&t.slideUp(e?50:200,function(){n.hide(),l.searchBox("value","")}),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.type-search"),$(document).off("mouseup.type-search"),$(document).off("click.type-search"))}function v(t,e){var o=t;if(void 0!==e.paletteLabel)try{o=("function"==typeof e.paletteLabel?e.paletteLabel.call(e):e.paletteLabel)||"",o+=" ("+t+")"}catch(e){console.log("Definition error: "+t+".paletteLabel",e)}return o}function b(e,t){var o=e.label.toLowerCase(),n=t.label.toLowerCase();return o<n?-1:o===n?0:1}function m(e,t,o){return!e||(!e.type||t===e.type)&&(!e.input||0<o.inputs)&&(!e.output||0<o.outputs)}function y(t){var e;d.editableList("empty"),l.searchBox("value",""),c=-1;var o=["inject","debug","function","change","switch"].filter(function(e){return m(t.filter,e,RED.nodes.getType(e))}),n=Object.keys(p);n.sort(function(e,t){return p[t]-p[e]}),n=n.filter(function(e){return m(t.filter,e,RED.nodes.getType(e))&&-1===o.indexOf(e)});var a=[];RED.nodes.registry.getNodeTypes().forEach(function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&a.push({type:e,def:t,label:v(e,t)})}),a.sort(b);var i,s=0;for(e=0;e<o.length;e++){var r=RED.nodes.getType(o[e]);r&&((i={type:o[e],common:!0,def:r,i:s++}).label=v(i.type,i.def),e===o.length-1&&(i.separator=!0),d.editableList("addItem",i))}for(e=0;e<Math.min(5,n.length);e++)(i={type:n[e],def:RED.nodes.getType(n[e]),recent:!0,i:s++}).label=v(i.type,i.def),e===n.length-1&&(i.separator=!0),d.editableList("addItem",i);for(e=0;e<a.length;e++)m(t.filter,a[e].type,a[e].def)&&(a[e].i=s++,d.editableList("addItem",a[e]));setTimeout(function(){c=0,d.children(":first").addClass("selected")},100)}return{show:function(e){i?(n.hide(),t.hide()):(RED.keyboard.add("*","escape",function(){g(),o&&o()}),null===n&&u(),i=!0),$(document).off("mousedown.type-search"),$(document).off("mouseup.type-search"),$(document).off("click.type-search"),setTimeout(function(){$(document).on("mousedown.type-search",h),$(document).on("mouseup.type-search",h),$(document).on("click.type-search",h)},200),y(e),a=e.add,o=e.cancel,RED.events.emit("type-search:open"),$("#main-container").height()-e.y-150<0&&(e.y=e.y-235),n.css({left:e.x+"px",top:e.y+"px"}).show(),t.slideDown(300),setTimeout(function(){t.find(".red-ui-editableList-container").scrollTop(0),l.focus()},100)},refresh:y,hide:g}}(),RED.subflow=function(){function l(e,t){var o={x:50,y:30};t||(o.x+=110);var n=[].concat(e.out).concat(e.in);e.status&&n.push(e.status),n.sort(function(e,t){return e.x-t.x});for(var a=0;a<n.length;a++){var i=n[a];i.x==o.x&&i.y==o.y&&(o.x+=55)}return o}function s(){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.in.length){var o=t.in[0],n=[];return RED.nodes.eachLink(function(e){"subflow"==e.source.type&&e.source.z==t.id&&e.source.i==o.i?n.push(e):e.target.type=="subflow:"+t.id&&n.push(e)}),n.forEach(function(e){RED.nodes.removeLink(e)}),t.in=[],$("#workspace-subflow-input-add").removeClass("active"),$("#workspace-subflow-input-remove").addClass("active"),t.changed=!0,RED.palette.refresh(),{subflowInputs:[o],links:n}}}function r(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var o=[];for(e.sort(function(e,t){return t.i-e.i}),i=0;i<e.length;i++){var n=e[i];t.out.splice(n.i,1);var a=[],s=[];RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==n.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==n.i?a.push(e):e.sourcePort>n.i&&s.push(e))}),a.forEach(function(e){RED.nodes.removeLink(e)}),s.forEach(function(e){e.sourcePort--}),o=o.concat(a);for(var r=n.i;r<t.out.length;r++)t.out[r].i--,t.out[r].dirty=!0}return t.changed=!0,RED.palette.refresh(),{subflowOutputs:e,links:o}}}function d(){var t=RED.nodes.subflow(RED.workspaces.active());if(t.status){var o=[];return RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&"status"==e.target.direction&&o.push(e)}),o.forEach(function(e){RED.nodes.removeLink(e)}),delete t.status,$("#workspace-subflow-status").prop("checked",!!t.status),$("#workspace-subflow-status").parent().parent().toggleClass("active",!!t.status),{links:o}}}function c(t){var o=RED.nodes.subflow(RED.workspaces.active());a(o);var n=[];if(o)return RED.nodes.filterNodes({type:"subflow:"+o.id}).forEach(function(e){for(n.push({id:e.id,changed:e.changed}),t&&(e.changed=!0),e.inputs=o.in.length,e.outputs=o.out.length;e.outputs<e.ports.length;)e.ports.pop();e.resize=!0,e.dirty=!0,RED.editor.updateNodeProperties(e)}),RED.editor.validateNode(o),{instances:n}}function a(e){e&&($("#workspace-subflow-input-add").toggleClass("active",0!==e.in.length),$("#workspace-subflow-input-remove").toggleClass("active",0===e.in.length),$("#workspace-subflow-output .spinner-value").text(e.out.length),$("#workspace-subflow-status").prop("checked",!!e.status),$("#workspace-subflow-status").parent().parent().toggleClass("active",!!e.status))}function o(i){var e=$("#workspace-toolbar");e.empty(),$('<a class="button" id="workspace-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="workspace-subflow-input-remove" class="button active" href="#">0</a><a id="workspace-subflow-input-add" class="button" href="#">1</a></div>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="workspace-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(e),$('<span class="button-group"><span class="button" style="padding:0"><label for="workspace-subflow-status"><input id="workspace-subflow-status" type="checkbox"> <span data-i18n="subflow.status"></span></label></span></span>').appendTo(e),$('<a class="button" id="workspace-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(e),e.i18n(),$("#workspace-subflow-output-remove").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),o=i.changed,n=r();if(n){var a=c(!0);RED.history.push({t:"delete",links:n.links,subflowOutputs:n.subflowOutputs,changed:o,dirty:t,subflow:{instances:a.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-output-add").click(function(e){e.preventDefault(),function(e){var t=RED.nodes.subflow(RED.workspaces.active()),o=l(t,!1),n={type:"subflow",direction:"out",z:t.id,i:t.out.length,x:o.x,y:o.y,id:RED.nodes.id()},a=t.out.length;t.out.push(n),t.dirty=!0;var i=RED.nodes.dirty(),s=t.changed;t.changed=!0;var r={t:"edit",node:t,dirty:i,changed:s,subflow:{outputCount:a,instances:c(!0).instances}};RED.history.push(r),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-output .spinner-value").text(t.out.length),RED.palette.refresh()}()}),$("#workspace-subflow-input-add").click(function(e){e.preventDefault(),function(){var e=RED.nodes.subflow(RED.workspaces.active());if(1!==e.in.length){var t=l(e,!0),o={type:"subflow",direction:"in",z:e.id,i:e.in.length,x:t.x,y:t.y,id:RED.nodes.id()},n=e.in.length;e.in.push(o),e.dirty=!0;var a=RED.nodes.dirty(),i=e.changed;e.changed=!0;var s={t:"edit",node:e,dirty:a,changed:i,subflow:{inputCount:n,instances:c(!0).instances}};RED.history.push(s),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-input-add").addClass("active"),$("#workspace-subflow-input-remove").removeClass("active"),RED.palette.refresh()}}()}),$("#workspace-subflow-input-remove").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),o=i.changed;i.changed=!0;var n=s();if(n){var a=c(!0);RED.history.push({t:"delete",links:n.links,changed:o,subflowInputs:n.subflowInputs,dirty:t,subflow:{instances:a.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-status").change(function(e){if(this.checked)!function(){var e=RED.nodes.subflow(RED.workspaces.active());if(!e.status){var t=l(e,!1),o={type:"subflow",direction:"status",z:e.id,x:t.x,y:t.y,id:RED.nodes.id()};e.status=o,e.dirty=!0;var n=RED.nodes.dirty(),a=e.changed,i=(c(e.changed=!0),{t:"edit",node:e,dirty:n,changed:a,subflow:{status:!0}});RED.history.push(i),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-status").prop("checked",!!e.status),$("#workspace-subflow-status").parent().parent().toggleClass("active",!!e.status)}}();else{var t=i.status,o=i.changed,n=d();if(n){i.changed=!0;var a=RED.nodes.dirty();RED.history.push({t:"delete",links:n.links,changed:o,dirty:a,subflow:{id:i.id,status:t}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw()}}}),$("#workspace-subflow-edit").click(function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()}),$("#workspace-subflow-delete").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),o=n(RED.workspaces.active());o.t="delete",o.dirty=t,RED.history.push(o)}),a(i),$("#chart").css({"margin-top":"40px"}),$("#workspace-toolbar").show()}function n(e){var t=[],o=[],n=RED.nodes.subflow(e);RED.nodes.eachNode(function(e){e.type=="subflow:"+n.id&&t.push(e),e.z==n.id&&t.push(e)}),RED.nodes.eachConfig(function(e){e.z==n.id&&t.push(e)});for(var a=[],i=0;i<t.length;i++){var s=RED.nodes.remove(t[i].id);o=o.concat(s.links),a=a.concat(s.nodes)}return t=t.concat(a),RED.nodes.removeSubflow(n),RED.workspaces.remove(n),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:t,links:o,subflows:[n]}}function e(){var o=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(o=Math.max(o,t[1]))});var e="Subflow "+(o+1),t=RED.nodes.id(),n={type:"subflow",id:t,name:e,info:"",in:[],out:[]};RED.nodes.addSubflow(n),RED.history.push({t:"createSubflow",subflow:{subflow:n},dirty:RED.nodes.dirty()}),RED.workspaces.show(t),RED.nodes.dirty(!0)}function y(e){return RED.settings.get("editor").view["view-snap-grid"]&&(e=Math.round(e/RED.view.gridSize())*RED.view.gridSize()),e}function t(){var e=RED.view.selection();if(e.nodes){var t,a,i={},n=[],o=[],s=[],r=[],l={},d=[e.nodes[0].x,e.nodes[0].y,e.nodes[0].x,e.nodes[0].y];for(t=0;t<e.nodes.length;t++)a=e.nodes[t],i[a.id]={n:a,outputs:{}},d=[Math.min(d[0],a.x),Math.min(d[1],a.y),Math.max(d[2],a.x),Math.max(d[3],a.y)];var c=y(d[0]-200),p=y(d[1]-80),u=[y((d[2]+d[0])/2),y((d[3]+d[1])/2)];RED.nodes.eachLink(function(e){i[e.source.id]&&i[e.target.id],i[e.source.id]&&!i[e.target.id]&&(r.push(e),o.push(e)),!i[e.source.id]&&i[e.target.id]&&(s.push(e),l[e.target.id]=e.target,o.push(e))});var f={};if((r=r.filter(function(e){return f[e.source.id+":"+e.sourcePort]?(f[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),f[e.source.id+":"+e.sourcePort]=e,!0)})).sort(function(e,t){return e.source.y-t.source.y}),1<Object.keys(l).length)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var h=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(h=Math.max(h,t[1]))});var g="Subflow "+(h+1),v=RED.nodes.id(),b={type:"subflow",id:v,name:g,info:"",in:Object.keys(l).map(function(e,t){var o=t;return{type:"subflow",direction:"in",x:y(l[e].x-l[e].w/2-80-c),y:y(l[e].y-p),z:v,i:o,id:RED.nodes.id(),wires:[{id:l[e].id}]}}),out:r.map(function(e,t){var o=t;return{type:"subflow",direction:"out",x:y(e.source.x+e.source.w/2+80-c),y:y(e.source.y-p),z:v,i:o,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}})};RED.nodes.addSubflow(b);var m={id:RED.nodes.id(),type:"subflow:"+b.id,x:u[0],y:u[1],z:RED.workspaces.active(),inputs:b.in.length,outputs:b.out.length,h:Math.max(30,15*(b.out.length||0)),changed:!0};for(m._def=RED.nodes.getType(m.type),RED.editor.validateNode(m),RED.nodes.add(m),s.forEach(function(e){var t={source:e.source,sourcePort:e.sourcePort,target:m};n.push(t),RED.nodes.addLink(t)}),r.forEach(function(e,o){e.targets.forEach(function(e){var t={source:m,sourcePort:o,target:e};n.push(t),RED.nodes.addLink(t)})}),b.in.forEach(function(o){o.wires.forEach(function(e){var t={source:o,sourcePort:0,target:RED.nodes.node(e.id)};n.push(t),RED.nodes.addLink(t)})}),b.out.forEach(function(o,e){o.wires.forEach(function(e){var t={source:RED.nodes.node(e.id),sourcePort:e.port,target:o};n.push(t),RED.nodes.addLink(t)})}),t=0;t<o.length;t++)RED.nodes.removeLink(o[t]);for(t=0;t<e.nodes.length;t++)a=e.nodes[t],/^link /.test(a.type)&&(a.links=a.links.filter(function(e){var t=i.hasOwnProperty(e);if(!t){var o=RED.nodes.node(e);if(o&&o.links){var n=o.links.indexOf(a.id);-1<n&&o.links.splice(n,1)}}return t})),a.x-=c,a.y-=p,a.z=b.id;RED.history.push({t:"createSubflow",nodes:[m.id],links:n,subflow:{subflow:b,offsetX:c,offsetY:p},activeWorkspace:RED.workspaces.active(),removedLinks:o,dirty:RED.nodes.dirty()}),RED.view.select(null),RED.editor.validateNode(b),RED.nodes.dirty(!0),RED.view.redraw(!0)}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")}return{init:function(){RED.events.on("workspace:change",function(e){var t=RED.nodes.subflow(e.workspace);t?o(t):($("#workspace-toolbar").hide().empty(),$("#chart").css({"margin-top":"0"}))}),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)}),RED.actions.add("core:create-subflow",e),RED.actions.add("core:convert-to-subflow",t),$('<script type="text/x-red" data-template-name="subflow"><div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name"></div><div class="form-row" style="margin-bottom: 0px;"><label style="width: auto;" data-i18n="[append]editor:editor-tab.env"><i class="fa fa-th-list"></i> </label></div><div class="form-row node-input-env-container-row"><ol id="node-input-env-container"></ol></div><\/script>').appendTo(document.body),$('<script type="text/x-red" data-template-name="subflow-template"><div class="form-row"><i class="fa fa-tag"></i> <label for="subflow-input-name" data-i18n="common.label.name"></label><input type="text" id="subflow-input-name"></div><div class="form-row"><i class="fa fa-folder-o"></i> <label for="subflow-input-category" data-i18n="editor:subflow.category"></label><select style="width: 250px;" id="subflow-input-category"></select><input style="display:none; margin-left: 10px; width:calc(100% - 250px)" type="text" id="subflow-input-custom-category"></div><div class="form-row" style="margin-bottom: 0px;"><label style="width: auto;" data-i18n="[append]editor:editor-tab.env"><i class="fa fa-th-list"></i> </label></div><div class="form-row node-input-env-container-row"><ol id="node-input-env-container"></ol></div><div class="form-row form-tips" id="subflow-dialog-user-count"></div><\/script>').appendTo(document.body)},createSubflow:e,convertToSubflow:t,removeSubflow:n,refresh:c,removeInput:s,removeOutput:r,removeStatus:d}}(),RED.userSettings=function(){var t=700,o=!1,r=[];function e(e){r.push(e)}function n(s){if(!o)if(RED.user.hasPermission("settings.write")){o=!0;var e={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){t=e.width},open:function(e){var t=e.find(".editor-tray-body"),o=$("<div></div>").appendTo(t),n=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(o);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(n);var a=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),i=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(o);r.forEach(function(e){a.addTab({id:"user-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(i)}),o.i18n(),a.activateTab("user-settings-tab-"+(s||"view")),$("#sidebar-shade").show()},close:function(){o=!1,r.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==t&&(e.width=t),RED.tray.show(e)}else RED.notify(RED._("user.errors.settings"),"error")}var s=[{title:"menu.label.view.grid",options:[{setting:"view-show-grid",oldSetting:"menu-menu-item-view-show-grid",label:"menu.label.view.showGrid",toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",oldSetting:"menu-menu-item-view-snap-grid",label:"menu.label.view.snapGrid",toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:20,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"},{setting:"view-node-show-label",label:"menu.label.showNodeLabelDefault",default:!0,toggle:!0}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"}]}],l={};function d(){var n=$('<div id="user-settings-tab-view" class="node-help"></div>'),a=RED.settings.get("editor")||{};return a.view=a.view||{},s.forEach(function(e){$("<h3></h3>").text(RED._(e.title)).appendTo(n),e.options.forEach(function(e){var t=a.view[e.setting],o=$('<div class="user-settings-row"></div>').appendTo(n);e.toggle?$('<label for="user-settings-'+e.setting+'"><input id="user-settings-'+e.setting+'" type="checkbox"> '+RED._(e.label)+"</label>").appendTo(o).find("input").prop("checked",t):($('<label for="user-settings-'+e.setting+'">'+RED._(e.label)+"</label>").appendTo(o),$('<input id="user-settings-'+e.setting+'" type="'+(e.type||"text")+'">').appendTo(o).val(t))})}),n}function c(e,t){var o=l[e],n=RED.settings.get("editor")||{};n.view=n.view||{},n.view[o.setting]=t,RED.settings.set("editor",n);var a=o.onchange;"string"==typeof a&&(a=RED.actions.get(a)),a&&a.call(o,t)}return{init:function(){RED.actions.add("core:show-user-settings",n),RED.actions.add("core:show-help",function(){n("keyboard")}),e({id:"view",title:RED._("menu.label.view.view"),get:d,close:function(){s.forEach(function(e){e.options.forEach(function(e){var t=$("#user-settings-"+e.setting);e.toggle?c(e.setting,t.prop("checked")):c(e.setting,t.val())})})}});var a=RED.settings.get("editor")||{};a.view=a.view||{};var i=!1;s.forEach(function(e){e.options.forEach(function(e){if(e.oldSetting){var t=RED.settings.get(e.oldSetting);null!=t&&(a.view[e.setting]=t,i=!0,RED.settings.remove(e.oldSetting))}l[e.setting]=e;var o=a.view[e.setting];if(null==o&&e.hasOwnProperty("default")&&(o=e.default,a.view[e.setting]=o,i=!0),e.onchange){var n=e.onchange;"string"==typeof n&&(n=RED.actions.get(n)),n&&n.call(e,o)}})}),i&&RED.settings.set("editor",a)},toggle:function(e){var t=l[e],o=RED.settings.get("editor")||{};o.view=o.view||{},c(e,!o.view[t.setting])},show:n,add:e}}(),RED.projects=function(){var B,i,q;function u(e){var t;t="git_missing_user"===e.code?RED.notify("<p>"+RED._("projects.errors.no-username-email")+"</p>",{fixed:!0,type:"error",buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:RED._("projects.config-git"),click:function(){RED.userSettings.show("gitconfig"),t.close()}}]}):(console.log(e),RED.notify("<p>"+RED._("projects.errors.unexpected")+":</p><p>"+e.message+"</p><small>"+RED._("projects.errors.code")+": "+e.code+"</small>",{fixed:!0,modal:!0,type:"error",buttons:[{text:RED._("common.label.close"),click:function(){t.close()}}]}))}var s={};function t(){var m=$('<div class="projects-dialog-screen-start-hero"></div>');$('<span><i class="fa fa-files-o fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-long-arrow-right fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-archive fa-2x"></i></span>').appendTo(m),$("<hr>").appendTo(m);var k,T,_,j,C,S,O,L,P,I,N,z,c,l,d,y,w,D,E,R,x,A,M,f,h,r,p,g={};s={welcome:{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');m.appendTo(t);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text(RED._("projects.welcome.hello")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc0")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc1")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc2")).appendTo(o);var n=$('<div style="text-align: center"></div>').appendTo(o),a=$('<button data-type="empty" class="editor-button projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.welcome.create")+"</button>").appendTo(n),i=$('<button data-type="clone" class="editor-button projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.welcome.clone")+"</button>").appendTo(n);return a.click(function(e){e.preventDefault(),g={action:"create"},v("git-config")}),i.click(function(e){e.preventDefault(),g={action:"clone"},v("git-config")}),t},buttons:[{text:RED._("projects.welcome.openExistingProject"),class:"secondary",click:function(){g={action:"open"},v("git-config")}},{text:RED._("projects.welcome.not-right-now"),click:function(){g={},$(this).dialog("close")}}]},"git-config":{content:function(e){var t=!1,o=RED.settings.get("git");o&&o.user?o=o.user:RED.settings.git&&RED.settings.git.globalUser&&(t=!0,o=RED.settings.git.globalUser);var n=function(){var e=r.val().trim(),t=p.val().trim(),o=0<e.length&&0<t.length;$("#projects-dialog-git-config").prop("disabled",!o).toggleClass("disabled ui-button-disabled ui-state-disabled",!o)},a=$('<div class="projects-dialog-screen-start"></div>');m.appendTo(a);var i=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(a);$("<p>").text(RED._("projects.git-config.setup")).appendTo(i),$("<p>").text(RED._("projects.git-config.desc0")).appendTo(i),$("<p>").text(RED._("projects.git-config.desc1")).appendTo(i),t&&$("<p>").text(RED._("projects.git-config.desc2")).appendTo(i),$("<p>").text(RED._("projects.git-config.desc3")).appendTo(i);var s=$('<div class="form-row"></div>').appendTo(i);return $('<label for="">'+RED._("projects.git-config.username")+"</label>").appendTo(s),(r=$('<input type="text">').val(o&&o.name||"").appendTo(s)).on("change keyup paste",n),s=$('<div class="form-row"></div>').appendTo(i),$('<label for="">'+RED._("projects.git-config.email")+"</label>").appendTo(s),(p=$('<input type="text">').val(o&&o.email||"").appendTo(s)).on("change keyup paste",n),setTimeout(function(){r.focus(),n()},50),a},buttons:[{text:RED._("common.label.back"),click:function(){v("welcome")}},{id:"projects-dialog-git-config",text:RED._("common.label.next"),class:"primary",click:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=r.val(),e.user.email=p.val(),RED.settings.set("git",e),"create"===g.action?v("project-details"):"clone"===g.action?v("clone-project"):"open"===g.action&&v("create",{screen:"open"})}}]},"project-details":{content:function(e){var o=null,n=!1;$.getJSON("projects",function(e){o={},e.projects.forEach(function(e){o[e]=!0,n&&(n=!1,i())})});var t=$('<div class="projects-dialog-screen-start"></div>');m.appendTo(t);var a=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text(RED._("projects.project-details.create")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc0")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc1")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc2")).appendTo(a);var i=function(){var e=f.val(),t=!0;if(p){if(null===o)return void(n=!0);c.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||o[e]?(f.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(c),t=l=!1,o[e]?projectNameSublabel.text(RED._("projects.project-details.already-exists")):projectNameSublabel.text(RED._("projects.project-details.must-contain"))):(f.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(c),projectNameSublabel.text(RED._("projects.project-details.must-contain")),l=!0),u=e}t=l,$("#projects-dialog-create-name").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)},s=$('<div class="form-row"></div>').appendTo(a);$('<label for="projects-dialog-screen-create-project-name">'+RED._("projects.project-details.project-name")+"</label>").appendTo(s);var r=$('<div style="position:relative;"></div>').appendTo(s);f=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').val(g.name||"").appendTo(r);var l,d,c=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(r),p=!1,u="";return f.on("change keyup paste",function(){if(p=f.val()!==u,d)clearTimeout(d);else if(p&&(c.empty(),$('<img src="red/images/spin.svg"/>').appendTo(c),""===f.val()))return void i();d=setTimeout(function(){i(),d=null},300)}),projectNameSublabel=$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.project-details.must-contain")+"</small></label>").appendTo(s).find("small"),s=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(a),$('<label for="projects-dialog-screen-create-project-desc">'+RED._("projects.project-details.desc")+"</label>").appendTo(s),h=$('<input id="projects-dialog-screen-create-project-desc" type="text">').val(g.summary||"").appendTo(s),$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.project-details.opt")+"</small></label>").appendTo(s),setTimeout(function(){f.focus(),f.change()},50),t},buttons:function(e){return[{text:RED._("common.label.back"),click:function(){v("git-config")}},{id:"projects-dialog-create-name",disabled:!0,text:RED._("common.label.next"),class:"primary disabled",click:function(){g.name=f.val(),g.summary=h.val(),v("default-files",e)}}]}},"clone-project":{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');m.appendTo(t);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text(RED._("projects.clone-project.clone")).appendTo(o),$("<p>").text(RED._("projects.clone-project.desc0")).appendTo(o);var a=null,i=!1;$.getJSON("projects",function(e){a={},e.projects.forEach(function(e){a[e]=!0,i&&(i=!1,s())})});var n,s=function(){var e=y.val(),t=!0;if(p){if(null===a)return void(i=!0);c.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||a[e]?(y.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(c),t=l=!1,a[e]?x.text(RED._("projects.clone-project.already-exists")):x.text(RED._("projects.clone-project.must-contain"))):(y.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(c),x.text(RED._("projects.clone-project.must-contain")),l=!0),u=e}t=l;var o=D.val(),n=0<o.length&&!/\s/.test(o);/^https?:\/\/[^/]+@/i.test(o)&&($("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.no-info-in-url")),n=!1),n?D.removeClass("input-error"):(h&&D.addClass("input-error"),t=!1),/^https?:\/\//.test(o)?($(".projects-dialog-screen-create-row-creds").show(),$(".projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(o)?($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").show()):($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").hide()),$("#projects-dialog-clone-project").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};n=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty projects-dialog-screen-create-row-clone"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-name">'+RED._("projects.clone-project.project-name")+"</label>").appendTo(n);var r=$('<div style="position:relative;"></div>').appendTo(n);y=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').appendTo(r);var l,d,c=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(r),p=!1,u="",f="";y.on("change keyup paste",function(){if(p=y.val()!==u,d)clearTimeout(d);else if(p&&(c.empty(),$('<img src="red/images/spin.svg"/>').appendTo(c),""===y.val()))return void s();d=setTimeout(function(){s(),d=null},300)}),x=$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.must-contain")+"</small></label>").appendTo(n).find("small"),n=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-repo">'+RED._("projects.clone-project.git-url")+"</label>").appendTo(n),D=$('<input id="projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(n),$('<label id="projects-dialog-screen-create-project-repo-label" class="projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.protocols")+"</small></label>").appendTo(n);var h=!1,g="";D.on("change keyup paste",function(){h=!0;var e=$(this).val();g!==e&&$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols"));var t=/\/([^/]+?)(?:\.git)?$/.exec(g=e);if(t){var o=y.val();""!==o&&o!==f||(f=t[1],y.val(f),y.change())}s()});var v=$('<div class="projects-dialog-screen-create-row"></div>').appendTo(o);n=$('<div class="form-row projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(v),$('<div><i class="fa fa-warning"></i> '+RED._("projects.clone-project.auth-failed")+"</div>").appendTo(n),n=$('<div class="hide form-row projects-dialog-screen-create-row-creds"></div>').hide().appendTo(v),r=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-repo-user">'+RED._("projects.clone-project.username")+"</label>").appendTo(r),E=$('<input id="projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(r),r=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-repo-pass">'+RED._("projects.clone-project.passwd")+"</label>").appendTo(r),R=$('<input id="projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(r),n=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(v),r=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.ssh-key")+"</label>").appendTo(r),A=$("<select>",{style:"width: 100%"}).appendTo(r),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){A.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(A.addClass("input-error"),A.attr("disabled",!0),b.show()):(A.removeClass("input-error"),A.attr("disabled",!1),b.hide())}),r=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(n),$('<label for="projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.passphrase")+"</label>").appendTo(r),M=$('<input id="projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(r),r=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').appendTo(v);var b=$('<div class="projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(r);return $('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.clone-project.ssh-key-desc")+"</div>").appendTo(b),r=$('<div style="text-align: center">').appendTo(b),$('<button class="editor-button">'+RED._("projects.clone-project.ssh-key-add")+"</button>").appendTo(r).click(function(e){e.preventDefault(),B.dialog("close"),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").click()},500)}),n=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(o),$("<label>"+RED._("projects.clone-project.credential-key")+"</label>").appendTo(n),w=$('<input type="password"></input>').appendTo(n),t},buttons:function(e){return[{text:RED._("common.label.back"),click:function(){v("git-config")}},{id:"projects-dialog-clone-project",disabled:!0,text:RED._("common.label.clone"),class:"primary disabled",click:function(){$(".projects-dialog-screen-create-type.selected").data("type");var e={name:y.val()};e.credentialSecret=w.val();var t=D.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(t)){var o=A.val();if(!o)return void console.log(RED._("projects.clone-project.cant-get-ssh-key"));e.git={remotes:{origin:{url:t,keyFile:o,passphrase:M.val()}}}}else e.git={remotes:{origin:{url:t,username:E.val(),password:R.val()}}};$(".projects-dialog-screen-create-row-auth-error").hide(),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),E.removeClass("input-error"),R.removeClass("input-error"),A.removeClass("input-error"),M.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(e.name),U({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){B.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.clone-project.already-exists2"))},git_error:function(e){console.log(RED._("projects.clone-project.git-error"),e)},git_connection_failed:function(e){D.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.connection-failed"))},git_not_a_repository:function(e){D.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.not-git-repo"))},git_repository_not_found:function(e){D.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.repo-not-found"))},git_auth_failed:function(e){$(".projects-dialog-screen-create-row-auth-error").show(),E.addClass("input-error"),R.addClass("input-error"),A.addClass("input-error"),M.addClass("input-error")},missing_flow_file:function(e){B.dialog("close")},missing_package_file:function(e){B.dialog("close")},project_empty:function(e){B.dialog("close")},credentials_load_failed:function(e){B.dialog("close")},"*":function(e){u(e),$(B).dialog("close")}}}},e).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"default-files":{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');m.appendTo(t);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text(RED._("projects.default-files.create")).appendTo(o),$("<p>").text(RED._("projects.default-files.desc0")).appendTo(o),$("<p>").text(RED._("projects.default-files.desc1")).appendTo(o),!e.existingProject&&RED.settings.files&&$("<p>").text(RED._("projects.default-files.desc2")).appendTo(o);var n=function(){var e=!0,t=l.val();""!==t&&/\.json$/.test(t)?(l.hasClass("input-error")&&(l.removeClass("input-error"),l.next().empty()),d.hasClass("input-error")&&(d.removeClass("input-error"),d.next().empty()),d.text(t.substring(0,t.length-5)+"_cred.json")):(e=!1,l.hasClass("input-error")||(l.addClass("input-error"),l.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>')),d.text(""),d.hasClass("input-error")||(d.addClass("input-error"),d.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),$("#projects-dialog-create-default-files").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},a=$('<div class="form-row"></div>').appendTo(o);$('<label for="projects-dialog-screen-create-project-file">'+RED._("projects.default-files.flow-file")+"</label>").appendTo(a);var i=$('<div style="position:relative;"></div>').appendTo(a),s=g.files&&g.files.flow||RED.settings.files&&RED.settings.files.flow||"flow.json";l=$('<input id="projects-dialog-screen-create-project-file" type="text">').val(s).on("change keyup paste",n).appendTo(i),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(i),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(a);var r=g.files&&g.files.credentials||RED.settings.files&&RED.settings.files.credentials||"flow_cred.json";return a=$('<div class="form-row"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-credfile">'+RED._("projects.default-files.credentials-file")+"</label>").appendTo(a),i=$('<div style="position:relative;"></div>').appendTo(a),d=$('<div style="width: 100%" class="uneditable-input" id="projects-dialog-screen-create-project-credentials">').text(r).appendTo(i),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(i),setTimeout(function(){l.focus(),n()},50),t},buttons:function(e){return[{text:RED._(e.existingProject?"common.label.cancel":"common.label.back"),click:function(){e.existingProject?$(this).dialog("close"):v("project-details",e)}},{id:"projects-dialog-create-default-files",text:RED._("common.label.next"),class:"primary",click:function(){g.files={flow:l.val(),credentials:d.text()},e.existingProject||(g.migrateFiles=!0),v("encryption-config",e)}}]}},"encryption-config":{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');m.appendTo(t);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);$("<p>").text(RED._("projects.encryption-config.setup")).appendTo(o),e.existingProject?($("<p>").text(RED._("projects.encryption-config.desc0")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc1")).appendTo(o)):"disabled"===RED.settings.flowEncryptionType?($("<p>").text(RED._("projects.encryption-config.desc2")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc3")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc4")).appendTo(o)):("user"===RED.settings.flowEncryptionType?$("<p>").text(RED._("projects.encryption-config.desc5")).appendTo(o):"system"===RED.settings.flowEncryptionType&&$("<p>").text(RED._("projects.encryption-config.desc6")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc7")).appendTo(o));var n=function(){var e=!0;"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(e=e&&""!==c.val()),$("#projects-dialog-create-encryption").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},a=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(o);$("<label>"+RED._("projects.encryption-config.credentials")+"</label>").appendTo(a);var i=$('<div style="width: 550px">').appendTo(a),s=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(i),r=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(i),l=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(r);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(l);var d=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(r);return $('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(d),r.find("input[name=projects-encryption-type]").click(function(e){var t,o;"enabled"===$(this).val()?(t=l,o=d,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&c.focus()):(o=l,t=d,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),o.css({borderColor:"white",borderRightColor:"#ccc"}),n()}),a=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(s),$('<label class="projects-edit-form-inline-label '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+'" style="margin-left: 5px"><input '+("user"!==RED.settings.flowEncryptionType?RED._("projects.encryption-config.disabled"):"")+' type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="default" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.copy")+"</span></label>").appendTo(a),a=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(s),$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="custom" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.use-custom")+"</span></label>").appendTo(a),a=$('<div class="projects-encryption-enabled-row"></div>').appendTo(s),(c=$('<input disabled type="password" style="margin-left: 25px; width: calc(100% - 30px);"></input>').appendTo(a)).on("change keyup paste",n),a=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(s),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.encryption-config.desc8")+"</div>").appendTo(a),s.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();c.attr("disabled","default"===e),"custom"===e&&c.focus(),n()}),setTimeout(function(){r.find("input[name=projects-encryption-type][value=enabled]").click(),"user"!==RED.settings.flowEncryptionType?s.find("input[name=projects-encryption-key][value=custom]").click():s.find("input[name=projects-encryption-key][value=default]").click(),n()},100),t},buttons:function(n){return[{text:RED._("common.label.back"),click:function(){v("default-files",n)}},{id:"projects-dialog-create-encryption",text:RED._(n.existingProject?"projects.encryption-config.create-project-files":"projects.encryption-config.create-project"),class:"primary disabled",disabled:!0,click:function(){"enabled"===$("input[name=projects-encryption-type]:checked").val()?"custom"===$("input[name=projects-encryption-key]:checked").val()&&(g.credentialSecret=c.val()):g.credentialSecret=!1,RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(g.name);var e="POST",t="projects";n.existingProject&&(g.initialise=!0,e="PUT",t="projects/"+q.name);var o=this;U({url:t,type:e,requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){g={},n.existingProject?$(o).dialog("close"):(v("create-success"),RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1))},400:{project_exists:function(e){console.log(RED._("projects.encryption-config.already-exists"))},git_error:function(e){console.log(RED._("projects.encryption-config.git-error"),e)},git_connection_failed:function(e){projectRepoInput.addClass("input-error")},git_auth_failed:function(e){projectRepoUserInput.addClass("input-error"),projectRepoPasswordInput.addClass("input-error"),console.log(RED._("projects.encryption-config.git-auth-error"),e)},"*":function(e){u(e),$(B).dialog("close")}}}},g).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"create-success":{content:function(e){var t=$('<div class="projects-dialog-screen-start"></div>');m.appendTo(t);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(t);return $("<p>").text(RED._("projects.create-success.success")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc0")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc1")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc2")).appendTo(o),t},buttons:[{text:RED._("common.label.done"),click:function(){$(this).dialog("close")}}]},create:{title:RED._("projects.create.projects"),content:function(e){var s=null;z=null;var r=!1;$.getJSON("projects",function(e){s={},e.projects.forEach(function(e){s[e]=!0,r&&(r=!1,n())})});var t,o=$('<div class="projects-dialog-screen-create"></div>'),n=function(){var e=k.val(),t=!0;if(f){if(null===s)return void(r=!0);u.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||s[e]?(k.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(u),t=c=!1,s[e]?P.text(RED._("projects.create.already-exists")):P.text(RED._("projects.create.must-contain"))):(k.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(u),P.text(RED._("projects.create.must-contain")),c=!0),h=e}t=c;var o=$(".projects-dialog-screen-create-type.selected").data("type");if("copy"===o)t=!1;else if("clone"===o){var n=C.val(),a=0<n.length&&!/\s/.test(n);/^https?:\/\/[^/]+@/i.test(n)&&($("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-info-in-url")),a=!1),a?C.removeClass("input-error"):(D&&C.addClass("input-error"),t=!1),/^https?:\/\//.test(n)?($(".projects-dialog-screen-create-row-creds").show(),$(".projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(n)?($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").show()):($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").hide())}else if("empty"===o){var i=_.val();""!==i&&/\.json$/.test(i)?_.hasClass("input-error")&&(_.removeClass("input-error"),_.next().empty()):(t=!1,_.hasClass("input-error")||(_.addClass("input-error"),_.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(t=t&&""!==S.val())}else"open"===o&&(t=!!z);$("#projects-dialog-create").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)};t=$('<div class="form-row button-group"></div>').appendTo(o);var a=$('<button data-type="open" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-folder-open"></i><br/>'+RED._("projects.create.open")+"</button>").appendTo(t),i=$('<button data-type="empty" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.create.create")+"</button>").appendTo(t),l=$('<button data-type="clone" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.create.clone")+"</button>").appendTo(t);t.find(".projects-dialog-screen-create-type").click(function(e){switch(e.preventDefault(),o.find(".projects-dialog-screen-create-type").removeClass("selected"),$(this).addClass("selected"),o.find(".projects-dialog-screen-create-row").hide(),o.find(".projects-dialog-screen-create-row-"+$(this).data("type")).show(),n(),k.focus(),$(this).data("type")){case"open":$("#projects-dialog-create").text(RED._("projects.create.open"));break;case"empty":$("#projects-dialog-create").text(RED._("projects.create.create"));break;case"clone":$("#projects-dialog-create").text(RED._("projects.create.clone"))}}),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-open"></div>').hide().appendTo(o),function(r){(r=r||{}).height;var n,e=$("<div></div>",{class:"projects-dialog-project-list-container"}),t="",o=$("<div>",{class:"red-ui-search-container"}).appendTo(e),a=$('<input id="projects-dialog-project-list-search" type="text" placeholder="'+RED._("projects.create-project-list.search")+'">').appendTo(o).searchBox({delay:200,change:function(){t=$(this).val().toLowerCase(),d.editableList("filter"),n&&!n.is(":visible")&&n.children().children().removeClass("selected"),(n=d.children(":visible").first()).children().children().addClass("selected"),r.select&&r.select(n.children().data("data")),l()}});a.on("keydown",function(e){if(40===e.keyCode){e.preventDefault();var t=n;if(n){for(;0!==(t=t.next()).length&&!t.is(":visible"););if(0===t.length)return;n.children().children().removeClass("selected")}else t=d.children(":visible").first();(n=t).children().children().addClass("selected"),r.select&&r.select(n.children().data("data")),l()}else if(38===e.keyCode){e.preventDefault();var o=n;if(n){for(;0!==(o=o.prev()).length&&!o.is(":visible"););if(0===o.length)return;n.children().children().removeClass("selected")}else o=d.children(":visible").first();(n=o).children().children().addClass("selected"),r.select&&r.select(n.children().data("data")),l()}else 13===e.keyCode&&(e.preventDefault(),n&&r.dblclick&&r.dblclick(n.children().data("data")))}),a.i18n();var l=function(){var e=d.find(".projects-dialog-project-list-entry.selected").parent().parent();if(1===e.length){var t=i,o=t.height(),n=(t.scrollTop(),e.position().top),a=e.height();o<n+a?t.animate({scrollTop:"-="+(o-n-a)},50):n<0&&t.animate({scrollTop:"+="+n},50)}},i=$("<div></div>",{class:"projects-dialog-project-list-inner-container"}).appendTo(e),d=$("<ol>",{class:"projects-dialog-project-list"}).appendTo(i).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(i,e,s){var t=$("<div></div>",{class:"projects-dialog-project-list-entry"}).appendTo(i);if($('<span class="projects-dialog-project-list-entry-icon"><i class="fa fa-archive"></i></span>').appendTo(t),$('<span class="projects-dialog-project-list-entry-name" style=""></span>').text(s.name).appendTo(t),!q||q.name!==s.name||(t.addClass("projects-list-entry-current"),$('<span class="projects-dialog-project-list-entry-current">'+RED._("projects.create-project-list.current")+"</span>").appendTo(t),!1!==r.canSelectActive)){t.addClass("selectable");var o=$('<div class="projects-dialog-project-list-entry-tools"></div>').appendTo(t);$('<button class="editor-button editor-button-small" style="float: right;"><i class="fa fa-trash"></i></button>').appendTo(o).click(function(e){var t,o,n,a;e.stopPropagation(),e.preventDefault(),t=i,o=s.name,n=function(e){e||i.fadeOut(300,function(){d.editableList("removeItem",s),r.delete&&r.delete(s)})},a=$("<div>").css({background:"white",position:"absolute",top:0,right:0,bottom:0,left:"100%",overflow:"hidden",padding:"5px 20px",transition:"left 0.4s",whitespace:"nowrap",width:"1000px"}).click(function(e){e.stopPropagation()}).appendTo(t),$("<span>").css({lineHeight:"40px"}).text(RED._("projects.delete.confirm")).appendTo(a),$('<button style="margin-left:20px" class="editor-button">'+RED._("common.label.cancel")+"</button>").appendTo(a).click(function(e){e.stopPropagation(),a.remove(),n(!0)}),$('<button style="margin-left:20px" class="editor-button primary">'+RED._("common.label.delete")+"</button>").appendTo(a).click(function(e){e.stopPropagation(),a.remove(),U({url:"projects/"+o,type:"DELETE",responses:{200:function(e){n(!1)},400:{unexpected_error:function(e){a.remove(),n(!0)}}}})}),setTimeout(function(){a.css("left",0)},50)}),i.click(function(e){$(".projects-dialog-project-list-entry").removeClass("selected"),t.addClass("selected"),n=i.parent(),r.select&&r.select(s),l(),a.focus()}),r.dblclick&&i.dblclick(function(e){e.preventDefault(),r.dblclick(s)})}},filter:function(e){return""===t||-1!==e.name.toLowerCase().indexOf(t)}});return $.getJSON("projects",function(e){e.projects.forEach(function(e){d.editableList("addItem",{name:e})})}),e}({canSelectActive:!1,dblclick:function(e){z=e,$("#projects-dialog-create").click()},select:function(e){z=e,n()},delete:function(e){s&&delete s[e.name],z=null,n()}}).appendTo(t),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty projects-dialog-screen-create-row-clone"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-name">'+RED._("projects.create.project-name")+"</label>").appendTo(t);var d=$('<div style="position:relative;"></div>').appendTo(t);k=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').appendTo(d);var c,p,u=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(d),f=!1,h="",g="";k.on("change keyup paste",function(){if(f=k.val()!==h,p)clearTimeout(p);else if(f&&(u.empty(),$('<img src="red/images/spin.svg"/>').appendTo(u),""===k.val()))return void n();p=setTimeout(function(){n(),p=null},300)}),P=$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.create.must-contain")+"</small></label>").appendTo(t).find("small"),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-desc">'+RED._("projects.create.desc")+"</label>").appendTo(t),T=$('<input id="projects-dialog-screen-create-project-desc" type="text">').appendTo(t),$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.create.opt")+"</small></label>").appendTo(t),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-file">'+RED._("projects.create.flow-file")+"</label>").appendTo(t),d=$('<div style="position:relative;"></div>').appendTo(t),_=$('<input id="projects-dialog-screen-create-project-file" type="text">').val("flow.json").on("change keyup paste",n).appendTo(d),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(d),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(t),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(o),$("<label>"+RED._("projects.create.credentials")+"</label>").appendTo(t);var v=$('<div style="width: 550px">').appendTo(t),b=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(v),m=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(v),y=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(m);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" checked style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">'+RED._("projects.create.enable-encryption")+"</span></label>").appendTo(y);var w=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(m);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">'+RED._("projects.create.disable-encryption")+"</span></label>").appendTo(w),m.find("input[name=projects-encryption-type]").click(function(e){var t,o;"enabled"===$(this).val()?(t=y,o=w,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&S.focus()):(o=y,t=w,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),o.css({borderColor:"white",borderRightColor:"#ccc"}),n()}),t=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(b),$('<label class="projects-edit-form-inline-label">'+RED._("projects.create.encryption-key")+"</label>").appendTo(t),(S=$('<input type="password"></input>').appendTo(t)).on("change keyup paste",n),$('<label class="projects-edit-form-sublabel"><small>'+RED._("projects.create.desc0")+"</small></label>").appendTo(t),t=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(b),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.create.desc1")+"</div>").appendTo(t),b.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();S.attr("disabled","default"===e),"custom"===e&&S.focus(),n()}),t=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-repo">'+RED._("projects.create.git-url")+"</label>").appendTo(t),C=$('<input id="projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(t),$('<label id="projects-dialog-screen-create-project-repo-label" class="projects-edit-form-sublabel"><small>'+RED._("projects.create.protocols")+"</small></label>").appendTo(t);var D=!1,E="";C.on("change keyup paste",function(){D=!0;var e=$(this).val();E!==e&&$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols"));var t=/\/([^/]+?)(?:\.git)?$/.exec(E=e);if(t){var o=k.val();""!==o&&o!==g||(g=t[1],k.val(g),k.change())}n()});var R=$('<div class="hide projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').hide().appendTo(o);t=$('<div class="form-row projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(R),$('<div><i class="fa fa-warning"></i> '+RED._("projects.create.auth-failed")+"</div>").appendTo(t),t=$('<div class="hide form-row projects-dialog-screen-create-row-creds"></div>').hide().appendTo(R),d=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(t),$('<label for="projects-dialog-screen-create-project-repo-user">'+RED._("projects.create.username")+"</label>").appendTo(d),O=$('<input id="projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(d),d=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(t),$('<label for="projects-dialog-screen-create-project-repo-pass">'+RED._("projects.create.password")+"</label>").appendTo(d),L=$('<input id="projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(d),t=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(R),d=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(t),$('<label for="projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.ssh-key")+"</label>").appendTo(d),I=$("<select>",{style:"width: 100%"}).appendTo(d),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){I.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(I.addClass("input-error"),I.attr("disabled",!0),x.show()):(I.removeClass("input-error"),I.attr("disabled",!1),x.hide())}),d=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(t),$('<label for="projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.passphrase")+"</label>").appendTo(d),N=$('<input id="projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(d),d=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').appendTo(R);var x=$('<div class="projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(d);switch($('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.create.desc2")+"</div>").appendTo(x),d=$('<div style="text-align: center">').appendTo(x),$('<button class="editor-button">'+RED._("projects.create.add-ssh-key")+"</button>").appendTo(d).click(function(e){e.preventDefault(),$("#projects-dialog-cancel").click(),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").click()},500)}),t=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(o),$("<label>"+RED._("projects.create.credentials-encryption-key")+"</label>").appendTo(t),j=$('<input type="password"></input>').appendTo(t),e.screen||"empty"){case"empty":i.click();break;case"open":a.click();break;case"clone":l.click()}return setTimeout(function(){"open"!==(e.screen||"empty")?k.focus():$("#projects-dialog-project-list-search").focus()},50),o},buttons:function(e){var t;switch(e.screen||"empty"){case"open":t=RED._("projects.create.open");break;case"empty":t=RED._("projects.create.create");break;case"clone":t=RED._("projects.create.clone")}return[{id:"projects-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"projects-dialog-create",text:t,class:"primary disabled",disabled:!0,click:function(){var e,t,o=$(".projects-dialog-screen-create-type.selected").data("type"),n={name:k.val()};if("empty"===o){n.summary=T.val(),n.files={flow:_.val()};var a=$("input[name=projects-encryption-type]:checked").val();n.credentialSecret="enabled"===a&&S.val()}else if("copy"===o)n.copy=(void 0).name;else if("clone"===o){n.credentialSecret=j.val();var i=C.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(i)){var s=I.val();if(!s)return void console.log(RED._("projects.create.cant-get-ssh-key-path"));n.git={remotes:{origin:{url:i,keyFile:s,passphrase:N.val()}}}}else n.git={remotes:{origin:{url:i,username:O.val(),password:L.val()}}}}else if("open"===o)return e=z.name,t=function(e,t){B.dialog("close"),e&&"credentials_load_failed"!==e.code&&console.log(RED._("projects.create.unexpected_error"),e)},RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(e),void U({url:"projects/"+e,type:"PUT",responses:{200:function(e){t(null,e)},400:{"*":t}}},{active:!0}).then(function(){RED.events.emit("project:change",{name:e})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)});$(".projects-dialog-screen-create-row-auth-error").hide(),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),O.removeClass("input-error"),L.removeClass("input-error"),I.removeClass("input-error"),N.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(n.name),U({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){B.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.create.already-exists-2"))},git_error:function(e){console.log(RED._("projects.create.git-error"),e)},git_connection_failed:function(e){C.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.con-failed"))},git_not_a_repository:function(e){C.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.not-git"))},git_repository_not_found:function(e){C.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-resource"))},git_auth_failed:function(e){$(".projects-dialog-screen-create-row-auth-error").show(),O.addClass("input-error"),L.addClass("input-error"),I.addClass("input-error"),N.addClass("input-error")},missing_flow_file:function(e){B.dialog("close")},missing_package_file:function(e){B.dialog("close")},project_empty:function(e){B.dialog("close")},credentials_load_failed:function(e){B.dialog("close")},"*":function(e){u(e),$(B).dialog("close")}}}},n).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}}function v(e,t){B||RED.projects.init();var o=s[e],n=o.content(t||{});i.empty();var a=o.buttons;"function"==typeof a&&(a=a(t||{})),B.dialog("option","buttons",a),i.append(n),B.dialog("option","title",o.title||""),B.dialog("open"),B.dialog({position:{my:"center top",at:"center top+10%",of:window}})}function e(e){if(RED.nodes.dirty())var t=RED._("projects.require-clean.confirm"),o=RED.notify(t,{type:"info",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.close(),e(!0)}},{text:RED._("common.label.cont"),click:function(){o.close(),e(!1)}}]})}function U(c,p){var t,o;if(c.requireCleanWorkspace&&RED.nodes.dirty())return e(function(e){e?c.cancel&&(c.cancel(),o&&o()):(delete c.requireCleanWorkspace,U(c,p).then(function(){t&&t()}).always(function(){o&&o()}))}),{then:function(e){return t=e,{always:function(e){o=e}}},always:function(e){o=e}};var u,f,n=Date.now();return $(".projects-dialog-spinner").show(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility","hidden"),p&&(c.data=JSON.stringify(p),c.contentType="application/json; charset=utf-8"),$.ajax(c).done(function(e,t,o){c.responses&&c.responses[200]&&(u=c.responses[200],f=e)}).fail(function(o,e,t){if(c.responses&&c.responses[o.status]){var n=c.responses[o.status];if("function"==typeof n)return void(f={error:(u=n).statusText});if(!1!==c.handleAuthFail&&"git_auth_failed"===o.responseJSON.code){var a=q.git.remotes[o.responseJSON.remote||c.remote||"origin"].fetch,i=$('<div><div class="form-row">'+RED._("projects.send-req.auth-req")+':</div><div class="form-row"><div style="margin-left: 20px;">'+a+"</div></div></div>"),s=!1;if(/^https?:\/\//.test(a))$('<div class="form-row"><label for="projects-user-auth-username">'+RED._("projects.send-req.username")+'</label><input id="projects-user-auth-username" type="text"></input></div><div class="form-row"><label for=projects-user-auth-password">'+RED._("projects.send-req.password")+'</label><input id="projects-user-auth-password" type="password"></input></div>').appendTo(i);else if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(a)){s=!0;var r=$('<div class="form-row"></div>').appendTo(i);$('<label for="projects-user-auth-key">SSH Key</label>').appendTo(r);var l=$('<select id="projects-user-auth-key">').width("70%").appendTo(r);$.getJSON("settings/user/keys",function(e){e.keys.forEach(function(e){l.append($("<option></option>").val(e.name).text(e.name)),0})}),r=$('<div class="form-row"></div>').appendTo(i),$('<label for="projects-user-auth-passphrase">'+RED._("projects.send-req.passphrase")+"</label>").appendTo(r),$('<input id="projects-user-auth-passphrase" type="password"></input>').appendTo(r)}var d=RED.notify(i,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){d.close()}},{text:'<span><i class="fa fa-refresh"></i> '+RED._("projects.send-req.retry")+"</span>",click:function(){p=p||{};var e={};s?(e.keyFile=$("#projects-user-auth-key").val(),e.passphrase=$("#projects-user-auth-passphrase").val()):(e.username=$("#projects-user-auth-username").val(),e.password=$("#projects-user-auth-password").val());var t=function(e){e?(console.log(RED._("projects.send-req.update-failed")),console.log(e)):(U(c,p),d.close())};U({url:"projects/"+q.name+"/remotes/"+(o.responseJSON.remote||c.remote||"origin"),type:"PUT",responses:{0:function(e){t(e)},200:function(e){t(null)},400:{unexpected_error:function(e){t(e)}}}},{auth:e})}}]});return}if(n[o.responseJSON.code])return u=n[o.responseJSON.code],void(f=o.responseJSON);if(n["*"])return u=n["*"],void(f=o.responseJSON)}console.log(n),console.log(RED._("projects.send-req.unhandled")+":"),console.log(o),console.log(e),console.log(t)}).always(function(){var e=Date.now()-n;e=Math.max(0,500-e),setTimeout(function(){$(".projects-dialog-spinner").hide(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility",""),u&&u(f)},e)})}function o(a){var i,o="",n=[],s="",r=$('<div class="projects-branch-list">').appendTo(a.container),l=$('<input type="text">').attr("placeholder",a.placeholder).appendTo(r).searchBox({delay:200,change:function(){o=$(this).val(),/(\.\.|\/\.|[?*[~^: \\]|\/\/|\/.$|\/$)/.test(o)?(i.hasClass("input-error")||(i.addClass("input-error"),i.find("i").addClass("fa-warning").removeClass("fa-code-fork")),i.find("span").text(RED._("projects.create-branch-list.invalid")+": "+s+o)):(i.hasClass("input-error")&&(i.removeClass("input-error"),i.find("i").removeClass("fa-warning").addClass("fa-code-fork")),i.find(".sidebar-version-control-branch-list-entry-create-name").text(s+o)),d.editableList("filter")}}),d=$("<ol>",{style:"height: 130px;"}).appendTo(r);return d.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){var n=$('<div class="sidebar-version-control-branch-list-entry">').appendTo(e);o.hasOwnProperty("commit")?($('<i class="fa fa-code-fork"></i>').appendTo(n),$("<span>").text(o.name).appendTo(n),o.current&&(n.addClass("selected"),$('<span class="current"></span>').text(a.currentLabel||RED._("projects.create-branch-list.current")).appendTo(n))):(i=n,$('<i class="fa fa-code-fork"></i>').appendTo(n),$("<span>").text(RED._("projects.create-branch-list.create")+":").appendTo(n),$('<div class="sidebar-version-control-branch-list-entry-create-name" style="margin-left: 10px;">').text(o.name).appendTo(n)),n.click(function(e){if(e.preventDefault(),!$(this).hasClass("input-error")){var t={};o.hasOwnProperty("commit")?($(this).hasClass("selected")&&(t.current=!0),t.name=o.name):(t.name=l.val(),t.create=!0,a.remote&&(t.name=a.remote()+"/"+t.name)),a.onselect&&a.onselect(t)}})},filter:function(e){var t=!e.hasOwnProperty("commit");return t&&""!==o&&-1===n.indexOf(s+o)||!t&&-1!==e.name.indexOf(o)}}),{refresh:function(e){l.searchBox("value",""),d.editableList("empty");var t=Date.now(),o=c(r).addClass("projects-dialog-spinner-contain");s=a.remote?a.remote()+"/":"",U({url:e,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){n=e.branches,e.branches.forEach(function(e){d.editableList("addItem",e)}),d.editableList("addItem",{}),setTimeout(function(){o.remove()},Math.max(300-(Date.now()-t),0))},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){u(e)}}}})},filter:function(){d.editableList("filter")},focus:function(){l.focus()}}}function c(e){return $('<div class="projects-dialog-spinner"><img src="red/images/spin.svg"/></div>').appendTo(e)}function n(){createProjectOptions={},q?v("create",{screen:"empty"}):v("welcome")}return{init:function(){B=$('<div id="projects-dialog" class="hide node-red-dialog projects-edit-form"><form class="form-horizontal"></form><div class="projects-dialog-spinner hide"><img src="red/images/spin.svg"/></div></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),i=B.find("form"),RED.actions.add("core:new-project",RED.projects.newProject),RED.actions.add("core:open-project",RED.projects.selectProject),RED.actions.add("core:show-project-settings",RED.projects.settings.show);var e={sendRequest:U,createBranchList:o,addSpinnerOverlay:c,reportUnexpectedError:u};RED.projects.settings.init(e),RED.projects.userSettings.init(e),RED.sidebar.versionControl.init(e),t()},showStartup:function(){RED.user.hasPermission("projects.write")?v("welcome"):RED.notify(RED._("user.errors.notAuthorized"),"error")},newProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?e(function(e){e||n()}):void n();RED.notify(RED._("user.errors.notAuthorized"),"error")},selectProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?e(function(e){e||v("create",{screen:"open"})}):void v("create",{screen:"open"});RED.notify(RED._("user.errors.notAuthorized"),"error")},showCredentialsPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showFilesPrompt:function(){RED.user.hasPermission("projects.write")?(RED.projects.settings.show("settings"),setTimeout(function(){$("#project-settings-tab-settings-file-edit").click()},200)):RED.notify(RED._("user.errors.notAuthorized"),"error")},showProjectDependencies:function(){RED.projects.settings.show("deps")},createDefaultFileSet:function(){if(!q)throw new Error(RED._("projects.create-default-file-set.no-active"));if(!q.empty)throw new Error(RED._("projects.create-default-file-set.no-empty"));RED.user.hasPermission("projects.write")?(createProjectOptions={},v("default-files",{existingProject:!0})):RED.notify(RED._("user.errors.notAuthorized"),"error")},createDefaultPackageFile:function(){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(q.name),U({url:"projects/"+q.name,type:"PUT",requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){},400:{git_error:function(e){console.log(RED._("projects.create-default-file-set.git-error"),e)},missing_flow_file:function(e){$(B).dialog("close")},"*":function(e){u(e),$(B).dialog("close")}}}},{initialise:!0}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})},refresh:function(t){$.getJSON("projects",function(e){e.active?$.getJSON("projects/"+e.active,function(e){q=e,RED.sidebar.versionControl.refresh(!0),t&&t(q)}):t&&t(null)})},editProject:function(){RED.projects.settings.show()},getActiveProject:function(){return q}}}(),RED.projects.settings=function(){var F,V,t=700,o=!1,l=[];function n(e){l.push(e)}function s(e,t){var o,n;t.empty(),o=e.description?marked(e.description):'<span class="node-info-none">No description available</span>',(n=$('<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(o)+'">'+o+"</span>"),$(n).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),n).appendTo(t).find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>")}function c(e,t){t.empty(),e?t.text(e).removeClass("node-info-node"):t.text(RED._("sidebar.project.projectSettings.noSummaryAvailable")).addClass("node-info-none")}function a(t){var e=$('<div id="project-settings-tab-main" class="project-settings-tab-pane node-help"></div>');$("<h1>").text(t.name).appendTo(e);var o=$('<div style="position: relative">').appendTo(e),n=$("<div></div>",{style:"color: #999"}).appendTo(o);c(t.summary,n),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">'+RED._("sidebar.project.editDescription")+"</button>").prependTo(o).click(function(e){e.preventDefault(),function a(i,s,r){var l=r.prev();l.hide(),r.empty();var e=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').appendTo(r),d=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(s||"").appendTo(r);$('<button class="editor-button">'+RED._("common.label.cancel")+"</button>").appendTo(e).click(function(e){e.preventDefault(),c(i.summary,r),l.show()}),$('<button class="editor-button">'+RED._("common.label.save")+"</button>").appendTo(e).click(function(e){e.preventDefault();var o=d.val();c(o,r);var n=V.addSpinnerOverlay(r),t=function(e,t){if(e)return n.remove(),a(i,s,r);i.summary=o,n.remove(),c(i.summary,r),l.show()};V.sendRequest({url:"projects/"+i.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),t(null)},400:{"*":function(e){V.reportUnexpectedError(e),t(e)}}}},{summary:o})})}(t,t.summary,n)}),$("<hr>").appendTo(e);var a=$('<div class="node-help" style="position: relative"></div>').appendTo(e),i=$("<div>",{style:"min-height: 200px"}).appendTo(a);return s(t,i),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">'+RED._("sidebar.project.editReadme")+"</button>").prependTo(a).click(function(e){e.preventDefault(),function n(a,i){RED.editor.editMarkdown({title:RED._("sidebar.project.editDescription"),header:$('<span><i class="fa fa-book"></i> README.md</span>'),value:a.description,complete:function(o){i.empty();var e=V.addSpinnerOverlay(i),t=function(e,t){if(e)return n(a,i);a.description=o,s(a,i)};V.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){t(null),RED.sidebar.versionControl.refresh(!0)},400:{"*":function(e){V.reportUnexpectedError(e),t(e)}}}},{description:o}).always(function(){e.remove()})}})}(t,i)}),e}function r(e,t){t.editableList("empty");var o=0;for(var n in h)h.hasOwnProperty(n)&&(t.editableList("addItem",{id:h[n].module,version:h[n].version,count:h[n].count,known:e.dependencies.hasOwnProperty(n),installed:!0}),o++,0===h[n].count&&0,e.dependencies.hasOwnProperty(n)||0);if(e.dependencies)for(var n in e.dependencies)if(e.dependencies.hasOwnProperty(n)&&!h.hasOwnProperty(n)){var a=!!RED.nodes.registry.getModule(n);t.editableList("addItem",{id:n,version:e.dependencies[n],count:0,known:!0,installed:a}),o++,a?0:0}0===o&&t.editableList("addItem",{index:0,label:RED._("sidebar.project.projectSettings.none")})}function p(e,t,o,n){var a=RED.projects.getActiveProject(),i=V.addSpinnerOverlay(t).addClass("projects-dialog-spinner-contain"),s=function(e,t){if(i.remove(),e)return n(e);a.dependencies=o,RED.sidebar.versionControl.refresh(!0),n()};V.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){s(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),s(null)},400:{"*":function(e){s(e)}}}},{dependencies:o})}function i(d){var t=$('<div id="project-settings-tab-deps" class="project-settings-tab-pane node-help"></div>');RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="margin-top:10px;float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(t).click(function(e){e.preventDefault(),function n(a,e,i,s){var t=e||JSON.stringify(a.dependencies||{},"",4);"{}"===t&&(t="{\n\n}"),RED.editor.editJSON({title:RED._("sidebar.project.editDependencies"),value:t,requireValid:!0,complete:function(t){try{var o=JSON.parse(t);p(0,i,o,function(e){if(e)return n(a,t,i,s);a.dependencies=o,r(a,s)})}catch(e){n(a,t,i,s)}}})}(d,null,t,c)});var c=$("<ol>",{style:"position: absolute;top: 60px;bottom: 20px;left: 20px;right: 20px;"}).appendTo(t);return c.editableList({addButton:!1,addItem:function(o,e,n){var a=$("<div>",{class:"palette-module-header"}).appendTo(o);if(n.label)0===n.index?a.addClass("red-ui-search-empty"):o.parent().addClass("palette-module-section"),a.text(n.label);else{a.addClass("palette-module-header"),n.installed?0===n.count?a.addClass("palette-module-unused"):n.known||a.addClass("palette-module-unknown"):a.addClass("palette-module-not-installed"),n.element=a;var t=$('<div class="palette-module-meta palette-module-name"></div>').appendTo(a),i="fa-cube";n.installed||(i="fa-warning");var s=$('<i class="fa '+i+'"></i>').appendTo(t);n.icon=s,$("<span>").text(n.id).appendTo(t);var r=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(a);$("<span>").text(n.version).appendTo(r);r=$('<div class="palette-module-meta"></div>').appendTo(a);var l=$('<div class="palette-module-button-group"></div>').appendTo(r);RED.user.hasPermission("projects.write")&&(n.installed||!1===RED.settings.theme("palette.editable")?n.known&&0===n.count?$('<a href="#" class="editor-button editor-button-small">'+RED._("sidebar.project.projectSettings.removeFromProject")+"</a>").appendTo(l).click(function(e){e.preventDefault();var t=$.extend(!0,{},d.dependencies);delete t[n.id],p(0,o,t,function(e){e?console.log(e):o.fadeOut(200,function(){c.editableList("removeItem",n)})})}):n.known||$('<a href="#" class="editor-button editor-button-small">'+RED._("sidebar.project.projectSettings.addToProject")+"</a>").appendTo(l).click(function(e){e.preventDefault();var t=$.extend(!0,{},d.dependencies);t[n.id]=h[n.id].version,p(0,o,t,function(e){e?console.log(e):(l.remove(),a.removeClass("palette-module-unknown"))})}):$('<a href="#" class="editor-button editor-button-small">'+RED._("sidebar.project.projectSettings.install")+"</a>").appendTo(l).click(function(e){e.preventDefault(),RED.palette.editor.install(n,o,function(e){if(!e){n.installed=!0;RED.utils.addSpinnerOverlay(o,!0);setTimeout(function(){c.editableList("removeItem",n),h={},RED.nodes.eachNode(f),RED.nodes.eachConfig(f),h.hasOwnProperty(n.id)?n.count=h[n.id].count:n.count=0,c.editableList("addItem",n)},500)}})}))}},sort:function(e,t){return e.id.localeCompare(t.id)}}),r(d,c),t}function G(e,t,n,i,s){var r=$('<div class="project-file-listing-container"></div>',{style:"position: relative; min-height: 175px; height: 175px;"}).hide().appendTo(e),l=V.addSpinnerOverlay(r);return $.getJSON("projects/"+t.name+"/files",function(t){var e=Object.keys(t);e=e.filter(function(e){return!t[e].status||!/D/.test(t[e].status)});var o={};e.sort(),e.forEach(function(e){e.split("/").reduce(function(e,t,o,n){if(t)return o<n.length-1?e[t]=e[t]||{}:e[t]=!0,e[t]},o)});var a=function(e,t,o){var n={name:e||"/",path:o+(o?"/":"")+e};return!0===t?n.type="f":(n.type="d",n.children=[],n.path=n.path,Object.keys(t).forEach(function(e){n.children.push(a(e,t[e],n.path))}),n.children.sort(function(e,t){return e.hasOwnProperty("children")&&!t.hasOwnProperty("children")?-1:!e.hasOwnProperty("children")&&t.hasOwnProperty("children")?1:e.name.localeCompare(t.name)})),n};o=a("",o,"");!function s(e,t,r,l,d,o){o=o||"";var n=$("<ol>",{class:"projects-dialog-file-list",style:o}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){var n=$("<div></div>",{class:"projects-dialog-file-list-entry"}).appendTo(e);if(o.children){if($('<span class="projects-dialog-file-list-entry-folder"><i class="fa fa-angle-right"></i> <i class="fa fa-folder-o"></i></span>').appendTo(n),0<o.children.length){var a=$("<div></div>",{style:"padding-left: 20px;"}).appendTo(e);0===r.indexOf(o.path+"/")?n.addClass("expanded"):a.hide(),s(a,o.children,r,l,d),n.addClass("selectable"),n.click(function(e){$(this).hasClass("expanded")?($(this).removeClass("expanded"),a.slideUp(200)):($(this).addClass("expanded"),a.slideDown(200))})}}else{var i="fa-file-o";/\.json$/i.test(o.name)?i="fa-file-code-o":/\.md$/i.test(o.name)?i="fa-book":/^\.git/i.test(o.name)&&(i="fa-code-fork",n.addClass("projects-dialog-file-list-entry-file-type-git")),$('<span class="projects-dialog-file-list-entry-file"> <i class="fa '+i+'"></i></span>').appendTo(n),l(o)?(n.addClass("selectable"),o.path===r&&n.addClass("selected"),n.click(function(e){$(".projects-dialog-file-list-entry.selected").removeClass("selected"),$(this).addClass("selected"),d(o.path,!0)}),n.dblclick(function(e){e.preventDefault(),d(o.path,!0)})):n.addClass("unselectable")}$('<span class="projects-dialog-file-list-entry-name" style=""></span>').text(o.name).appendTo(n)}});o||n.parent().css("overflow-y","");t.forEach(function(e){n.editableList("addItem",e)})}(r,o.children,n,i,s,"height: 175px"),l.remove()}),r}function d(s,e){$("<h3></h3>").text(RED._("sidebar.project.projectSettings.versionControl")).appendTo(e),function(l,e){var t=$('<div class="user-settings-section"></div>').appendTo(e);$("<h4></h4>").text(RED._("sidebar.project.projectSettings.branches")).appendTo(t);var o=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(t),d=$("<ol>").appendTo(o).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(a,e,i){var t=$('<div class="projects-dialog-list-entry">').appendTo(a);if(i.empty)return t.addClass("red-ui-search-empty"),void t.text(RED._("sidebar.project.projectSettings.noBranches"));i.current&&t.addClass("current"),$('<span class="entry-icon"><i class="fa fa-code-fork"></i></span>').appendTo(t);var o=$("<span>").appendTo(t),n=$("<div>").appendTo(o);if($('<span class="entry-name">').text(i.name).appendTo(n),i.commit&&$('<span class="entry-detail">').text(i.commit.sha).appendTo(n),i.remote){var s=$("<div>").appendTo(o);$('<span class="entry-detail entry-remote-name">').text(i.remote||"").appendTo(s),0<i.status.ahead+i.status.behind&&$('<span class="entry-detail"><i class="fa fa-long-arrow-up"></i> <span>'+i.status.ahead+'</span> <i class="fa fa-long-arrow-down"></i> <span>'+i.status.behind+"</span></span>").appendTo(s)}if(!i.current){var r=$('<span class="entry-tools">').appendTo(t);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(r).click(function(e){e.preventDefault();var o=V.addSpinnerOverlay(a).addClass("projects-dialog-spinner-contain"),n=RED.notify(RED._("sidebar.project.projectSettings.deleteConfirm",{name:i.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.remove(),n.close()}},{text:"Delete branch",click:function(){n.close();var t={url:"projects/"+l.name+"/branches/"+i.name,type:"DELETE",responses:{200:function(e){a.fadeOut(200,function(){d.editableList("removeItem",i),o.remove()})},400:{git_delete_branch_unmerged:function(e){n=RED.notify(RED._("sidebar.project.projectSettings.unmergedConfirm",{name:i.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.remove(),n.close()}},{text:RED._("sidebar.project.projectSettings.deleteUnmergedBranch"),click:function(){t.url+="?force=true",n.close(),V.sendRequest(t)}}]})},"*":function(e){V.reportUnexpectedError(e),o.remove()}}}};V.sendRequest(t)}}]})})}}});$.getJSON("projects/"+l.name+"/branches",function(e){e.branches&&(0<e.branches.length?(e.branches.sort(function(e,t){return e.current?-1:t.current?1:e.name.localeCompare(t.name)}),e.branches.forEach(function(e){d.editableList("addItem",e)})):d.editableList("addItem",{empty:!0}))})}(s,e);var t=$('<div class="user-settings-section"></div>').appendTo(e),o=$("<h4></h4>").text(RED._("sidebar.project.projectSettings.gitRemotes")).appendTo(t),n=$('<button class="editor-button editor-button-small" style="float: right; margin-right: 10px;">'+RED._("sidebar.project.projectSettings.addRemote")+"</button>").appendTo(o).click(function(e){n.attr("disabled",!0),i.slideDown(200,function(){i[0].scrollIntoView(),l?(h.val("origin"),g.focus()):h.focus(),p()})}),r={empty:!0},l=!0,a=$('<div class="user-settings-row"></div>').appendTo(t),i=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(a);a=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(t);var d=$("<ol>").appendTo(a);d.editableList({addButton:!1,height:"auto",addItem:function(n,e,a){var t=$('<div class="projects-dialog-list-entry">').appendTo(n);if(a.empty)return t.addClass("red-ui-search-empty"),void t.text(RED._("sidebar.project.projectSettings.noRemotes"));$('<span class="entry-icon"><i class="fa fa-globe"></i></span>').appendTo(t);var o=$("<span>").appendTo(t);$('<div class="entry-name">').text(a.name).appendTo(o),a.urls.fetch===a.urls.push?$('<div class="entry-detail">').text(a.urls.fetch).appendTo(o):($('<div class="entry-detail">').text("fetch: "+a.urls.fetch).appendTo(o),$('<div class="entry-detail">').text("push: "+a.urls.push).appendTo(o));var i=$('<span class="entry-tools">').appendTo(t);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(i).click(function(e){e.preventDefault();var t=V.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),o=RED.notify(RED._("sidebar.project.projectSettings.deleteRemoteConfrim",{name:a.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),o.close()}},{text:RED._("sidebar.project.projectSettings.deleteRemote"),click:function(){o.close(),s.git.branches.remote&&0===s.git.branches.remote.indexOf(a.name+"/")&&delete s.git.branches.remote,s.git.branches.remoteAlt&&0===s.git.branches.remoteAlt.indexOf(a.name+"/")&&delete s.git.branches.remoteAlt;var e={url:"projects/"+s.name+"/remotes/"+a.name,type:"DELETE",responses:{200:function(e){n.fadeOut(200,function(){d.editableList("removeItem",a),setTimeout(t.remove,100),0===e.remotes.length?(delete s.git.remotes,l=!0,d.editableList("addItem",r)):(s.git.remotes={},e.remotes.forEach(function(e){var t=e.name;delete e.name,s.git.remotes[t]=e})),delete s.git.branches.remoteAlt,RED.sidebar.versionControl.refresh()})},400:{"*":function(e){V.reportUnexpectedError(e),t.remove()}}}};V.sendRequest(e)}}]})})}});var c,p=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(h.val()),t=g.val(),o=0<t.length&&!/\s/.test(t);/^https?:\/\/[^/]+@/i.test(t)?(v.text(RED._("sidebar.project.projectSettings.urlRule2")),o=!1):v.text(RED._("sidebar.project.projectSettings.urlRule")),y.attr("disabled",!e||!o),h.toggleClass("input-error",u&&!e),g.toggleClass("input-error",f&&!o),c&&(c.close(),c=null)},u=!1,f=!1;$('<div class="projects-dialog-list-dialog-header">').text(RED._("sidebar.project.projectSettings.addRemote2")).appendTo(i),a=$('<div class="user-settings-row"></div>').appendTo(i),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.remoteName")).appendTo(a);var h=$('<input type="text">').appendTo(a).on("change keyup paste",function(){u=!0,p()});$('<label class="projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.nameRule")+"</small></label>").appendTo(a).find("small"),a=$('<div class="user-settings-row"></div>').appendTo(i),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.url")).appendTo(a);var g=$('<input type="text">').appendTo(a).on("change keyup paste",function(){f=!0,p()}),v=$('<label class="projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.urlRule")+"</small></label>").appendTo(a).find("small"),b=function(){n.attr("disabled",!1),i.hide(),h.val(""),g.val(""),c&&(c.close(),c=null)},m=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(i);$('<button class="editor-button">'+RED._("common.label.cancel")+"</button>").appendTo(m).click(function(e){e.preventDefault(),b()});var y=$('<button class="editor-button">'+RED._("sidebar.project.projectSettings.addRemote2")+"</button>").appendTo(m).click(function(e){e.preventDefault();var t=V.addSpinnerOverlay(i).addClass("projects-dialog-spinner-contain"),o={name:h.val(),url:g.val()},n=function(e){t.remove(),e||b()};RED.deploy.setDeployInflight(!0),V.sendRequest({url:"projects/"+s.name+"/remotes",type:"POST",responses:{0:function(e){n(e)},200:function(e){s.git.remotes={},e.remotes.forEach(function(e){var t=e.name;delete e.name,s.git.remotes[t]=e}),w(),RED.sidebar.versionControl.refresh(),n()},400:{git_remote_already_exists:function(e){c=RED.popover.create({target:h,direction:"right",size:"small",content:"Remote already exists",autoClose:6e3}).open(),h.addClass("input-error"),n(e)},"*":function(e){V.reportUnexpectedError(e),n(e)}}}},o)}),w=function(){d.editableList("empty");var e=0;if(s.git.hasOwnProperty("remotes"))for(var t in s.git.remotes)s.git.remotes.hasOwnProperty(t)&&(e++,d.editableList("addItem",{name:t,urls:s.git.remotes[t]}));(l=0===e)&&d.editableList("addItem",r)};w()}function u(e){var t=$('<div id="project-settings-tab-settings" class="project-settings-tab-pane node-help"></div>');return function(i,e){var t,o=$("<h3></h3>").text(RED._("sidebar.project.projectSettings.files")).appendTo(e),s=$('<div class="user-settings-section"></div>').appendTo(e);if(RED.user.hasPermission("projects.write"))var n=$('<button type="button" id="project-settings-tab-settings-file-edit" class="editor-button editor-button-small" style="float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(o).click(function(e){e.preventDefault(),q.show(),n.hide(),i.files.package||(c.find(".projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.packageCreate")),c.show()),d.show(),v.hide(),m.show(),y.show(),b(),T.addClass("uneditable-input"),$(".user-settings-row-credentials").show(),T.css("height","auto"),S.hide(),_.show()});t=$('<div class="user-settings-row"></div>').appendTo(s),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.package")).appendTo(t);var a=$('<div class="uneditable-input" style="padding:0">').appendTo(t),r=$('<span style="display:inline-block;  padding: 6px">').text(i.files.package||"package.json").appendTo(a),l=$('<input type="hidden">').val(i.files.package||"package.json").appendTo(a),d=$('<button type="button" class="editor-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(a).click(function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),a.find(".project-file-listing-container").slideUp(200,function(){$(this).remove(),a.css("height","")}),a.css("color","");else{$(this).addClass("selected"),a.css("color","inherit");var t=G(a,i,l.val(),function(e){return e.children||/package\.json$/.test(e.path)},function(e,t){if(e){l.val(e),r.text(e);var o=e.substring(0,e.length-12);h.text(o),E.text(o),b(),c.hide()}t&&$(d).click(),k()});a.css("height","auto"),setTimeout(function(){t.slideDown(200)},50)}});RED.popover.tooltip(d,RED._("sidebar.project.projectSettings.selectFile"));var c=$('<label style="margin-left: 110px" class="projects-edit-form-sublabel"><small><span class="form-warning"><i class="fa fa-warning"></i> <span class="projects-edit-form-sublabel-text"></span></small></label>').appendTo(t).hide();i.files.package||(c.find(".projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),c.show());var p=i.files.package||"package.json",u=p.substring(0,p.length-12);t=$('<div class="user-settings-row"></div>').appendTo(s),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.flow")).appendTo(t);var f=$('<div class="uneditable-input" style="padding:0">').appendTo(t),h=$('<span style="display:inline-block; padding: 6px 0 6px 6px">').text(u).appendTo(f),g="flows.json";i.files.flow&&(g=0===i.files.flow.indexOf(u)?i.files.flow.substring(u.length):i.files.flow);var v=$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(g).appendTo(f),b=function(){m.css({width:"calc(100% - "+(y.width()+h.width())+"px)"})},m=$('<input type="text" style="padding-left:1px; margin-top: -2px; margin-bottom: 0;border: none;">').val(g).hide().appendTo(f),y=$('<button type="button" class="editor-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(f).click(function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),f.find(".project-file-listing-container").slideUp(200,function(){$(this).remove(),f.css("height","")}),f.css("color","");else{$(this).addClass("selected"),f.css("color","inherit");var t=l.val(),o=t.substring(0,t.length-12),n=new RegExp("^"+o+".*.json$"),a=G(f,i,m.val(),function(e){return!/package.json$/.test(e.path)&&n.test(e.path)&&!/_cred\.json$/.test(e.path)},function(e,t){e&&m.val(e.substring(o.length)),t&&$(y).click(),k()});f.css("height","auto"),setTimeout(function(){a.slideDown(200)},50)}});RED.popover.tooltip(y,RED._("sidebar.project.projectSettings.selectFile")),t=$('<div class="user-settings-row"></div>').appendTo(s),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.credentials")).appendTo(t);var w="flows_cred.json";i.files.credentials&&(w=0===i.files.flow.indexOf(u)?i.files.credentials.substring(u.length):i.files.credentials);var D=$('<div class="uneditable-input" style="padding:0">').appendTo(t),E=$('<span style="display:inline-block;padding: 6px 0 6px 6px">').text(u).appendTo(D),R=$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(w).appendTo(D),x=$('<input type="hidden">').val(w).insertAfter(D),k=function(){var e,t=m.val(),o=/^(.+?)(\.[^.]*)?$/.exec(t);o?R.text(o[1]+"_cred"+(o[2]||".json")):""===t&&R.text(""),x.val(R.text());var n=""===t||/\.\./.test(t)||/\/$/.test(t);e=n||""===R.text(),N.is(":visible")&&(N.toggleClass("input-error",""===N.val()),e=e||""===N.val()),A.is(":visible")&&(A.toggleClass("input-error",""===A.val()),e=e||""===A.val()),m.toggleClass("input-error",n),U.toggleClass("disabled",e),U.prop("disabled",e)};m.on("change keyup paste",k),t=$('<div class="user-settings-row"></div>').appendTo(s),$("<label></label>").appendTo(t);var T=$('<span><i class="user-settings-credentials-state-icon fa"></i> <span class="user-settings-credentials-state"></span></span>').appendTo(t),_=$('<span class="button-group" style="margin-left: -72px;">').hide().appendTo(t);T.css("color","#666"),_.css("vertical-align","top");var j=$('<button type="button" class="editor-button" style="vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-trash-o"></i></button>').appendTo(_).click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),S.hide()):(A.val(""),I.hide(),z.show(),$(this).addClass("selected"),C.removeClass("selected"),P.show(),M.show(),O.hide(),L.hide(),S.show()),k()});RED.popover.tooltip(j,RED._("sidebar.project.projectSettings.resetTheEncryptionKey"));var C=$('<button type="button" class="editor-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-pencil"></i></button>').appendTo(_).click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),S.hide()):(N.val(""),A.val(""),i.settings.credentialSecretInvalid||!i.settings.credentialsEncrypted?(O.show(),L.hide(),I.hide()):(I.show(),O.hide(),L.show()),z.show(),C.addClass("selected"),j.removeClass("selected"),P.hide(),M.hide(),S.show()),k()});RED.popover.tooltip(C,RED._("sidebar.project.projectSettings.changeTheEncryptionKey")),t=$('<div class="user-settings-row user-settings-row-credentials"></div>').hide().appendTo(s);var S=$("<div>",{style:"margin-top:10px"}).hide().appendTo(T),O=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.setTheEncryptionKey")+"</div>").hide().appendTo(S),L=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.changeTheEncryptionKey")+"</div>").hide().appendTo(S),P=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.resetTheEncryptionKey")+"</div>").hide().appendTo(S),I=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(S);$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.currentKey")).appendTo(I);var N=$('<input type="password">').appendTo(I).on("change keyup paste",function(){F&&(F.close(),F=null),k()}),z=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(S);$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.newKey")).appendTo(z);var A=$('<input type="password">').appendTo(z).on("change keyup paste",k),M=$('<div class="form-tips form-warning" style="margin: 10px;"><i class="fa fa-warning"></i>'+RED._("sidebar.project.projectSettings.credentialsAlert")+"</div>").hide().appendTo(S),B=function(){n.show(),q.hide(),d.hide(),v.show(),m.hide(),y.hide(),T.removeClass("uneditable-input"),T.css("height",""),y.removeClass("selected"),f.find(".project-file-listing-container").remove(),f.css("height",""),f.css("color",""),$(".user-settings-row-credentials").hide(),S.hide(),_.hide(),j.removeClass("selected"),C.removeClass("selected")},q=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').hide().appendTo(s);$('<button type="button" class="editor-button">'+RED._("common.label.cancel")+"</button>").appendTo(q).click(function(e){e.preventDefault();var t=i.files.package||"package.json",o=t.substring(0,t.length-12);h.text(o),E.text(o),r.text(i.files.package||"package.json"),i.files.package?c.hide():(c.find(".projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),c.show()),m.val(v.text()),R.text(w),B()});var U=$('<button type="button" class="editor-button">'+RED._("common.label.save")+"</button>").appendTo(q).click(function(e){e.preventDefault();var t=V.addSpinnerOverlay(s),o=function(e){t.remove(),e?V.reportUnexpectedError(e):(v.text(m.val()),R.text(x.val()),c.hide(),B())},n=l.val();n=n.substring(0,n.length-12);var a={files:{package:l.val(),flow:n+m.val(),credentials:n+x.val()}};j.hasClass("selected")&&(a.resetCredentialSecret=!0),(j.hasClass("selected")||C.hasClass("selected"))&&(a.credentialSecret=A.val(),N.is(":visible")&&(a.currentCredentialSecret=N.val())),RED.deploy.setDeployInflight(!0),V.sendRequest({url:"projects/"+i.name,type:"PUT",responses:{0:function(e){o(e)},200:function(e){i=e,RED.sidebar.versionControl.refresh(!0),J(),o()},400:{credentials_load_failed:function(e){o(e)},missing_current_credential_key:function(e){N.addClass("input-error"),F=RED.popover.create({target:N,direction:"right",size:"small",content:"Incorrect key",autoClose:3e3}).open(),o(e)},"*":function(e){o(e)}}}},a).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),J=function(){i.settings.credentialSecretInvalid?(T.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-warning"),T.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.invalidEncryptionKey"))):i.settings.credentialsEncrypted?(T.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-lock"),T.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionEnabled"))):(T.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-unlock"),T.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionDisabled"))),j.toggleClass("disabled",!i.settings.credentialSecretInvalid&&!i.settings.credentialsEncrypted),j.prop("disabled",!i.settings.credentialSecretInvalid&&!i.settings.credentialsEncrypted)};k(),J()}(e,t),d(e,t),t}function f(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&(h.hasOwnProperty(t)||(h[t]={module:t,version:RED.nodes.registry.getModule(t).version,count:0,known:!1}),h[t].count++)}}var h={};return{init:function(e){V=e,n({id:"main",title:RED._("sidebar.project.name"),get:a,close:function(){}}),n({id:"deps",title:RED._("sidebar.project.dependencies"),get:i,close:function(){}}),n({id:"settings",title:RED._("sidebar.project.settings"),get:u,close:function(){F&&(F.close(),F=null)}}),RED.events.on("nodes:add",f),RED.events.on("nodes:remove",function(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&h.hasOwnProperty(t)&&(h[t].count--,0===h[t].count&&(h[t].known||delete h[t]))}})},show:function(r){if(!o)if(RED.user.hasPermission("projects.write")){o=!0;var e={title:RED._("sidebar.project.projectSettings.title"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){t=e.width},open:function(e){var t=RED.projects.getActiveProject(),o=e.find(".editor-tray-body"),n=$("<div></div>").appendTo(o),a=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(n);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(a);var i=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),s=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(n);l.forEach(function(e){i.addTab({id:"project-settings-tab-"+e.id,label:e.title,pane:e}),e.get(t).hide().appendTo(s)}),n.i18n(),i.activateTab("project-settings-tab-"+(r||"main")),$("#sidebar-shade").show()},close:function(){o=!1,l.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==t&&(e.width=t),RED.tray.show(e)}else RED.notify(RED._("user.errors.notAuthorized"),"error")},switchProject:function(e){h={}}}}(),RED.projects.userSettings=function(){var a,D,E;function t(e){var t=$('<div id="user-settings-tab-gitconfig" class="project-settings-tab-pane node-help"></div>');return function(e){var t=RED.settings.get("git")||{};t.user=t.user||{},$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.committerDetail")).appendTo(e);var o=$('<div class="user-settings-section"></div>').appendTo(e);$('<div style="color:#aaa;"></div>').appendTo(o).text(RED._("editor:sidebar.project.userSettings.committerTip"));var n=$('<div class="user-settings-row"></div>').appendTo(o);$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.userName")).appendTo(n),(a=$('<input type="text">').appendTo(n)).val(t.user.name||""),n=$('<div class="user-settings-row"></div>').appendTo(o),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.email")).appendTo(n),(D=$('<input type="text">').appendTo(n)).val(t.user.email||"")}(t),function(e){var n,t=$('<div class="user-settings-section"></div>').appendTo(e),o=($("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.sshKeys")).appendTo(t),$('<div style="color:#aaa;"></div>').appendTo(t).text(RED._("editor:sidebar.project.userSettings.sshKeysTip"))),a=$('<button id="user-settings-gitconfig-add-key" class="editor-button editor-button-small" style="float: right; margin-right: 10px;">'+RED._("editor:sidebar.project.userSettings.add")+"</button>").appendTo(o).click(function(e){a.attr("disabled",!0),v.attr("disabled",!0),r.slideDown(200),c.focus()}),i=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(c.val());c.toggleClass("input-error",d&&!e);var t=u.val(),o=0===t.length||8<=t.length;u.toggleClass("input-error",!o),o?0===t.length?f.text(RED._("editor:sidebar.project.userSettings.optional")):f.text(""):f.text(RED._("editor:sidebar.project.userSettings.passphraseShort")),e=e&&o,v.attr("disabled",!e),n&&(n.close(),n=null)},s=$('<div class="user-settings-row"></div>').appendTo(t),r=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(s);$('<div class="projects-dialog-list-dialog-header">').text(RED._("editor:sidebar.project.userSettings.addSshKey")).appendTo(r);var l=$("<div>").appendTo(r);s=$('<div class="user-settings-row"></div>').appendTo(l),$('<div style="color:#aaa;"></div>').appendTo(s).text(RED._("editor:sidebar.project.userSettings.addSshKeyTip")),s=$('<div class="user-settings-row"></div>').appendTo(l),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.name")).appendTo(s);var d=!1,c=$('<input type="text">').appendTo(s).on("change keyup paste",function(){d=!0,i()});$('<label class="projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.nameRule")+"</small></label>").appendTo(s).find("small");var p=$("<div>").appendTo(l);s=$('<div class="user-settings-row"></div>').appendTo(p),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.passphrase")).appendTo(s);var u=$('<input type="password">').appendTo(s).on("change keyup paste",i),f=$('<label class="projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.optional")+"</small></label>").appendTo(s).find("small"),h=function(){a.attr("disabled",!1),r.hide(),c.val(""),d=!1,u.val(""),n&&(n.close(),n=null)},g=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(r);$('<button class="editor-button">'+RED._("editor:sidebar.project.userSettings.cancel")+"</button>").appendTo(g).click(function(e){e.preventDefault(),h()});var v=$('<button class="editor-button">'+RED._("editor:sidebar.project.userSettings.generate")+"</button>").appendTo(g).click(function(e){e.preventDefault();var t=E.addSpinnerOverlay(r).addClass("projects-dialog-spinner-contain"),o={name:c.val(),type:"generate"};o.comment=D.val(),o.password=u.val(),o.size=4096;var n=function(e){t.remove(),e||h()};RED.deploy.setDeployInflight(!0),E.sendRequest({url:"settings/user/keys",type:"POST",responses:{0:function(e){n(e)},200:function(e){w(o.name),n()},400:{unexpected_error:function(e){console.log(e),n(e)}}}},o)});s=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(t);var b={empty:!0},m=function(e,t){var o=$('<div class="projects-dialog-ssh-public-key">',{style:"position:relative"}).appendTo(e),n=$("<pre>",{style:"min-height: 80px"}).appendTo(o),a=E.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),i={url:"settings/user/keys/"+t.name,type:"GET",responses:{200:function(e){n.text(e.publickey),a.remove()},400:{unexpected_error:function(e){console.log(e),a.remove()}}}};E.sendRequest(i);var s=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(o);return $('<button class="editor-button editor-button-small">'+RED._("editor:sidebar.project.userSettings.copyPublicKey")+"</button>").appendTo(s).click(function(e){try{e.stopPropagation(),e.preventDefault(),document.getSelection().selectAllChildren(n[0]),document.execCommand("copy"),document.getSelection().empty()}catch(e){}}),o},y=$('<ol class="projects-dialog-ssh-key-list">').appendTo(s).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(n,e,a){var t=$('<div class="projects-dialog-list-entry">').appendTo(n);if(a.empty)return t.addClass("red-ui-search-empty"),void t.text(RED._("editor:sidebar.project.userSettings.noSshKeys"));var o=$('<div class="projects-dialog-ssh-key-header">').appendTo(t);$('<span class="entry-icon"><i class="fa fa-key"></i></span>').appendTo(o),$('<span class="entry-name">').text(a.name).appendTo(o);var i,s=$('<span class="button-row entry-tools">').appendTo(o);o.click(function(e){i?i.slideUp(200,function(){i.remove(),i=null}):i=m(t,a)}),a.system||$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(s).click(function(e){e.stopPropagation();var t=E.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),o=RED.notify(RED._("editor:sidebar.project.userSettings.deleteConfirm",{name:a.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),o.close()}},{text:RED._("editor:sidebar.project.userSettings.delete"),click:function(){o.close();var e={url:"settings/user/keys/"+a.name,type:"DELETE",responses:{200:function(e){n.fadeOut(200,function(){y.editableList("removeItem",a),setTimeout(t.remove,100),0===y.editableList("length")&&y.editableList("addItem",b)})},400:{unexpected_error:function(e){console.log(e),t.remove()}}}};E.sendRequest(e)}}]})}),a.expand&&(i=m(t,a))}}),w=function(t){$.getJSON("settings/user/keys",function(e){e.keys&&(e.keys.sort(function(e,t){return e.name.localeCompare(t.name)}),y.editableList("empty"),e.keys.forEach(function(e){e.name===t&&(e.expand=!0),y.editableList("addItem",e)}),0===y.editableList("length")&&y.editableList("addItem",b))})};w()}(t),t}return{init:function(e){E=e,RED.userSettings.add({id:"gitconfig",title:RED._("editor:sidebar.project.userSettings.gitConfig"),get:t,close:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=a.val(),e.user.email=D.val(),RED.settings.set("git",e)}})}}}(),RED.sidebar.versionControl=function(){var O,L,P,I,N,z,r,A,M,B,q,U,J,l,F,V,G,W={};function K(o,s,e,r){o.addClass("sidebar-version-control-change-entry");var n=$("<div>").appendTo(o);if(s.label){if(o.addClass("node-info-none"),n.text(s.label),s.button){n.css({display:"inline-block",maxWidth:"300px",textAlign:"left"});var t=$('<div style="float: right; margin: 5px; height: 50px;"></div>').appendTo(n);$('<button class="editor-button editor-button-small"></button>').text(s.button.label).appendTo(t).click(s.button.click)}}else{var a,i,l=$('<i class=""></i>').appendTo(n),d=$('<a href="#">').appendTo(n).click(function(e){var n,a,i,t;e.preventDefault(),n=s,a=r,i=RED.projects.getActiveProject(),t="staged"===a?"index":"tree",F.sendRequest({url:"projects/"+i.name+"/diff/"+t+"/"+encodeURIComponent(n.file),type:"GET",responses:{0:function(e){console.log(e)},200:function(e){var t;t="unstaged"===a?RED._("sidebar.project.versionControl.unstagedChanges")+" : "+n.file:"staged"===a?RED._("sidebar.project.versionControl.stagedChanges")+" : "+n.file:RED._("sidebar.project.versionControl.resolveConflicts")+" : "+n.file;var o={diff:e.diff,title:t,unmerged:"unmerged"===a,project:i};"unstaged"==a?(o.oldRevTitle=" "===n.indexStatus?RED._("sidebar.project.versionControl.head"):RED._("sidebar.project.versionControl.staged"),o.newRevTitle=RED._("sidebar.project.versionControl.unstaged"),o.oldRev=" "===n.indexStatus?"@":":0",o.newRev="_"):"staged"===a?(o.oldRevTitle=RED._("sidebar.project.versionControl.head"),o.newRevTitle=RED._("sidebar.project.versionControl.staged"),o.oldRev="@",o.newRev=":0"):(o.oldRevTitle=RED._("sidebar.project.versionControl.local"),o.newRevTitle=RED._("sidebar.project.versionControl.remote"),o.commonRev=":1",o.oldRev=":2",o.newRev=":3",o.onresolve=function(e){F.sendRequest({url:"projects/"+i.name+"/resolve/"+encodeURIComponent(n.file),type:"POST",responses:{0:function(e){console.log(e)},200:function(e){Z(!0)},400:{unexpected_error:function(e){console.log(e)}}}},{resolutions:e.resolutions[n.file]})}),RED.diff.showUnifiedDiff(o)},400:{unexpected_error:function(e){console.log(e)}}}})}),c=$("<span>").appendTo(d),p=$('<div class="sidebar-version-control-change-entry-tools">').appendTo(o);if("unstaged"===r&&(a=$('<span class="button-group" style="margin-right: 5px;"></span>').appendTo(p),i=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(a).click(function(e){e.preventDefault();var t=F.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),o=RED.notify(RED._("sidebar.project.versionControl.revert",{file:s.file}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),o.close()}},{text:RED._("sidebar.project.versionControl.revertChanges"),click:function(){o.close();var e={url:"projects/"+RED.projects.getActiveProject().name+"/files/_/"+s.file,type:"DELETE",responses:{200:function(e){t.remove()},400:{unexpected_error:function(e){t.remove(),console.log(e)}}}};RED.deploy.setDeployInflight(!0),F.sendRequest(e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]})}),RED.popover.tooltip(i,RED._("sidebar.project.versionControl.revertChanges"))),a=$('<span class="button-group"></span>').appendTo(p),"unmerged"!==r){var u=$('<button class="editor-button editor-button-small"><i class="fa fa-'+("unstaged"===r?"plus":"minus")+'"></i></button>').appendTo(a).click(function(e){e.preventDefault();var t=RED.projects.getActiveProject();s.spinner=F.addSpinnerOverlay(o).addClass("projects-version-control-spinner-sidebar"),F.sendRequest({url:"projects/"+t.name+"/stage/"+encodeURIComponent(s.file),type:"unstaged"===r?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){Q(e)},400:{unexpected_error:function(e){console.log(e)}}}},{})});RED.popover.tooltip(u,RED._("sidebar.project.versionControl."+("unstaged"===r?"stage":"unstage")+"Change"))}s["update"+("unstaged"===r?"Unstaged":"Staged")]=function(e,t){n.removeClass();var o="";o="A"===t?(n.addClass("node-diff-added"),"fa-plus-square"):"?"===t?(n.addClass("node-diff-unchanged"),"fa-question-circle-o"):"D"===t?(n.addClass("node-diff-deleted"),"fa-minus-square"):"M"===t?(n.addClass("node-diff-changed"),"fa-square"):"R"===t?(n.addClass("node-diff-changed"),"fa-toggle-right"):("U"===t&&n.addClass("node-diff-conflicted"),"fa-exclamation-triangle"),c.empty(),$("<span>").text(e.file.replace(/\\(.)/g,"$1")).appendTo(c),e.oldName&&($('<i class="fa fa-long-arrow-right"></i>').prependTo(c),$("<span>").text(e.oldName.replace(/\\(.)/g,"$1")).prependTo(c)),l.removeClass(),l.addClass("fa "+o),e.spinner&&(e.spinner.remove(),delete e.spinner),i&&i.toggle("?"!==t),d.toggleClass("disabled","D"===t||"?"===t)},s["update"+("unstaged"===r?"Unstaged":"Staged")](s,e)}}function H(e){var t=Date.now()/1e3-e,o=Math.floor(t/86400);if(30<o)return new Date(1e3*e).toLocaleDateString();if(0<o)return RED._("sidebar.project.versionControl.daysAgo",{count:o});var n=Math.floor(t/3600);if(0<n)return RED._("sidebar.project.versionControl.hoursAgo",{count:n});var a=Math.floor(t/60);return 0<a?RED._("sidebar.project.versionControl.minsAgo",{count:a}):RED._("sidebar.project.versionControl.secondsAgo")}function Y(e,t){var o=RED.projects.getActiveProject();(r=t?F.addSpinnerOverlay(P.parent()):F.addSpinnerOverlay(N.parent())).addClass("projects-dialog-spinner-sidebar");var n=t?{files:e}:void 0;F.sendRequest({url:"projects/"+o.name+"/stage",type:t?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){Q(e)},400:{unexpected_error:function(e){console.log(e)}}}},n)}var a=!1;function X(n,a,e,i,t){var s=F.addSpinnerOverlay(e),o=n+"?limit="+(i||20);t&&(o+="&before="+t),F.sendRequest({url:o,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){var t;e.commits.forEach(function(e){a.editableList("addItem",e),t=e.sha}),a.loadMoreItem&&(a.editableList("removeItem",a.loadMoreItem),delete a.loadMoreItem);var o=a.editableList("length");o<e.total&&(a.loadMoreItem={totalKnown:o,total:e.total,url:n,before:t+"~1",limit:i},a.editableList("addItem",a.loadMoreItem)),s.remove()},400:{unexpected_error:function(e){console.log(e)}}}})}function Q(e){var n=e.files;r&&(r.remove(),r=null),(l=!!e.merging)?(O.addClass("sidebar-version-control-merging"),A.show()):(O.removeClass("sidebar-version-control-merging"),A.hide()),P.editableList("removeItem",V),N.editableList("removeItem",V),M.editableList("removeItem",G);var t=Object.keys(n).filter(function(e){return"f"===n[e].type});t.sort();var a=Date.now()+Math.floor(100*Math.random());t.forEach(function(e){var t=n[e],o=!1;t.status&&(t.file=e,t.indexStatus=t.status[0],t.treeStatus=t.status[1],("A"===t.indexStatus&&/[AU]/.test(t.treeStatus)||"U"===t.indexStatus&&/[DAU]/.test(t.treeStatus)||"D"===t.indexStatus&&/[DU]/.test(t.treeStatus))&&(t.unmerged=!0),W[e]?(W[e].unmerged&&!t.unmerged?(M.editableList("removeItem",W[e]),o=!0):!W[e].unmerged&&t.unmerged&&(P.editableList("removeItem",W[e]),N.editableList("removeItem",W[e])),W[e].status!==t.status&&(" "!==W[e].treeStatus?" "===t.treeStatus?P.editableList("removeItem",W[e]):t.treeStatus!==W[e].treeStatus&&W[e].updateUnstaged(t,t.treeStatus):o=!0," "!==W[e].indexStatus&&"?"!==W[e].indexStatus?" "===t.indexStatus||"?"===t.indexStatus?N.editableList("removeItem",W[e]):t.indexStatus!==W[e].indexStatus&&W[e].updateStaged(t,t.indexStatus):o=!0),W[e].status=t.status,W[e].indexStatus=t.indexStatus,W[e].treeStatus=t.treeStatus,W[e].oldName=t.oldName,W[e].unmerged=t.unmerged):(o=!0,W[e]=t),W[e].updateIndex=a,o&&(t.unmerged?M.editableList("addItem",W[e]):(" "!==t.treeStatus&&P.editableList("addItem",W[e])," "!==t.indexStatus&&"?"!==t.indexStatus&&N.editableList("addItem",W[e]))))}),Object.keys(W).forEach(function(e){W[e].updateIndex!==a&&(P.editableList("removeItem",W[e]),N.editableList("removeItem",W[e]),delete W[e])});var o=N.editableList("length"),i=P.editableList("length"),s=M.editableList("length");B.prop("disabled",l&&0<s||!l&&0===o),I.prop("disabled",0===i),z.prop("disabled",0===o),0===o&&N.editableList("addItem",V),0===i&&P.editableList("addItem",V),0===s&&M.editableList("addItem",G)}function Z(e,t){if(!a&&(e&&(W={},P.editableList("empty"),N.editableList("empty"),M.editableList("empty")),RED.user.hasPermission("projects.write"))){a=!0,function(){U.editableList("empty");var e=RED.projects.getActiveProject();e&&X("projects/"+e.name+"/commits",U,U.parent())}();var n=RED.projects.getActiveProject();if(n){var o="projects/"+n.name+"/status";t&&(o+="?remote=true"),$.getJSON(o,function(e){Q(e),$("#sidebar-version-control-local-branch").text(e.branches.local),$("#sidebar-version-control-remote-branch").text(e.branches.remote||RED._("sidebar.project.versionControl.none"));var t=e.commits.ahead||0,o=e.commits.behind||0;n.git.hasOwnProperty("remotes")?e.branches.hasOwnProperty("remoteError")&&"git_remote_gone"!==e.branches.remoteError.code?($("#sidebar-version-control-repo-status-auth-issue").show(),$("#sidebar-version-control-repo-status-stats").hide(),$("#sidebar-version-control-repo-branch").prop("disabled",!0),$("#sidebar-version-control-repo-pull").prop("disabled",!0),$("#sidebar-version-control-repo-push").prop("disabled",!0),$("#sidebar-version-control-repo-toolbar-message").hide(),$("#sidebar-version-control-repo-toolbar-error-message").show()):($("#sidebar-version-control-repo-toolbar-message").show(),$("#sidebar-version-control-repo-toolbar-error-message").hide(),$("#sidebar-version-control-repo-status-auth-issue").hide(),$("#sidebar-version-control-repo-status-stats").show(),$("#sidebar-version-control-repo-branch").prop("disabled",!1),$("#sidebar-version-control-repo-status-button").show(),e.branches.hasOwnProperty("remote")?ee(t,o):($("#sidebar-version-control-commits-ahead").text(""),$("#sidebar-version-control-commits-behind").text(""),$("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.notTracking")),$("#sidebar-version-control-repo-pull").prop("disabled",!0),$("#sidebar-version-control-repo-push").prop("disabled",!0))):$("#sidebar-version-control-repo-status-button").hide(),a=!1,$(".sidebar-version-control-shade").hide()}).fail(function(){a=!1})}else $(".sidebar-version-control-shade").show(),P.editableList("empty"),N.editableList("empty"),M.editableList("empty")}}function ee(e,t){$("#sidebar-version-control-commits-ahead").text(e),$("#sidebar-version-control-commits-behind").text(t),l?($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.statusUnmergedChanged")),$("#sidebar-version-control-repo-pull").prop("disabled",!0),$("#sidebar-version-control-repo-push").prop("disabled",!0)):0<e&&0===t?($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAhead",{count:e})),$("#sidebar-version-control-repo-pull").prop("disabled",!0),$("#sidebar-version-control-repo-push").prop("disabled",!1)):0===e&&0<t?($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsBehind",{count:t})),$("#sidebar-version-control-repo-pull").prop("disabled",!1),$("#sidebar-version-control-repo-push").prop("disabled",!0)):0<e&&0<t?($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAheadAndBehind1",{count:t})+RED._("sidebar.project.versionControl.commitsAheadAndBehind2",{count:e})+RED._("sidebar.project.versionControl.commitsAheadAndBehind3",{count:t})),$("#sidebar-version-control-repo-pull").prop("disabled",!1),$("#sidebar-version-control-repo-push").prop("disabled",!0)):0===e&&0===t&&($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.repositoryUpToDate")),$("#sidebar-version-control-repo-pull").prop("disabled",!0),$("#sidebar-version-control-repo-push").prop("disabled",!0))}function te(){Z(),RED.sidebar.show("version-control")}return{init:function(e){F=e,RED.actions.add("core:show-version-control-tab",te),RED.events.on("deploy",function(){var e=RED.projects.getActiveProject();e&&(W={},P.editableList("empty"),N.editableList("empty"),M.editableList("empty"),$.getJSON("projects/"+e.name+"/status",function(e){Q(e)}))}),RED.events.on("login",function(){Z(!0)}),O=$("<div>",{class:"sidebar-version-control"});var t=$("<div>",{class:"sidebar-version-control-stack"}).appendTo(O);L=RED.stack.create({container:t,fill:!0,singleExpanded:!0}),(q=L.add({title:RED._("sidebar.project.versionControl.localChanges"),collapsible:!0})).expand(),q.content.css({height:"100%"});var o=$('<div style="float: right"></div>').appendTo(q.header),n=$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(o).click(function(e){e.preventDefault(),e.stopPropagation(),Z(!0)});RED.popover.tooltip(n,RED._("sidebar.project.versionControl.refreshChanges")),V={label:RED._("sidebar.project.versionControl.none")},G={label:RED._("sidebar.project.versionControl.conflictResolve")};var a=$('<div class="sidebar-version-control-change-container"></div>').appendTo(q.content),i=$('<div class="sidebar-version-control-change-header">'+RED._("sidebar.project.versionControl.localFiles")+"</div>").appendTo(a);I=$('<button class="editor-button editor-button-small" style="float: right"><i class="fa fa-plus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(i).click(function(e){e.preventDefault(),e.stopPropagation(),Y(Object.keys(W).filter(function(e){return" "!==W[e].treeStatus}),!0)}),RED.popover.tooltip(I,RED._("sidebar.project.versionControl.stageAllChange")),(P=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(a)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){K(e,o,o.treeStatus,"unstaged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),A=$('<div class="sidebar-version-control-change-container"></div>').appendTo(q.content),i=$('<div class="sidebar-version-control-change-header">'+RED._("sidebar.project.versionControl.unmergedChanges")+"</div>").appendTo(A),o=$('<div style="float: right"></div>').appendTo(i);var s=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.abortMerge")+"</button>").appendTo(o).click(function(e){e.preventDefault(),e.stopPropagation();var t=F.addSpinnerOverlay(A),o=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),F.sendRequest({url:"projects/"+o.name+"/merge",type:"DELETE",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),Z(!0)},400:{unexpected_error:function(e){console.log(e)}}}}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})});(M=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(A)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){o===G&&(o.button={label:RED._("sidebar.project.versionControl.commit"),click:function(e){e.preventDefault(),e.stopPropagation(),l()}}),K(e,o,o.treeStatus,"unmerged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}});var r=$('<div class="sidebar-version-control-change-container"></div>').appendTo(q.content);i=$('<div class="sidebar-version-control-change-header">'+RED._("sidebar.project.versionControl.changeToCommit")+"</div>").appendTo(r),o=$('<div style="float: right"></div>').appendTo(i);var l=function(){d.val(""),u.prop("disabled",!0),a.css("height","30px"),A.is(":visible")?(A.css("height","30px"),r.css("height","calc(100% - 60px - 175px)")):r.css("height","calc(100% - 30px - 175px)"),commitBox.show(),setTimeout(function(){commitBox.css("height","175px")},10),I.prop("disabled",!0),z.prop("disabled",!0),B.prop("disabled",!0),s.prop("disabled",!0),d.focus()};B=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.commit")+"</button>").appendTo(o).click(function(e){e.preventDefault(),e.stopPropagation(),l()}),RED.popover.tooltip(B,RED._("sidebar.project.versionControl.commitChanges")),z=$('<button class="editor-button editor-button-small"><i class="fa fa-minus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(o).click(function(e){e.preventDefault(),e.stopPropagation(),Y(Object.keys(W).filter(function(e){return" "!==W[e].indexStatus&&"?"!==W[e].indexStatus}),!1)}),RED.popover.tooltip(z,RED._("sidebar.project.versionControl.unstageAllChange")),(N=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(r)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){K(e,o,o.indexStatus,"staged")},sort:function(e,t){return e.file.localeCompare(t.file)}}),commitBox=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-bottom"></div>').hide().appendTo(q.content);var d=$("<textarea placeholder="+RED._("sidebar.project.versionControl.commitPlaceholder")+"></textarea>").appendTo(commitBox).on("change keyup paste",function(){u.prop("disabled",""===$(this).val().trim())}),c=$('<div class="sidebar-version-control-slide-box-toolbar button-group">').appendTo(commitBox),p=$('<button class="editor-button">'+RED._("sidebar.project.versionControl.cancelCapital")+"</button>").appendTo(c).click(function(e){e.preventDefault(),d.val(""),a.css("height",""),A.css("height",""),r.css("height",""),commitBox.css("height",0),setTimeout(function(){commitBox.hide()},200),I.prop("disabled",!1),z.prop("disabled",!1),B.prop("disabled",!1),s.prop("disabled",!1)}),u=$('<button class="editor-button">'+RED._("sidebar.project.versionControl.commitCapital")+"</button>").appendTo(c).click(function(e){e.preventDefault();var t=F.addSpinnerOverlay(u).addClass("projects-dialog-spinner-sidebar"),o=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),F.sendRequest({url:"projects/"+o.name+"/commit",type:"POST",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),p.click(),Z(!0)},400:{"*":function(e){F.reportUnexpectedError(e)}}}},{message:d.val()}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),f=L.add({title:RED._("sidebar.project.versionControl.commitHistory"),collapsible:!0});o=$('<div style="float: right"></div>').appendTo(f.header),n=$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(o).click(function(e){e.preventDefault(),e.stopPropagation(),Z(!0,!0)}),RED.popover.tooltip(n,RED._("sidebar.project.versionControl.refreshCommitHistory"));var h=$('<div class="sidebar-version-control-change-header" style="text-align: right;"></div>').appendTo(f.content),g=$('<button class="editor-button editor-button-small"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.branch")+' <span id="sidebar-version-control-local-branch"></span></button>').appendTo(h).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))b();else{D(),J.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();y.refresh("projects/"+t.name+"/branches"),m.show(),setTimeout(function(){m.css("height","215px"),y.focus()},100)}});RED.popover.tooltip(g,RED._("sidebar.project.versionControl.changeLocalBranch"));var v=$('<button class="editor-button editor-button-small" style="margin-left: 10px;" id="sidebar-version-control-repo-status-button"><span id="sidebar-version-control-repo-status-stats"><i class="fa fa-long-arrow-up"></i> <span id="sidebar-version-control-commits-ahead"></span> <i class="fa fa-long-arrow-down"></i> <span id="sidebar-version-control-commits-behind"></span></span><span id="sidebar-version-control-repo-status-auth-issue"><i class="fa fa-warning"></i></span></button>').appendTo(h).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))D();else{b(),J.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();$("#sidebar-version-control-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),w.show(),setTimeout(function(){w.css("height","265px")},100)}});RED.popover.tooltip(v,RED._("sidebar.project.versionControl.manageRemoteBranch")),U=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0px; right:0; left:0;"}).appendTo(f.content),J=$('<div class="component-shade" style="z-Index: 3"></div>').css("top","30px").hide().appendTo(f.content),U.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,e,o){if(t.addClass("sidebar-version-control-commit-entry"),o.url)t.addClass("sidebar-version-control-commit-more"),t.text("+ "+(o.total-o.totalKnown)+RED._("sidebar.project.versionControl.moreCommits")),t.click(function(e){e.preventDefault(),X(o.url,U,t,o.limit,o.before)});else{t.click(function(e){var t=RED.projects.getActiveProject();t&&$.getJSON("projects/"+t.name+"/commits/"+o.sha,function(e){e.project=t,e.parents=o.parents,e.oldRev=o.sha+"~1",e.newRev=o.sha,e.oldRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+o.sha.substring(0,7)+"~1",e.newRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+o.sha.substring(0,7),e.date=H(parseInt(o.date)),RED.diff.showCommitDiff(e)})});var n=$("<div>").appendTo(t);if($('<div class="sidebar-version-control-commit-subject">').text(o.subject).appendTo(n),o.refs){var a=$('<div class="sidebar-version-control-commit-refs">').appendTo(n);o.refs.forEach(function(e){var t=e;/HEAD -> /.test(e)&&(t=e.substring(8)),$('<span class="sidebar-version-control-commit-ref">').text(t).appendTo(a)}),t.addClass("sidebar-version-control-commit-head")}$('<div class="sidebar-version-control-commit-sha">').text(o.sha.substring(0,7)).appendTo(n),$('<div class="sidebar-version-control-commit-date">').text(H(parseInt(o.date))).appendTo(n)}}});var b=function(e){g.removeClass("selected"),m.css("height","0"),J.hide(),setTimeout(function(){m.hide(),e&&e()},200)},m=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px;"></div>').hide().appendTo(f.content);$('<div class="sidebar-version-control-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.changeLocalBranch")).appendTo(m);var y=F.createBranchList({placeholder:RED._("sidebar.project.versionControl.createBranchPlaceholder"),container:m,onselect:function(e){if(e.current)return b();var t=F.addSpinnerOverlay(m),o=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),F.sendRequest({url:"projects/"+o.name+"/branches",type:"POST",requireCleanWorkspace:!0,cancel:function(){t.remove()},responses:{0:function(e){t.remove(),console.log(e)},200:function(e){b(function(){t.remove()})},400:{git_local_overwrite:function(e){t.remove(),RED.notify(RED._("sidebar.project.versionControl.localOverwrite"),{type:"error",timeout:8e3})},unexpected_error:function(e){t.remove(),console.log(e)}}}},e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}),w=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px"></div>').hide().appendTo(f.content),D=function(){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),v.removeClass("selected"),w.css("height","0"),J.hide(),setTimeout(function(){w.hide(),E()},200)},E=function(e){x.hasClass("selected")&&(x.removeClass("selected"),_.height(0),w.css("height","265px"),setTimeout(function(){_.hide(),e&&e()},200))};$('<div class="sidebar-version-control-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.manageRemoteBranch")).appendTo(w);var R=$('<div style="margin-bottom: 5px;"></div>').appendTo(w),x=$('<button id="sidebar-version-control-repo-branch" class="sidebar-version-control-repo-action editor-button"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.remote")+': <span id="sidebar-version-control-remote-branch"></span></button>').appendTo(R).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))E();else{$(this).addClass("selected");var t=RED.projects.getActiveProject();j.refresh("projects/"+t.name+"/branches/remote"),_.show(),setTimeout(function(){_.height(180),w.css("height","445px"),j.focus()},100)}});$('<div id="sidebar-version-control-repo-toolbar-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').appendTo(w);var k=$('<div id="sidebar-version-control-repo-toolbar-error-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').hide().appendTo(w);$('<div style="margin-top: 10px;"><i class="fa fa-warning"></i> '+RED._("sidebar.project.versionControl.unableToAccess")+"</div>").appendTo(k);var T=$('<div style="margin: 10px 30px; text-align: center"></div>').appendTo(k);$('<button class="editor-button" style="width: 80%;"><i class="fa fa-refresh"></i> '+RED._("sidebar.project.versionControl.retry")+"</button>").appendTo(T).click(function(e){e.preventDefault();var t=RED.projects.getActiveProject(),o=F.addSpinnerOverlay(w).addClass("projects-dialog-spinner-contain");F.sendRequest({url:"projects/"+t.name+"/branches/remote",type:"GET",responses:{0:function(e){console.log(e)},200:function(e){Z(!0)},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){console.log(e)}}}}).always(function(){o.remove()})}),$('<div class="sidebar-version-control-slide-box-header" style="height: 20px;"><label id="sidebar-version-control-repo-toolbar-set-upstream-row" for="sidebar-version-control-repo-toolbar-set-upstream" class="hide"><input type="checkbox" id="sidebar-version-control-repo-toolbar-set-upstream"> '+RED._("sidebar.project.versionControl.setUpstreamBranch")+"</label></div>").appendTo(w);var _=$('<div style="height: 0;overflow:hidden; transition: height 0.2s ease-in-out;"></div>').hide().appendTo(R),j=F.createBranchList({placeholder:RED._("sidebar.project.versionControl.createRemoteBranchPlaceholder"),currentLabel:RED._("sidebar.project.versionControl.upstream"),remote:function(){var e=RED.projects.getActiveProject();return Object.keys(e.git.remotes)[0]},container:_,onselect:function(e){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!1),$("#sidebar-version-control-remote-branch").text(e.name+(e.create?" *":""));var n=RED.projects.getActiveProject();n.git.branches.remote===e.name?delete n.git.branches.remoteAlt:n.git.branches.remoteAlt=e.name,$("#sidebar-version-control-repo-toolbar-set-upstream-row").toggle(!!n.git.branches.remoteAlt),E(function(){if(e.create)n.git.branches.remote?$("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.selectUpstreamBranch")):($("#sidebar-version-control-repo-toolbar-message").text(RED._("sidebar.project.versionControl.trackedUpstreamBranch")),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!0),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!0)),$("#sidebar-version-control-repo-pull").prop("disabled",!0),$("#sidebar-version-control-repo-push").prop("disabled",!1);else{var t=Date.now(),o=F.addSpinnerOverlay($("#sidebar-version-control-repo-toolbar-message")).addClass("projects-dialog-spinner-contain");$.getJSON("projects/"+n.name+"/branches/remote/"+e.name+"/status",function(e){setTimeout(function(){ee(e.commits.ahead,e.commits.behind),o.remove()},Math.max(400-(Date.now()-t),0))})}})}}),C=$('<div style="margin-bottom: 5px;"></div>').appendTo(w);$('<button id="sidebar-version-control-repo-push" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-up"></i> <span data-i18n="sidebar.project.versionControl.push"></span></button>').appendTo(C).click(function(e){e.preventDefault();var t=F.addSpinnerOverlay(w).addClass("projects-dialog-spinner-contain"),o=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(t);$('<button class="editor-button"></button>').text(RED._("eventLog.view")).appendTo(o).click(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")});var n=RED.projects.getActiveProject();RED.eventLog.startEvent("Push changes"+(n.git.branches.remoteAlt?" : "+n.git.branches.remoteAlt:""));var a="projects/"+n.name+"/push";n.git.branches.remoteAlt&&(a+="/"+n.git.branches.remoteAlt);var i=$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked");i&&(a+="?u=true"),F.sendRequest({url:a,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){i&&n.git.branches.remoteAlt&&(n.git.branches.remote=n.git.branches.remoteAlt,delete n.git.branches.remoteAlt),Z(!0),D()},400:{git_push_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.pushFailed"),"error")},unexpected_error:function(e){console.log(e)}}}},{}).always(function(){t.remove()})});var S=function(o){o=o||{};var e=F.addSpinnerOverlay(w).addClass("projects-dialog-spinner-contain"),t=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(e);$('<button class="editor-button"></button>').text(RED._("eventLog.view")).appendTo(t).click(function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")});var n=RED.projects.getActiveProject();RED.eventLog.startEvent("Pull changes"+(n.git.branches.remoteAlt?" : "+n.git.branches.remoteAlt:""));var a="projects/"+n.name+"/pull";n.git.branches.remoteAlt&&(a+="/"+n.git.branches.remoteAlt),(o.setUpstream||o.allowUnrelatedHistories)&&(a+="?"),o.setUpstream&&(a+="setUpstream=true",o.allowUnrelatedHistories&&(a+="&")),o.allowUnrelatedHistories&&(a+="allowUnrelatedHistories=true"),F.sendRequest({url:a,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){o.setUpstream&&n.git.branches.remoteAlt&&(n.git.branches.remote=n.git.branches.remoteAlt,delete n.git.branches.remoteAlt),Z(!0),D()},400:{git_local_overwrite:function(e){RED.notify(RED._("sidebar.project.versionControl.unablePull")+'<p><a href="#" onclick="RED.sidebar.versionControl.showLocalChanges(); return false;">'+RED._("sidebar.project.versionControl.showUnstagedChanges")+"</a></p>","error",!1,1e7)},git_pull_merge_conflict:function(e){Z(!0),D()},git_connection_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.connectionFailed")+e.toString(),"warning")},git_pull_unrelated_history:function(e){var t=RED.notify(RED._("sidebar.project.versionControl.pullUnrelatedHistory"),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:RED._("sidebar.project.versionControl.pullChanges"),click:function(){t.close(),o.allowUnrelatedHistories=!0,S(o)}}]})},"*":function(e){F.reportUnexpectedError(e)}}}},{}).always(function(){e.remove()})};$('<button id="sidebar-version-control-repo-pull" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-down"></i> <span data-i18n="sidebar.project.versionControl.pull"></span></button>').appendTo(C).click(function(e){e.preventDefault(),S({setUpstream:$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked")})}),$('<div class="component-shade sidebar-version-control-shade">').appendTo(O),RED.sidebar.addTab({id:"version-control",label:RED._("sidebar.project.versionControl.history"),name:RED._("sidebar.project.versionControl.projectHistory"),content:O,enableOnEdit:!1,pinned:!0,iconClass:"fa fa-code-fork",action:"core:show-version-control-tab",onchange:function(){setTimeout(function(){L.resize()},10)}})},show:te,refresh:Z,showLocalChanges:function(){RED.sidebar.show("version-control"),q.expand()}}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var f=null,h=!1,g=!1,v=null;return{show:function(e,i,t){h=!0;try{$("body").width(),$("body").height();for(var n=(f=d3.select("body").append("div").style({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":1e3}).on("touchstart",function(){u(),d3.event.preventDefault()})).append("div").style({position:"absolute",top:i[1]-80+"px",left:i[0]-80+"px","border-radius":"80px",width:"160px",height:"160px",background:"rgba(255,255,255,0.6)",border:"1px solid #666"}),s=[],o=function(e,t,o){o.el=n.append("div").style({position:"absolute",top:t+80-25+"px",left:e+80-25+"px","border-radius":"20px",width:"50px",height:"50px",background:"#fff",border:"2px solid #666","text-align":"center","line-height":"50px"}),o.el.html(o.name),o.disabled&&o.el.style({"border-color":"#ccc",color:"#ccc"}),o.x=e,o.y=t,s.push(o),o.el.on("touchstart",function(){o.el.style("background","#999"),d3.event.preventDefault(),d3.event.stopPropagation()}),o.el.on("touchend",function(){u(),o.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})},a=t.length,r=Math.max(Math.PI/(a-1),Math.PI/4),l=Math.PI,d=0;d<a;d++){var c=Math.floor(80*Math.cos(l)),p=Math.floor(80*Math.sin(l));t[d].name&&o(c,p,t[d]),l+=r}var u=function(){h=!1,v=null,f.remove(),f=null};e.on("touchend.radial",function(){if(e.on("touchend.radial",null),e.on("touchmenu.radial",null),v){try{v.onselect()}catch(e){RED._debug(e)}u()}else g&&u()}),e.on("touchmove.radial",function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-i[0],e.pageY-i[1]],o=0;o<s.length;o++){var n=s[o];n.disabled||(t[0]>n.x-30&&t[0]<n.x+30&&t[1]>n.y-30&&t[1]<n.y+30?n!==v&&(n.el.style("background","#999"),v=n):n===v?(n.el.style("background","#fff"),v=null):n.el.style("background","#fff"))}if(!v){var a=Math.abs(t[0]*t[0]+t[1]*t[1]);g=6400<a}}catch(e){RED._debug(e)}})}catch(e){RED._debug(e)}},active:function(){return h}}}();